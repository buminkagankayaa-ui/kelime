<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LingoMaster</title>
  <meta name="theme-color" content="#0b1220" id="meta-theme">
  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --header-h: 60px;
      --nav-h: 78px;
      --radius: 18px;
      --bg:#0b1220;
      --card:#111b2d;
      --card2:#0f172a;
      --border:#25324a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#6366f1;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --card2:#f1f5f9; --border:#cbd5e1;
      --text:#0f172a; --muted:#64748b; --primary:#4f46e5;
      --danger:#dc2626; --warn:#d97706; --ok:#059669;
    }
    [data-theme="ocean"]{ --bg:#06131f; --card:#0b2236; --card2:#0a1b2a; --border:#245070; --text:#e6f2ff; --muted:#9bb7d3; --primary:#38bdf8;}
    [data-theme="emerald"]{ --bg:#071a14; --card:#0b2a21; --card2:#082018; --border:#1f6b52; --text:#ecfdf5; --muted:#9fe3c7; --primary:#10b981;}
    [data-theme="sunset"]{ --bg:#1b1020; --card:#2a1731; --card2:#1f1225; --border:#6b2a59; --text:#fff7ed; --muted:#fbcfe8; --primary:#fb7185;}
    [data-theme="rose"]{ --bg:#120a10; --card:#1f0f1b; --card2:#160b13; --border:#7f1d1d; --text:#fff1f2; --muted:#fda4af; --primary:#f43f5e;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;}
    header{
      position:sticky; top:0; z-index:20;
      height:calc(var(--header-h) + var(--safe-top));
      padding-top:var(--safe-top);
      display:flex; align-items:center; justify-content:space-between;
      padding-left:16px; padding-right:16px;
      background:color-mix(in srgb, var(--bg) 78%, transparent);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:950;}
    .logo{width:18px;height:18px;border:2px solid var(--primary);border-radius:6px;transform:rotate(15deg);}
    .iconBtn{
      width:44px;height:44px;border-radius:14px;background:transparent;border:1px solid var(--border);
      color:var(--muted);display:grid;place-items:center;cursor:pointer;user-select:none;
    }
    .iconBtn:active{transform:scale(.98);opacity:.9;}
    #viewport{position:relative;height:calc(100vh - (var(--header-h) + var(--safe-top)));}
    .view{
      position:absolute; inset:0;
      padding:18px;
      padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 18px);
      overflow:auto;
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:.25s ease;
    }
    .view.active{opacity:1; pointer-events:auto; transform:none;}
    .row{display:flex;gap:12px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
    .muted{color:var(--muted);}
    .big{font-size:34px;font-weight:980;}
    .h2{font-size:20px;font-weight:980;margin:0 0 12px 0;}
    .secTitle{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:950;margin:4px 0 10px;}
    .btn{
      border:0;cursor:pointer;border-radius:16px;padding:14px 16px;font-weight:980;
      display:flex;align-items:center;justify-content:center;gap:10px;user-select:none;
    }
    .btn:active{transform:scale(.985);opacity:.92;}
    .btnPrimary{background:var(--primary);color:white;}
    .btnSoft{background:var(--card2);color:var(--text);border:1px solid var(--border);}
    .btnDanger{background:var(--danger);color:white;}
    .btnOk{background:var(--ok);color:white;}
    .btnHalf{flex:1;}
    nav{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      height:calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom:var(--safe-bottom);
      background:var(--card2);
      border-top:1px solid var(--border);
      display:flex;
    }
    .navBtn{
      flex:1;background:transparent;border:0;color:var(--muted);
      cursor:pointer;user-select:none;
      display:grid;grid-template-rows:36px 18px;
      align-items:center;justify-items:center;
      padding:6px 0;line-height:1;min-width:0;
    }
    .navBtn .ico{width:46px;height:36px;display:grid;place-items:center;font-size:20px;line-height:1;}
    .navBtn span{font-size:11.5px;font-weight:980;line-height:1;transform:translateY(-1px);white-space:nowrap;}
    .navBtn.active{color:var(--primary);}
    .navBtn.active .ico{background:color-mix(in srgb, var(--primary) 15%, transparent);border-radius:14px;}
    .backdrop{position:fixed;inset:0;z-index:40;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:.2s ease;}
    .backdrop.open{opacity:1;pointer-events:auto;}
    .sheet{
      position:fixed;left:0;right:0;bottom:0;z-index:50;
      background:var(--card);
      border-radius:26px 26px 0 0;
      border:1px solid var(--border);
      transform:translateY(110%);
      transition:.25s ease;
      max-height:85vh;overflow:auto;
      padding:14px 16px calc(16px + var(--safe-bottom));
    }
    .sheet.open{transform:none;}
    .handle{width:48px;height:5px;border-radius:99px;background:var(--border);margin:6px auto 14px;}
    .field{margin:10px 0;}
    label{display:block;font-size:12px;font-weight:980;color:var(--muted);margin-bottom:6px;}
    input, textarea, select{
      width:100%;background:var(--card2);border:1px solid var(--border);border-radius:16px;
      padding:14px;color:var(--text);font-size:16px;outline:none;
    }
    textarea{min-height:92px;resize:none;}
    .two{display:flex;gap:10px;}
    .smallInfo{font-size:12px;color:var(--muted);font-weight:950;margin-top:6px;}
    .toast{
      position:fixed;left:50%;top:calc(14px + var(--safe-top));
      transform:translate(-50%,-20px);
      background:var(--text);color:var(--bg);
      padding:10px 14px;border-radius:99px;font-weight:980;
      opacity:0;pointer-events:none;transition:.25s ease;z-index:200;
      max-width:calc(100vw - 20px);text-align:center;
    }
    .toast.show{opacity:1;transform:translate(-50%,0);}
    .cardLine{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .termBig{font-weight:980;color:var(--primary);font-size:20px;}
    .badge{
      font-size:11px;font-weight:980;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      color:var(--muted);background:color-mix(in srgb, var(--card2) 60%, transparent);white-space:nowrap;
    }
    .badge.due{color:var(--warn);border-color:color-mix(in srgb, var(--warn) 45%, var(--border));background:color-mix(in srgb, var(--warn) 10%, transparent);}
    .divider{height:1px;background:var(--border);margin:12px 0;}
    .kbd{font-size:11px;font-weight:980;border:1px solid var(--border);padding:4px 8px;border-radius:10px;background:var(--card);color:var(--muted);}

    /* Quiz overlay (simple) */
    .overlay{position:fixed;inset:0;z-index:120;background:var(--bg);transform:translateX(110%);transition:.25s ease;display:flex;flex-direction:column;}
    .overlay.open{transform:none;}
    .overlayTop{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px calc(14px + var(--safe-top));
      padding-top:calc(14px + var(--safe-top));
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb, var(--bg) 85%, transparent);
      backdrop-filter: blur(12px);
    }
    .qChoice{ text-align:left;background:var(--card);border:1px solid var(--border);padding:14px;border-radius:16px;cursor:pointer;font-weight:950;}
    .qChoice.correct{border-color:color-mix(in srgb, var(--ok) 70%, var(--border));background:color-mix(in srgb, var(--ok) 12%, var(--card));}
    .qChoice.wrong{border-color:color-mix(in srgb, var(--danger) 70%, var(--border));background:color-mix(in srgb, var(--danger) 10%, var(--card));}
  </style>
</head>

<body>
<header>
  <div class="brand"><div class="logo"></div><div>LingoMaster</div></div>
  <div style="display:flex; gap:10px;">
    <button class="iconBtn" id="btnTheme">üé®</button>
    <button class="iconBtn" id="btnSettings">‚öôÔ∏è</button>
  </div>
</header>

<div id="viewport">
  <section class="view active" id="home">
    <div class="secTitle">Genel Bakƒ±≈ü</div>
    <div class="row">
      <div class="card" style="flex:1;">
        <div class="muted" style="font-weight:980;">Toplam Kart</div>
        <div class="big" id="dashTotal">0</div>
      </div>
      <div class="card" style="flex:1; border-color:color-mix(in srgb, var(--warn) 45%, var(--border));">
        <div style="font-weight:980; color:var(--warn);">Tekrar (Due)</div>
        <div class="big" style="color:var(--warn);" id="dashDue">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="font-weight:980;">Hƒ±zlƒ± ƒ∞≈ülemler</div>
      <div class="two" style="margin-top:12px;">
        <button class="btn btnPrimary btnHalf" onclick="go('review')">üß† Tekrar</button>
        <button class="btn btnSoft btnHalf" onclick="go('cards')">üóÇÔ∏è Kartlar</button>
      </div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="openManualAdd()">‚ûï Elle Kelime Ekle</button>
        <button class="btn btnSoft btnHalf" onclick="resetTodaysQueue()">üîÅ Kuyruƒüu Yenile</button>
      </div>
      <div class="smallInfo" style="margin-top:10px;">
        Elle kelime girince uygulama online olarak: <b>anlam + t√ºr + √∂rnek c√ºmle</b> doldurur.
        <br/>Kƒ±sayol: <span class="kbd">Enter</span> doldur ‚Ä¢ <span class="kbd">ESC</span> kapat
      </div>
    </div>
  </section>

  <section class="view" id="review">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 class="h2">Tekrar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="startReviewQuiz()">Ba≈ülat</button>
    </div>

    <div class="card">
      <div style="font-weight:980;">Bug√ºn tekrar edilecek kartlar</div>
      <div class="smallInfo">Due olan kartlar √∂ncelikli gelir. Due yoksa rastgele pratik a√ßƒ±lƒ±r.</div>

      <div style="display:flex; gap:10px; margin-top:12px;">
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Due</div>
          <div class="big" id="rvDue">0</div>
        </div>
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Toplam</div>
          <div class="big" id="rvTotal">0</div>
        </div>
      </div>

      <div class="two" style="margin-top:12px;">
        <button class="btn btnOk btnHalf" onclick="startReviewQuiz()">üéØ Quiz Ba≈ülat</button>
        <button class="btn btnSoft btnHalf" onclick="toggleQuizMode()">Mod: <span id="quizModeLabel">Se√ßmeli</span></button>
      </div>

      <div class="divider"></div>

      <div class="two">
        <button class="btn btnSoft btnHalf" onclick="clearProgress()">‚ôªÔ∏è SRS Sƒ±fƒ±rla</button>
        <button class="btn btnSoft btnHalf" onclick="toast('Online AutoFill aktif ‚úÖ')">Durum</button>
      </div>
    </div>
  </section>

  <section class="view" id="cards">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 class="h2">Kartlar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="openManualAdd()">‚ûï Ekle</button>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <input id="search" placeholder="Kart ara (kelime/anlam/t√ºr)..." />
      <div class="smallInfo" style="margin-top:8px;">Kartƒ± a√ß ‚Üí d√ºzenle / sil.</div>
    </div>

    <div id="cardsList"></div>
  </section>
</div>

<nav>
  <button class="navBtn active" id="navHome" onclick="go('home')"><div class="ico">üè†</div><span>Ana Sayfa</span></button>
  <button class="navBtn" id="navReview" onclick="go('review')"><div class="ico">üß†</div><span>Tekrar</span></button>
  <button class="navBtn" id="navCards" onclick="go('cards')"><div class="ico">üóÇÔ∏è</div><span>Kartlar</span></button>
</nav>

<div class="backdrop" id="backdrop" onclick="closeSheets()"></div>
<div class="toast" id="toast">‚Äî</div>

<!-- Manual Add -->
<div class="sheet" id="manualAddSheet">
  <div class="handle"></div>
  <h2 class="h2">Elle Kelime Ekle (Online Otomatik)</h2>

  <div class="field">
    <label>Dil</label>
    <select id="maLang">
      <option value="EN">ƒ∞ngilizce</option>
      <option value="RU">Rus√ßa</option>
      <option value="DE">Almanca</option>
      <option value="ES">ƒ∞spanyolca</option> <option value="FR">Fransƒ±zca</option>
      <option value="TR">T√ºrk√ße</option>
    </select>
  </div>
  <div class="field">
    <label>Kelime / Terim</label>
    <input id="maTerm" placeholder="√ñrn: reinforcement" />
    <div class="smallInfo" id="maHint">Yazƒ±nca otomatik doldurur. ƒ∞nternet ≈üart.</div>
  </div>

  <div class="field">
    <label>Anlamƒ± (TR)</label>
    <input id="maMeaning" placeholder="Otomatik dolacak" />
  </div>

  <div class="field">
    <label>T√ºr</label>
    <select id="maType">
      <option value="word">Kelime</option>
      <option value="phrase">Kalƒ±p</option>
      <option value="idiom">Deyim</option>
      <option value="phrasal">Phrasal Verb</option>
      <option value="noun">ƒ∞sim</option>
      <option value="verb">Fiil</option>
      <option value="adj">Sƒ±fat</option>
      <option value="adv">Zarf</option>
    </select>
  </div>

  <div class="field">
    <label>√ñrnek C√ºmle</label>
    <textarea id="maExample" placeholder="Otomatik dolacak"></textarea>
  </div>

  <div class="field">
    <label>Not (opsiyonel)</label>
    <input id="maNote" placeholder="ƒ∞pucu/Not" />
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="closeSheets()">Vazge√ß</button>
    <button class="btn btnSoft btnHalf" onclick="autoFillManualFields(true)">‚ö° Doldur</button>
  </div>
  <div class="two" style="margin-top:10px;">
    <button class="btn btnPrimary btnHalf" onclick="saveManualCard()">Kaydet</button>
    <button class="btn btnDanger btnHalf" onclick="clearManual()">Temizle</button>
  </div>
</div>

<!-- Settings -->
<div class="sheet" id="settingsSheet">
  <div class="handle"></div>
  <h2 class="h2">Ayarlar</h2>

  <div class="card" style="margin-top:10px;">
    <div style="font-weight:980;">Tema</div>
    <div class="two" style="margin-top:10px;">
      <select id="themeSelect" onchange="applyThemeFromSelect()">
        <option value="dark">dark</option>
        <option value="light">light</option>
        <option value="ocean">ocean</option>
        <option value="emerald">emerald</option>
        <option value="sunset">sunset</option>
        <option value="rose">rose</option>
      </select>
      <button class="btn btnSoft" style="padding:12px 12px;" onclick="document.getElementById('btnTheme').click()">D√∂nd√ºr</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Quiz Modu</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="toggleQuizMode()">Mod: <span id="quizModeLabel2">Se√ßmeli</span></button>
      <button class="btn btnSoft btnHalf" onclick="exportAll()">Export</button>
    </div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="importAllPrompt()">Import</button>
      <button class="btn btnDanger btnHalf" onclick="hardReset()">Sƒ±fƒ±rla</button>
    </div>
  </div>

  <div class="smallInfo" style="margin-top:12px;">S√ºr√ºm: online-autofill ‚Ä¢ dictionary + translate ‚Ä¢ no level/category</div>
</div>

<!-- Quiz overlay -->
<div class="overlay" id="quizOverlay">
  <div class="overlayTop">
    <div style="font-weight:980;">Quiz</div>
    <button class="iconBtn" onclick="stopQuiz()">√ó</button>
  </div>
  <div id="quizBody" style="padding:18px;">
    <div class="card" style="padding:12px;">
      <div class="smallInfo">Kalan: <b id="qRemain">0</b>/<b id="qTotal">0</b> ‚Ä¢ ‚úÖ <b id="qCorrect">0</b> ‚Ä¢ ‚ùå <b id="qWrong">0</b></div>
      <div style="margin-top:10px; font-size:40px; font-weight:1000; text-align:center;" id="qWord">‚Äî</div>
      <div class="smallInfo" style="text-align:center; margin-top:8px;" id="qMeta">‚Äî</div>
    </div>

    <div id="qChoices" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>

    <div id="qTyping" style="margin-top:12px; display:none; gap:10px;">
      <input id="qInput" placeholder="Anlamƒ±nƒ± yaz..." style="flex:1; font-weight:950;" />
      <button class="btn btnPrimary" style="padding:12px 14px;" onclick="checkTypingAnswer()">Kontrol</button>
    </div>

    <div class="smallInfo" id="qReveal" style="text-align:center; margin-top:10px; min-height:18px;"></div>

    <div class="two" style="margin-top:12px;">
      <button class="btn btnSoft btnHalf" onclick="speakQuizWord()">üîä Oku</button>
      <button class="btn btnSoft btnHalf" onclick="skipQuestion()">‚è≠Ô∏è Ge√ß</button>
    </div>

    <div class="smallInfo" style="text-align:center; margin-top:10px;">
      <span class="kbd">Enter</span> kontrol (yazmalƒ±) ‚Ä¢ <span class="kbd">Esc</span> √ßƒ±kƒ±≈ü
    </div>
  </div>
</div>

<script>
/* ===========================
   Storage + helpers
=========================== */
const DB = {
  get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
  set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}
function now(){ return Date.now(); }
function norm(s){ return (s||"").toLowerCase().trim(); }
function uid(){ return "c_" + Math.random().toString(36).slice(2) + "_" + Math.random().toString(36).slice(2); }
function safeText(s){ return (s ?? "").toString(); }

/* ===========================
   State
=========================== */
const themes=["dark","light","ocean","emerald","sunset","rose"];
const state = {
  settings: DB.get("lm_settings", { theme:"dark", quizMode:"choice" }), // choice|typing
  cards: DB.get("lm_cards", []),
  txCache: DB.get("lm_tx_cache", {}),        // cache for translations
  dictCache: DB.get("lm_dict_cache", {}),    // cache for dictionary results (EN)
  reviewQueue: DB.get("lm_review_queue", [])
};
function saveAll(){
  DB.set("lm_settings", state.settings);
  DB.set("lm_cards", state.cards);
  DB.set("lm_tx_cache", state.txCache);
  DB.set("lm_dict_cache", state.dictCache);
  DB.set("lm_review_queue", state.reviewQueue);
}

/* ===========================
   Theme
=========================== */
function setTheme(name){
  document.documentElement.setAttribute("data-theme", name);
  state.settings.theme = name;
  DB.set("lm_settings", state.settings);
  const meta=document.getElementById("meta-theme");
  meta.setAttribute("content", getComputedStyle(document.documentElement).getPropertyValue("--bg").trim() || "#0b1220");
  const sel=document.getElementById("themeSelect"); if(sel) sel.value=name;
}
function applyThemeFromSelect(){ setTheme(document.getElementById("themeSelect").value); toast("Tema g√ºncellendi"); }
document.getElementById("btnTheme").onclick=()=>{
  const idx=(themes.indexOf(state.settings.theme)+1)%themes.length;
  setTheme(themes[idx]); toast("Tema: " + themes[idx]);
};
document.getElementById("btnSettings").onclick=()=>{
  document.getElementById("themeSelect").value = state.settings.theme;
  syncQuizModeLabels();
  openSheet("settingsSheet");
};

/* ===========================
   Router
=========================== */
function go(id){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
  if(id==="home") document.getElementById("navHome").classList.add("active");
  if(id==="review") document.getElementById("navReview").classList.add("active");
  if(id==="cards") document.getElementById("navCards").classList.add("active");
  if(id==="home") renderDash();
  if(id==="review") renderReview();
  if(id==="cards") renderCards();
}

/* ===========================
   Sheets
=========================== */
const backdrop=document.getElementById("backdrop");
function openSheet(id){ backdrop.classList.add("open"); document.getElementById(id).classList.add("open"); }
function closeSheets(){ backdrop.classList.remove("open"); document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open")); }
window.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    if(document.getElementById("quizOverlay").classList.contains("open")) stopQuiz();
    else closeSheets();
  }
});

/* ===========================
   ONLINE: Translate (meaning TR)
   - uses Google translate gtx (works in browser)
=========================== */
async function translateToTR(lang, term){
  const key=`${lang}|${norm(term)}`;
  if(state.txCache[key]) return state.txCache[key];

  // ƒ∞spanyolca (ES: 'es') eklendi
const sl = ({EN:"en", RU:"ru", DE:"de", FR:"fr", ES:"es", TR:"tr"})[lang] || "auto";
  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=tr&dt=t&q=${encodeURIComponent(term)}`;

  try{
    const r=await fetch(url);
    if(!r.ok) throw new Error("translate_failed");
    const data=await r.json();
    const out=(data?.[0]?.[0]?.[0] || "").trim();
    if(out){
      state.txCache[key]=out;
      DB.set("lm_tx_cache", state.txCache);
      return out;
    }
  }catch(e){
    return "";
  }
  return "";
}

/* ===========================
   ONLINE: Dictionary (EN only)
   - dictionaryapi.dev returns meanings/partOfSpeech/examples
=========================== */
function mapPosToType(pos){
  const p=(pos||"").toLowerCase();
  if(p==="noun") return "noun";
  if(p==="verb") return "verb";
  if(p==="adjective") return "adj";
  if(p==="adverb") return "adv";
  if(p==="phrasal verb") return "phrasal";
  if(p==="idiom") return "idiom";
  return "word";
}

async function lookupEN(term){
  const k = norm(term);
  if(!k) return null;
  if(state.dictCache[k]) return state.dictCache[k];

  const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(k)}`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error("dict_fail");
    const data = await r.json();

    // pick first meaning/definition/example
    let pos="", def="", ex="";
    const meanings = data?.[0]?.meanings || [];
    for(const m of meanings){
      if(!pos && m.partOfSpeech) pos = m.partOfSpeech;
      const defs = m.definitions || [];
      for(const d of defs){
        if(!def && d.definition) def = d.definition;
        if(!ex && d.example) ex = d.example;
        if(def && ex) break;
      }
      if(def && ex) break;
    }

    const result = {
      pos: pos || "",
      type: mapPosToType(pos),
      definitionEN: def || "",
      exampleEN: ex || ""
    };
    state.dictCache[k] = result;
    DB.set("lm_dict_cache", state.dictCache);
    return result;
  }catch(e){
    return null;
  }
}

/* ===========================
   Example generator (fallback)
=========================== */
function genExample(term, lang, type){
  const t = term.trim();
  if(!t) return "";
  if(lang==="EN"){
    if(type==="verb") return `Workers ${t} the elements according to the drawing.`;
    if(type==="noun") return `The ${t} was checked during inspection.`;
    if(type==="adj") return `The structure remained ${t} under the design load.`;
    if(type==="adv") return `The crew worked ${t} to finish before sunset.`;
    if(type==="phrase") return `We reviewed "${t}" before starting the work.`;
    return `We used "${t}" in the daily site report.`;
  }
  return `(${lang}) ${t} ‚Äî √∂rnek c√ºmle (istersen d√ºzenle).`;
}

function inferTypeBasic(term){
  if(term.includes(" ")) return "phrase";
  return "word";
}

/* ===========================
   SRS (SM-2 style)
=========================== */
function srsCalc(card, quality){
  let s = card.srs || { interval:0, reps:0, ef:2.5 };
  let { interval, reps, ef } = s;

  if(quality >= 3){
    if(reps === 0) interval = 1;
    else if(reps === 1) interval = 6;
    else interval = Math.round(interval * ef);
    reps++;
    ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
    if(ef < 1.3) ef = 1.3;
  }else{
    reps = 0;
    interval = 1;
  }
  return { due: now() + interval*24*60*60*1000, srs:{interval,reps,ef} };
}

/* ===========================
   Dash + Review
=========================== */
function renderDash(){
  document.getElementById("dashTotal").textContent = state.cards.length;
  document.getElementById("dashDue").textContent = state.cards.filter(c => (c.due||0) <= now()).length;
}
function getDueCards(){ return state.cards.filter(c => (c.due||0) <= now()); }
function renderReview(){
  document.getElementById("rvTotal").textContent = state.cards.length;
  document.getElementById("rvDue").textContent = getDueCards().length;
  syncQuizModeLabels();
}
function resetTodaysQueue(){
  const due = getDueCards();
  let q=[];
  if(due.length) q = due.map(c=>c.id);
  else q = [...state.cards].sort(()=>Math.random()-0.5).slice(0, Math.min(30, state.cards.length)).map(c=>c.id);
  state.reviewQueue=q;
  DB.set("lm_review_queue", state.reviewQueue);
  toast("Kuyruk yenilendi ‚úÖ");
  renderReview();
}
function clearProgress(){
  if(!confirm("SRS sƒ±fƒ±rlansƒ±n mƒ±? (Kartlar silinmez)")) return;
  state.cards = state.cards.map(c=>({...c,due:now(),srs:{interval:0,reps:0,ef:2.5},updatedAt:now()}));
  DB.set("lm_cards", state.cards);
  toast("SRS sƒ±fƒ±rlandƒ± ‚úÖ");
  renderDash(); renderReview(); renderCards();
}

/* ===========================
   Cards list
=========================== */
document.getElementById("search").addEventListener("input", renderCards);
function renderCards(){
  const q = norm(document.getElementById("search").value);
  const list = document.getElementById("cardsList");
  list.innerHTML="";

  const items = state.cards
    .filter(c=>{
      if(!q) return true;
      return norm(c.term).includes(q) || norm(c.meaning).includes(q) || norm(c.type).includes(q);
    })
    .sort((a,b)=> (a.term||"").localeCompare((b.term||""), "en"));

  if(!items.length){
    const e=document.createElement("div");
    e.className="card";
    e.innerHTML=`<div style="font-weight:980;">Hen√ºz kart yok</div><div class="smallInfo">‚ûï Elle Kelime Ekle ile ba≈üla.</div>`;
    list.appendChild(e);
    return;
  }

  items.forEach(c=>{
    const isDue=(c.due||0) <= now();
    const el=document.createElement("div");
    el.className="card";
    el.style.marginTop="12px";
    el.innerHTML=`
      <div class="cardLine">
        <div class="termBig">${safeText(c.term)}</div>
        <div class="badge ${isDue?'due':''}">${isDue?'DUE':'OK'}</div>
      </div>
      <div class="smallInfo">${safeText(c.lang)} ‚Ä¢ ${safeText(c.meaning)}</div>
      <div class="smallInfo" style="margin-top:6px;">T√ºr: ${safeText(c.type||'-')}</div>
      <div class="smallInfo" style="margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        ${safeText(c.example||'')}
      </div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" data-edit="${c.id}">D√ºzenle</button>
        <button class="btn btnDanger btnHalf" data-del="${c.id}">Sil</button>
      </div>
    `;
    el.querySelector(`[data-edit="${c.id}"]`).onclick=()=>openEditPrompt(c.id);
    el.querySelector(`[data-del="${c.id}"]`).onclick=()=>deleteCard(c.id);
    list.appendChild(el);
  });
}

/* ===========================
   Manual Add (ONLINE AUTOFILL)
=========================== */
let autoTimer=null;
function openManualAdd(){
  clearManual();
  openSheet("manualAddSheet");
}
function clearManual(){
  document.getElementById("maLang").value="EN";
  document.getElementById("maTerm").value="";
  document.getElementById("maMeaning").value="";
  document.getElementById("maType").value="word";
  document.getElementById("maExample").value="";
  document.getElementById("maNote").value="";
  document.getElementById("maHint").textContent="Yazƒ±nca otomatik doldurur. ƒ∞nternet ≈üart.";
}
document.getElementById("maTerm").addEventListener("input", ()=>{
  clearTimeout(autoTimer);
  autoTimer=setTimeout(()=>autoFillManualFields(false), 450);
});
document.getElementById("maLang").addEventListener("change", ()=>{
  clearTimeout(autoTimer);
  autoTimer=setTimeout(()=>autoFillManualFields(false), 250);
});
document.getElementById("maTerm").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    autoFillManualFields(true);
  }
});

async function autoFillManualFields(force){
  const lang=document.getElementById("maLang").value;
  const term=document.getElementById("maTerm").value.trim();
  if(!term) return;

  document.getElementById("maHint").textContent="Dolduruluyor‚Ä¶";

  // TYPE + EXAMPLE (try dictionary for EN)
  let type = document.getElementById("maType").value;
  let example = document.getElementById("maExample").value.trim();
  let meaning = document.getElementById("maMeaning").value.trim();

  // EN dictionary
  if(lang==="EN"){
    const dict = await lookupEN(term);
    if(dict){
      if((!type || type==="word" || force) && dict.type) type = dict.type;
      // Prefer dictionary example
      if((!example || force) && dict.exampleEN) example = dict.exampleEN;
      // If no example in dict, generate
      if((!example || force) && !dict.exampleEN) example = genExample(term, lang, type);
    }else{
      if((!type || type==="word") && (force || !type)) type = inferTypeBasic(term);
      if((!example || force) && !example) example = genExample(term, lang, type);
    }
  }else{
    // non-EN: basic type + template example
    if((!type || type==="word" || force)) type = inferTypeBasic(term);
    if((!example || force)) example = genExample(term, lang, type);
  }

  // MEANING: always translate to TR
  if((!meaning || force)){
    const tr = await translateToTR(lang, term);
    if(tr) meaning = tr;
  }

  document.getElementById("maType").value = type || "word";
  document.getElementById("maExample").value = example || "";
  document.getElementById("maMeaning").value = meaning || "";

  if(!meaning){
    document.getElementById("maHint").textContent="Anlam alƒ±namadƒ± (internet/translate engeli olabilir).";
  }else{
    document.getElementById("maHint").textContent="Otomatik dolduruldu ‚úÖ (istersen d√ºzenle)";
  }
}

function saveManualCard(){
  const lang=document.getElementById("maLang").value;
  const term=document.getElementById("maTerm").value.trim();
  const meaning=document.getElementById("maMeaning").value.trim();
  const type=document.getElementById("maType").value;
  const example=document.getElementById("maExample").value.trim();
  const note=document.getElementById("maNote").value.trim();

  if(!term) return toast("Kelime bo≈ü olamaz.");
  if(!meaning) return toast("Anlam bo≈ü olamaz (doldur/manuel gir).");

  const dupe = state.cards.find(c => norm(c.term)===norm(term) && (c.lang||"EN")===lang);
  if(dupe){
    if(confirm("Bu kelime zaten var. G√ºncellensin mi?")){
      dupe.meaning=meaning;
      dupe.type=type;
      dupe.example=example;
      dupe.note=note;
      dupe.updatedAt=now();
      DB.set("lm_cards", state.cards);
      toast("G√ºncellendi ‚úÖ");
      closeSheets(); renderDash(); renderReview(); renderCards();
    }
    return;
  }

  state.cards.push({
    id:uid(),
    lang, term, meaning, type, example, note,
    due: now(),
    srs:{interval:0,reps:0,ef:2.5},
    createdAt: now(),
    updatedAt: now()
  });
  DB.set("lm_cards", state.cards);
  toast("Eklendi ‚úÖ");
  closeSheets(); renderDash(); renderReview(); renderCards();
}

function deleteCard(id){
  if(!confirm("Silinsin mi?")) return;
  state.cards = state.cards.filter(c=>c.id!==id);
  DB.set("lm_cards", state.cards);
  state.reviewQueue = (state.reviewQueue||[]).filter(x=>x!==id);
  DB.set("lm_review_queue", state.reviewQueue);
  toast("Silindi");
  renderDash(); renderReview(); renderCards();
}

/* Simple edit prompt (keep UI minimal) */
function openEditPrompt(id){
  const c = state.cards.find(x=>x.id===id);
  if(!c) return;
  const newMeaning = prompt("Anlam (TR):", c.meaning || "");
  if(newMeaning===null) return;
  const newType = prompt("T√ºr (noun/verb/adj/adv/phrase/word‚Ä¶):", c.type || "word");
  if(newType===null) return;
  const newExample = prompt("√ñrnek c√ºmle:", c.example || "");
  if(newExample===null) return;

  c.meaning = newMeaning.trim();
  c.type = (newType||"word").trim();
  c.example = (newExample||"").trim();
  c.updatedAt = now();
  DB.set("lm_cards", state.cards);
  toast("G√ºncellendi ‚úÖ");
  renderCards();
}

/* ===========================
   Quiz
=========================== */
function getQuizMode(){ return state.settings.quizMode || "choice"; }
function syncQuizModeLabels(){
  const label=(getQuizMode()==="typing")?"Yazmalƒ±":"Se√ßmeli";
  document.getElementById("quizModeLabel").textContent=label;
  document.getElementById("quizModeLabel2").textContent=label;
}
function toggleQuizMode(){
  state.settings.quizMode = (getQuizMode()==="choice") ? "typing" : "choice";
  DB.set("lm_settings", state.settings);
  syncQuizModeLabels();
  toast("Quiz modu: " + ((getQuizMode()==="typing")?"Yazmalƒ±":"Se√ßmeli"));
}
let quizCurrent=null;
let correctCount=0, wrongCount=0;
function startReviewQuiz(){
  if(!state.cards.length) return toast("Kart yok.");
  if(!state.reviewQueue || !state.reviewQueue.length) resetTodaysQueue();
  correctCount=0; wrongCount=0;
  document.getElementById("qCorrect").textContent="0";
  document.getElementById("qWrong").textContent="0";
  document.getElementById("qTotal").textContent=String(state.reviewQueue.length);
  openQuizOverlay();
  nextQuiz();
}
function openQuizOverlay(){
  document.getElementById("quizOverlay").classList.add("open");
  document.getElementById("qInput").onkeydown=(e)=>{
    if(e.key==="Enter"){ e.preventDefault(); checkTypingAnswer(); }
  };
}
function stopQuiz(){
  document.getElementById("quizOverlay").classList.remove("open");
  quizCurrent=null;
  renderDash(); renderReview();
}
function updateQuizRemain(){
  document.getElementById("qRemain").textContent=String(state.reviewQueue.length);
}
function nextQuiz(){
  if(!state.reviewQueue.length){
    toast("Quiz bitti ‚úÖ");
    stopQuiz();
    return;
  }
  updateQuizRemain();
  const id = state.reviewQueue.shift();
  DB.set("lm_review_queue", state.reviewQueue);
  const card = state.cards.find(c=>c.id===id);
  if(!card) return nextQuiz();

  quizCurrent = card;
  document.getElementById("qWord").textContent=card.term;
  document.getElementById("qMeta").textContent=`${card.lang} ‚Ä¢ ${card.type || 'word'}`;
  document.getElementById("qReveal").textContent="";

  const mode=getQuizMode();
  const choicesBox=document.getElementById("qChoices");
  const typingBox=document.getElementById("qTyping");
  const input=document.getElementById("qInput");
  choicesBox.innerHTML="";

  if(mode==="typing"){
    typingBox.style.display="flex";
    choicesBox.style.display="none";
    input.value="";
    setTimeout(()=>input.focus(), 50);
  }else{
    typingBox.style.display="none";
    choicesBox.style.display="flex";
    const distractors = state.cards.filter(c=>c.id!==card.id).sort(()=>Math.random()-0.5).slice(0,3).map(x=>x.meaning);
    const options = [...distractors, card.meaning].sort(()=>Math.random()-0.5);
    const correctIndex = options.indexOf(card.meaning);

    options.forEach((opt, idx)=>{
      const b=document.createElement("button");
      b.className="qChoice";
      b.textContent=opt;
      b.onclick=()=>{
        document.querySelectorAll(".qChoice").forEach(x=>x.disabled=true);
        if(idx===correctIndex){
          b.classList.add("correct");
          grade(card, 4, true);
        }else{
          b.classList.add("wrong");
          document.querySelectorAll(".qChoice")[correctIndex]?.classList.add("correct");
          grade(card, 2, false);
        }
      };
      choicesBox.appendChild(b);
    });
  }
}
function normalizeAnswer(a){
  return norm(a).replace(/[.,!?;:"(){}\[\]<>]/g,"").replace(/\s+/g," ").trim();
}
function checkTypingAnswer(){
  if(!quizCurrent) return;
  const typed = normalizeAnswer(document.getElementById("qInput").value);
  if(!typed) return toast("Cevap yaz.");
  const correct = normalizeAnswer(quizCurrent.meaning);
  const ok = (typed===correct) || (correct.includes(typed) && typed.length >= Math.min(6, correct.length));
  if(ok){
    document.getElementById("qReveal").textContent="‚úÖ Doƒüru";
    grade(quizCurrent, 4, true);
  }else{
    document.getElementById("qReveal").textContent=`‚ùå Doƒüru: ${quizCurrent.meaning}`;
    grade(quizCurrent, 2, false);
  }
}
function grade(card, quality, isCorrect){
  if(isCorrect){ correctCount++; document.getElementById("qCorrect").textContent=String(correctCount); }
  else{ wrongCount++; document.getElementById("qWrong").textContent=String(wrongCount); }

  const upd = srsCalc(card, quality);
  card.due = upd.due;
  card.srs = upd.srs;
  card.updatedAt = now();
  DB.set("lm_cards", state.cards);

  setTimeout(()=>{ quizCurrent=null; nextQuiz(); }, 550);
}
function skipQuestion(){
  if(!quizCurrent) return;
  state.reviewQueue.push(quizCurrent.id);
  DB.set("lm_review_queue", state.reviewQueue);
  toast("Soru sona atƒ±ldƒ±");
  quizCurrent=null;
  nextQuiz();
}

/* Speak */
function speakText(txt, lang){
  const u=new SpeechSynthesisUtterance(txt);
  // ƒ∞spanyolca (ES: 'es-ES') eklendi
const map={EN:"en-US", RU:"ru-RU", DE:"de-DE", FR:"fr-FR", ES:"es-ES", TR:"tr-TR"};
  u.lang=map[lang] || "en-US";
  u.rate=0.9;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function speakQuizWord(){
  if(!quizCurrent) return;
  speakText(quizCurrent.term, quizCurrent.lang || "EN");
}

/* ===========================
   Export/Import/Reset
=========================== */
function exportAll(){
  const data = JSON.stringify({ settings:state.settings, cards:state.cards }, null, 2);
  prompt("Kopyala (Export JSON):", data);
}
function importAllPrompt(){
  const txt = prompt("Import JSON yapƒ±≈ütƒ±r:");
  if(!txt) return;
  try{
    const obj=JSON.parse(txt);
    if(obj.settings) state.settings=obj.settings;
    if(obj.cards) state.cards=obj.cards;
    saveAll();
    setTheme(state.settings.theme || "dark");
    syncQuizModeLabels();
    toast("Import ‚úÖ");
    renderDash(); renderReview(); renderCards();
  }catch(e){
    toast("Import hata");
  }
}
function hardReset(){
  if(!confirm("Her ≈üeyi sƒ±fƒ±rlamak istiyor musun?")) return;
  localStorage.clear();
  location.reload();
}

/* ===========================
   Init
=========================== */
setTheme(state.settings.theme || "dark");
syncQuizModeLabels();
renderDash(); renderReview(); renderCards();
if(!state.reviewQueue) state.reviewQueue=[];
</script>
</body>
</html>
