<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LingoMaster</title>
  <meta name="theme-color" content="#0b1220" id="meta-theme">
  <link rel="icon" href="data:,">

  <style>
    /* ... (styles remain unchanged) ... */
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>LingoMaster</div>
  </div>
  <div style="display:flex; gap:10px; align-items:center;">
    <button class="iconBtn" id="btnTheme" title="Tema">ğŸ¨</button>
    <button class="iconBtn" id="btnSettings" title="Ayarlar">âš™ï¸</button>
  </div>
</header>

<div id="viewport">

  <!-- HOME -->
  <section class="view active" id="home">
    <div class="secTitle">Genel BakÄ±ÅŸ</div>

    <div class="row">
      <div class="card" style="flex:1;">
        <div class="muted" style="font-weight:980;">Toplam Kart</div>
        <div class="big" id="dashTotal">0</div>
      </div>
      <div class="card" style="flex:1; border-color:color-mix(in srgb, var(--warn) 45%, var(--border));">
        <div style="font-weight:980; color:var(--warn);">Tekrar (Due)</div>
        <div class="big" style="color:var(--warn);" id="dashDue">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:18px; font-weight:980;">Ã‡alÄ±ÅŸma Zinciri</div>
        <div style="font-weight:980; color:var(--primary);" id="dashStreak">0 GÃ¼n</div>
      </div>
      <div class="muted" style="margin-top:10px; font-weight:950;">
        Son 7 gÃ¼n toplam: <span id="dashWeek">0</span>
      </div>
    </div>

    <div class="secTitle" style="margin-top:16px;">HÄ±zlÄ± Ä°ÅŸlemler</div>

    <button class="btn btnPrimary" style="width:100%; font-size:16px;" onclick="go('review')">ğŸ§  BugÃ¼nkÃ¼ Tekrarlar</button>

    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="go('library')">ğŸ“š Kitap Okumaya Devam Et</button>
      <button class="btn btnSoft btnHalf" onclick="go('cards')">ğŸ—‚ï¸ Kartlar</button>
    </div>

    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="openManualAdd()">â• Elle Kelime Ekle</button>
      <button class="btn btnSoft btnHalf" onclick="go('depot')">ğŸ§¾ Kelime Deposu</button>
    </div>
  </section>

  <!-- REVIEW / TEKRAR -->
  <section class="view" id="review">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">Tekrar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="startReviewQuiz()">BaÅŸlat</button>
    </div>

    <div class="card">
      <div style="font-weight:980; font-size:16px;">BugÃ¼n tekrar edilecek kartlar</div>
      <div class="smallInfo">Due olan kartlar Ã¶ncelikli gelir. Kart yoksa rastgele pratik aÃ§Ä±lÄ±r.</div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Due</div>
          <div class="big" id="rvDue">0</div>
        </div>
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Toplam</div>
          <div class="big" id="rvTotal">0</div>
        </div>
      </div>

      <div class="two" style="margin-top:12px;">
        <button class="btn btnOk btnHalf" onclick="startReviewQuiz()">ğŸ¯ Quiz BaÅŸlat</button>
        <button class="btn btnSoft btnHalf" onclick="resetTodaysQueue()">ğŸ” KuyruÄŸu Yenile</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="font-weight:980;">Tekrar AyarlarÄ±</div>
      <div class="smallInfo">SRS (aralÄ±klÄ± tekrar) aktif. YanÄ±tÄ±na gÃ¶re kartÄ±n tekrar tarihi otomatik gÃ¼ncellenir.</div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="toast('SRS aktif âœ…')">SRS Durumu</button>
        <button class="btn btnSoft btnHalf" onclick="clearProgress()">Ä°lerlemeyi SÄ±fÄ±rla</button>
      </div>
    </div>
  </section>

  <!-- LIBRARY -->
  <section class="view" id="library">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">KÃ¼tÃ¼phane</h2>
      <div style="display:flex; gap:10px;">
        <button class="iconBtn" onclick="openAddBook()" title="Metin ekle">â•</button>
      </div>
    </div>
    <div id="libraryList"></div>
  </section>

  <!-- READER -->
  <section class="view" id="reader">
    <div class="readerTop">
      <button class="iconBtn" onclick="go('library')" title="Geri">â†</button>
      <div class="titleWrap">
        <div class="title" id="rTitle">â€”</div>
        <div class="sub" id="rPage">Sayfa 1 / 1</div>
      </div>
      <button class="iconBtn" onclick="toggleFont()" title="YazÄ±">T</button>
    </div>

    <div class="reader" id="readerText"></div>

    <div class="two" style="margin-top:16px;">
      <button class="btn btnSoft btnHalf" onclick="prevPage()">Ã–nceki</button>
      <button class="btn btnSoft btnHalf" onclick="nextPage()">Sonraki</button>
    </div>
  </section>

  <!-- CARDS -->
  <section class="view" id="cards">
    <h2 class="h2">Kartlar</h2>
    <input id="search" placeholder="Kart ara..." />
    <div id="cardsList" style="margin-top:12px;"></div>
  </section>

  <!-- DEPOT / CACHE -->
  <section class="view" id="depot">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">Kelime Deposu</h2>
      <div style="display:flex; gap:10px;">
        <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="exportDepot()">DÄ±ÅŸa Aktar</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:980;">Ã–nbellek + Offline SÃ¶zlÃ¼k</div>
      <div class="smallInfo">Otomatik Ã§evirilen kelimeler cacheâ€™e kaydolur. Buradan arayÄ±p kopyalayabilirsin.</div>
      <div class="two" style="margin-top:10px;">
        <input id="depotSearch" placeholder="Depoda ara (word/meaning)..." />
        <button class="btn btnSoft" style="padding:12px 12px;" onclick="renderDepot()">Ara</button>
      </div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="clearCache()">Cache Temizle</button>
        <button class="btn btnDanger btnHalf" onclick="clearDepotAll()">Hepsini Sil</button>
      </div>
    </div>

    <div id="depotList" style="margin-top:12px;"></div>
  </section>

</div>

<nav>
  <button class="navBtn active" id="navHome" onclick="go('home')">
    <div class="ico">ğŸ </div><span>Ana Sayfa</span>
  </button>
  <button class="navBtn" id="navReview" onclick="go('review')">
    <div class="ico">ğŸ§ </div><span>Tekrar</span>
  </button>
  <button class="navBtn" id="navLibrary" onclick="go('library')">
    <div class="ico">ğŸ“š</div><span>KÃ¼tÃ¼phane</span>
  </button>
  <button class="navBtn" id="navCards" onclick="go('cards')">
    <div class="ico">ğŸ—‚ï¸</div><span>Kartlar</span>
  </button>
</nav>

<div class="backdrop" id="backdrop" onclick="closeSheets()"></div>

<!-- WORD SHEET -->
<div class="sheet" id="wordSheet">
  <div class="handle"></div>

  <div class="sheetHeader">
    <div style="min-width:0;">
      <div class="lang" id="wsLang">EN</div>
      <div class="word" id="wsWord">word</div>
      <div class="smallInfo" id="wsStatus">Yeni kart</div>
      <div class="smallInfo" id="wsSource">Ã‡eviri: â€”</div>
    </div>
    <button class="iconBtn" onclick="speakWord()" title="Oku">ğŸ”Š</button>
  </div>

  <div class="field">
    <label>AnlamÄ± (TR)</label>
    <input id="wsMeaning" placeholder="TÃ¼rkÃ§esi nedir?" />
  </div>

  <div class="field">
    <label>Ã–rnek / BaÄŸlam</label>
    <textarea id="wsContext"></textarea>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="autoTranslate()">Otomatik Ã‡evir</button>
    <button class="btn btnPrimary btnHalf" onclick="saveCard()">Kaydet</button>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="editCard()">DÃ¼zenle</button>
    <button class="btn btnDanger btnHalf" onclick="deleteCard()">Sil</button>
  </div>
</div>

<!-- ADD BOOK SHEET -->
<div class="sheet" id="addBookSheet">
  <div class="handle"></div>
  <h2 class="h2">Yeni Metin Ekle</h2>

  <div class="field">
    <label>BaÅŸlÄ±k</label>
    <input id="bTitle" placeholder="Kitap / Makale BaÅŸlÄ±ÄŸÄ±" />
  </div>

  <div class="field">
    <label>Dil</label>
    <select id="bLang">
      <option value="EN">Ä°ngilizce</option>
      <option value="RU">RusÃ§a</option>
      <option value="DE">Almanca</option>
      <option value="FR">FransÄ±zca</option>
    </select>
  </div>

  <div class="field">
    <label>Ä°Ã§erik</label>
    <textarea id="bText" placeholder="Metni buraya yapÄ±ÅŸtÄ±r..."></textarea>
  </div>

  <button class="btn btnPrimary" style="width:100%;" onclick="saveBook()">KÃ¼tÃ¼phaneye Ekle</button>
</div>

<!-- SETTINGS SHEET -->
<div class="sheet" id="settingsSheet">
  <div class="handle"></div>
  <h2 class="h2">Ayarlar</h2>

  <div class="card" style="margin-top:10px;">
    <div style="font-weight:980;">Tema</div>
    <div class="smallInfo">Tema seÃ§imi burada. Ãœstteki ğŸ¨ butonu da temayÄ± dÃ¶ndÃ¼rÃ¼r.</div>
    <div class="two" style="margin-top:10px;">
      <select id="themeSelect" onchange="applyThemeFromSelect()">
        <option value="dark">dark</option>
        <option value="light">light</option>
        <option value="ocean">ocean</option>
        <option value="emerald">emerald</option>
        <option value="sunset">sunset</option>
        <option value="rose">rose</option>
      </select>
      <button class="btn btnSoft" style="padding:12px 12px;" onclick="document.getElementById('btnTheme').click()">DÃ¶ndÃ¼r</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Okuma YazÄ± Boyutu</div>
    <div class="smallInfo">Reader font bÃ¼yÃ¼klÃ¼ÄŸÃ¼</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="decFont()">-</button>
      <button class="btn btnSoft btnHalf" onclick="incFont()">+</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Veri YÃ¶netimi</div>
    <div class="smallInfo">KartlarÄ±nÄ± ve cacheâ€™i dÄ±ÅŸa aktar / iÃ§e aktar</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="exportAll()">Export</button>
      <button class="btn btnSoft btnHalf" onclick="importAllPrompt()">Import</button>
    </div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="clearCache()">Cache Temizle</button>
      <button class="btn btnDanger btnHalf" onclick="hardReset()">Her Åeyi SÄ±fÄ±rla</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">KÄ±sayollar</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="go('depot'); closeSheets();">Kelime Deposu</button>
      <button class="btn btnSoft btnHalf" onclick="openManualAdd()">Elle Kelime Ekle</button>
    </div>
  </div>

  <div class="smallInfo" style="margin-top:12px;">SÃ¼rÃ¼m: full-single-file + review + depot + settings + manual-add</div>
</div>

<!-- MANUAL ADD SHEET -->
<div class="sheet" id="manualAddSheet">
  <div class="handle"></div>
  <h2 class="h2">Elle Kelime Ekle</h2>

  <div class="field">
    <label>Dil</label>
    <select id="maLang">
      <option value="EN">Ä°ngilizce</option>
      <option value="RU">RusÃ§a</option>
      <option value="DE">Almanca</option>
      <option value="FR">FransÄ±zca</option>
      <option value="TR">TÃ¼rkÃ§e</option>
    </select>
  </div>

  <div class="field">
    <label>Kelime / Terim</label>
    <input id="maTerm" placeholder="Ã–rn: despite" />
  </div>

  <div class="field">
    <label>AnlamÄ± (TR)</label>
    <input id="maMeaning" placeholder="Ã–rn: -e raÄŸmen" />
  </div>

  <div class="two">
    <div style="flex:1;">
      <label>TÃ¼r</label>
      <select id="maType">
        <option value="word">Kelime</option>
        <option value="phrase">KalÄ±p</option>
        <option value="idiom">Deyim</option>
        <option value="phrasal">Phrasal Verb</option>
        <option value="noun">Ä°sim</option>
        <option value="verb">Fiil</option>
        <option value="adj">SÄ±fat</option>
        <option value="adv">Zarf</option>
      </select>
    </div>
    <div style="flex:1;">
      <label>Seviye</label>
      <select id="maLevel">
        <option value="A1">A1</option><option value="A2">A2</option>
        <option value="B1">B1</option><option value="B2">B2</option>
        <option value="C1">C1</option><option value="C2">C2</option>
        <option value="UNK">Bilinmiyor</option>
      </select>
    </div>
  </div>

  <div class="field">
    <label>Kategori</label>
    <input id="maCategory" placeholder="Ã–rn: Travel / Business / Daily" />
  </div>

  <div class="field">
    <label>Ã–rnek CÃ¼mle</label>
    <textarea id="maExample" placeholder="Ã–rn: Despite the rain, we went outside."></textarea>
  </div>

  <div class="field">
    <label>Not</label>
    <input id="maNote" placeholder="Ä°pucu/Not (opsiyonel)" />
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="closeSheets()">VazgeÃ§</button>
    <button class="btn btnPrimary btnHalf" onclick="saveManualCard()">Kaydet</button>
  </div>
</div>

<!-- QUIZ OVERLAY -->
<div class="overlay" id="quizOverlay">

  <!-- ÃœST BAR -->
  <div class="overlayTop">
    <div style="font-weight:980;">Quiz</div>
    <button class="iconBtn" onclick="stopQuiz()">Ã—</button>
  </div>

  <!-- QUIZ BODY (SORULARIN OLDUÄU YER) -->
  <div id="quizBody" style="padding:18px 18px 24px 18px;">

    <!-- ÃœST Ä°STATÄ°STÄ°K + PROGRESS -->
    <div class="qTopStats" style="margin-top:6px;">
      <div class="qPill">Kalan: <span id="qRemain">0</span>/<span id="qTotal">0</span></div>
      <div class="qPill">âœ… <span id="qCorrect">0</span>  âŒ <span id="qWrong">0</span></div>
    </div>
    <div class="qProgOuter">
      <div class="qProgInner" id="qProg"></div>
    </div>

    <!-- META -->
    <div id="qMeta" style="margin-top:12px; opacity:.8; font-weight:900; font-size:12px;">
      â€”
    </div>

    <!-- WORD -->
    <div id="qWord" style="margin-top:14px; font-size:40px; font-weight:1000; text-align:center;">
      â€”
    </div>

    <!-- CHOICES (Ã‡OKTAN SEÃ‡MELÄ°) -->
    <div id="qChoices" style="margin-top:18px; display:flex; flex-direction:column; gap:10px;">
      <!-- JS buraya butonlarÄ± basacak -->
    </div>

    <!-- TYPING MODE -->
    <div class="qInputWrap" id="qTyping" style="display:none">
      <input id="qInput" class="qInput" placeholder="AnlamÄ±nÄ± yaz..." />
      <button class="qCheckBtn" onclick="checkTypingAnswer()">Kontrol</button>
    </div>

    <!-- DOÄRU CEVAP GÃ–STER -->
    <div class="qAnswerReveal" id="qReveal"></div>

    <!-- KOLAY / ORTA / ZOR -->
    <div id="qGrade" style="display:none; margin-top:14px">
      <button class="btn ghost" onclick="gradeAnswer('hard')">Zor</button>
      <button class="btn secondary" onclick="gradeAnswer('medium')">Orta</button>
      <button class="btn primary" onclick="gradeAnswer('easy')">Kolay</button>
    </div>

  </div><!-- /quizBody -->

  <!-- QUIZ SUMMARY (BÄ°TTÄ° EKRANI) -->
  <div id="quizSummary" style="display:none; padding:24px; text-align:center">
    <h2 style="margin-bottom:10px">Quiz Bitti</h2>

    <div style="font-size:14px; font-weight:900; margin-bottom:16px">
      DoÄŸru: <span id="sumCorrect">0</span> |
      YanlÄ±ÅŸ: <span id="sumWrong">0</span> |
      BaÅŸarÄ±: <span id="sumRate">0%</span>
    </div>

    <button class="btn primary" onclick="repeatWrongQuiz()" style="width:100%; margin-bottom:10px">
      YanlÄ±ÅŸlarÄ± Tekrar Sor
    </button>

    <button class="btn ghost" onclick="stopQuiz()" style="width:100%">
      Ã‡Ä±k
    </button>
  </div>

</div><!-- /quizOverlay -->

<script>
  // ---------------- Storage ----------------
  const DB = {
    get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  // ---------------- Toast ----------------
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  // ---------------- State ----------------
  const themes = ["dark","light","ocean","emerald","sunset","rose"];
  const state = {
    settings: DB.get("lm_settings", { theme:"dark", fontSize:19 }),
    cards: DB.get("lm_cards", []),
    books: DB.get("lm_books", []),
    txCache: DB.get("lm_tx_cache", {}),     // online+offline Ã§eviri cache
    depot: DB.get("lm_depot", []),          // kelime deposu (cache + sÃ¶zlÃ¼kten gelen kayÄ±tlar)
    reviewQueue: DB.get("lm_review_queue", []) // bugÃ¼nkÃ¼ quiz kuyruÄŸu
  };

  function saveAllState(){
    DB.set("lm_settings", state.settings);
    DB.set("lm_cards", state.cards);
    DB.set("lm_books", state.books);
    DB.set("lm_tx_cache", state.txCache);
    DB.set("lm_depot", state.depot);
    DB.set("lm_review_queue", state.reviewQueue);
  }

  function setTheme(name){
    document.documentElement.setAttribute("data-theme", name);
    state.settings.theme = name;
    DB.set("lm_settings", state.settings);
    const meta = document.getElementById("meta-theme");
    meta.setAttribute("content", getComputedStyle(document.documentElement).getPropertyValue("--bg").trim() || "#0b1220");
    const sel = document.getElementById("themeSelect");
    if(sel) sel.value = name;
  }

  function applyThemeFromSelect(){
    const v = document.getElementById("themeSelect").value;
    setTheme(v);
    toast("Tema: " + v);
  }

  document.getElementById("btnTheme").onclick = () => {
    const idx = (themes.indexOf(state.settings.theme) + 1) % themes.length;
    setTheme(themes[idx]);
    toast("Tema: " + themes[idx]);
  };

  // âœ… Ayarlar butonu artÄ±k settings sheet aÃ§Ä±yor
  document.getElementById("btnSettings").onclick = () => {
    document.getElementById("themeSelect").value = state.settings.theme;
    openSheet("settingsSheet");
  };

  // ---------------- Router (go) ----------------
  function go(id){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
    if(id==="home") document.getElementById("navHome").classList.add("active");
    if(id==="review") document.getElementById("navReview").classList.add("active");
    if(id==="library" || id==="reader") document.getElementById("navLibrary").classList.add("active");
    if(id==="cards") document.getElementById("navCards").classList.add("active");
    if(id==="depot"){ renderDepot(); }

    if(id === "home") renderDash();
    if(id === "library") renderLibrary();
    if(id === "cards") renderCards();
    if(id === "review") renderReview();
  }

  // ---------------- Demo books (expanded) ----------------
  const BOOKS_SEED = [
    {
      id:"b_holmes",
      title:"Sherlock Holmes (Free)",
      lang:"EN",
      page:0,
      content:
`To Sherlock Holmes she is always THE woman. I have seldom heard him mention her under any other name.

It was not that he felt any emotion akin to love for Irene Adler. All emotions, and that one particularly, were abhorrent to his cold, precise mind.

Holmes remained in our lodgings in Baker Street... (demo)
`
    },
    {
      id:"b_alice",
      title:"Alice in Wonderland (Free)",
      lang:"EN",
      page:0,
      content:
`Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do.

Once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it.

"So she was considering in her own mind..." (demo)
`
    },
    {
      id:"b_pride",
      title:"Pride and Prejudice (Free)",
      lang:"EN",
      page:0,
      content:
`It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife.

However little known the feelings or views of such a man may be on his first entering a neighbourhood... (demo)
`
    },
    {
      id:"b_time",
      title:"The Time Machine (Free)",
      lang:"EN",
      page:0,
      content:
`The Time Traveller (for so it will be convenient to speak of him) was expounding a recondite matter to us. His grey eyes shone and twinkled, and his usually pale face was flushed and animated. 

The fire burned brightly, and the soft radiance of the incandescent lights in the lilies of silver caught the bubbles that flashed and passed in our glasses. 

Our chairs, being his patents, embraced and caressed us rather than submitted to be sat upon... (demo)
`
    },
    {
      id:"b_callwild",
      title:"The Call of the Wild (Free)",
      lang:"EN",
      page:0,
      content:
`Buck did not read the newspapers, or he would have known that trouble was brewing... 

During the four years since his puppyhood he had lived the life of a sated aristocrat... 

But people came from the Klondike, and told how dogs were selling for incredible prices... (demo)
`
    },
    {
      id:"b_jekyll",
      title:"Dr. Jekyll and Mr. Hyde (Free)",
      lang:"EN",
      page:0,
      content:
`Mr. Utterson the lawyer was a man of a rugged countenance that was never lighted by a smile; cold, scanty and embarrassed in discourse... 

"I incline to Cain's heresy," he used to say. "I let my brother go to the devil in his own way." 

In this character, it was frequently his fortune to be the last reputable acquaintance and the last good influence in the lives of down-going men... (demo)
`
    },
    {
      id:"b_stage1_1",
      title:"Little Red Riding Hood (Stage 1)",
      lang:"EN",
      page:0,
      content:
`Once upon a time there was a sweet little girl who lived in a village near the forest. Everyone who saw her liked her, but most of all her grandmother. 

One day her mother said, "Come, Little Red Riding Hood, here is a piece of cake and a bottle of wine. Take them to your grandmother, she is ill and weak." 

Little Red Riding Hood set out immediately... (demo)
`
    },
    {
      id:"b_stage1_2",
      title:"Hansel and Gretel (Stage 1)",
      lang:"EN",
      page:0,
      content:
`Near the edge of a great forest there lived a poor woodcutter with his wife and two children. The boy's name was Hansel and the girl's name was Gretel. 

They had very little to bite or to sup, and once when great dearth fell on the land, the man could no longer procure daily bread. 

One night, the wife said to the woodcutter, "We will take the children out into the thickest part of the forest and leave them there"... (demo)
`
    },
    {
      id:"b_stage1_3",
      title:"The Hare and the Tortoise (Stage 1)",
      lang:"EN",
      page:0,
      content:
`A Hare was making fun of the Tortoise one day for being so slow. 

"Do you ever get anywhere?" he asked with a mocking laugh. 

"Yes," replied the Tortoise, "and I get there sooner than you think. I'll run a race with you." 

The Hare agreed and they started the race... (demo)
`
    },
    {
      id:"b_stage2_1",
      title:"The Monkey's Paw (Stage 2)",
      lang:"EN",
      page:0,
      content:
`Without, the night was cold and wet, but in the small parlour of Laburnam Villa the blinds were drawn and the fire burned brightly. 

Father and son were at chess, the former, who possessed ideas about the game involving radical changes, putting his king into such sharp and unnecessary perils... 

"So, youâ€™ve got the monkeyâ€™s paw?" said Mr. White. "Whatâ€™s so special about it?"... (demo)
`
    },
    {
      id:"b_stage2_2",
      title:"The Gift of the Magi (Stage 2)",
      lang:"EN",
      page:0,
      content:
`One dollar and eighty-seven cents. That was all. 

Della counted it three times. One dollar and eighty-seven cents. And the next day would be Christmas. 

She had saved every penny she could, but it was still only $1.87 to buy a present for Jim... (demo)
`
    },
    {
      id:"b_stage2_3",
      title:"The Tell-Tale Heart (Stage 2)",
      lang:"EN",
      page:0,
      content:
`TRUE! --nervous --very, very dreadfully nervous I had been and am; but why will you say that I am mad? 

The disease had sharpened my senses --not destroyed --not dulled them. Above all was the sense of hearing acute. 

I heard all things in the heaven and in the earth. I heard many things in hell. How, then, am I mad?... (demo)
`
    },
    {
      id:"b_stage3_1",
      title:"Dracula (Stage 3)",
      lang:"EN",
      page:0,
      content:
`3 May. Bistritz. -- Left Munich at 8:35 P.M., on 1st May, arriving at Vienna early next morning... 

Jonathan Harkerâ€™s Journal: 
The impression I had was that we were leaving the West and entering the East... 

The driver suddenly turned down a narrow roadway which seemed to dip into a very dark place... (demo)
`
    },
    {
      id:"b_stage3_2",
      title:"Frankenstein (Stage 3)",
      lang:"EN",
      page:0,
      content:
`You will rejoice to hear that no disaster has accompanied the commencement of an enterprise which you have regarded with such evil forebodings. 

I arrived here yesterday, and my first task is to assure my dear sister of my welfare... 

We have already reached a very high latitude; but the weather is so favorable... (demo)
`
    },
    {
      id:"b_stage3_3",
      title:"The Speckled Band (Stage 3)",
      lang:"EN",
      page:0,
      content:
`On glancing over my notes of the seventy odd cases in which I have during the last eight years studied the methods of my friend Sherlock Holmes, I find many tragic, some comic, and a few merely strange. 

It was early in April in the year '83 that I woke one morning to find Sherlock Holmes standing by my bedside. 

He was a late riser, as a rule, and I had no wish to disturb him, but by the look upon his face I saw that something was amiss... (demo)
`
    },
    {
      id:"b_stage3_4",
      title:"Treasure Island (Stage 3)",
      lang:"EN",
      page:0,
      content:
`Squire Trelawney, Dr. Livesey, and the rest of these gentlemen having asked me to write down the whole particulars about Treasure Island... 

I take up my pen in the year of grace 17__, and go back to the time when my father kept the Admiral Benbow inn... 

I remember him as if it were yesterday, as he came plodding to the inn door, his sea-chest following behind him... (demo)
`
    }
  ];

  function seedBooks(){
    if(state.books.length === 0){
      state.books = [...BOOKS_SEED];
      DB.set("lm_books", state.books);
    }
  }

  // ---------------- Paging ----------------
  let activeBook = null;

  function getPages(text){
    const t = (text || "").replace(/\r\n/g,"\n");
    const size = 1400;
    const pages = [];
    let i=0;
    while(i < t.length){
      let end = Math.min(i + size, t.length);
      if(end < t.length){
        let cut = Math.max(
          t.lastIndexOf(". ", end),
          t.lastIndexOf("! ", end),
          t.lastIndexOf("? ", end),
          t.lastIndexOf("\n", end)
        );
        if(cut < i + Math.floor(size*0.45)){
          const sp = t.lastIndexOf(" ", end);
          if(sp > i) cut = sp;
        }
        if(cut > i) end = cut + 1;
      }
      pages.push(t.slice(i,end).trim());
      i=end;
    }
    return pages.length ? pages : ["(BoÅŸ)"];
  }

  function openBook(id){
    activeBook = state.books.find(b=>b.id===id);
    go("reader");
    renderReader();
  }

  function renderReader(){
    if(!activeBook) return;
    const pages = getPages(activeBook.content);
    if(activeBook.page >= pages.length) activeBook.page = pages.length-1;
    if(activeBook.page < 0) activeBook.page = 0;

    document.getElementById("rTitle").textContent = activeBook.title;
    document.getElementById("rPage").textContent = `Sayfa ${activeBook.page+1} / ${pages.length}`;

    const box = document.getElementById("readerText");
    box.style.fontSize = state.settings.fontSize + "px";
    box.innerHTML = "";

    const text = pages[activeBook.page];
    const parts = text.split(/(\s+)/);

    parts.forEach(ch=>{
      if(ch.trim().length===0){ box.appendChild(document.createTextNode(ch)); return; }
      const clean = ch.replace(/[.,!?;:"()Â«Â»â€”â€“\[\]{}<>]+/g,"").trim();
      if(clean){
        const s = document.createElement("span");
        s.className = "token";
        s.textContent = ch;
        s.onclick = ()=>openWord(clean, activeBook.lang, text);
        box.appendChild(s);
      }else{
        box.appendChild(document.createTextNode(ch));
      }
    });

    DB.set("lm_books", state.books);
  }

  function nextPage(){ if(!activeBook) return; activeBook.page++; renderReader(); }
  function prevPage(){ if(!activeBook) return; activeBook.page--; renderReader(); }
  function toggleFont(){
    state.settings.fontSize = state.settings.fontSize >= 27 ? 17 : state.settings.fontSize + 2;
    DB.set("lm_settings", state.settings);
    renderReader();
  }
  function incFont(){ state.settings.fontSize = Math.min(40, (state.settings.fontSize||19)+1); DB.set("lm_settings", state.settings); toast("Font: "+state.settings.fontSize); if(activeBook) renderReader(); }
  function decFont(){ state.settings.fontSize = Math.max(12, (state.settings.fontSize||19)-1); DB.set("lm_settings", state.settings); toast("Font: "+state.settings.fontSize); if(activeBook) renderReader(); }

  // ---------------- Library ----------------
  function renderLibrary(){
    const wrap = document.getElementById("libraryList");
    wrap.innerHTML = "";
    state.books.forEach(b=>{
      const total = getPages(b.content).length;
      const el = document.createElement("div");
      el.className = "card";
      el.style.marginTop = "12px";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div style="min-width:0;">
            <div style="font-weight:980; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
            <div class="smallInfo">${b.lang} â€¢ Sayfa ${b.page+1} / ${total}</div>
          </div>
          <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" data-open="${b.id}">Oku</button>
        </div>
      `;
      el.querySelector("[data-open]").onclick = ()=>openBook(b.id);
      wrap.appendChild(el);
    });
  }

  // ---------------- Sheets ----------------
  const backdrop = document.getElementById("backdrop");
  function openSheet(id){
    backdrop.classList.add("open");
    document.getElementById(id).classList.add("open");
  }
  function closeSheets(){
    backdrop.classList.remove("open");
    document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open"));
  }

  // ---------------- Add book ----------------
  function openAddBook(){
    document.getElementById("bTitle").value = "";
    document.getElementById("bText").value = "";
    openSheet("addBookSheet");
  }

  function saveBook(){
    const title = document.getElementById("bTitle").value.trim() || "AdsÄ±z Metin";
    const lang = document.getElementById("bLang").value;
    const content = document.getElementById("bText").value.trim();
    if(!content) return toast("Ä°Ã§erik boÅŸ olamaz.");

    state.books.push({ id:"b_"+Math.random().toString(36).slice(2), title, lang, page:0, content });
    DB.set("lm_books", state.books);
    toast("KÃ¼tÃ¼phaneye eklendi âœ…");
    closeSheets();
    renderLibrary();
  }

  // ---------------- Word sheet ----------------
  let currentCardId = null;

  function openWord(word, lang, ctx){
    currentCardId = null;
    document.getElementById("wsLang").textContent = lang;
    document.getElementById("wsWord").textContent = word;
    document.getElementById("wsMeaning").value = "";
    document.getElementById("wsContext").value = (ctx || "").slice(0,240) + ((ctx||"").length>240 ? "..." : "");
    document.getElementById("wsStatus").textContent = "Yeni kart";
    document.getElementById("wsSource").textContent = "Ã‡eviri: â€”";
    openSheet("wordSheet");
  }

  function speakWord(){
    const txt = document.getElementById("wsWord").textContent;
    const lang = document.getElementById("wsLang").textContent;
    const u = new SpeechSynthesisUtterance(txt);
    const map = {EN:"en-US", RU:"ru-RU", DE:"de-DE", FR:"fr-FR", TR:"tr-TR"};
    u.lang = map[lang] || "en-US";
    u.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ---------------- Offline dictionary (geniÅŸletildi) ----------------
  const OFFLINE_EN_TR = {
    "that":"ÅŸu / o / -diÄŸi ÅŸey","this":"bu","into":"iÃ§ine","past":"geÃ§miÅŸ / geÃ§miÅŸten","met":"tanÄ±ÅŸtÄ± / buluÅŸtu",
    "above":"Ã¼stÃ¼nde","from":"-den/-dan","seem":"gibi gÃ¶rÃ¼nmek","still":"hala","rose":"gÃ¼l / yÃ¼kseldi",
    "would":"-erdi","wonder":"merak etmek","even":"bile","notice":"fark etmek","matter":"mesele / Ã¶nemsemek",
    "anyone":"kimse / herhangi biri","at once":"hemen / aynÄ± anda","badly":"kÃ¶tÃ¼ bir ÅŸekilde",
    "across":"karÅŸÄ±dan karÅŸÄ±ya / boyunca","round":"etrafÄ±nda / yuvarlak","passage":"geÃ§it / koridor","bend":"viraj / kÄ±vrÄ±m",
    "dark":"karanlÄ±k","went":"gitti","down":"aÅŸaÄŸÄ±","and":"ve","the":"(belirli artikel)","a":"bir","in":"iÃ§inde","on":"Ã¼zerinde","to":"-e/-a",
    "always":"her zaman","woman":"kadÄ±n","seldom":"nadiren","mention":"bahsetmek","under":"altÄ±nda","other":"diÄŸer","name":"isim",
    "eyes":"gÃ¶zler","whole":"tÃ¼m","sex":"cinsiyet","felt":"hissetti","emotion":"duygu","love":"aÅŸk","particularly":"Ã¶zellikle",
    "cold":"soÄŸuk","precise":"kesin / net","mind":"zihin","perfect":"mÃ¼kemmel","machine":"makine",
    "beginning":"baÅŸlangÄ±Ã§","tired":"yorgun","sitting":"oturmak","bank":"nehir kÄ±yÄ±sÄ± / banka","nothing":"hiÃ§bir ÅŸey",
    "pictures":"resimler","conversations":"konuÅŸmalar","truth":"gerÃ§ek","universally":"evrensel olarak","acknowledged":"kabul edilmiÅŸ",
    "single":"bekar / tek","possession":"sahiplik","fortune":"servet","want":"istemek / ihtiyaÃ§ duymak","wife":"eÅŸ",
    "into":"iÃ§ine","above":"Ã¼stÃ¼nde","from":"-den/-dan","still":"hala","across":"karÅŸÄ±dan karÅŸÄ±ya / boyunca",
    "can":"-ebilmek","like":"gibi / sevmek","women":"kadÄ±nlar","children":"Ã§ocuklar","gun":"silah",
    "yard":"yarda / avlu","could":"-ebilirdi",
    "foundation":"temel","concrete":"beton","cement":"Ã§imento","aggregate":"agrega","steel":"Ã§elik",
    "beam":"kiriÅŸ","column":"kolon","slab":"dÃ¶ÅŸeme","reinforcement":"donatÄ±","structural":"yapÄ±sal",
    "load":"yÃ¼k","tension":"Ã§ekme","compression":"basÄ±nÃ§","shear":"kesme","strength":"dayanÄ±m","stress":"gerilme","strain":"deformasyon",
    "excavation":"kazÄ±","scaffolding":"iskele","formwork":"kalÄ±p","brick":"tuÄŸla","mortar":"harÃ§","asphalt":"asfalt",
    "soil":"toprak","clay":"kil","sand":"kum","gravel":"Ã§akÄ±l","earthquake":"deprem","survey":"Ã¶lÃ§Ã¼m","blueprint":"plan","architecture":"mimari",
    "engineer":"mÃ¼hendis","civil engineer":"inÅŸaat mÃ¼hendisi","construction":"inÅŸaat","bridge":"kÃ¶prÃ¼","tunnel":"tÃ¼nel","dam":"baraj",
    "road":"yol","railway":"demiryolu","density":"yoÄŸunluk","viscosity":"viskozite","girder":"kiriÅŸ","truss":"makas","retaining wall":"istinat duvarÄ±",
    "pavement":"kaldÄ±rÄ±m","crane":"vinÃ§","bulldozer":"buldozer","excavator":"ekskavatÃ¶r","construction site":"ÅŸantiye",
    "plaster":"sÄ±va","paint":"boya","tile":"fayans","pipe":"boru","valve":"vana",
    "as":"olarak","I":"ben","his":"onun","he":"o (erkek)","for":"iÃ§in","are":"-dÄ±r (Ã§oÄŸul)","with":"ile","they":"onlar","be":"olmak",
    "at":"-de/-da","one":"bir (tek)","have":"sahip olmak","by":"tarafÄ±ndan","hot":"sÄ±cak","word":"kelime","but":"ama","what":"ne","some":"bazÄ±",
    "is":"-dÄ±r","it":"o (cansÄ±z)","you":"sen / siz","or":"veya","had":"-miÅŸti","not":"deÄŸil","there":"orada","when":"ne zaman","up":"yukarÄ±",
    "use":"kullanmak","your":"senin / sizin","way":"yol","about":"hakkÄ±nda","many":"birÃ§ok","then":"sonra","them":"onlarÄ±","write":"yazmak",
    "would":"-erdi","so":"bu yÃ¼zden","these":"bunlar","her":"onun (kadÄ±n)","long":"uzun","make":"yapmak","thing":"ÅŸey","see":"gÃ¶rmek",
    "him":"onu (erkek)","two":"iki","has":"var (sahip)","look":"bakmak","more":"daha fazla","day":"gÃ¼n","could":"-ebilir","go":"gitmek",
    "come":"gelmek","did":"yaptÄ±","number":"sayÄ±","sound":"ses","no":"hayÄ±r","most":"en Ã§ok","people":"insanlar","my":"benim",
    "over":"Ã¼zerinde","know":"bilmek","water":"su","than":"-den (daha)","call":"Ã§aÄŸÄ±rmak","first":"birinci / ilk","who":"kim",
    "may":"-ebilir (olasÄ±lÄ±k)","down":"aÅŸaÄŸÄ±","side":"yan","been":"olmuÅŸ","now":"ÅŸimdi","find":"bulmak","head":"kafa","stand":"durmak",
    "own":"kendi","page":"sayfa","should":"-meli/-malÄ±","country":"Ã¼lke","found":"bulundu","answer":"cevap","school":"okul","grow":"bÃ¼yÃ¼mek",
    "study":"Ã§alÄ±ÅŸma","still":"hala","learn":"Ã¶ÄŸrenmek","plant":"bitki","cover":"kapak","food":"yemek / gÄ±da","sun":"gÃ¼neÅŸ","four":"dÃ¶rt",
    "between":"arasÄ±nda","state":"devlet","keep":"tutmak","eye":"gÃ¶z","never":"asla","last":"son","let":"izin vermek","thought":"dÃ¼ÅŸÃ¼nce",
    "city":"ÅŸehir","tree":"aÄŸaÃ§","cross":"Ã§apraz","farm":"Ã§iftlik","hard":"sert / zor","start":"baÅŸlamak","might":"-ebilir","story":"hikaye",
    "saw":"gÃ¶rdÃ¼ / testere","far":"uzak","sea":"deniz","draw":"Ã§izmek","left":"sol / kaldÄ±","late":"geÃ§","run":"koÅŸmak","don't":"yapma (kÄ±saltma)",
    "while":"-ken","press":"basmak","close":"yakÄ±n / kapatmak","night":"gece","real":"gerÃ§ek","life":"hayat","few":"az","north":"kuzey","book":"kitap",
    "carry":"taÅŸÄ±mak","took":"aldÄ±","science":"bilim","eat":"yemek","room":"oda","friend":"arkadaÅŸ","began":"baÅŸladÄ±","idea":"fikir","fish":"balÄ±k",
    "mountain":"daÄŸ","stop":"durmak","once":"bir kez","base":"temel / baz","hear":"duymak","horse":"at","cut":"kesmek","sure":"emin","watch":"izlemek / saat",
    "color":"renk","face":"yÃ¼z","wood":"ahÅŸap / odun","main":"ana","open":"aÃ§Ä±k / aÃ§mak","together":"birlikte","next":"sonraki","white":"beyaz","children":"Ã§ocuklar",
    "begin":"baÅŸlamak","got":"elde etti","walk":"yÃ¼rÃ¼mek","example":"Ã¶rnek","ease":"kolaylÄ±k","paper":"kaÄŸÄ±t","group":"grup","always":"her zaman","music":"mÃ¼zik",
    "those":"ÅŸunlar","both":"her ikisi","mark":"iÅŸaret","often":"sÄ±k sÄ±k","letter":"mektup / harf","until":"-e kadar","mile":"mil","river":"nehir","car":"araba",
    "feet":"ayaklar","care":"Ã¶nem / bakÄ±m","second":"ikinci / saniye","enough":"yeterli","plain":"ova / sade","girl":"kÄ±z","usual":"olaÄŸan","young":"genÃ§","ready":"hazÄ±r",
    "above":"yukarÄ±daki","ever":"hiÃ§","red":"kÄ±rmÄ±zÄ±","list":"liste","though":"-dÄ±ÄŸÄ± halde","feel":"hissetmek","talk":"konuÅŸmak","bird":"kuÅŸ","soon":"yakÄ±nda","body":"vÃ¼cut",
    "dog":"kÃ¶pek","family":"aile","direct":"doÄŸrudan","pose":"poz vermek","leave":"ayrÄ±lmak","song":"ÅŸarkÄ±","measure":"Ã¶lÃ§mek","door":"kapÄ±","product":"Ã¼rÃ¼n","black":"siyah",
    "short":"kÄ±sa","numeral":"rakam","class":"sÄ±nÄ±f","wind":"rÃ¼zgar","question":"soru","happen":"olmak","complete":"tamamlamak","ship":"gemi","area":"alan","half":"yarÄ±m",
    "rock":"kaya","order":"sipariÅŸ / dÃ¼zen","fire":"ateÅŸ / yangÄ±n","south":"gÃ¼ney","problem":"sorun","piece":"parÃ§a","told":"sÃ¶yledi","knew":"biliyordu","pass":"geÃ§mek",
    "since":"-den beri","top":"Ã¼st","king":"kral","street":"sokak","inch":"inÃ§","multiply":"Ã§arpma","nothing":"hiÃ§bir ÅŸey","course":"kurs / gidiÅŸat","stay":"kalmak",
    "wheel":"tekerlek","full":"tam / dolu","force":"kuvvet","blue":"mavi","object":"nesne","decide":"karar vermek","surface":"yÃ¼zey","deep":"derin","moon":"ay","island":"ada",
    "foot":"ayak","system":"sistem","busy":"meÅŸgul","test":"test / sÄ±namak","record":"kayÄ±t / rekor","boat":"tekne","common":"ortak","gold":"altÄ±n","possible":"mÃ¼mkÃ¼n","plane":"dÃ¼zlem / uÃ§ak",
    "stead":"yerine","dry":"kuru","wonder":"merak etmek","laugh":"gÃ¼lmek","thousand":"bin","ago":"Ã¶nce","ran":"koÅŸtu","check":"kontrol etmek","game":"oyun",
    "shape":"ÅŸekil","equate":"eÅŸit kÄ±lmak","miss":"Ã¶zlemek / bayan (hitap)","brought":"getirdi","heat":"Ä±sÄ±","snow":"kar","tire":"lastik / yormak",
    "bring":"getirmek","yes":"evet","distant":"uzak","fill":"doldurmak","east":"doÄŸu","paint":"boya","language":"dil","among":"arasÄ±nda","unit":"Ã¼nite",
    "power":"gÃ¼Ã§","town":"kasaba","fine":"iyi / ince","certain":"belirli","fly":"uÃ§mak","fall":"dÃ¼ÅŸmek","lead":"Ã¶nderlik etmek / kurÅŸun","cry":"aÄŸlamak",
    "dark":"karanlÄ±k","machine":"makine","note":"not","wait":"beklemek","plan":"plan","figure":"rakam / ÅŸekil","star":"yÄ±ldÄ±z","box":"kutu","noun":"isim (dilbilgisi)",
    "field":"alan","rest":"dinlenme / geri kalan","correct":"doÄŸru","able":"yetenekli","pound":"pound (aÄŸÄ±rlÄ±k)","done":"yapÄ±ldÄ±","beauty":"gÃ¼zellik",
    "drive":"sÃ¼rmek / dÃ¼rtÃ¼","stood":"durdu","contain":"iÃ§ermek","front":"Ã¶n","teach":"Ã¶ÄŸretmek","week":"hafta","final":"nihai","gave":"verdi","green":"yeÅŸil",
    "oh":"ah","quick":"hÄ±zlÄ±","develop":"geliÅŸtirmek","ocean":"okyanus","warm":"sÄ±cak (Ä±lÄ±k)","free":"Ã¼cretsiz / Ã¶zgÃ¼r","minute":"dakika","strong":"gÃ¼Ã§lÃ¼","special":"Ã¶zel",
    "mind":"zihin","behind":"arkasÄ±nda","clear":"aÃ§Ä±k / net","tail":"kuyruk","produce":"Ã¼retmek","fact":"gerÃ§ek","space":"uzay / boÅŸluk","heard":"duydu","best":"en iyi",
    "hour":"saat","better":"daha iyi","true":"doÄŸru","during":"esnasÄ±nda","hundred":"yÃ¼z","five":"beÅŸ","remember":"hatÄ±rlamak","step":"adÄ±m","early":"erken","hold":"tutmak",
    "west":"batÄ±","ground":"zemin","interest":"ilgi / faiz","reach":"ulaÅŸmak","fast":"hÄ±zlÄ±","verb":"fiil","sing":"ÅŸarkÄ± sÃ¶ylemek","listen":"dinlemek","six":"altÄ±",
    "table":"tablo / masa","travel":"seyahat etmek","less":"daha az","morning":"sabah","ten":"on","simple":"basit","several":"birkaÃ§","vowel":"Ã¼nlÃ¼ (sesli harf)",
    "toward":"-e doÄŸru","war":"savaÅŸ","lay":"yerleÅŸtirmek","against":"-e karÅŸÄ±","pattern":"desen","slow":"yavaÅŸ","center":"merkez","love":"aÅŸk / sevmek",
    "person":"kiÅŸi","money":"para","serve":"hizmet etmek","appear":"gÃ¶rÃ¼nmek","road":"yol","map":"harita","rain":"yaÄŸmur","rule":"kural","govern":"yÃ¶netmek",
    "pull":"Ã§ekmek","cold":"soÄŸuk","notice":"fark etmek","voice":"ses","energy":"enerji","hunt":"avlamak","probable":"muhtemel","bed":"yatak","brother":"erkek kardeÅŸ",
    "egg":"yumurta","ride":"binmek","cell":"hÃ¼cre","believe":"inanmak","perhaps":"belki","pick":"seÃ§mek","sudden":"ani","count":"saymak","square":"kare","reason":"neden / gerekÃ§e",
    "length":"uzunluk","represent":"temsil etmek","art":"sanat","subject":"konu","region":"bÃ¶lge","size":"boyut","vary":"deÄŸiÅŸmek","settle":"yerleÅŸmek","speak":"konuÅŸmak",
    "weight":"aÄŸÄ±rlÄ±k","general":"genel","ice":"buz","matter":"Ã¶nem / madde","circle":"daire","pair":"Ã§ift","include":"dahil etmek","divide":"bÃ¶lmek",
    "syllable":"hece","felt":"hissetti / keÃ§e","grand":"bÃ¼yÃ¼k","ball":"top","yet":"henÃ¼z","wave":"dalga","drop":"dÃ¼ÅŸÃ¼rmek","heart":"kalp","am":"-yÄ±m (to be)","present":"mevcut / sunmak",
    "heavy":"aÄŸÄ±r","dance":"dans etmek","engine":"motor","position":"pozisyon","arm":"kol","wide":"geniÅŸ","sail":"yelken","material":"malzeme","fraction":"kesir",
    "forest":"orman","sit":"oturmak","race":"yarÄ±ÅŸ / Ä±rk","window":"pencere","store":"maÄŸaza / depolamak","summer":"yaz","train":"tren / eÄŸitmek","sleep":"uyumak",
    "prove":"kanÄ±tlamak","lone":"yalnÄ±z","leg":"bacak","exercise":"egzersiz","wall":"duvar","catch":"yakalamak","mount":"daÄŸ / monte etmek","wish":"dilemek",
    "sky":"gÃ¶kyÃ¼zÃ¼","board":"tahta / binmek (gemi/uÃ§aÄŸa)","joy":"sevinÃ§","winter":"kÄ±ÅŸ","sat":"oturdu (to sit past)","written":"yazÄ±lÄ±","wild":"vahÅŸi","instrument":"enstrÃ¼man",
    "kept":"tuttu","glass":"cam / bardak","grass":"Ã§im","cow":"inek","job":"iÅŸ","edge":"kenar","sign":"iÅŸaret / imzalamak","visit":"ziyaret etmek","soft":"yumuÅŸak","fun":"eÄŸlence",
    "bright":"parlak","gas":"gaz","weather":"hava durumu","month":"ay (aylÄ±k)","million":"milyon","bear":"ayÄ± / taÅŸÄ±mak","finish":"bitirmek","happy":"mutlu","hope":"umut etmek",
    "flower":"Ã§iÃ§ek","clothe":"giydirmek","strange":"garip","gone":"gitmiÅŸ","trade":"ticaret","melody":"melodi","trip":"gezi","office":"ofis","receive":"almak","row":"sÄ±ra / kÃ¼rek Ã§ekmek",
    "mouth":"aÄŸÄ±z","exact":"tam","symbol":"sembol","die":"Ã¶lmek","least":"en az","trouble":"sorun","shout":"baÄŸÄ±rmak","except":"hariÃ§","wrote":"yazdÄ±","seed":"tohum","tone":"ton / ses rengi",
    "join":"katÄ±lmak","suggest":"Ã¶nermek","clean":"temiz","break":"kÄ±rmak / mola","lady":"hanÄ±mefendi","yard":"yarda / avlu","rise":"yÃ¼kselmek","bad":"kÃ¶tÃ¼","blow":"darbe / Ã¼flemek",
    "oil":"yaÄŸ","blood":"kan","touch":"dokunmak","grew":"bÃ¼yÃ¼dÃ¼","cent":"sent (yÃ¼zde)","mix":"karÄ±ÅŸtÄ±rmak","team":"takÄ±m","wire":"tel","cost":"maliyet","lost":"kayÄ±p / kaybetti",
    "brown":"kahverengi","wear":"giymek","garden":"bahÃ§e","equal":"eÅŸit","sent":"gÃ¶nderildi","choose":"seÃ§mek","fell":"dÃ¼ÅŸtÃ¼","fit":"uygun / sÄ±ÄŸmak","flow":"akÄ±ÅŸ","fair":"adil / fuar",
    "bank":"banka / nehir kenarÄ±","collect":"toplamak","save":"kaydetmek / kurtarmak","control":"kontrol","decimal":"ondalÄ±k","ear":"kulak","else":"baÅŸka","quite":"oldukÃ§a",
    "broke":"kÄ±rdÄ± / bozdu","case":"durum / dava","middle":"orta","kill":"Ã¶ldÃ¼rmek","son":"oÄŸul / gÃ¼neÅŸ","lake":"gÃ¶l","moment":"an","scale":"Ã¶lÃ§ek","loud":"yÃ¼ksek sesle","spring":"ilkbahar / yay",
    "observe":"gÃ¶zlemlemek","child":"Ã§ocuk","straight":"dÃ¼z / doÄŸru","consonant":"Ã¼nsÃ¼z","nation":"ulus","dictionary":"sÃ¶zlÃ¼k","milk":"sÃ¼t","speed":"hÄ±z","method":"yÃ¶ntem","organ":"organ",
    "pay":"Ã¶demek","age":"yaÅŸ","section":"bÃ¶lÃ¼m","dress":"elbise / giyinmek","cloud":"bulut","surprise":"sÃ¼rpriz","quiet":"sessiz","stone":"taÅŸ","tiny":"kÃ¼Ã§Ã¼cÃ¼k","climb":"tÄ±rmanmak",
    "cool":"serin / havalÄ±","design":"tasarÄ±m / tasarlamak","poor":"fakir / kÃ¶tÃ¼","lot":"Ã§ok / arsa","experiment":"deney","bottom":"alt","key":"anahtar","iron":"demir","single":"tek","stick":"sopa / yapÄ±ÅŸtÄ±rmak",
    "flat":"dÃ¼z / apartman dairesi","twenty":"yirmi","skin":"cilt","smile":"gÃ¼lÃ¼msemek","crease":"buruÅŸukluk / kÄ±rÄ±ÅŸÄ±k","hole":"delik","jump":"atlamak","baby":"bebek","eight":"sekiz",
    "village":"kÃ¶y","meet":"karÅŸÄ±laÅŸmak / tanÄ±ÅŸmak","root":"kÃ¶k","buy":"satÄ±n almak","raise":"yÃ¼kseltmek / Ã§ocuk bÃ¼yÃ¼tmek","solve":"Ã§Ã¶zmek","metal":"metal","whether":"-ip -mediÄŸi","push":"itmek",
    "seven":"yedi","paragraph":"paragraf","third":"Ã¼Ã§Ã¼ncÃ¼","shall":"-eceÄŸim (kararlÄ±lÄ±k)","held":"tutuldu","hair":"saÃ§","describe":"tanÄ±mlamak","cook":"aÅŸÃ§Ä± / yemek piÅŸirmek","floor":"zemin / kat",
    "either":"ya ... ya","result":"sonuÃ§","burn":"yanmak","hill":"tepe","safe":"gÃ¼venli","cat":"kedi","century":"yÃ¼zyÄ±l","consider":"dÃ¼ÅŸÃ¼nmek","type":"tip / tÃ¼r","law":"hukuk","bit":"biraz / parÃ§a",
    "coast":"kÄ±yÄ±","copy":"kopyalamak","phrase":"ifade","silent":"sessiz","tall":"uzun boylu","sand":"kum","soil":"toprak","roll":"yuvarlanmak / rulo","temperature":"sÄ±caklÄ±k","finger":"parmak",
    "industry":"sanayi","value":"deÄŸer","fight":"kavga / dÃ¶vÃ¼ÅŸmek","lie":"yalan / uzanmak","beat":"yenmek / vurmak","excite":"heyecanlandÄ±rmak","natural":"doÄŸal","view":"gÃ¶rÃ¼nÃ¼m","sense":"hissetmek / duyu",
    "capital":"baÅŸkent / bÃ¼yÃ¼k harf / sermaye","wonâ€™t":"olmayacak (will not)","chair":"sandalye","danger":"tehlike","fruit":"meyve","rich":"zengin","thick":"kalÄ±n","soldier":"asker",
    "process":"sÃ¼reÃ§","operate":"iÅŸletmek","practice":"pratik / uygulamak","separate":"ayÄ±rmak / ayrÄ±","difficult":"zor","doctor":"doktor","please":"lÃ¼tfen / memnun etmek","protect":"korumak",
    "noon":"Ã¶ÄŸle","crop":"ekin / kÄ±rpmak","modern":"modern","element":"element","hit":"vurmak","student":"Ã¶ÄŸrenci","corner":"kÃ¶ÅŸe","party":"parti","supply":"arz / tedarik etmek",
    "whose":"kimin","locate":"yerini saptamak","ring":"yÃ¼zÃ¼k / zil","character":"karakter","insect":"bÃ¶cek","caught":"yakalandÄ±","period":"dÃ¶nem / periyot","indicate":"belirtmek","radio":"radyo",
    "spoke":"konuÅŸtu (speak past)","atom":"atom","human":"insan","history":"tarih","effect":"etki","electric":"elektrikli","expect":"beklemek","bone":"kemik","rail":"demiryolu / ray",
    "imagine":"hayal etmek","provide":"saÄŸlamak","agree":"katÄ±lmak","thus":"bÃ¶ylece","gentle":"nazik","woman":"kadÄ±n","captain":"kaptan","guess":"tahmin etmek","necessary":"gerekli",
    "sharp":"keskin","wing":"kanat","create":"oluÅŸturmak","neighbor":"komÅŸu","wash":"yÄ±kamak","bat":"yarasa / sopa","rather":"daha ziyade","crowd":"kalabalÄ±k","corn":"mÄ±sÄ±r",
    "compare":"karÅŸÄ±laÅŸtÄ±rmak","poem":"ÅŸiir","string":"dizi / tel","bell":"Ã§an","depend":"baÄŸlÄ± olmak","meat":"et","rub":"ovmak","tube":"tÃ¼p","famous":"Ã¼nlÃ¼","stream":"akÄ±ÅŸ / dere",
    "fear":"korku","sight":"gÃ¶rÃ¼ÅŸ","thin":"ince","triangle":"Ã¼Ã§gen","planet":"gezegen","hurry":"acele etmek","chief":"ÅŸef / ana","colony":"koloni","clock":"saat","mine":"benimki / maden",
    "tie":"kravat / baÄŸlamak","enter":"girmek","major":"bÃ¼yÃ¼k / ana dal","fresh":"taze","send":"gÃ¶ndermek","yellow":"sarÄ±","gun":"silah","allow":"izin vermek","print":"yazdÄ±rmak",
    "dead":"Ã¶lÃ¼","spot":"nokta / benek","desert":"Ã§Ã¶l / terk etmek","suit":"takÄ±m elbise / uygun olmak","current":"akÄ±ntÄ± / mevcut","lift":"kaldÄ±rmak / asansÃ¶r","arrive":"varmak","master":"usta / ana",
    "track":"iz / takip etmek","parent":"ebeveyn","shore":"kÄ±yÄ±","division":"bÃ¶lme","sheet":"levha / Ã§arÅŸaf","substance":"madde","favor":"iyilik","connect":"baÄŸlamak","post":"posta / gÃ¶rev",
    "spend":"harcamak","chord":"akor","fat":"ÅŸiÅŸman / yaÄŸ","glad":"memnun","original":"orijinal","share":"pay / paylaÅŸmak","station":"istasyon","dad":"baba","bread":"ekmek","charge":"ÅŸarj / Ã¼cretlendirmek",
    "proper":"uygun","bar":"bar / Ã§ubuk","offer":"teklif etmek","segment":"segment / parÃ§a","slave":"kÃ¶le","duck":"Ã¶rdek","instant":"anlÄ±k","market":"pazar / piyasa","degree":"derece",
    "populate":"doldurmak (nÃ¼fus)","chick":"civciv","dear":"sevgili","enemy":"dÃ¼ÅŸman","reply":"cevaplamak","drink":"iÃ§mek","occur":"meydana gelmek","support":"desteklemek / destek","speech":"konuÅŸma",
    "nature":"doÄŸa","range":"aralÄ±k","steam":"buhar","motion":"hareket","path":"yol / patika","liquid":"sÄ±vÄ±","log":"kÃ¼tÃ¼k / log tutmak","meant":"anlamÄ±na gelmek (geÃ§miÅŸ)","quotient":"bÃ¶lÃ¼m (mat.)","teeth":"diÅŸler",
    "shell":"kabuk","neck":"boyun","oxygen":"oksijen","sugar":"ÅŸeker","death":"Ã¶lÃ¼m","pretty":"gÃ¼zel","skill":"beceri","women":"kadÄ±nlar","season":"sezon / mevsim","solution":"Ã§Ã¶zÃ¼m","magnet":"mÄ±knatÄ±s",
    "silver":"gÃ¼mÃ¼ÅŸ","thank":"teÅŸekkÃ¼r etmek","branch":"ÅŸube / dal","match":"maÃ§ / eÅŸleÅŸmek","suffix":"sonek","especially":"Ã¶zellikle","fig":"incir","afraid":"korkmuÅŸ","huge":"kocaman",
    "sister":"kÄ±z kardeÅŸ","steel":"Ã§elik","discuss":"tartÄ±ÅŸmak","forward":"ileriye","similar":"benzer","guide":"rehber / yol gÃ¶stermek","experience":"deneyim","score":"puan","apple":"elma",
    "bought":"satÄ±n aldÄ±","led":"Ã¶ncÃ¼lÃ¼k etti / gÃ¶tÃ¼rdÃ¼","pitch":"saha / perde (ses) / zift","coat":"ceket / kaplamak","mass":"kitle / kÃ¼tle","card":"kart","band":"bant / grup","rope":"halat",
    "slip":"kaymak / fiÅŸ","win":"kazanmak","dream":"rÃ¼ya","evening":"akÅŸam","condition":"durum","feed":"beslemek","tool":"alet","total":"toplam","basic":"temel","smell":"koku","valley":"vadi",
    "nor":"ne (olumsuz baÄŸlaÃ§)","double":"Ã§ift","seat":"koltuk / oturacak yer","continue":"devam etmek","block":"blok / engellemek","chart":"grafik","hat":"ÅŸapka","sell":"satmak",
    "success":"baÅŸarÄ±","company":"ÅŸirket","subtract":"Ã§Ä±karmak","event":"olay","particular":"Ã¶zellikle / belirli","deal":"anlaÅŸma / ilgilenmek","swim":"yÃ¼zmek","term":"terim / dÃ¶nem","opposite":"karÅŸÄ±sÄ±nda / zÄ±t",
    "wife":"eÅŸ","shoe":"ayakkabÄ±","shoulder":"omuz","spread":"yaymak","arrange":"dÃ¼zenlemek","camp":"kamp","invent":"icat etmek","cotton":"pamuk","born":"doÄŸmuÅŸ","determine":"belirlemek","quart":"kuart (1/4 galon)",
    "nine":"dokuz","truck":"kamyon","noise":"gÃ¼rÃ¼ltÃ¼","level":"seviyesi","chance":"ÅŸans","gather":"toplamak","shop":"dÃ¼kkan / alÄ±ÅŸveriÅŸ yapmak","stretch":"gerinmek / uzatmak","throw":"atmak","shine":"parlamak",
    "property":"mÃ¼lkiyet / Ã¶zellik","column":"sÃ¼tun / kolon","molecule":"molekÃ¼l","select":"seÃ§mek","wrong":"yanlÄ±ÅŸ","gray":"gri","repeat":"tekrar etmek","require":"gerektirmek","broad":"geniÅŸ",
    "prepare":"hazÄ±rlamak","salt":"tuz","nose":"burun","plural":"Ã§oÄŸul","anger":"Ã¶fke","claim":"iddia etmek","continent":"kÄ±ta"
  };

  function normalizeKey(w){ return (w || "").toLowerCase().trim(); }

  function depotUpsert(entry){
    // entry: { key, lang, word, meaning, source, ts }
    const k = entry.key;
    const idx = state.depot.findIndex(x=>x.key===k);
    if(idx >= 0){
      state.depot[idx] = { ...state.depot[idx], ...entry, ts: Date.now() };
    }else{
      state.depot.push({ ...entry, ts: Date.now() });
    }
    DB.set("lm_depot", state.depot);
  }

  async function autoTranslate(){
    const word = document.getElementById("wsWord").textContent.trim();
    const lang = document.getElementById("wsLang").textContent.trim();
    const key = `${lang}|${normalizeKey(word)}`;

    // Cache
    if(state.txCache[key]){
      document.getElementById("wsMeaning").value = state.txCache[key];
      document.getElementById("wsSource").textContent = "Ã‡eviri: Cache âœ…";
      depotUpsert({ key, lang, word, meaning: state.txCache[key], source:"cache" });
      toast("Cache Ã§eviri âœ…");
      return;
    }

    // Online translate (gtx)
    try{
      const sl = ({EN:"en", RU:"ru", DE:"de", FR:"fr"})[lang] || "auto";
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=tr&dt=t&q=${encodeURIComponent(word)}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error("gtx_fail");
      const data = await r.json();
      const out = (data?.[0]?.[0]?.[0] || "").trim();
      if(out){
        document.getElementById("wsMeaning").value = out;
        document.getElementById("wsSource").textContent = "Ã‡eviri: Online âœ…";
        state.txCache[key] = out;
        DB.set("lm_tx_cache", state.txCache);
        depotUpsert({ key, lang, word, meaning: out, source:"online" });
        toast("Online Ã§eviri âœ…");
        return;
      }
      throw new Error("gtx_empty");
    }catch(e){
      // Offline fallback (EN)
      if(lang === "EN"){
        const k = normalizeKey(word);
        if(OFFLINE_EN_TR[k]){
          const out = OFFLINE_EN_TR[k];
          document.getElementById("wsMeaning").value = out;
          document.getElementById("wsSource").textContent = "Ã‡eviri: Offline âœ…";
          state.txCache[key] = out;
          DB.set("lm_tx_cache", state.txCache);
          depotUpsert({ key, lang, word, meaning: out, source:"offline" });
          toast("Offline sÃ¶zlÃ¼k âœ…");
          return;
        }
      }
      document.getElementById("wsSource").textContent = "Ã‡eviri: BulunamadÄ±";
      toast("Ã‡eviri bulunamadÄ± (manuel gir).");
    }
  }

  // ---------------- SRS (AralÄ±klÄ± Tekrar) ----------------
  // Card: {id, term, meaning, lang, context, type, level, category, example, note, due, srs:{interval,reps,ef}}
  function srsCalc(card, quality){
    // quality 0-5
    let s = card.srs || { interval:0, reps:0, ef:2.5 };
    let { interval, reps, ef } = s;

    if(quality >= 3){
      if(reps === 0) interval = 1;
      else if(reps === 1) interval = 6;
      else interval = Math.round(interval * ef);

      reps++;
      ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
      if(ef < 1.3) ef = 1.3;
    }else{
      reps = 0;
      interval = 1;
    }

    const nextDue = Date.now() + interval * 24*60*60*1000;
    return { due: nextDue, srs:{ interval, reps, ef } };
  }

  // ---------------- Cards CRUD ----------------
  function saveCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const lang = document.getElementById("wsLang").textContent.trim();
    const meaning = document.getElementById("wsMeaning").value.trim();
    const context = document.getElementById("wsContext").value.trim();

    if(!term) return toast("Kelime boÅŸ olamaz.");
    if(!meaning) return toast("AnlamÄ± (TR) doldur.");

    const now = Date.now();
    const card = {
      id: currentCardId || ("c_" + Math.random().toString(36).slice(2)),
      term, lang, meaning,
      context,
      type: "word",
      level: "UNK",
      category: "",
      example: "",
      note: "",
      due: now,
      srs: { interval:0, reps:0, ef:2.5 }
    };

    const idx = state.cards.findIndex(c=>c.id===card.id);
    if(idx >= 0) state.cards[idx] = { ...state.cards[idx], ...card };
    else state.cards.push(card);

    DB.set("lm_cards", state.cards);

    const activity = DB.get("lm_activity", {});
    const k = new Date().toISOString().slice(0,10);
    activity[k] = (activity[k] || 0) + 1;
    DB.set("lm_activity", activity);

    toast("Kaydedildi âœ…");
    closeSheets();
    renderDash();
    renderReview();
  }

  function editCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const found = state.cards.find(c => c.term.toLowerCase() === term.toLowerCase());
    if(!found) return toast("Bu kelime kartlarda yok.");
    currentCardId = found.id;
    document.getElementById("wsMeaning").value = found.meaning || "";
    document.getElementById("wsContext").value = found.context || "";
    document.getElementById("wsStatus").textContent = "DÃ¼zenleme modu";
    toast("DÃ¼zenleme aÃ§Ä±ldÄ±");
  }

  function deleteCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const idx = state.cards.findIndex(c => c.term.toLowerCase() === term.toLowerCase());
    if(idx < 0) return toast("Silinecek kart yok.");
    state.cards.splice(idx,1);
    DB.set("lm_cards", state.cards);
    toast("Silindi");
    closeSheets();
    renderDash();
    renderReview();
    renderCards();
  }

  // ---------------- Manual Add ----------------
  function openManualAdd(){
    document.getElementById("maLang").value = "EN";
    document.getElementById("maTerm").value = "";
    document.getElementById("maMeaning").value = "";
    document.getElementById("maType").value = "word";
    document.getElementById("maLevel").value = "UNK";
    document.getElementById("maCategory").value = "";
    document.getElementById("maExample").value = "";
    document.getElementById("maNote").value = "";
    openSheet("manualAddSheet");
  }

  function saveManualCard(){
    const lang = document.getElementById("maLang").value;
    const term = document.getElementById("maTerm").value.trim();
    const meaning = document.getElementById("maMeaning").value.trim();
    const type = document.getElementById("maType").value;
    const level = document.getElementById("maLevel").value;
    const category = document.getElementById("maCategory").value.trim();
    const example = document.getElementById("maExample").value.trim();
    const note = document.getElementById("maNote").value.trim();

    if(!term) return toast("Kelime/terim boÅŸ olamaz.");
    if(!meaning) return toast("Anlam boÅŸ olamaz.");

    const card = {
      id: "c_" + Math.random().toString(36).slice(2),
      term, meaning, lang,
      context: example || "",
      type, level, category, example, note,
      due: Date.now(),
      srs: { interval:0, reps:0, ef:2.5 }
    };

    state.cards.push(card);
    DB.set("lm_cards", state.cards);

    toast("Elle eklendi âœ…");
    closeSheets();
    renderDash();
    renderCards();
    renderReview();
  }

  // ---------------- Cards view ----------------
  document.getElementById("search").addEventListener("input", renderCards);

  function renderCards(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const list = document.getElementById("cardsList");
    list.innerHTML = "";

    const items = state.cards
      .filter(c => !q || c.term.toLowerCase().includes(q) || (c.meaning||"").toLowerCase().includes(q) || (c.category||"").toLowerCase().includes(q))
      .sort((a,b)=>a.term.localeCompare(b.term));

    if(items.length===0){
      const e = document.createElement("div");
      e.className = "card";
      e.innerHTML = `<div style="font-weight:980;">HenÃ¼z kart yok</div><div class="smallInfo">Kitapta kelimeye dokun â†’ Otomatik Ã‡evir â†’ Kaydet</div>`;
      list.appendChild(e);
      return;
    }

    items.forEach(c=>{
      const isDue = (c.due||0) <= Date.now();
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-weight:980; color:var(--primary); font-size:20px;">${c.term}</div>
          <div class="smallInfo" style="font-weight:980; color:${isDue?'var(--warn)':'var(--muted)'}">${isDue?'DUE':'OK'}</div>
        </div>
        <div class="smallInfo">${c.lang} â€¢ ${c.meaning}</div>
        <div class="smallInfo" style="margin-top:6px;">TÃ¼r: ${c.type||'-'} â€¢ Seviye: ${c.level||'-'} â€¢ Kategori: ${(c.category||'-') || '-'}</div>
        <div class="smallInfo" style="margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.example || c.context || ""}</div>
      `;
      list.appendChild(e);
    });
  }

  // ---------------- Dashboard ----------------
  function renderDash(){
    document.getElementById("dashTotal").textContent = state.cards.length;
    document.getElementById("dashDue").textContent = state.cards.filter(c => (c.due||0) <= Date.now()).length;

    const activity = DB.get("lm_activity", {});
    const today = new Date();
    let streak = 0;
    for(let i=0;i<365;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      if((activity[k]||0)>0) streak++;
      else break;
    }
    document.getElementById("dashStreak").textContent = streak + " GÃ¼n";

    let week = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      week += (activity[k]||0);
    }
    document.getElementById("dashWeek").textContent = week;
  }

  // ---------------- Review Page ----------------
  function getDueCards(){
    const now = Date.now();
    return state.cards.filter(c => (c.due||0) <= now);
  }

  function renderReview(){
    document.getElementById("rvTotal").textContent = state.cards.length;
    document.getElementById("rvDue").textContent = getDueCards().length;
  }

  function resetTodaysQueue(){
    // due Ã¶ncelikli, yoksa random
    const due = getDueCards();
    let q = [];
    if(due.length > 0){
      q = due.map(c=>c.id);
    }else{
      q = [...state.cards].sort(()=>Math.random()-0.5).slice(0, Math.min(20, state.cards.length)).map(c=>c.id);
    }
    state.reviewQueue = q;
    DB.set("lm_review_queue", state.reviewQueue);
    toast("Kuyruk yenilendi âœ…");
    renderReview();
  }

  function clearProgress(){
    // sadece srs sÄ±fÄ±rlama (kartlarÄ± silmez)
    state.cards = state.cards.map(c=>({
      ...c,
      due: Date.now(),
      srs:{ interval:0, reps:0, ef:2.5 }
    }));
    DB.set("lm_cards", state.cards);
    toast("SRS sÄ±fÄ±rlandÄ± âœ…");
    renderDash(); renderReview(); renderCards();
  }

  // ---------------- Quiz Engine ----------------
  let quizCurrent = null; // { card, choices[], correctIndex }
  let quizSelectedChoiceIndex = null;
  let quizMode = "choice";
  let wrongCardsThisQuiz = [];

  function startReviewQuiz(){
    if(state.cards.length === 0){
      toast("Kart yok. Ã–nce kart ekle.");
      return;
    }
    if(!state.reviewQueue || state.reviewQueue.length === 0){
      resetTodaysQueue();
    }
    // Initialize quiz counters and UI
    const total = state.reviewQueue.length;
    document.getElementById("qTotal").textContent = total;
    document.getElementById("qRemain").textContent = total;
    document.getElementById("qCorrect").textContent = 0;
    document.getElementById("qWrong").textContent = 0;
    wrongCardsThisQuiz = [];
    document.getElementById("quizBody").style.display = "block";
    document.getElementById("quizSummary").style.display = "none";
    openQuizOverlay();
    nextQuizQuestion();
  }

  function openQuizOverlay(){
    document.getElementById("quizOverlay").classList.add("open");
  }
  function stopQuiz(){
    document.getElementById("quizOverlay").classList.remove("open");
    quizCurrent = null;
    quizSelectedChoiceIndex = null;
    renderDash();
    renderReview();
  }

  function nextQuizQuestion(){
    if(state.reviewQueue.length === 0){
      showQuizSummary();
      return;
    }
    const id = state.reviewQueue.shift();
    DB.set("lm_review_queue", state.reviewQueue);
    const card = state.cards.find(c=>c.id===id);
    if(!card){
      nextQuizQuestion();
      return;
    }
    // Generate choices for question
    const pool = state.cards.filter(c=>c.id!==card.id).sort(()=>Math.random()-0.5);
    const distractors = pool.slice(0,3).map(x=>x.meaning);
    const choices = [...distractors, card.meaning].sort(()=>Math.random()-0.5);
    const correctIndex = choices.indexOf(card.meaning);
    quizCurrent = { card, choices, correctIndex };
    quizSelectedChoiceIndex = null;
    document.getElementById("qMeta").textContent = `${card.lang} â€¢ ${card.type||'word'} â€¢ ${card.level||'UNK'} â€¢ Due: ${((card.due||0) <= Date.now()) ? 'YES' : 'NO'}`;
    document.getElementById("qWord").textContent = card.term;
    const box = document.getElementById("qChoices");
    box.innerHTML = "";
    choices.forEach((ch, idx)=>{
      const b = document.createElement("button");
      b.className = "qChoice";
      b.textContent = ch;
      b.onclick = ()=>selectChoice(idx, b);
      box.appendChild(b);
    });
  }

  function selectChoice(idx, btn){
    quizSelectedChoiceIndex = idx;
    document.querySelectorAll(".qChoice").forEach(b=>b.classList.remove("correct","wrong"));
    // highlight selection briefly
    btn.style.outline = `2px solid color-mix(in srgb, var(--primary) 55%, transparent)`;
    document.querySelectorAll(".qChoice").forEach(b=>b.disabled = true);
    setTimeout(()=>{
      btn.style.outline = "";
      if(quizCurrent){
        if(idx === quizCurrent.correctIndex){
          gradeCurrent(4);
        } else {
          gradeCurrent(2);
        }
      }
    }, 300);
  }

  function gradeCurrent(q){
    if(!quizCurrent) return;
    const { card, correctIndex } = quizCurrent;
    const all = Array.from(document.querySelectorAll(".qChoice"));
    all.forEach((b,i)=>{
      b.disabled = true;
      if(i === correctIndex) b.classList.add("correct");
    });
    if(quizSelectedChoiceIndex !== null && quizSelectedChoiceIndex !== correctIndex){
      all[quizSelectedChoiceIndex]?.classList.add("wrong");
    }
    // track wrong answers for repeat
    if(quizSelectedChoiceIndex !== null && quizSelectedChoiceIndex !== correctIndex){
      wrongCardsThisQuiz.push(card.id);
    }
    // SRS update
    const upd = srsCalc(card, q);
    card.due = upd.due;
    card.srs = upd.srs;
    // log activity
    const activity = DB.get("lm_activity", {});
    const k = new Date().toISOString().slice(0,10);
    activity[k] = (activity[k] || 0) + 1;
    DB.set("lm_activity", activity);
    DB.set("lm_cards", state.cards);
    setTimeout(()=>{
      all.forEach(b=>b.disabled=false);
      nextQuizQuestion();
    }, 900);
  }

  function gradeAnswer(level){
    let q = 3;
    if(level === 'medium') q = 4;
    if(level === 'easy') q = 5;
    gradeCurrent(q);
  }

  function showQuizSummary(){
    // Calculate and display summary stats
    const correctCount = parseInt(document.getElementById('qCorrect').textContent) || 0;
    const wrongCount = parseInt(document.getElementById('qWrong').textContent) || 0;
    document.getElementById('sumCorrect').textContent = correctCount;
    document.getElementById('sumWrong').textContent = wrongCount;
    const total = correctCount + wrongCount;
    const rate = total ? Math.round((correctCount / total) * 100) : 0;
    document.getElementById('sumRate').textContent = rate + '%';
    // Show summary and hide quiz body
    document.getElementById('quizBody').style.display = 'none';
    document.getElementById('quizSummary').style.display = 'block';
  }

  function repeatWrongQuiz(){
    if(wrongCardsThisQuiz.length === 0){
      toast('YanlÄ±ÅŸ yok.');
      stopQuiz();
      return;
    }
    state.reviewQueue = wrongCardsThisQuiz.slice();
    DB.set('lm_review_queue', state.reviewQueue);
    wrongCardsThisQuiz = [];
    document.getElementById('quizSummary').style.display = 'none';
    document.getElementById('quizBody').style.display = 'block';
    const total = state.reviewQueue.length;
    document.getElementById('qTotal').textContent = total;
    document.getElementById('qRemain').textContent = total;
    document.getElementById('qCorrect').textContent = 0;
    document.getElementById('qWrong').textContent = 0;
    nextQuizQuestion();
  }

  // ---------------- Depot ----------------
  function renderDepot(){
    const q = (document.getElementById("depotSearch")?.value || "").toLowerCase().trim();
    const list = document.getElementById("depotList");
    if(!list) return;

    const items = [...(state.depot||[])]
      .filter(x=>{
        if(!q) return true;
        return (x.word||"").toLowerCase().includes(q) || (x.meaning||"").toLowerCase().includes(q) || (x.lang||"").toLowerCase().includes(q);
      })
      .sort((a,b)=>(b.ts||0)-(a.ts||0));

    list.innerHTML = "";

    const info = document.createElement("div");
    info.className = "card";
    info.innerHTML = `<div style="font-weight:980;">KayÄ±t: ${items.length}</div><div class="smallInfo">Kaynak: online / offline / cache</div>`;
    list.appendChild(info);

    if(items.length === 0){
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `<div style="font-weight:980;">Depo boÅŸ</div><div class="smallInfo">Otomatik Ã‡evir yaptÄ±kÃ§a burada birikir.</div>`;
      list.appendChild(e);
      return;
    }

    items.slice(0,200).forEach(x=>{
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div style="font-weight:980; font-size:18px; color:var(--primary);">${x.word}</div>
          <div class="smallInfo" style="font-weight:980;">${x.lang} â€¢ ${x.source}</div>
        </div>
        <div class="smallInfo" style="margin-top:6px;">${x.meaning}</div>
        <div class="two" style="margin-top:10px;">
          <button class="btn btnSoft btnHalf" onclick="copyText('${x.word.replace(/'/g,"\\'").replace(/"/g,'\\"')} â€” ${x.meaning.replace(/'/g,"\\'").replace(/"/g,'\\"')}')">Kopyala</button>
          <button class="btn btnDanger btnHalf" onclick="deleteDepotItem('${x.key.replace(/'/g,"\\'").replace(/"/g,'\\"')}')">Sil</button>
        </div>
      `;
      list.appendChild(e);
    });
  }

  function escapeQuotes(s){
    return (s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"');
  }

  async function copyText(t){
    try{
      await navigator.clipboard.writeText(t);
      toast("KopyalandÄ± âœ…");
    }catch(e){
      toast("Kopyalama baÅŸarÄ±sÄ±z");
    }
  }

  function deleteDepotItem(key){
    state.depot = (state.depot||[]).filter(x=>x.key !== key);
    DB.set("lm_depot", state.depot);
    toast("Silindi");
    renderDepot();
  }

  function clearCache(){
    state.txCache = {};
    DB.set("lm_tx_cache", state.txCache);
    toast("Cache temizlendi âœ…");
  }

  function clearDepotAll(){
    state.depot = [];
    DB.set("lm_depot", state.depot);
    toast("Depo temizlendi");
    renderDepot();
  }

  function exportDepot(){
    const data = JSON.stringify({ depot: state.depot, cache: state.txCache }, null, 2);
    prompt("Kopyala (Depo Export):", data);
  }

  // ---------------- Import/Export All ----------------
  function exportAll(){
    const data = JSON.stringify({
      settings: state.settings,
      cards: state.cards,
      books: state.books,
      cache: state.txCache,
      depot: state.depot
    }, null, 2);
    prompt("Kopyala (Export JSON):", data);
  }

  function importAllPrompt(){
    const txt = prompt("Import JSON yapÄ±ÅŸtÄ±r:");
    if(!txt) return;
    try{
      const obj = JSON.parse(txt);
      if(obj.settings) state.settings = obj.settings;
      if(obj.cards) state.cards = obj.cards;
      if(obj.books) state.books = obj.books;
      if(obj.cache) state.txCache = obj.cache;
      if(obj.depot) state.depot = obj.depot;

      saveAllState();
      setTheme(state.settings.theme || "dark");
      toast("Import tamam âœ…");
      renderDash(); renderLibrary(); renderCards(); renderReview(); renderDepot();
    }catch(e){
      toast("Import hata");
    }
  }

  function hardReset(){
    if(!confirm("Her ÅŸeyi sÄ±fÄ±rlamak istiyor musun?")) return;
    localStorage.removeItem("lm_settings");
    localStorage.removeItem("lm_cards");
    localStorage.removeItem("lm_books");
    localStorage.removeItem("lm_tx_cache");
    localStorage.removeItem("lm_depot");
    localStorage.removeItem("lm_review_queue");
    localStorage.removeItem("lm_activity");
    location.reload();
  }

  // ---------------- Misc ----------------
  function renderReviewOnEnter(){
    renderReview();
  }

  // ---------------- Init ----------------
  seedBooks();
  setTheme(state.settings.theme);
  renderDash();
  renderLibrary();
  renderCards();
  renderReview();
  renderDepot();

  // Ensure settings select sync
  window.addEventListener("load", ()=>{
    const sel = document.getElementById("themeSelect");
    if(sel) sel.value = state.settings.theme;
  });

  // If review queue empty but due exists, keep ok
  if(!state.reviewQueue) state.reviewQueue = [];
</script>
</body>
</html>
