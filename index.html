<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LingoMaster</title>

  <meta name="theme-color" content="#0f172a" id="meta-theme" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --nav-h: 70px;
      --header-h: 60px;
      --radius: 18px;

      --bg:#0b1220;
      --card:#111b2d;
      --card2:#0f172a;
      --border:#25324a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#6366f1;
      --danger:#ef4444;
      --warn:#f59e0b;
    }

    [data-theme="light"]{
      --bg:#f8fafc;
      --card:#ffffff;
      --card2:#f1f5f9;
      --border:#cbd5e1;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#4f46e5;
    }

    [data-theme="ocean"]{
      --bg:#06131f;
      --card:#0b2236;
      --card2:#0a1b2a;
      --border:#245070;
      --text:#e6f2ff;
      --muted:#9bb7d3;
      --primary:#38bdf8;
    }

    [data-theme="emerald"]{
      --bg:#071a14;
      --card:#0b2a21;
      --card2:#082018;
      --border:#1f6b52;
      --text:#ecfdf5;
      --muted:#9fe3c7;
      --primary:#10b981;
    }

    [data-theme="sunset"]{
      --bg:#1b1020;
      --card:#2a1731;
      --card2:#1f1225;
      --border:#6b2a59;
      --text:#fff7ed;
      --muted:#fbcfe8;
      --primary:#fb7185;
    }

    [data-theme="rose"]{
      --bg:#120a10;
      --card:#1f0f1b;
      --card2:#160b13;
      --border:#7f1d1d;
      --text:#fff1f2;
      --muted:#fda4af;
      --primary:#f43f5e;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }

    header{
      position:sticky; top:0; z-index:20;
      height:calc(var(--header-h) + var(--safe-top));
      padding-top:var(--safe-top);
      display:flex; align-items:center; justify-content:space-between;
      padding-left:16px; padding-right:16px;
      background:color-mix(in srgb, var(--bg) 75%, transparent);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800;}
    .logo{
      width:18px; height:18px; border:2px solid var(--primary);
      border-radius:6px; transform:rotate(15deg);
    }
    .iconBtn{
      width:44px; height:44px; border-radius:14px;
      background:transparent; border:1px solid var(--border);
      color:var(--muted);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .iconBtn:active{transform:scale(.98); opacity:.9;}

    #viewport{position:relative; height:calc(100vh - (var(--header-h) + var(--safe-top)));}

    .view{
      position:absolute; inset:0;
      padding:18px;
      padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 18px);
      overflow:auto;
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:.25s ease;
    }
    .view.active{opacity:1; pointer-events:auto; transform:none;}

    .row{display:flex; gap:12px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
    }
    .muted{color:var(--muted);}
    .big{font-size:34px; font-weight:900;}
    .h2{font-size:20px; font-weight:800; margin:0 0 12px 0;}
    .secTitle{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); font-weight:800; margin:4px 0 10px;}

    .btn{
      border:0; cursor:pointer;
      border-radius:16px;
      padding:14px 16px;
      font-weight:800;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
    }
    .btn:active{transform:scale(.98); opacity:.92;}
    .btnPrimary{background:var(--primary); color:white;}
    .btnSoft{background:color-mix(in srgb, var(--card2) 100%, transparent); color:var(--text); border:1px solid var(--border);}
    .btnDanger{background:var(--danger); color:white;}
    .btnHalf{flex:1;}

    /* Bottom Nav ‚Äî FIXED (yamuk durma bitti) */
    nav{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      height:calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom:var(--safe-bottom);
      background:var(--card2);
      border-top:1px solid var(--border);
      display:flex;
    }
    .navBtn{
      flex:1;
      background:transparent;
      border:0;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:900;
      font-size:12px;
      padding:10px 0;
      line-height:1;
      cursor:pointer;
    }
    .navBtn span{display:block;}
    .navBtn.active{color:var(--primary);}

    /* Reader */
    .readerTop{
      position:sticky; top:0;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      padding:10px 0 12px;
      margin-bottom:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .readerTop .titleWrap{min-width:0; text-align:center;}
    .readerTop .title{font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .readerTop .sub{font-size:12px; color:var(--muted); font-weight:800;}
    .reader{
      max-width:720px; margin:0 auto;
      font-family: ui-serif, Georgia, "Times New Roman", serif;
      font-size:19px;
      line-height:1.75;
      text-align:justify;
    }
    .token{cursor:pointer; padding:2px 0; border-radius:6px;}
    .token:active{background:color-mix(in srgb, var(--primary) 25%, transparent);}

    /* Bottom Sheet */
    .backdrop{
      position:fixed; inset:0; z-index:40;
      background:rgba(0,0,0,.55);
      opacity:0; pointer-events:none;
      transition:.2s ease;
    }
    .backdrop.open{opacity:1; pointer-events:auto;}

    .sheet{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      background:var(--card);
      border-radius:26px 26px 0 0;
      border:1px solid var(--border);
      transform:translateY(110%);
      transition:.25s ease;
      max-height:85vh;
      overflow:auto;
      padding:14px 16px calc(16px + var(--safe-bottom));
    }
    .sheet.open{transform:none;}
    .handle{width:48px; height:5px; border-radius:99px; background:var(--border); margin:6px auto 14px;}
    .sheetHeader{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:10px;}
    .sheetHeader .word{font-size:34px; font-weight:950; margin:2px 0;}
    .sheetHeader .lang{font-size:12px; font-weight:900; color:var(--primary); letter-spacing:.08em;}
    .field{margin:10px 0;}
    label{display:block; font-size:12px; font-weight:900; color:var(--muted); margin-bottom:6px;}
    input, textarea, select{
      width:100%;
      background:var(--card2);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    textarea{min-height:92px; resize:none;}
    .two{display:flex; gap:10px;}
    .smallInfo{font-size:12px; color:var(--muted); font-weight:800; margin-top:6px;}

    .toast{
      position:fixed; left:50%; top:calc(14px + var(--safe-top));
      transform:translate(-50%,-20px);
      background:var(--text);
      color:var(--bg);
      padding:10px 14px;
      border-radius:99px;
      font-weight:900;
      opacity:0; pointer-events:none;
      transition:.25s ease;
      z-index:200;
      max-width:calc(100vw - 20px);
      text-align:center;
    }
    .toast.show{opacity:1; transform:translate(-50%,0);}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>LingoMaster</div>
  </div>
  <div style="display:flex; gap:10px;">
    <button class="iconBtn" id="btnTheme" title="Tema">‚òÄÔ∏è</button>
    <button class="iconBtn" id="btnInfo" title="Bilgi">‚öôÔ∏è</button>
  </div>
</header>

<div id="viewport">
  <!-- HOME -->
  <section class="view active" id="home">
    <div class="secTitle">Genel Bakƒ±≈ü</div>

    <div class="row">
      <div class="card" style="flex:1;">
        <div class="muted" style="font-weight:900;">Toplam Kart</div>
        <div class="big" id="dashTotal">0</div>
      </div>
      <div class="card" style="flex:1; border-color:color-mix(in srgb, var(--warn) 45%, var(--border));">
        <div style="font-weight:900; color:var(--warn);">Tekrar (Due)</div>
        <div class="big" style="color:var(--warn);" id="dashDue">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:18px; font-weight:950;">√áalƒ±≈üma Zinciri</div>
        <div style="font-weight:950; color:var(--primary);" id="dashStreak">0 G√ºn</div>
      </div>
      <div class="muted" style="margin-top:10px; font-weight:850;">Son 7 g√ºn toplam: <span id="dashWeek">0</span></div>
    </div>

    <div class="secTitle" style="margin-top:16px;">Hƒ±zlƒ± ƒ∞≈ülemler</div>

    <button class="btn btnPrimary" id="btnQuiz" style="width:100%; font-size:16px;">
      üìò Bug√ºnk√º Tekrarlarƒ± Ba≈ülat
    </button>

    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="go('library')">üìö Kitap Okumaya Devam Et</button>
      <button class="btn btnSoft btnHalf" onclick="go('cards')">üóÇÔ∏è Kartlar</button>
    </div>
  </section>

  <!-- LIBRARY -->
  <section class="view" id="library">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">K√ºt√ºphane</h2>
      <div style="display:flex; gap:10px;">
        <button class="iconBtn" onclick="openFreeBooks()" title="√úcretsiz Kitap">‚¨áÔ∏è</button>
        <button class="iconBtn" onclick="openAddBook()" title="Metin ekle">‚ûï</button>
      </div>
    </div>
    <div id="libraryList"></div>
  </section>

  <!-- READER -->
  <section class="view" id="reader">
    <div class="readerTop">
      <button class="iconBtn" onclick="go('library')" title="Geri">‚Üê</button>
      <div class="titleWrap">
        <div class="title" id="rTitle">‚Äî</div>
        <div class="sub" id="rPage">Sayfa 1 / 1</div>
      </div>
      <button class="iconBtn" onclick="toggleFont()" title="Yazƒ±">T</button>
    </div>

    <div class="reader" id="readerText"></div>

    <div class="two" style="margin-top:16px;">
      <button class="btn btnSoft btnHalf" onclick="prevPage()">√ñnceki</button>
      <button class="btn btnSoft btnHalf" onclick="nextPage()">Sonraki</button>
    </div>
  </section>

  <!-- CARDS -->
  <section class="view" id="cards">
    <h2 class="h2">Kartlar</h2>
    <input id="search" placeholder="Kart ara..." />
    <div id="cardsList" style="margin-top:12px;"></div>
  </section>
</div>

<nav>
  <button class="navBtn active" id="navHome" onclick="go('home')"><span>üè†</span><span>Ana Sayfa</span></button>
  <button class="navBtn" id="navLibrary" onclick="go('library')"><span>üìö</span><span>K√ºt√ºphane</span></button>
  <button class="navBtn" id="navCards" onclick="go('cards')"><span>üóÇÔ∏è</span><span>Kartlar</span></button>
</nav>

<div class="backdrop" id="backdrop" onclick="closeSheets()"></div>

<!-- WORD SHEET -->
<div class="sheet" id="wordSheet">
  <div class="handle"></div>

  <div class="sheetHeader">
    <div style="min-width:0;">
      <div class="lang" id="wsLang">EN</div>
      <div class="word" id="wsWord">word</div>
      <div class="smallInfo" id="wsStatus">Yeni kart</div>
    </div>
    <button class="iconBtn" onclick="speakWord()" title="Oku">üîä</button>
  </div>

  <div class="field">
    <label>Anlamƒ± (TR)</label>
    <input id="wsMeaning" placeholder="T√ºrk√ßesi nedir?" />
  </div>

  <div class="field">
    <label>√ñrnek / Baƒülam</label>
    <textarea id="wsContext"></textarea>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="autoTranslate()">Otomatik √áevir</button>
    <button class="btn btnPrimary btnHalf" onclick="saveCard()">Kaydet</button>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="editCard()">D√ºzenle</button>
    <button class="btn btnDanger btnHalf" onclick="deleteCard()">Sil</button>
  </div>
</div>

<!-- ADD BOOK SHEET -->
<div class="sheet" id="addBookSheet">
  <div class="handle"></div>
  <h2 class="h2">Yeni Metin Ekle</h2>

  <div class="field">
    <label>Ba≈ülƒ±k</label>
    <input id="bTitle" placeholder="Kitap / Makale Ba≈ülƒ±ƒüƒ±" />
  </div>

  <div class="field">
    <label>Dil</label>
    <select id="bLang">
      <option value="EN">ƒ∞ngilizce</option>
      <option value="RU">Rus√ßa</option>
      <option value="DE">Almanca</option>
      <option value="FR">Fransƒ±zca</option>
    </select>
  </div>

  <div class="field">
    <label>URL‚Äôden √ßek (opsiyonel)</label>
    <input id="bUrl" placeholder="√ñrn: Project Gutenberg .txt linki" />
    <div class="smallInfo">URL girersen otomatik indirir. Girmezsen a≈üaƒüƒ±daki metni kaydeder.</div>
  </div>

  <div class="field">
    <label>ƒ∞√ßerik</label>
    <textarea id="bText" placeholder="Metni buraya yapƒ±≈ütƒ±r..."></textarea>
  </div>

  <button class="btn btnPrimary" style="width:100%;" onclick="saveBook()">K√ºt√ºphaneye Ekle</button>
</div>

<!-- FREE BOOK SHEET -->
<div class="sheet" id="freeBookSheet" style="max-height:75vh;">
  <div class="handle"></div>
  <h2 class="h2">√úcretsiz Kitaplar</h2>
  <div class="smallInfo" style="margin-bottom:10px;">Tek tƒ±kla indirip k√ºt√ºphaneye ekler (internet gerekli).</div>
  <div id="freeBooks"></div>
</div>

<div class="toast" id="toast">‚Äî</div>

<script>
  // PWA
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }

  // Store
  const DB = {
    get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  const state = {
    settings: DB.get("lm_settings", { theme:"dark", fontSize:19, themeIndex:0 }),
    cards: DB.get("lm_cards", []),
    books: DB.get("lm_books", []),
    activity: DB.get("lm_activity", {})
  };

  const themes = ["dark","light","ocean","emerald","sunset","rose"];

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2400);
  }

  function setTheme(name){
    document.documentElement.setAttribute("data-theme", name);
    state.settings.theme = name;
    DB.set("lm_settings", state.settings);
    const meta = document.getElementById("meta-theme");
    meta.setAttribute("content", getComputedStyle(document.documentElement).getPropertyValue("--bg").trim() || "#0f172a");
  }

  document.getElementById("btnTheme").onclick = () => {
    const idx = (themes.indexOf(state.settings.theme) + 1) % themes.length;
    setTheme(themes[idx]);
    toast("Tema: " + themes[idx]);
  };

  document.getElementById("btnInfo").onclick = () => toast("Ayarlar yakƒ±nda.");

  // Router
  function go(id){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
    if(id==="home") document.getElementById("navHome").classList.add("active");
    if(id==="library" || id==="reader") document.getElementById("navLibrary").classList.add("active");
    if(id==="cards") document.getElementById("navCards").classList.add("active");

    if(id==="home") renderDash();
    if(id==="library") renderLibrary();
    if(id==="cards") renderCards();
  }

  // Seed demo (kƒ±sa demo + 1 √ºcretsiz kitap listesi)
  function seed(){
    if(state.books.length===0){
      state.books.push({
        id:"demo",
        title:"Sherlock Holmes (Demo)",
        lang:"EN",
        page:0,
        content:`To Sherlock Holmes she is always the woman. I have seldom heard him mention her under any other name.
In his eyes she eclipses and predominates the whole of her sex. It was not that he felt any emotion akin to love for Irene Adler.

(ƒ∞pucu: Kelimeye dokun ‚Üí Kart paneli a√ßƒ±lƒ±r ‚Üí Otomatik √áevir ile TR doldur.)`
      });
      DB.set("lm_books", state.books);
    }
  }

  // Dashboard
  function renderDash(){
    document.getElementById("dashTotal").textContent = state.cards.length;
    document.getElementById("dashDue").textContent = state.cards.filter(c => c.due <= Date.now()).length;

    // streak/7day sum (basit)
    const today = new Date();
    let week = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today);
      d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      week += (state.activity[k] || 0);
    }
    document.getElementById("dashWeek").textContent = week;

    // streak (ardƒ±≈üƒ±k g√ºn)
    let streak = 0;
    for(let i=0;i<365;i++){
      const d = new Date(today);
      d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      if((state.activity[k] || 0) > 0) streak++;
      else break;
    }
    document.getElementById("dashStreak").textContent = streak + " G√ºn";
  }

  // Library
  function renderLibrary(){
    const wrap = document.getElementById("libraryList");
    wrap.innerHTML = "";
    state.books.forEach(b=>{
      const total = getPages(b.content).length;
      const el = document.createElement("div");
      el.className = "card";
      el.style.marginTop = "12px";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div style="min-width:0;">
            <div style="font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
            <div class="smallInfo">${b.lang} ‚Ä¢ Sayfa ${b.page+1} / ${total}</div>
          </div>
          <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" data-open="${b.id}">Oku</button>
        </div>
      `;
      el.querySelector("[data-open]").onclick = ()=>openBook(b.id);
      wrap.appendChild(el);
    });
  }

  // Reader paging (1 sayfa sorunu burada √ß√∂z√ºl√ºyor)
  let activeBook = null;

  function getPages(text){
    const t = (text || "").replace(/\r\n/g,"\n");
    const size = 1500; // k√º√ß√ºk tut -> ger√ßek sayfalama
    const pages = [];
    let i=0;
    while(i < t.length){
      let end = Math.min(i + size, t.length);
      if(end < t.length){
        let cut = Math.max(
          t.lastIndexOf(". ", end),
          t.lastIndexOf("! ", end),
          t.lastIndexOf("? ", end),
          t.lastIndexOf("\n", end)
        );
        if(cut < i + Math.floor(size*0.4)){
          const sp = t.lastIndexOf(" ", end);
          if(sp > i) cut = sp;
        }
        if(cut > i) end = cut + 1;
      }
      pages.push(t.slice(i,end).trim());
      i=end;
    }
    return pages.length ? pages : ["(Bo≈ü)"];
  }

  function openBook(id){
    activeBook = state.books.find(b=>b.id===id);
    go("reader");
    renderReader();
  }

  function renderReader(){
    if(!activeBook) return;
    const pages = getPages(activeBook.content);
    if(activeBook.page >= pages.length) activeBook.page = pages.length-1;
    if(activeBook.page < 0) activeBook.page = 0;

    document.getElementById("rTitle").textContent = activeBook.title;
    document.getElementById("rPage").textContent = `Sayfa ${activeBook.page+1} / ${pages.length}`;

    const box = document.getElementById("readerText");
    box.style.fontSize = state.settings.fontSize + "px";
    box.innerHTML = "";

    const text = pages[activeBook.page];
    const parts = text.split(/(\s+)/);
    parts.forEach(ch=>{
      if(ch.trim().length===0){
        box.appendChild(document.createTextNode(ch));
        return;
      }
      // noktalama ayƒ±klama
      const clean = ch.replace(/[.,!?;:"()¬´¬ª‚Äî‚Äì\[\]{}<>]+/g,"").trim();
      if(clean){
        const s = document.createElement("span");
        s.className = "token";
        s.textContent = ch;
        s.onclick = ()=>openWord(clean, activeBook.lang, text);
        box.appendChild(s);
      }else{
        box.appendChild(document.createTextNode(ch));
      }
    });

    DB.set("lm_books", state.books);
  }

  function nextPage(){ if(!activeBook) return; activeBook.page++; renderReader(); }
  function prevPage(){ if(!activeBook) return; activeBook.page--; renderReader(); }
  function toggleFont(){
    state.settings.fontSize = state.settings.fontSize >= 27 ? 17 : state.settings.fontSize + 2;
    DB.set("lm_settings", state.settings);
    renderReader();
  }

  // Sheets
  const backdrop = document.getElementById("backdrop");
  function openSheet(id){
    backdrop.classList.add("open");
    document.getElementById(id).classList.add("open");
  }
  function closeSheets(){
    backdrop.classList.remove("open");
    document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open"));
  }

  // Word Sheet
  let currentCardId = null;

  function openWord(word, lang, ctx){
    currentCardId = null;
    document.getElementById("wsLang").textContent = lang;
    document.getElementById("wsWord").textContent = word;
    document.getElementById("wsMeaning").value = "";
    document.getElementById("wsContext").value = ctx.slice(0,220) + (ctx.length>220 ? "..." : "");
    document.getElementById("wsStatus").textContent = "Yeni kart";
    openSheet("wordSheet");
  }

  function speakWord(){
    const txt = document.getElementById("wsWord").textContent;
    const lang = document.getElementById("wsLang").textContent;
    const u = new SpeechSynthesisUtterance(txt);
    const map = {EN:"en-US", RU:"ru-RU", DE:"de-DE", FR:"fr-FR", TR:"tr-TR"};
    u.lang = map[lang] || "en-US";
    u.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // Auto translate (NO redirect)
  async function autoTranslate(){
    const word = document.getElementById("wsWord").textContent;
    const lang = document.getElementById("wsLang").textContent;
    const source = ({EN:"en", RU:"ru", DE:"de", FR:"fr"})[lang] || "auto";

    try{
      const r = await fetch("https://libretranslate.de/translate",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ q: word, source, target:"tr", format:"text" })
      });
      if(!r.ok) throw new Error("translate_failed");
      const data = await r.json();
      document.getElementById("wsMeaning").value = (data.translatedText || "").trim();
      toast("√áeviri alƒ±ndƒ± ‚úÖ");
    }catch(e){
      toast("√áeviri servisi eri≈üemedi (internet/yoƒüunluk).");
    }
  }

  function saveCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const lang = document.getElementById("wsLang").textContent.trim();
    const meaning = document.getElementById("wsMeaning").value.trim();
    const context = document.getElementById("wsContext").value.trim();

    if(!term) return toast("Kelime bo≈ü olamaz.");
    if(!meaning) return toast("Anlamƒ± (TR) doldur.");

    const now = Date.now();
    const card = {
      id: currentCardId || ("c_" + Math.random().toString(36).slice(2)),
      term, lang, meaning, context,
      due: now,
      srs: { interval:0, reps:0, ef:2.5 }
    };

    const idx = state.cards.findIndex(c=>c.id===card.id);
    if(idx >= 0) state.cards[idx] = card;
    else state.cards.push(card);

    DB.set("lm_cards", state.cards);
    toast("Kaydedildi ‚úÖ");
    closeSheets();
    renderDash();
  }

  function editCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const found = state.cards.find(c => c.term.toLowerCase() === term.toLowerCase());
    if(!found) return toast("Bu kelime kartlarda yok.");
    currentCardId = found.id;
    document.getElementById("wsMeaning").value = found.meaning || "";
    document.getElementById("wsContext").value = found.context || "";
    document.getElementById("wsStatus").textContent = "D√ºzenleme modu";
    toast("D√ºzenleme a√ßƒ±ldƒ±");
  }

  function deleteCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const idx = state.cards.findIndex(c => c.term.toLowerCase() === term.toLowerCase());
    if(idx < 0) return toast("Silinecek kart yok.");
    state.cards.splice(idx,1);
    DB.set("lm_cards", state.cards);
    toast("Silindi");
    closeSheets();
    renderDash();
    renderCards();
  }

  // Cards view
  document.getElementById("search").addEventListener("input", renderCards);

  function renderCards(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const list = document.getElementById("cardsList");
    list.innerHTML = "";

    const items = state.cards
      .filter(c => !q || c.term.toLowerCase().includes(q) || c.meaning.toLowerCase().includes(q))
      .sort((a,b)=>a.term.localeCompare(b.term));

    if(items.length===0){
      const e = document.createElement("div");
      e.className = "card";
      e.innerHTML = `<div style="font-weight:950;">Hen√ºz kart yok</div><div class="smallInfo">Kitapta kelimeye dokun ‚Üí Kaydet</div>`;
      list.appendChild(e);
      return;
    }

    items.forEach(c=>{
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `
        <div style="font-weight:950; color:var(--primary); font-size:20px;">${c.term}</div>
        <div class="smallInfo">${c.lang} ‚Ä¢ ${c.meaning}</div>
        <div class="smallInfo" style="margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.context || ""}</div>
      `;
      list.appendChild(e);
    });
  }

  // Quiz (basit ba≈ülangƒ±√ß)
  document.getElementById("btnQuiz").onclick = () => {
    toast("Quiz ekranƒ±nƒ± bir sonraki adƒ±mda ekleyeceƒüim. ≈ûimdilik kart biriktirelim üôÇ");
  };

  // Add Book
  function openAddBook(){
    document.getElementById("bTitle").value = "";
    document.getElementById("bUrl").value = "";
    document.getElementById("bText").value = "";
    openSheet("addBookSheet");
  }

  async function saveBook(){
    const title = document.getElementById("bTitle").value.trim() || "Adsƒ±z Metin";
    const lang = document.getElementById("bLang").value;
    const url = document.getElementById("bUrl").value.trim();
    let content = document.getElementById("bText").value.trim();

    if(url){
      try{
        const r = await fetch(url);
        if(!r.ok) throw new Error("fetch_failed");
        content = await r.text();
      }catch(e){
        return toast("URL‚Äôden √ßekemedim. Link doƒüru mu / CORS engeli olabilir.");
      }
    }

    if(!content) return toast("ƒ∞√ßerik bo≈ü olamaz.");

    state.books.push({ id:"b_"+Math.random().toString(36).slice(2), title, lang, page:0, content });
    DB.set("lm_books", state.books);
    toast("K√ºt√ºphaneye eklendi ‚úÖ");
    closeSheets();
    renderLibrary();
  }

  // Free Books (Gutenberg TXT)
  const FREE = [
    { title:"Alice‚Äôs Adventures in Wonderland", lang:"EN", url:"https://www.gutenberg.org/cache/epub/11/pg11.txt" },
    { title:"The Adventures of Sherlock Holmes", lang:"EN", url:"https://www.gutenberg.org/cache/epub/1661/pg1661.txt" },
    { title:"Pride and Prejudice", lang:"EN", url:"https://www.gutenberg.org/cache/epub/1342/pg1342.txt" }
  ];

  function openFreeBooks(){
    const box = document.getElementById("freeBooks");
    box.innerHTML = "";
    FREE.forEach(b=>{
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="min-width:0;">
            <div style="font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
            <div class="smallInfo">${b.lang} ‚Ä¢ Project Gutenberg</div>
          </div>
          <button class="btn btnPrimary" style="padding:10px 12px; border-radius:14px;" data-dl>ƒ∞ndir</button>
        </div>
      `;
      e.querySelector("[data-dl]").onclick = ()=>downloadBook(b);
      box.appendChild(e);
    });
    openSheet("freeBookSheet");
  }

  async function downloadBook(b){
    toast("ƒ∞ndiriliyor...");
    try{
      const r = await fetch(b.url);
      if(!r.ok) throw new Error("dl_failed");
      const content = await r.text();
      state.books.push({ id:"g_"+Math.random().toString(36).slice(2), title:b.title, lang:b.lang, page:0, content });
      DB.set("lm_books", state.books);
      toast("Eklendi ‚úÖ");
      closeSheets();
      renderLibrary();
    }catch(e){
      toast("ƒ∞ndirme ba≈üarƒ±sƒ±z (internet/CORS). Ba≈üka kitap deneyelim.");
    }
  }

  // Init
  seed();
  setTheme(state.settings.theme);
  renderDash();
  renderLibrary();
  renderCards();
</script>
</body>
</html>
