<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vocab Pocket Pro</title>

  <!-- PWA-ish -->
  <meta name="theme-color" content="#0b0b10" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VocabPocket" />

  <!-- Manifest (runtime generated by JS) -->
  <link rel="manifest" id="manifestLink" href="">

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12121a;
      --card:#151523;
      --card2:#17172a;
      --line:#23233a;
      --text:#f2f2f7;
      --muted:#a6a6bb;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#fb7185;
      --warn:#fbbf24;

      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;

      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(34,197,94,.18), transparent 55%);
      --headerTop: rgba(11,11,16,.92);
      --headerBottom: rgba(11,11,16,.60);
      --inputBg: rgba(21,21,35,.85);
    }

    body[data-theme="dark"]{
      --bg:#0b0b10; --panel:#12121a; --card:#151523; --card2:#17172a;
      --line:#23233a; --text:#f2f2f7; --muted:#a6a6bb;
      --accent:#7c3aed; --accent2:#22c55e;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(34,197,94,.18), transparent 55%);
      --headerTop: rgba(11,11,16,.92);
      --headerBottom: rgba(11,11,16,.60);
      --inputBg: rgba(21,21,35,.85);
    }
    body[data-theme="emerald"]{
      --bg:#07110c; --panel:#0b1711; --card:#0f1f17; --card2:#11251b;
      --line:#1f3a2d; --text:#eafff3; --muted:#a2c8b3;
      --accent:#22c55e; --accent2:#7c3aed;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(34,197,94,.22), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(124,58,237,.16), transparent 55%);
      --headerTop: rgba(7,17,12,.92);
      --headerBottom: rgba(7,17,12,.60);
      --inputBg: rgba(15,31,23,.88);
    }
    body[data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --card2:#f4f6ff;
      --line:#d7d9e6; --text:#0b0b10; --muted:#4b5563;
      --accent:#7c3aed; --accent2:#16a34a;
      --shadow: 0 16px 60px rgba(0,0,0,.12);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.16), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(22,163,74,.12), transparent 55%);
      --headerTop: rgba(246,247,251,.92);
      --headerBottom: rgba(246,247,251,.72);
      --inputBg: rgba(255,255,255,.92);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: var(--bgGrad1), var(--bgGrad2), var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      -webkit-tap-highlight-color: transparent;
    }

    header{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(to bottom, var(--headerTop), var(--headerBottom));
      backdrop-filter: blur(10px);
      padding: 12px 0 12px 0;
    }

    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; flex-direction:column; gap:4px}
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: color-mix(in srgb, var(--accent) 35%, transparent);
      background: color-mix(in srgb, var(--accent) 16%, transparent);
    }
    .btn.good{
      border-color: color-mix(in srgb, var(--accent2) 35%, transparent);
      background: color-mix(in srgb, var(--accent2) 14%, transparent);
    }
    .btn.ghost{background: transparent;}
    .btn.danger{
      border-color: color-mix(in srgb, var(--danger) 35%, transparent);
      background: color-mix(in srgb, var(--danger) 12%, transparent);
    }

    .controls{ margin-top:12px; display:grid; gap:10px; grid-template-columns: 1fr; }

    .input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: var(--inputBg);
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      outline:none;
      font-size:15px;
    }
    textarea{min-height:88px; resize:vertical}

    .chips{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:9px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      flex:1;
      min-width: 110px;
      text-align:center;
      user-select:none;
    }
    .chip.active{
      border-color: color-mix(in srgb, var(--accent2) 35%, transparent);
      background: color-mix(in srgb, var(--accent2) 14%, transparent);
    }

    /* Filters on one row (wrap) */
    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }
    .filters select{ width:auto; min-width: 160px; flex: 1; }
    @media (max-width: 420px){ .filters select{ min-width: 140px; } }

    .bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      color: var(--muted); font-size:12px; margin-top:4px;
    }
    .bar .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:999px;
      color: var(--muted);
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .pill strong{color:var(--text); font-weight:900}

    /* Mini dashboard */
    .dash{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:8px;
    }
    .dash .pill{ background: rgba(255,255,255,.02); }

    main{margin-top:12px}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 680px){ .grid{ grid-template-columns: 1fr 1fr; } }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1fr 1fr 1fr; } }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), color-mix(in srgb, var(--panel) 92%, transparent));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      touch-action: pan-y;
    }

    .cardFlipWrap{
      position: relative;
      perspective: 1000px;
      height: 260px; /* JS will auto-fit to content */
    }
    .cardFlip{
      position:absolute; inset:0;
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
      transition: transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .cardFlip.flipped{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      padding:14px;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      display:flex; flex-direction:column; gap:10px;
    }
    .back{
      transform: rotateY(180deg);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card2) 95%, transparent), color-mix(in srgb, var(--panel) 92%, transparent));
    }

    .meta{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .badge .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .star{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:grid; place-items:center;
      font-size:20px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
    }
    .star.on{
      border-color: color-mix(in srgb, var(--warn) 35%, transparent);
      background: color-mix(in srgb, var(--warn) 12%, transparent);
      color: var(--warn);
    }

    .term{
      margin:0;
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.05;
      word-break: break-word;
    }
    .example{
      margin:0;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
    }

    .miniStats{
      display:flex; gap:8px; flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
      margin-top: 2px;
    }
    .miniStats b{ color:var(--text); }
    .statusPill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 9px;
      font-size:11px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    .statusPill.new{ border-color: color-mix(in srgb, var(--warn) 35%, transparent); background: color-mix(in srgb, var(--warn) 10%, transparent); }
    .statusPill.learning{ border-color: color-mix(in srgb, var(--accent) 35%, transparent); background: color-mix(in srgb, var(--accent) 10%, transparent); }
    .statusPill.mastered{ border-color: color-mix(in srgb, var(--accent2) 35%, transparent); background: color-mix(in srgb, var(--accent2) 10%, transparent); }

    .tags{ display:flex; flex-wrap:wrap; gap:6px; margin-top:auto; }
    .tag{
      font-size:11px;
      color: var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding:6px 8px;
      border-radius: 999px;
    }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }

    dialog{
      width:min(760px, 96vw);
      border:none;
      border-radius: 18px;
      background: rgba(18,18,26,.98);
      color: var(--text);
      box-shadow: var(--shadow);
      padding:0;
      overflow:hidden;
      z-index:50;
    }
    body[data-theme="light"] dialog{ background: rgba(255,255,255,.98); }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .modalHead{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modalHead h2{margin:0; font-size:15px}
    .modalHead .small{font-size:12px; color:var(--muted); margin-top:6px}
    .modalBody{padding:14px; display:grid; gap:10px}
    .two{display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 680px){ .two{grid-template-columns: 1fr 1fr;} }
    .modalFoot{
      padding:14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .help{
      font-size:12px; color:var(--muted);
      border:1px dashed color-mix(in srgb, var(--text) 18%, transparent);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.02);
      white-space:pre-wrap;
      line-height:1.35;
    }

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      background: rgba(18,18,26,.95);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--text);
      display:none;
      z-index:9999;
    }
    body[data-theme="light"] .toast{ background: rgba(255,255,255,.95); }

    /* ===== QUIZ FULLSCREEN OVERLAY ===== */
    .quizOverlay{
      position:fixed; inset:0;
      z-index:60;
      display:none;
      background: linear-gradient(180deg, color-mix(in srgb, var(--bg) 82%, #000), color-mix(in srgb, var(--bg) 92%, #000));
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }
    .quizOverlay.on{ display:block; }

    .quizShell{
      max-width: 820px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      height: 100%;
    }

    .quizTop{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:12px;
    }
    .quizTop .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .quizTop .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .quizCard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:14px;
      flex: 1;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .quizQ{
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
      margin:0;
      word-break: break-word;
    }
    .quizSub{
      margin:0;
      color: var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .quizReveal{
      border:1px dashed color-mix(in srgb, var(--text) 22%, transparent);
      border-radius: var(--radius2);
      padding:12px;
      background: rgba(255,255,255,.02);
      display:none;
    }
    .quizReveal.on{ display:block; }
    .quizReveal .ans{
      font-size:18px;
      font-weight:950;
      margin:0 0 6px 0;
    }
    .quizReveal .ex{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .options{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .opt{
      text-align:left;
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:12px;
      border-radius: 14px;
      font-weight:900;
      font-size:14px;
    }
    .opt:active{ transform:scale(.995); }
    .opt.good{ border-color: color-mix(in srgb, var(--accent2) 35%, transparent); background: color-mix(in srgb, var(--accent2) 12%, transparent); }
    .opt.bad{ border-color: color-mix(in srgb, var(--danger) 35%, transparent); background: color-mix(in srgb, var(--danger) 12%, transparent); }

    .quizBottom{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .quizBottom .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .quizBottom .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .listBox{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:12px;
      background: rgba(255,255,255,.02);
      display:grid;
      gap:8px;
    }
    .listBox h3{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }
    .listBox .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      font-size:13px;
    }
    .listBox .item b{ color:var(--text); }
  </style>
</head>

<body data-theme="dark">
  <header>
    <div class="topbar">
      <div class="brand">
        <h1>Vocab Pocket Pro</h1>
        <div class="sub">Kart ‚Ä¢ Flip ‚Ä¢ Favori ‚Ä¢ Etiket ‚Ä¢ Seviye ‚Ä¢ SRS ‚Ä¢ Quiz</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="langManageBtn">üåê Diller</button>
        <button class="btn ghost" id="quickBtn">‚ö° Hƒ±zlƒ± Ekle</button>
        <button class="btn good" id="quizBtn">üß† Quiz</button>
        <button class="btn primary" id="addBtn">Ôºã Ekle</button>
      </div>
    </div>

    <div class="controls">
      <input class="input" id="search" placeholder="Ara: kelime / anlam / √∂rnek / etiket... (√∂rn: #story  level:B1  lang:EN)" />

      <div class="chips" id="chips"></div>

      <div class="filters">
        <select id="statusFilter" title="Durum filtresi">
          <option value="ALL" selected>Durum: T√ºm√º</option>
          <option value="NEW">Durum: Yeni</option>
          <option value="LEARNING">Durum: √ñƒüreniliyor</option>
          <option value="MASTERED">Durum: √ñƒürenildi</option>
          <option value="DUE">Durum: Bug√ºn (Due)</option>
        </select>

        <select id="levelFilter" title="Seviye filtresi">
          <option value="ALL" selected>Seviye: T√ºm√º</option>
          <option value="A1">Seviye: A1</option>
          <option value="A2">Seviye: A2</option>
          <option value="B1">Seviye: B1</option>
          <option value="B2">Seviye: B2</option>
          <option value="C1">Seviye: C1</option>
          <option value="C2">Seviye: C2</option>
        </select>

        <select id="tagFilter" title="Etiket filtresi">
          <option value="ALL" selected>Etiket: T√ºm√º</option>
        </select>

        <select id="themeSelect" title="Tema">
          <option value="dark" selected>Tema: Dark</option>
          <option value="emerald">Tema: Emerald</option>
          <option value="light">Tema: Light</option>
        </select>

        <select id="sort" title="Sƒ±rala">
          <option value="due">Sƒ±rala: Due √∂nce</option>
          <option value="updated">Sƒ±rala: Son g√ºncellenen</option>
          <option value="created">Sƒ±rala: Son eklenen</option>
          <option value="az">Sƒ±rala: A ‚Üí Z</option>
          <option value="za">Sƒ±rala: Z ‚Üí A</option>
        </select>
      </div>

      <div class="dash" id="dash"></div>

      <div class="bar">
        <div class="left">
          <span class="pill">Toplam <strong id="countAll">0</strong></span>
          <span class="pill">G√∂r√ºnen <strong id="countVisible">0</strong></span>
          <span class="pill">Bug√ºn due <strong id="countDue">0</strong></span>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn danger" id="wipeBtn">üóëÔ∏è Hepsini Sil</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <datalist id="tagDatalist"></datalist>
    <div class="grid" id="grid"></div>
  </main>

  <!-- Modal: Add/Edit -->
  <dialog id="modal">
    <div class="modalHead">
      <div>
        <h2 id="modalTitle">Kelime Ekle</h2>
        <div class="small" id="modalSub">Kaynak dil (kelime) + Anlam dili + TR/diƒüer anlam + √∂rnek + etiket</div>
      </div>
      <button class="btn" id="closeBtn" type="button">‚úï</button>
    </div>

    <form class="modalBody" id="form">
      <div class="two">
        <div>
          <label class="small">Kelime dili (source)</label>
          <select id="sourceLang"></select>
        </div>
        <div>
          <label class="small">Anlam dili (target)</label>
          <select id="meaningLang"></select>
        </div>
      </div>

      <div class="two">
        <div>
          <label class="small">Seviye</label>
          <select id="level">
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1" selected>B1</option>
            <option value="B2">B2</option>
            <option value="C1">C1</option>
            <option value="C2">C2</option>
          </select>
        </div>
        <div>
          <label class="small">Durum</label>
          <select id="status">
            <option value="NEW" selected>Yeni</option>
            <option value="LEARNING">√ñƒüreniliyor</option>
            <option value="MASTERED">√ñƒürenildi</option>
          </select>
        </div>
      </div>

      <div class="two">
        <div>
          <label class="small">Kelime</label>
          <input class="input" id="term" placeholder="beneath / shone / ..." autocomplete="off" />
        </div>
        <div>
          <label class="small">Anlam</label>
          <input class="input" id="meaning" placeholder="Anlam (target dilinde)..." autocomplete="off" />
        </div>
      </div>

      <div>
        <label class="small">√ñrnek c√ºmle (kelimenin dilinde)</label>
        <textarea id="example" placeholder="√ñrn: George found a mass of gold beneath the dusty floor."></textarea>
      </div>

      <div class="two">
        <div>
          <label class="small">Etiketler (virg√ºlle)</label>
          <input class="input" id="tags" list="tagDatalist" placeholder="story, daily..." autocomplete="off" />
        </div>
        <div class="help">
          <div><strong>Kƒ±sayollar / Swipe</strong></div>
          <div>‚Ä¢ Karta dokun: √ßevir</div>
          <div>‚Ä¢ Saƒüa kaydƒ±r: ‚òÖ favori</div>
          <div>‚Ä¢ Sola kaydƒ±r: sil</div>
          <div>‚Ä¢ Yukarƒ± kaydƒ±r: √ßevir</div>
        </div>
      </div>
    </form>

    <div class="modalFoot">
      <button class="btn danger" id="deleteBtn" type="button" style="display:none;">Sil</button>
      <button class="btn" id="cancelBtn" type="button">ƒ∞ptal</button>
      <button class="btn primary" id="saveBtn" type="button">Kaydet</button>
    </div>
  </dialog>

  <!-- Modal: Quick Add -->
  <dialog id="quickModal">
    <div class="modalHead">
      <div>
        <h2>‚ö° Hƒ±zlƒ± Ekle</h2>
        <div class="small">Format: <b>term - meaning - level - tags</b> (level/tags opsiyonel). √ñrn: <i>notice - fark etmek - A2 - story, daily</i></div>
      </div>
      <button class="btn" id="quickCloseBtn" type="button">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="two">
        <div>
          <label class="small">Kelime dili</label>
          <select id="quickSourceLang"></select>
        </div>
        <div>
          <label class="small">Anlam dili</label>
          <select id="quickMeaningLang"></select>
        </div>
      </div>

      <textarea id="quickText" placeholder="Her satƒ±r 1 kayƒ±t‚Ä¶"></textarea>

      <div class="help">Ayra√ß olarak <b>-</b> veya <b>|</b> kullanabilirsin. √ñrnek: <i>beneath | altƒ±nda | B1 | story</i></div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="quickCancelBtn" type="button">ƒ∞ptal</button>
      <button class="btn primary" id="quickSaveBtn" type="button">Ekle</button>
    </div>
  </dialog>

  <!-- Modal: Languages -->
  <dialog id="langModal">
    <div class="modalHead">
      <div>
        <h2>Diller</h2>
        <div class="small">Yeni dil ekle (√∂r: DE - Deutsch). Kod 2-5 harf.</div>
      </div>
      <button class="btn" id="langCloseBtn" type="button">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="two">
        <div>
          <label class="small">Dil Kodu</label>
          <input class="input" id="newLangCode" placeholder="DE" maxlength="5" />
        </div>
        <div>
          <label class="small">Dil Adƒ±</label>
          <input class="input" id="newLangName" placeholder="Deutsch" />
        </div>
      </div>

      <div class="two">
        <button class="btn primary" id="addLangBtn" type="button" style="justify-content:center;">Ôºã Dil Ekle</button>
        <button class="btn danger" id="resetLangBtn" type="button" style="justify-content:center;">‚Ü∫ Varsayƒ±lanlara d√∂n</button>
      </div>

      <div class="help" id="langListBox">‚Äî</div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="langDoneBtn" type="button">Tamam</button>
    </div>
  </dialog>

  <!-- QUIZ FULLSCREEN -->
  <div class="quizOverlay" id="quizOverlay" aria-hidden="true">
    <div class="quizShell">
      <div class="quizTop">
        <div class="left">
          <span class="pill">Quiz <strong id="quizProgress">0/0</strong></span>
          <span class="pill">Skor <strong id="quizScore">0</strong></span>
          <span class="pill">Doƒüru <strong id="quizCorrect">0</strong></span>
          <span class="pill">Yanlƒ±≈ü <strong id="quizWrong">0</strong></span>
        </div>
        <div class="right">
          <select id="quizType" title="Soru tipi">
            <option value="TR2TERM" selected>Anlam ‚Üí Kelime</option>
            <option value="TERM2TR">Kelime ‚Üí Anlam</option>
            <option value="MCQ_TR2TERM">√áoktan se√ßmeli (Anlam‚ÜíKelime)</option>
            <option value="MCQ_TERM2TR">√áoktan se√ßmeli (Kelime‚ÜíAnlam)</option>
          </select>
          <select id="quizScope" title="Kapsam">
            <option value="DUE" selected>Bug√ºn Due</option>
            <option value="VISIBLE">G√∂r√ºnen filtre</option>
            <option value="ALL">T√ºm√º</option>
          </select>
          <button class="btn" id="quizExitBtn">‚úï √áƒ±k</button>
        </div>
      </div>

      <div class="quizCard" id="quizCard">
        <p class="quizSub" id="quizMeta">‚Äî</p>
        <p class="quizQ" id="quizQ">‚Äî</p>

        <div class="options" id="quizOptions" style="display:none;"></div>

        <div class="quizReveal" id="quizReveal">
          <p class="ans" id="quizAnswer">‚Äî</p>
          <p class="ex" id="quizExample">‚Äî</p>
        </div>
      </div>

      <div class="quizBottom">
        <div class="left">
          <button class="btn" id="quizShowBtn">üëÄ Cevabƒ± G√∂ster</button>
          <button class="btn" id="quizPassBtn">‚è≠Ô∏è Pas</button>
        </div>
        <div class="right">
          <button class="btn danger" id="quizWrongBtn">‚úó Yanlƒ±≈ü</button>
          <button class="btn good" id="quizRightBtn">‚úì Doƒüru</button>
          <button class="btn primary" id="quizNextBtn">‚û°Ô∏è Sonraki</button>
        </div>
      </div>

      <div class="quizCard" id="quizSummary" style="display:none;">
        <p class="quizQ" style="margin:0;">Bitti ‚úÖ</p>
        <p class="quizSub" id="quizSummaryText">‚Äî</p>
        <div class="two">
          <div class="listBox" id="knownBox">
            <h3>Bildiklerin</h3>
            <div id="knownList"></div>
          </div>
          <div class="listBox" id="unknownBox">
            <h3>Bilemediklerin</h3>
            <div id="unknownList"></div>
          </div>
        </div>
        <div class="quizBottom" style="margin-top:12px;">
          <div class="left">
            <button class="btn" id="quizAgainWrongBtn">üîÅ Sadece yanlƒ±≈ülarƒ± √ß√∂z</button>
          </div>
          <div class="right">
            <button class="btn primary" id="quizDoneBtn">Tamam</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =======================
       Storage keys (v5)
    ======================= */
    const KEY_ITEMS   = "vocab_pocket_pro_v5_items";
    const KEY_THEME   = "vocab_theme_v1";
    const KEY_LANGS   = "vocab_languages_v2";
    const KEY_STATS   = "vocab_stats_v1";

    const DAY = 24*60*60*1000;
    const now = () => Date.now();
    const clean = (s) => (s ?? "").toString().trim();

    function escapeHtml(str){
      return (str ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[m]));
    }
    function parseTags(input){
      return clean(input).split(",").map(t=>t.trim()).filter(Boolean).slice(0,10);
    }

    /* =======================
       Toast
    ======================= */
    const toastEl = document.getElementById("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display="none", 1600);
    }

    /* =======================
       Languages (multi language)
    ======================= */
    const DEFAULT_LANGS = [
      { code:"EN", name:"English" },
      { code:"RU", name:"–†—É—Å—Å–∫–∏–π" },
      { code:"TR", name:"T√ºrk√ße" }
    ];

    function normalizeLangs(list){
      const map = new Map();
      for(const x of (list||[])){
        const code = clean(x.code).toUpperCase();
        const name = clean(x.name);
        if(!code || code.length < 2 || code.length > 5) continue;
        if(!name) continue;
        map.set(code, {code, name});
      }
      for(const d of DEFAULT_LANGS){
        if(!map.has(d.code)) map.set(d.code, d);
      }
      return Array.from(map.values()).sort((a,b)=>a.code.localeCompare(b.code));
    }
    function loadLangs(){
      try{
        const v = JSON.parse(localStorage.getItem(KEY_LANGS));
        if(Array.isArray(v) && v.length) return normalizeLangs(v);
      }catch{}
      return DEFAULT_LANGS.slice();
    }
    function saveLangs(list){ localStorage.setItem(KEY_LANGS, JSON.stringify(normalizeLangs(list))); }

    /* =======================
       Items + Migration
    ======================= */
    function loadItems(){
      // v5
      try{
        const v = JSON.parse(localStorage.getItem(KEY_ITEMS));
        if(Array.isArray(v)) return v.map(patchItem);
      }catch{}

      // fallback: v4 (your previous)
      try{
        const v4 = JSON.parse(localStorage.getItem("vocab_pocket_pro_v4"));
        if(Array.isArray(v4)){
          const migrated = v4.map(it => patchItem({
            id: it.id,
            sourceLang: (it.lang || "EN"),
            meaningLang: "TR",
            level: it.level || "B1",
            term: it.term,
            meaning: it.meaningTR,
            example: it.example,
            tags: it.tags,
            fav: !!it.fav,
            status: "NEW",
            createdAt: it.createdAt,
            updatedAt: it.updatedAt
          }));
          localStorage.setItem(KEY_ITEMS, JSON.stringify(migrated));
          return migrated;
        }
      }catch{}

      // fallback: v2 original
      try{
        const v2 = JSON.parse(localStorage.getItem("vocab_pocket_pro_v2"));
        if(Array.isArray(v2)){
          const migrated = v2.map(it => patchItem({
            id: it.id,
            sourceLang: (it.lang || "EN"),
            meaningLang: "TR",
            level: it.level || "B1",
            term: it.term,
            meaning: it.meaningTR,
            example: it.example,
            tags: it.tags,
            fav: !!it.fav,
            status: "NEW",
            createdAt: it.createdAt,
            updatedAt: it.updatedAt
          }));
          localStorage.setItem(KEY_ITEMS, JSON.stringify(migrated));
          return migrated;
        }
      }catch{}

      return [];
    }
    function saveItems(items){ localStorage.setItem(KEY_ITEMS, JSON.stringify(items)); }

    function defaultSRS(){
      return {
        ease: 2.0,
        interval: 0,       // days
        dueAt: now(),      // ms
        streak: 0,
        correct: 0,
        wrong: 0,
        lastReviewed: 0
      };
    }

    function patchItem(it){
      const x = {...it};
      x.id = String(x.id || (crypto.randomUUID ? crypto.randomUUID() : String(now()) + Math.random().toString(16).slice(2)));
      x.sourceLang = clean(x.sourceLang || x.lang || "EN").toUpperCase();
      x.meaningLang = clean(x.meaningLang || "TR").toUpperCase();
      x.level = clean(x.level) || "B1";
      x.term = clean(x.term);
      x.meaning = clean(x.meaning || x.meaningTR);
      x.example = clean(x.example);
      x.tags = Array.isArray(x.tags) ? x.tags.map(clean).filter(Boolean).slice(0,10) : parseTags(x.tags||"");
      x.fav = !!x.fav;

      const st = clean(x.status).toUpperCase();
      x.status = (st === "LEARNING" || st === "MASTERED") ? st : "NEW";

      x.srs = x.srs && typeof x.srs === "object" ? {...defaultSRS(), ...x.srs} : defaultSRS();
      x.srs.ease = clamp(Number(x.srs.ease || 2.0), 1.3, 2.6);
      x.srs.interval = Math.max(0, Number(x.srs.interval || 0));
      x.srs.dueAt = Number(x.srs.dueAt || now());
      x.srs.streak = Math.max(0, Number(x.srs.streak || 0));
      x.srs.correct = Math.max(0, Number(x.srs.correct || 0));
      x.srs.wrong = Math.max(0, Number(x.srs.wrong || 0));
      x.srs.lastReviewed = Number(x.srs.lastReviewed || 0);

      x.createdAt = Number(x.createdAt || now());
      x.updatedAt = Number(x.updatedAt || now());
      return x;
    }

    function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }

    /* =======================
       SRS update rules
       - correct => interval grows, ease slightly up, status progresses
       - wrong   => interval reset to 1, ease down, streak reset
       - pass    => small postpone (6h)
    ======================= */
    function srsCorrect(it){
      const s = it.srs;
      s.correct += 1;
      s.streak += 1;
      s.ease = clamp(s.ease + 0.05, 1.3, 2.6);

      if(s.interval === 0) s.interval = 1;
      else if(s.interval === 1) s.interval = 3;
      else s.interval = Math.round(s.interval * s.ease);

      s.dueAt = now() + s.interval * DAY;
      s.lastReviewed = now();

      if(it.status === "NEW") it.status = "LEARNING";
      if(s.streak >= 5 && s.interval >= 14) it.status = "MASTERED";
      it.updatedAt = now();
    }

    function srsWrong(it){
      const s = it.srs;
      s.wrong += 1;
      s.streak = 0;
      s.ease = clamp(s.ease - 0.2, 1.3, 2.6);
      s.interval = 1;
      s.dueAt = now() + 1 * DAY;
      s.lastReviewed = now();
      if(it.status === "MASTERED") it.status = "LEARNING";
      else if(it.status === "NEW") it.status = "LEARNING";
      it.updatedAt = now();
    }

    function srsPass(it){
      const s = it.srs;
      s.dueAt = Math.max(now() + 6*60*60*1000, s.dueAt);
      it.updatedAt = now();
    }

    function isDue(it){ return (it.srs?.dueAt || 0) <= now(); }

    /* =======================
       Search: supports #tag, lang:EN, level:B1
    ======================= */
    function parseAdvancedQuery(q){
      const out = { text: "", tag: null, lang: null, level: null };
      const parts = q.split(/\s+/).filter(Boolean);
      const rest = [];
      for(const p of parts){
        const low = p.toLowerCase();
        if(low.startsWith("#")) out.tag = p.slice(1);
        else if(low.startsWith("lang:")) out.lang = p.slice(5).toUpperCase();
        else if(low.startsWith("level:")) out.level = p.slice(6).toUpperCase();
        else rest.push(p);
      }
      out.text = rest.join(" ").toLowerCase();
      return out;
    }

    function matchesQuery(it, qObj){
      if(qObj.lang && it.sourceLang !== qObj.lang) return false;
      if(qObj.level && (it.level || "B1") !== qObj.level) return false;
      if(qObj.tag && !(it.tags||[]).includes(qObj.tag)) return false;

      if(!qObj.text) return true;
      const hay = (it.term + " " + it.meaning + " " + (it.example||"") + " " + (it.tags||[]).join(" ")).toLowerCase();
      return hay.includes(qObj.text);
    }

    /* =======================
       Theme
    ======================= */
    function applyTheme(t){
      const theme = (t === "emerald" || t === "light") ? t : "dark";
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem(KEY_THEME, theme);
      themeSelect.value = theme;

      // update meta theme-color roughly
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta){
        meta.setAttribute("content", theme === "light" ? "#f6f7fb" : "#0b0b10");
      }
    }

    /* =======================
       Stats history (simple)
    ======================= */
    function loadStats(){
      try{
        const s = JSON.parse(localStorage.getItem(KEY_STATS));
        if(s && typeof s === "object") return s;
      }catch{}
      return { daily: {} }; // daily["YYYY-MM-DD"] = {correct, wrong}
    }
    function saveStats(s){ localStorage.setItem(KEY_STATS, JSON.stringify(s)); }
    function dayKey(ts=now()){
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function bumpDaily(correctDelta, wrongDelta){
      const k = dayKey();
      stats.daily[k] = stats.daily[k] || {correct:0, wrong:0};
      stats.daily[k].correct += correctDelta;
      stats.daily[k].wrong += wrongDelta;
      saveStats(stats);
    }
    function accuracyLastNDays(n=7){
      const keys = [];
      for(let i=0;i<n;i++){
        const t = now() - i*DAY;
        keys.push(dayKey(t));
      }
      let c=0,w=0;
      for(const k of keys){
        const v = stats.daily[k];
        if(!v) continue;
        c += v.correct||0;
        w += v.wrong||0;
      }
      const total = c+w;
      return total ? Math.round((c/total)*100) : 0;
    }

    /* =======================
       UI elements
    ======================= */
    const gridEl = document.getElementById("grid");
    const chipsEl = document.getElementById("chips");
    const dashEl = document.getElementById("dash");

    const searchEl = document.getElementById("search");
    const sortEl = document.getElementById("sort");
    const levelFilterEl = document.getElementById("levelFilter");
    const tagFilterEl = document.getElementById("tagFilter");
    const statusFilterEl = document.getElementById("statusFilter");
    const themeSelect = document.getElementById("themeSelect");

    const countAll = document.getElementById("countAll");
    const countVisible = document.getElementById("countVisible");
    const countDue = document.getElementById("countDue");

    const tagDatalist = document.getElementById("tagDatalist");

    // modal add/edit
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const deleteBtn = document.getElementById("deleteBtn");
    const sourceLangEl = document.getElementById("sourceLang");
    const meaningLangEl = document.getElementById("meaningLang");
    const levelEl = document.getElementById("level");
    const statusEl = document.getElementById("status");
    const termEl = document.getElementById("term");
    const meaningEl = document.getElementById("meaning");
    const exampleEl = document.getElementById("example");
    const tagsEl = document.getElementById("tags");

    // quick add
    const quickModal = document.getElementById("quickModal");
    const quickSourceLang = document.getElementById("quickSourceLang");
    const quickMeaningLang = document.getElementById("quickMeaningLang");
    const quickText = document.getElementById("quickText");

    // language manager
    const langModal = document.getElementById("langModal");
    const langListBox = document.getElementById("langListBox");
    const newLangCode = document.getElementById("newLangCode");
    const newLangName = document.getElementById("newLangName");

    // quiz
    const quizOverlay = document.getElementById("quizOverlay");
    const quizTypeEl = document.getElementById("quizType");
    const quizScopeEl = document.getElementById("quizScope");
    const quizProgressEl = document.getElementById("quizProgress");
    const quizScoreEl = document.getElementById("quizScore");
    const quizCorrectEl = document.getElementById("quizCorrect");
    const quizWrongEl = document.getElementById("quizWrong");

    const quizMetaEl = document.getElementById("quizMeta");
    const quizQEl = document.getElementById("quizQ");
    const quizOptionsEl = document.getElementById("quizOptions");
    const quizRevealEl = document.getElementById("quizReveal");
    const quizAnswerEl = document.getElementById("quizAnswer");
    const quizExampleEl = document.getElementById("quizExample");

    const quizSummaryEl = document.getElementById("quizSummary");
    const quizCardEl = document.getElementById("quizCard");
    const quizSummaryTextEl = document.getElementById("quizSummaryText");
    const knownListEl = document.getElementById("knownList");
    const unknownListEl = document.getElementById("unknownList");

    /* =======================
       State
    ======================= */
    let langs = loadLangs();
    let items = loadItems();
    let stats = loadStats();

    let editingId = null;

    let filterLang = "ALL";
    let levelFilter = "ALL";
    let tagFilter = "ALL";
    let statusFilter = "ALL";

    // quiz state
    let quiz = {
      on:false,
      pool:[],
      idx:0,
      score:0,
      correct:0,
      wrong:0,
      current:null,
      knownIds:new Set(),
      unknownIds:new Set(),
      onlyWrongMode:false,
      wrongPoolIds:[]
    };

    /* =======================
       Build selects and chips
    ======================= */
    function renderLangSelects(){
      const opts = langs.map(l=>`<option value="${l.code}">${escapeHtml(l.name)} (${escapeHtml(l.code)})</option>`).join("");
      sourceLangEl.innerHTML = opts;
      meaningLangEl.innerHTML = opts;
      quickSourceLang.innerHTML = opts;
      quickMeaningLang.innerHTML = opts;

      if(langs.some(x=>x.code==="EN")) sourceLangEl.value="EN"; else sourceLangEl.value=langs[0]?.code||"EN";
      if(langs.some(x=>x.code==="TR")) meaningLangEl.value="TR"; else meaningLangEl.value=langs[0]?.code||"TR";

      quickSourceLang.value = sourceLangEl.value;
      quickMeaningLang.value = meaningLangEl.value;
    }

    function renderChips(){
      chipsEl.innerHTML = "";
      function chip(label, value){
        const b = document.createElement("button");
        b.className = "chip" + (filterLang === value ? " active" : "");
        b.textContent = label;
        b.addEventListener("click", ()=>{
          filterLang = value;
          renderChips();
          render();
        });
        chipsEl.appendChild(b);
      }
      chip("T√ºm√º", "ALL");
      for(const l of langs){
        chip(l.name, l.code);
      }
    }

    function renderLangListBox(){
      langListBox.textContent = langs.map(l=>`‚Ä¢ ${l.code} ‚Äî ${l.name}`).join("\n") || "‚Äî";
    }

    function updateTagDatalist(){
      const set = new Set();
      for(const it of items){
        for(const t of (it.tags||[])) set.add(t);
      }
      const list = Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
      tagDatalist.innerHTML = list.map(t=>`<option value="${escapeHtml(t)}"></option>`).join("");
    }

    function updateTagFilterOptions(){
      const set = new Set();
      for(const it of items){
        for(const t of (it.tags||[])) set.add(t);
      }
      const list = Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
      const prev = tagFilterEl.value || "ALL";
      tagFilterEl.innerHTML = `<option value="ALL">Etiket: T√ºm√º</option>` + list.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml("#"+t)}</option>`).join("");
      if(list.includes(prev)) tagFilterEl.value = prev;
      else tagFilterEl.value = "ALL";
      tagFilter = tagFilterEl.value;
    }

    /* =======================
       View pipeline
    ======================= */
    function applyFilters(arr){
      let out = [...arr];

      // chip lang filter (sourceLang)
      if(filterLang !== "ALL") out = out.filter(x=>x.sourceLang === filterLang);

      // dropdown filters
      if(levelFilter !== "ALL") out = out.filter(x=>(x.level||"B1") === levelFilter);
      if(tagFilter !== "ALL") out = out.filter(x=>(x.tags||[]).includes(tagFilter));
      if(statusFilter === "NEW") out = out.filter(x=>x.status==="NEW");
      else if(statusFilter === "LEARNING") out = out.filter(x=>x.status==="LEARNING");
      else if(statusFilter === "MASTERED") out = out.filter(x=>x.status==="MASTERED");
      else if(statusFilter === "DUE") out = out.filter(x=>isDue(x));

      // search (advanced)
      const q = searchEl.value.trim();
      const qObj = parseAdvancedQuery(q);
      if(q || qObj.tag || qObj.lang || qObj.level){
        out = out.filter(it=>matchesQuery(it, qObj));
      }

      return out;
    }

    function applySort(arr){
      const s = sortEl.value;
      const copy = [...arr];
      if(s === "due"){
        copy.sort((a,b)=>{
          const ad = (a.srs?.dueAt||0), bd = (b.srs?.dueAt||0);
          if(ad !== bd) return ad - bd;
          return (b.updatedAt||0) - (a.updatedAt||0);
        });
      } else if(s === "updated"){
        copy.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      } else if(s === "created"){
        copy.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      } else if(s === "az"){
        copy.sort((a,b)=> (a.term||"").localeCompare(b.term||"", undefined, {sensitivity:"base"}));
      } else if(s === "za"){
        copy.sort((a,b)=> (b.term||"").localeCompare(a.term||"", undefined, {sensitivity:"base"}));
      }
      return copy;
    }

    function getVisibleItems(){
      let v = applyFilters(items);
      v = applySort(v);
      return v;
    }

    /* =======================
       Dashboard + stats
    ======================= */
    function renderDash(){
      const total = items.length;
      const due = items.filter(isDue).length;
      const mastered = items.filter(x=>x.status==="MASTERED").length;
      const learning = items.filter(x=>x.status==="LEARNING").length;
      const acc7 = accuracyLastNDays(7);

      dashEl.innerHTML = `
        <span class="pill">√ñƒüreniliyor <strong>${learning}</strong></span>
        <span class="pill">√ñƒürenildi <strong>${mastered}</strong></span>
        <span class="pill">7g doƒüruluk <strong>${acc7}%</strong></span>
        <span class="pill">Due <strong>${due}</strong></span>
      `;
    }

    /* =======================
       Render cards + auto-fit flip height + swipe
    ======================= */
    function statusLabel(st){
      if(st==="NEW") return ["Yeni","new"];
      if(st==="MASTERED") return ["√ñƒürenildi","mastered"];
      return ["√ñƒüreniliyor","learning"];
    }

    function render(){
      const due = items.filter(isDue).length;
      countAll.textContent = items.length;
      countDue.textContent = due;

      const view = getVisibleItems();
      countVisible.textContent = view.length;

      updateTagDatalist();
      updateTagFilterOptions();
      renderDash();

      gridEl.innerHTML = "";

      if(view.length === 0){
        gridEl.innerHTML = `
          <div class="card">
            <div class="cardFlipWrap">
              <div class="cardFlip">
                <div class="face">
                  <div class="meta">
                    <span class="badge"><span class="dot"></span> ƒ∞pucu</span>
                  </div>
                  <p class="term">Kayƒ±t yok</p>
                  <p class="example">Yeni kelime eklemek i√ßin <b>Ôºã Ekle</b> veya <b>‚ö° Hƒ±zlƒ± Ekle</b> kullan.</p>
                  <div class="tags">
                    <span class="tag">SRS</span>
                    <span class="tag">Quiz</span>
                    <span class="tag">Dil</span>
                    <span class="tag">Etiket</span>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
        return;
      }

      for(const it of view){
        const sourceName = (langs.find(x=>x.code===it.sourceLang)?.name) || it.sourceLang;
        const meaningName = (langs.find(x=>x.code===it.meaningLang)?.name) || it.meaningLang;

        const [stText, stClass] = statusLabel(it.status);
        const dueTxt = isDue(it) ? "Due" : `Due: ${new Date(it.srs.dueAt).toLocaleDateString("tr-TR")}`;

        const tagsHtml = (it.tags||[]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join("");

        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = it.id;

        card.innerHTML = `
          <div class="cardFlipWrap">
            <div class="cardFlip" data-id="${it.id}">
              <div class="face front">
                <div class="meta">
                  <span class="badge">
                    <span class="dot"></span>
                    ${escapeHtml(it.sourceLang)} ‚Ä¢ ${escapeHtml(it.level||"B1")}
                  </span>
                  <div class="star ${it.fav ? "on":""}" data-action="fav" title="Favori">
                    ${it.fav ? "‚òÖ" : "‚òÜ"}
                  </div>
                </div>

                <p class="term">${escapeHtml(it.term)}</p>
                <p class="example">${escapeHtml(it.example || "Karta dokun ‚Üí √ßevir")}</p>

                <div class="miniStats">
                  <span class="statusPill ${stClass}">${stText}</span>
                  <span class="statusPill">${escapeHtml(sourceName)} ‚Üí ${escapeHtml(meaningName)}</span>
                  <span class="statusPill">${escapeHtml(dueTxt)}</span>
                </div>

                <div class="tags">
                  ${tagsHtml || `<span class="tag">#etiket</span>`}
                </div>
              </div>

              <div class="face back">
                <div class="meta">
                  <span class="badge">
                    <span class="dot"></span>
                    Anlam (${escapeHtml(it.meaningLang)})
                  </span>
                  <div class="star ${it.fav ? "on":""}" data-action="fav" title="Favori">
                    ${it.fav ? "‚òÖ" : "‚òÜ"}
                  </div>
                </div>

                <p class="term">${escapeHtml(it.meaning)}</p>
                <p class="example" style="-webkit-line-clamp:4">${escapeHtml(it.example || "")}</p>

                <div class="tags">
                  <span class="tag">${escapeHtml(it.sourceLang)} ‚Ä¢ ${escapeHtml(it.level||"B1")} ‚Ä¢ ${stText}</span>
                  ${tagsHtml}
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" data-action="flip" data-id="${it.id}">‚Ü∫ √áevir</button>
            <button class="btn" data-action="edit" data-id="${it.id}">‚úé D√ºzenle</button>
            <button class="btn danger" data-action="delete" data-id="${it.id}">üóëÔ∏è Sil</button>
          </div>
        `;

        gridEl.appendChild(card);
      }

      // auto-fit flip heights after render
      requestAnimationFrame(autoFitFlipHeights);

      // init swipe on cards
      initSwipeHandlers();
    }

    function autoFitFlipHeights(){
      const cards = document.querySelectorAll(".card");
      for(const c of cards){
        const wrap = c.querySelector(".cardFlipWrap");
        const front = c.querySelector(".face.front");
        const back  = c.querySelector(".face.back");
        if(!wrap || !front || !back) continue;

        // Temporarily ensure both visible for measurement
        const flip = c.querySelector(".cardFlip");
        const wasFlipped = flip.classList.contains("flipped");

        flip.classList.remove("flipped");
        const h1 = front.scrollHeight;

        flip.classList.add("flipped");
        const h2 = back.scrollHeight;

        if(!wasFlipped) flip.classList.remove("flipped");

        const target = Math.max(h1, h2, 240);
        wrap.style.height = (target + 4) + "px";
      }
    }

    /* =======================
       Swipe gestures
       right: fav, left: delete, up: flip
    ======================= */
    function initSwipeHandlers(){
      const cards = document.querySelectorAll(".card");
      for(const card of cards){
        if(card._swipeBound) continue;
        card._swipeBound = true;

        let sx=0, sy=0, st=0, moved=false;

        card.addEventListener("touchstart", (e)=>{
          const t = e.touches[0];
          sx = t.clientX; sy = t.clientY; st = now();
          moved = false;
        }, {passive:true});

        card.addEventListener("touchmove", (e)=>{
          moved = true;
        }, {passive:true});

        card.addEventListener("touchend", (e)=>{
          const t = e.changedTouches[0];
          const dx = t.clientX - sx;
          const dy = t.clientY - sy;
          const dt = now() - st;

          if(!moved || dt > 650) return; // ignore long presses

          const absX = Math.abs(dx);
          const absY = Math.abs(dy);

          const id = card.dataset.id;
          if(!id) return;

          // swipe up
          if(absY > absX && dy < -55){
            const flipEl = document.querySelector(`.cardFlip[data-id="${id}"]`);
            if(flipEl) flipEl.classList.toggle("flipped");
            return;
          }

          // horizontal swipes
          if(absX > absY && absX > 70){
            if(dx > 0){
              toggleFav(id, true);
            } else {
              deleteById(id);
            }
          }
        }, {passive:true});
      }
    }

    /* =======================
       Modal Add/Edit
    ======================= */
    function openAdd(){
      editingId = null;
      modalTitle.textContent = "Kelime Ekle";
      deleteBtn.style.display = "none";

      renderLangSelects();

      // defaults
      sourceLangEl.value = langs.some(x=>x.code==="EN") ? "EN" : (langs[0]?.code||"EN");
      meaningLangEl.value = langs.some(x=>x.code==="TR") ? "TR" : (langs[0]?.code||"TR");
      levelEl.value = "B1";
      statusEl.value = "NEW";
      termEl.value = "";
      meaningEl.value = "";
      exampleEl.value = "";
      tagsEl.value = "";

      modal.showModal();
      setTimeout(()=>termEl.focus(), 50);
    }

    function openEdit(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;

      editingId = id;
      modalTitle.textContent = "Kelime D√ºzenle";
      deleteBtn.style.display = "inline-flex";

      renderLangSelects();

      sourceLangEl.value = it.sourceLang;
      meaningLangEl.value = it.meaningLang;
      levelEl.value = it.level || "B1";
      statusEl.value = it.status || "NEW";
      termEl.value = it.term || "";
      meaningEl.value = it.meaning || "";
      exampleEl.value = it.example || "";
      tagsEl.value = (it.tags||[]).join(", ");

      modal.showModal();
      setTimeout(()=>termEl.focus(), 50);
    }

    function upsert(){
      const sourceLang = (sourceLangEl.value || "EN").toUpperCase();
      const meaningLang = (meaningLangEl.value || "TR").toUpperCase();
      const level = levelEl.value || "B1";
      const status = (statusEl.value || "NEW").toUpperCase();

      const term = clean(termEl.value);
      const meaning = clean(meaningEl.value);
      const example = clean(exampleEl.value);
      const tags = parseTags(tagsEl.value);

      if(!term || !meaning){
        toast("Kelime ve anlam zorunlu.");
        return;
      }

      const t = now();

      if(editingId){
        const it = items.find(x=>x.id===editingId);
        if(!it) return;

        it.sourceLang = sourceLang;
        it.meaningLang = meaningLang;
        it.level = level;
        it.status = (status==="LEARNING"||status==="MASTERED") ? status : "NEW";
        it.term = term;
        it.meaning = meaning;
        it.example = example;
        it.tags = tags;
        it.updatedAt = t;

        toast("G√ºncellendi ‚úÖ");
      } else {
        const id = (crypto.randomUUID ? crypto.randomUUID() : String(t) + Math.random().toString(16).slice(2));
        const it = patchItem({
          id, sourceLang, meaningLang, level, status,
          term, meaning, example, tags,
          fav:false,
          createdAt:t, updatedAt:t
        });
        // new items should be due now for initial learning
        it.srs.dueAt = now();
        items.push(it);
        toast("Eklendi ‚úÖ");
      }

      saveItems(items);
      modal.close();
      render();
    }

    function deleteById(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      if(confirm(`Silinsin mi?\n\n${it.term} (${it.sourceLang})`)){
        items = items.filter(x=>x.id!==id);
        saveItems(items);
        toast("Silindi üóëÔ∏è");
        render();
      }
    }

    function toggleFav(id, fromSwipe=false){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      it.fav = !it.fav;
      it.updatedAt = now();
      saveItems(items);
      toast(it.fav ? "Favori ‚òÖ" : "Favori kaldƒ±rƒ±ldƒ± ‚òÜ");
      if(fromSwipe) render();
      else render();
    }

    /* =======================
       Quick add
    ======================= */
    function openQuick(){
      renderLangSelects();
      quickSourceLang.value = langs.some(x=>x.code==="EN") ? "EN" : (langs[0]?.code||"EN");
      quickMeaningLang.value = langs.some(x=>x.code==="TR") ? "TR" : (langs[0]?.code||"TR");
      quickText.value = "";
      quickModal.showModal();
      setTimeout(()=>quickText.focus(), 50);
    }

    function quickParseLine(line){
      // supports "-" or "|" as separators
      const raw = line.trim();
      if(!raw) return null;
      const sep = raw.includes("|") ? "|" : "-";
      const parts = raw.split(sep).map(x=>x.trim()).filter(Boolean);

      const term = parts[0] || "";
      const meaning = parts[1] || "";
      let level = "B1";
      let tags = [];
      if(parts[2] && /^[ABC][12]$/i.test(parts[2])) level = parts[2].toUpperCase();
      if(parts[3]) tags = parseTags(parts.slice(3).join(","));
      return {term, meaning, level, tags};
    }

    function saveQuick(){
      const src = (quickSourceLang.value || "EN").toUpperCase();
      const trg = (quickMeaningLang.value || "TR").toUpperCase();
      const lines = quickText.value.split("\n").map(x=>x.trim()).filter(Boolean);
      if(lines.length === 0){ toast("En az 1 satƒ±r yaz."); return; }

      let added = 0;
      const t = now();

      for(const line of lines){
        const p = quickParseLine(line);
        if(!p || !p.term || !p.meaning) continue;

        const it = patchItem({
          sourceLang: src,
          meaningLang: trg,
          level: p.level || "B1",
          status: "NEW",
          term: p.term,
          meaning: p.meaning,
          example: "",
          tags: p.tags || [],
          fav:false,
          createdAt: t,
          updatedAt: t
        });
        it.srs.dueAt = now();
        items.push(it);
        added++;
      }

      saveItems(items);
      toast(`Eklendi ‚úÖ (${added})`);
      quickModal.close();
      render();
    }

    /* =======================
       Languages modal
    ======================= */
    function openLangModal(){
      renderLangListBox();
      newLangCode.value = "";
      newLangName.value = "";
      langModal.showModal();
      setTimeout(()=>newLangCode.focus(), 50);
    }

    function addLanguage(){
      const code = clean(newLangCode.value).toUpperCase();
      const name = clean(newLangName.value);
      if(!code || code.length < 2 || code.length > 5){ toast("Dil kodu 2-5 harf olmalƒ±."); return; }
      if(!name){ toast("Dil adƒ± bo≈ü olamaz."); return; }

      langs = normalizeLangs([...langs, {code, name}]);
      saveLangs(langs);
      toast("Dil eklendi ‚úÖ");
      renderLangListBox();
      renderLangSelects();
      renderChips();
      render();
    }

    function resetLanguages(){
      if(confirm("Diller varsayƒ±lanlara d√∂necek (EN/RU/TR). Emin misin?")){
        langs = DEFAULT_LANGS.slice();
        saveLangs(langs);
        toast("Sƒ±fƒ±rlandƒ± ‚úÖ");
        renderLangListBox();
        renderLangSelects();
        renderChips();
        render();
      }
    }

    /* =======================
       Quiz (fullscreen)
    ======================= */
    function buildQuizPool(scope){
      if(scope === "ALL") return [...items];
      if(scope === "VISIBLE") return getVisibleItems();
      // DUE
      const due = items.filter(isDue);
      return due.length ? due : items; // if no due, fall back to all
    }

    function quizOpen(){
      quiz.on = true;
      quiz.onlyWrongMode = false;
      quiz.knownIds = new Set();
      quiz.unknownIds = new Set();
      quiz.idx = 0;
      quiz.score = 0;
      quiz.correct = 0;
      quiz.wrong = 0;
      quiz.current = null;

      quiz.pool = shuffle(buildQuizPool(quizScopeEl.value)).slice(0, 50); // max 50 per session
      if(quiz.pool.length === 0){
        toast("Quiz i√ßin kayƒ±t lazƒ±m.");
        return;
      }

      quizOverlay.classList.add("on");
      quizOverlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";

      quizSummaryEl.style.display = "none";
      quizCardEl.style.display = "flex";

      nextQuestion();
    }

    function quizClose(){
      quiz.on = false;
      quizOverlay.classList.remove("on");
      quizOverlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      quizRevealEl.classList.remove("on");
      quizOptionsEl.style.display = "none";
      quizOptionsEl.innerHTML = "";
      render(); // update due, status etc.
    }

    function shuffle(a){
      const arr = [...a];
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function quizUpdateTop(){
      quizProgressEl.textContent = `${Math.min(quiz.idx+1, quiz.pool.length)}/${quiz.pool.length}`;
      quizScoreEl.textContent = String(quiz.score);
      quizCorrectEl.textContent = String(quiz.correct);
      quizWrongEl.textContent = String(quiz.wrong);
    }

    function formatLangName(code){
      return (langs.find(x=>x.code===code)?.name) || code;
    }

    function makeOptions(correctText, poolTexts){
      // pick 3 unique distractors
      const uniq = Array.from(new Set(poolTexts.filter(Boolean).filter(t=>t!==correctText)));
      const picks = shuffle(uniq).slice(0,3);
      const opts = shuffle([correctText, ...picks]);
      return opts;
    }

    function nextQuestion(){
      if(quiz.idx >= quiz.pool.length){
        return quizFinish();
      }

      quiz.current = quiz.pool[quiz.idx];
      quizRevealEl.classList.remove("on");
      quizOptionsEl.style.display = "none";
      quizOptionsEl.innerHTML = "";

      const it = quiz.current;
      const t = quizTypeEl.value;

      const meta = `${it.sourceLang} (${formatLangName(it.sourceLang)})  ‚Ä¢  Anlam: ${it.meaningLang} (${formatLangName(it.meaningLang)})  ‚Ä¢  Seviye: ${it.level}  ‚Ä¢  Durum: ${it.status}`;
      quizMetaEl.textContent = meta;

      // set question + answer by mode
      let questionText = "";
      let answerText = "";
      let options = null;

      if(t === "TR2TERM"){
        questionText = it.meaning;
        answerText = it.term;
      } else if(t === "TERM2TR"){
        questionText = it.term;
        answerText = it.meaning;
      } else if(t === "MCQ_TR2TERM"){
        questionText = it.meaning;
        answerText = it.term;
        const poolTerms = quiz.pool.map(x=>x.term);
        options = makeOptions(answerText, poolTerms);
      } else if(t === "MCQ_TERM2TR"){
        questionText = it.term;
        answerText = it.meaning;
        const poolMeanings = quiz.pool.map(x=>x.meaning);
        options = makeOptions(answerText, poolMeanings);
      }

      quizQEl.textContent = questionText || "‚Äî";
      quizAnswerEl.textContent = answerText || "‚Äî";
      quizExampleEl.textContent = it.example ? `√ñrnek: ${it.example}` : "√ñrnek yok.";

      if(options){
        quizOptionsEl.style.display = "grid";
        quizOptionsEl.innerHTML = options.map(o=>`<button class="opt" data-opt="${escapeHtml(o)}" type="button">${escapeHtml(o)}</button>`).join("");
      }

      quizUpdateTop();
    }

    function quizShowAnswer(){
      quizRevealEl.classList.add("on");
    }

    function quizMarkCorrect(){
      const it = quiz.current;
      if(!it) return;

      quiz.correct += 1;
      quiz.score += 1;
      quiz.knownIds.add(it.id);

      // SRS update
      srsCorrect(it);
      bumpDaily(1,0);

      saveItems(items);

      quizUpdateTop();
    }

    function quizMarkWrong(){
      const it = quiz.current;
      if(!it) return;

      quiz.wrong += 1;
      quiz.score = Math.max(0, quiz.score - 1);
      quiz.unknownIds.add(it.id);

      // SRS update
      srsWrong(it);
      bumpDaily(0,1);

      saveItems(items);

      quizUpdateTop();
    }

    function quizPass(){
      const it = quiz.current;
      if(!it) return;
      srsPass(it);
      saveItems(items);
      toast("Pas ‚è≠Ô∏è");
    }

    function quizNext(){
      quiz.idx += 1;
      nextQuestion();
    }

    function quizFinish(){
      quizCardEl.style.display = "none";
      quizSummaryEl.style.display = "block";

      const total = quiz.pool.length;
      const known = Array.from(quiz.knownIds);
      const unknown = Array.from(quiz.unknownIds);

      quizSummaryTextEl.textContent = `Toplam: ${total} ‚Ä¢ Doƒüru: ${quiz.correct} ‚Ä¢ Yanlƒ±≈ü: ${quiz.wrong} ‚Ä¢ Skor: ${quiz.score}`;

      knownListEl.innerHTML = known.length
        ? known.map(id => {
            const it = items.find(x=>x.id===id);
            if(!it) return "";
            return `<div class="item"><span><b>${escapeHtml(it.term)}</b> ‚Äî ${escapeHtml(it.meaning)}</span><span class="statusPill">${escapeHtml(it.level)}</span></div>`;
          }).join("")
        : `<div class="quizSub">‚Äî</div>`;

      unknownListEl.innerHTML = unknown.length
        ? unknown.map(id => {
            const it = items.find(x=>x.id===id);
            if(!it) return "";
            return `<div class="item"><span><b>${escapeHtml(it.term)}</b> ‚Äî ${escapeHtml(it.meaning)}</span><span class="statusPill">${escapeHtml(it.level)}</span></div>`;
          }).join("")
        : `<div class="quizSub">‚Äî</div>`;

      quiz.wrongPoolIds = unknown;
      quizUpdateTop();
    }

    function quizAgainWrong(){
      if(!quiz.wrongPoolIds || quiz.wrongPoolIds.length === 0){
        toast("Yanlƒ±≈ü yok ‚úÖ");
        return;
      }
      quiz.onlyWrongMode = true;
      quiz.pool = shuffle(quiz.wrongPoolIds.map(id => items.find(x=>x.id===id)).filter(Boolean));
      quiz.idx = 0;
      quiz.score = 0;
      quiz.correct = 0;
      quiz.wrong = 0;
      quiz.knownIds = new Set();
      quiz.unknownIds = new Set();

      quizSummaryEl.style.display = "none";
      quizCardEl.style.display = "flex";
      nextQuestion();
    }

    /* =======================
       Quiz MCQ click handler
    ======================= */
    quizOptionsEl.addEventListener("click", (e)=>{
      const btn = e.target.closest(".opt");
      if(!btn) return;

      const picked = btn.textContent;
      const correct = quizAnswerEl.textContent;

      // lock answers: paint options
      for(const b of quizOptionsEl.querySelectorAll(".opt")){
        if(b.textContent === correct) b.classList.add("good");
        else if(b.textContent === picked) b.classList.add("bad");
        b.disabled = true;
      }

      // auto reveal
      quizRevealEl.classList.add("on");

      // auto mark
      if(picked === correct) quizMarkCorrect();
      else quizMarkWrong();
    });

    /* =======================
       Events
    ======================= */
    // top buttons
    document.getElementById("addBtn").addEventListener("click", openAdd);
    document.getElementById("quickBtn").addEventListener("click", openQuick);
    document.getElementById("langManageBtn").addEventListener("click", openLangModal);
    document.getElementById("quizBtn").addEventListener("click", quizOpen);

    // modal add/edit
    document.getElementById("cancelBtn").addEventListener("click", ()=>modal.close());
    document.getElementById("closeBtn").addEventListener("click", ()=>modal.close());
    document.getElementById("saveBtn").addEventListener("click", upsert);

    deleteBtn.addEventListener("click", ()=>{
      if(editingId) deleteById(editingId);
      modal.close();
    });

    // quick modal
    document.getElementById("quickCloseBtn").addEventListener("click", ()=>quickModal.close());
    document.getElementById("quickCancelBtn").addEventListener("click", ()=>quickModal.close());
    document.getElementById("quickSaveBtn").addEventListener("click", saveQuick);

    // language modal
    document.getElementById("langCloseBtn").addEventListener("click", ()=>langModal.close());
    document.getElementById("langDoneBtn").addEventListener("click", ()=>langModal.close());
    document.getElementById("addLangBtn").addEventListener("click", addLanguage);
    document.getElementById("resetLangBtn").addEventListener("click", resetLanguages);

    // filters
    searchEl.addEventListener("input", render);
    sortEl.addEventListener("change", render);
    levelFilterEl.addEventListener("change", ()=>{ levelFilter = levelFilterEl.value; render(); });
    tagFilterEl.addEventListener("change", ()=>{ tagFilter = tagFilterEl.value; render(); });
    statusFilterEl.addEventListener("change", ()=>{ statusFilter = statusFilterEl.value; render(); });

    themeSelect.addEventListener("change", (e)=> applyTheme(e.target.value));

    // card click actions + flip on tap
    gridEl.addEventListener("click", (e)=>{
      const actionBtn = e.target.closest("[data-action]");
      if(actionBtn){
        const action = actionBtn.dataset.action;
        const id = actionBtn.dataset.id || e.target.closest(".card")?.dataset.id;
        if(!id) return;

        if(action === "flip"){
          const flipEl = document.querySelector(`.cardFlip[data-id="${id}"]`);
          if(flipEl) flipEl.classList.toggle("flipped");
          return;
        }
        if(action === "edit"){ openEdit(id); return; }
        if(action === "delete"){ deleteById(id); return; }
        if(action === "fav"){ toggleFav(id); return; }
      }

      const flipEl = e.target.closest(".cardFlip");
      if(flipEl && !e.target.closest(".actions") && !e.target.closest(".star")){
        flipEl.classList.toggle("flipped");
      }
    });

    // wipe
    document.getElementById("wipeBtn").addEventListener("click", ()=>{
      if(items.length === 0) return toast("Zaten bo≈ü.");
      if(confirm("T√ºm kelimeler silinecek. Emin misin?")){
        items = [];
        saveItems(items);
        toast("Hepsi silindi üóëÔ∏è");
        render();
      }
    });

    // quiz buttons
    document.getElementById("quizExitBtn").addEventListener("click", quizClose);
    document.getElementById("quizShowBtn").addEventListener("click", quizShowAnswer);
    document.getElementById("quizPassBtn").addEventListener("click", ()=>{ quizPass(); quizNext(); });

    document.getElementById("quizRightBtn").addEventListener("click", ()=>{
      // if MCQ, allow manual too (after reveal)
      quizRevealEl.classList.add("on");
      quizMarkCorrect();
    });
    document.getElementById("quizWrongBtn").addEventListener("click", ()=>{
      quizRevealEl.classList.add("on");
      quizMarkWrong();
    });
    document.getElementById("quizNextBtn").addEventListener("click", quizNext);

    document.getElementById("quizDoneBtn").addEventListener("click", quizClose);
    document.getElementById("quizAgainWrongBtn").addEventListener("click", quizAgainWrong);

    // when quiz type/scope changes mid-session, restart clean
    quizTypeEl.addEventListener("change", ()=>{ if(quiz.on) { quiz.idx = 0; quiz.pool = shuffle(buildQuizPool(quizScopeEl.value)).slice(0,50); nextQuestion(); } });
    quizScopeEl.addEventListener("change", ()=>{ if(quiz.on) { quiz.idx = 0; quiz.pool = shuffle(buildQuizPool(quizScopeEl.value)).slice(0,50); nextQuestion(); } });

    /* =======================
       PWA improvements (simple)
       - runtime manifest
       - offline cache (service worker via blob)
    ======================= */
    function setupManifest(){
      const manifest = {
        name: "Vocab Pocket Pro",
        short_name: "VocabPocket",
        start_url: ".",
        display: "standalone",
        background_color: "#0b0b10",
        theme_color: "#0b0b10",
        icons: []
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("manifestLink");
      if(link) link.href = url;
    }

    async function setupServiceWorker(){
      if(!("serviceWorker" in navigator)) return;

      const swCode = `
        const CACHE = "vocab-pocket-pro-cache-v1";
        self.addEventListener("install", (e)=>{
          e.waitUntil(
            caches.open(CACHE).then(cache => cache.addAll(["./"]))
          );
          self.skipWaiting();
        });
        self.addEventListener("activate", (e)=>{
          e.waitUntil(self.clients.claim());
        });
        self.addEventListener("fetch", (e)=>{
          const req = e.request;
          e.respondWith(
            caches.match(req).then(cached => cached || fetch(req).then(res => {
              const copy = res.clone();
              caches.open(CACHE).then(c => c.put(req, copy)).catch(()=>{});
              return res;
            }).catch(()=>cached))
          );
        });
      `;
      const blob = new Blob([swCode], {type:"text/javascript"});
      const swUrl = URL.createObjectURL(blob);
      try{
        await navigator.serviceWorker.register(swUrl, {scope:"./"});
      }catch{}
    }

    /* =======================
       Init
    ======================= */
    function init(){
      langs = loadLangs();
      saveLangs(langs);

      items = items.map(patchItem);
      saveItems(items);

      renderLangSelects();
      renderLangListBox();
      renderChips();

      applyTheme(localStorage.getItem(KEY_THEME) || "dark");

      levelFilter = levelFilterEl.value;
      tagFilter = tagFilterEl.value;
      statusFilter = statusFilterEl.value;

      setupManifest();
      setupServiceWorker();

      render();
    }
    init();
  </script>
</body>
</html>
