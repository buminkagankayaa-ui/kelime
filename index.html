<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Vocab Pocket</title>

  <meta name="theme-color" content="#0b0b10" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <style>
    :root{
      --bg:#0b0b10; --panel:#12121a; --card:#151523; --card2:#17172a;
      --line:#23233a; --text:#f2f2f7; --muted:#a6a6bb;
      --accent:#7c3aed; --accent2:#22c55e; --danger:#fb7185; --warn:#fbbf24;
      --shadow: 0 10px 40px rgba(0,0,0,0.5);
      --radius:16px;
      --headerTop: rgba(11,11,16,.98); --headerBottom: rgba(11,11,16,.90);
      --inputBg: rgba(21,21,35,.85);
    }
    body[data-theme="light"]{
      --bg:#f2f2f7; --panel:#ffffff; --card:#ffffff; --card2:#f0f0f5;
      --line:#d1d1d6; --text:#000000; --muted:#8e8e93;
      --accent:#007aff; --accent2:#34c759;
      --headerTop: rgba(242,242,247,.98); --headerBottom: rgba(242,242,247,.90);
      --inputBg: rgba(255,255,255,.95);
    }

    *{box-sizing:border-box}
    body{
      margin:0; background: var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      padding: env(safe-area-inset-top) 16px 100px 16px;
      -webkit-tap-highlight-color: transparent; overflow-x: hidden;
    }

    /* HEADER */
    header{
      position:sticky; top:0; z-index:40;
      background: linear-gradient(to bottom, var(--headerTop), var(--headerBottom));
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      padding: 12px 0; margin: -16px -16px 16px -16px; padding-left:16px; padding-right:16px;
      border-bottom: 1px solid var(--line);
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 12px;}
    .brand h1{ margin:0; font-size:22px; font-weight: 800; letter-spacing:-0.5px; }

    /* LANGUAGE SELECTOR (HERO) */
    .lang-hero {
        background: var(--panel); border: 1px solid var(--line); border-radius: 12px;
        padding: 4px; display: flex; align-items: center; width: fit-content;
    }
    .lang-hero select {
        background: transparent; border: none; font-weight: 700; font-size: 14px;
        padding: 6px 12px; color: var(--accent); cursor: pointer; width: auto;
    }

    .row{ display:flex; gap:8px; align-items:center; }

    /* BUTTONS */
    .btn{
      border:1px solid var(--line); background: rgba(255,255,255,.05); color:var(--text);
      width: 40px; height: 40px; border-radius:12px; font-weight:700; font-size:16px;
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; transition:transform 0.1s; user-select:none; padding: 0;
    }
    .btn:active{ transform:scale(0.95); }
    .btn.primary{ border-color:transparent; background: var(--accent); color:#fff; width: auto; padding: 0 16px; }
    .btn.text-btn { width: auto; padding: 0 12px; font-size: 13px; }
    
    /* INPUTS */
    .input, select, textarea{
      width:100%; border:1px solid var(--line); background: var(--inputBg); color:var(--text);
      padding:12px; border-radius:12px; outline:none; font-size:15px; appearance: none;
    }
    
    /* FILTERS SCROLL */
    .filters{ display:flex; gap:8px; overflow-x:auto; padding-bottom:5px; margin-top: 8px;}
    .filters::-webkit-scrollbar { display:none; }
    .filters select { min-width: 100px; padding: 8px 12px; font-size: 13px; height: 36px;}

    /* STATS BAR */
    .stats-bar {
        display: flex; gap: 15px; margin-top: 10px; padding: 10px;
        background: var(--panel); border-radius: 12px; border: 1px solid var(--line);
        font-size: 12px; color: var(--muted); justify-content: space-around;
    }
    .stat-item b { color: var(--text); font-size: 14px; display: block; text-align: center;}

    /* CARDS */
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:16px; margin-top:16px; }
    .card{ position:relative; perspective:1000px; touch-action: pan-y; user-select:none; }
    
    .cardFlipWrap{ position:relative; width:100%; min-height:220px; transform-style:preserve-3d; transition:height 0.3s; }
    .cardFlip{
      position:absolute; inset:0; transform-style:preserve-3d; transition:transform 0.6s cubic-bezier(0.175,0.885,0.32,1.275);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .cardFlip.flipped{ transform: rotateY(180deg); }
    
    .face{
      position:absolute; inset:0; backface-visibility:hidden; -webkit-backface-visibility:hidden;
      background: linear-gradient(145deg, var(--card), var(--panel)); border:1px solid var(--line);
      border-radius:var(--radius); padding:16px; display:flex; flex-direction:column;
    }
    .face.back{ transform: rotateY(180deg); background: linear-gradient(145deg, var(--card2), var(--panel)); }

    /* CARD INTERNAL */
    .meta{ display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;}
    .badge{ font-size:10px; font-weight:700; color:var(--muted); background:rgba(255,255,255,0.05); padding:4px 8px; border-radius:6px; text-transform: uppercase; letter-spacing: 0.5px;}
    
    .term{ font-size:26px; font-weight:800; margin:10px 0; line-height:1.1; }
    .example{ font-size:14px; color:var(--muted); font-style:italic; line-height:1.4; flex:1; }

    .actions{ margin-top:auto; display:flex; gap:10px; padding-top:12px; border-top:1px solid var(--line); }
    .actions .btn{ flex:1; height: 32px; font-size: 12px; }

    /* SOUND BTN */
    .sound-btn {
        width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--line);
        background: transparent; color: var(--accent); display: flex; align-items: center; justify-content: center;
    }

    /* MODALS */
    dialog{
      width:min(90vw, 400px); border:none; border-radius:20px; background:var(--panel);
      color:var(--text); box-shadow:0 25px 50px rgba(0,0,0,0.5); padding:0; margin:auto;
    }
    dialog::backdrop{ background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); }
    .modalHead{ padding:16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items: center; background: var(--headerTop); position: sticky; top:0;}
    .modalBody{ padding:20px; display:flex; flex-direction:column; gap:12px; max-height: 70vh; overflow-y: auto;}
    .modalFoot{ padding:16px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:flex-end; background: var(--panel);}

    /* QUIZ FULLSCREEN */
    .quizOverlay{
      position:fixed; inset:0; z-index:100; background:var(--bg); display:none; flex-direction:column;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    }
    .quizOverlay.on{ display:flex; }
    .quizCard { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; gap:20px; }
    .qText { font-size:36px; font-weight:900; }
    .opt { width: 100%; padding: 16px; border: 1px solid var(--line); background: var(--panel); color: var(--text); border-radius: 12px; font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .opt.correct { background: var(--accent2); color: #fff; border-color: transparent; }
    .opt.wrong { background: var(--danger); color: #fff; border-color: transparent; }

    .toast{
      position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
      background:var(--text); color:var(--bg);
      padding:10px 20px; border-radius:30px; font-weight:600; opacity:0; pointer-events:none;
      transition:all 0.3s; z-index:200; font-size: 13px;
    }
    .toast.show{ opacity:1; transform:translateY(-10px); }

  </style>
</head>

<body data-theme="dark">
  <header>
    <div class="topbar">
      <div class="brand">
        <h1>Vocab Pocket</h1>
      </div>
      <div class="lang-hero">
        <span style="font-size:18px; margin-left:8px">üèÅ</span>
        <select id="activeLangSelect" title="√áalƒ±≈üƒ±lan Dil">
             </select>
      </div>
    </div>

    <div class="row" style="justify-content: space-between;">
        <div style="flex:1; position: relative;">
            <input class="input" id="search" placeholder="Kelime ara..." style="padding-left: 36px; height: 44px;">
            <span style="position:absolute; left:12px; top:12px; opacity: 0.5">üîç</span>
        </div>
        <button class="btn" onclick="openSettings()" title="Ayarlar">‚öôÔ∏è</button>
        <button class="btn" onclick="startQuizCheck()" title="Quiz">üß†</button>
        <button class="btn primary" onclick="openAdd()" title="Ekle">Ôºã</button>
    </div>

    <div class="stats-bar">
        <div class="stat-item"><b id="countDue">0</b>Tekrar</div>
        <div class="stat-item"><b id="countTotal">0</b>Kart</div>
        <div class="stat-item"><b id="countStreak">0</b>Zincir</div>
    </div>
  </header>

  <main>
    <div class="grid" id="grid"></div>
  </main>

  <dialog id="modal">
    <div class="modalHead">
      <h3 id="modalTitle" style="margin:0">Yeni Kart</h3>
      <button class="btn" onclick="modal.close()">‚úï</button>
    </div>
    <div class="modalBody">
      <div style="font-size:12px; color:var(--muted); text-align:center;">
        <span id="lblSource">EN</span> ‚Üí <span id="lblTarget">TR</span>
      </div>
      
      <input class="input" id="term" placeholder="Kelime">
      <input class="input" id="meaning" placeholder="Anlam">
      <textarea class="input" id="example" placeholder="√ñrnek c√ºmle" rows="2"></textarea>
      
      <div class="row">
          <input class="input" id="imgUrl" placeholder="Resim URL (Opsiyonel)">
      </div>
      
      <details style="font-size:12px; color:var(--muted)">
          <summary style="padding:5px; cursor:pointer">Geli≈ümi≈ü</summary>
          <div style="margin-top:10px; display:grid; gap:10px">
              <input class="input" id="tags" placeholder="Etiketler">
              <input class="input" id="level" placeholder="Seviye (B1)">
          </div>
      </details>
    </div>
    <div class="modalFoot">
      <button class="btn danger text-btn" id="deleteBtn" style="display:none; margin-right:auto">Sil</button>
      <button class="btn primary" id="saveBtn">Kaydet</button>
    </div>
  </dialog>

  <dialog id="settingsModal">
    <div class="modalHead"><h3>Ayarlar</h3><button class="btn" onclick="settingsModal.close()">‚úï</button></div>
    <div class="modalBody">
        <label>Tema</label>
        <select id="themeSelect" class="input">
            <option value="dark">Karanlƒ±k</option>
            <option value="light">Aydƒ±nlƒ±k</option>
        </select>
        <hr style="width:100%; border:0; border-top:1px solid var(--line)">
        <label>Yedekleme</label>
        <div class="row">
            <button class="btn text-btn" onclick="exportData()" style="flex:1">Yedek ƒ∞ndir</button>
            <button class="btn text-btn" onclick="$('#fileInput').click()" style="flex:1">Yedek Y√ºkle</button>
            <input type="file" id="fileInput" hidden onchange="importData(this)">
        </div>
        <hr style="width:100%; border:0; border-top:1px solid var(--line)">
        <label>Toplu Ekle (Excel)</label>
        <textarea class="input" id="quickText" rows="4" placeholder="kelime - anlam"></textarea>
        <button class="btn primary" style="width:100%" onclick="quickAdd()">Ekle</button>
    </div>
  </dialog>

  <div class="quizOverlay" id="quizOverlay">
    <div class="topbar">
        <h3>Quiz</h3>
        <button class="btn" onclick="closeQuiz()">‚úï</button>
    </div>
    <div class="quizCard" id="quizCardArea">
        <div class="badge" id="qBadge">EN</div>
        <div class="qText" id="qText">Word</div>
        <button class="sound-btn" style="width:40px; height:40px" onclick="speakCurrent()">üîä</button>
        <div id="quizOptions" style="width:100%; max-width:400px; margin-top:20px;"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // --- HELPER ---
    const $ = s => document.querySelector(s);
    const now = () => Date.now();
    const uuid = () => 'id-' + Math.random().toString(36).substr(2, 9);
    
    // --- STATE ---
    let items = JSON.parse(localStorage.getItem('vp_items') || "[]");
    let activeLang = localStorage.getItem('vp_lang') || "EN"; // Varsayƒ±lan √áalƒ±≈üƒ±lan Dil
    let userLang = "TR"; // Kullanƒ±cƒ±nƒ±n Ana Dili (Anlam Dili)
    
    const LANGS = [
        {code:"EN", name:"ƒ∞ngilizce"}, {code:"DE", name:"Almanca"},
        {code:"ES", name:"ƒ∞spanyolca"}, {code:"FR", name:"Fransƒ±zca"},
        {code:"IT", name:"ƒ∞talyanca"}, {code:"RU", name:"Rus√ßa"}
    ];

    // --- INIT ---
    function init(){
        // Dil Se√ßiciyi Doldur
        const sel = $('#activeLangSelect');
        sel.innerHTML = LANGS.map(l => `<option value="${l.code}">${l.name}</option>`).join('');
        sel.value = activeLang;
        
        sel.addEventListener('change', e => {
            activeLang = e.target.value;
            localStorage.setItem('vp_lang', activeLang);
            render();
        });

        // Tema
        const theme = localStorage.getItem('vp_theme') || 'dark';
        document.body.setAttribute('data-theme', theme);
        $('#themeSelect').value = theme;
        $('#themeSelect').onchange = e => {
            document.body.setAttribute('data-theme', e.target.value);
            localStorage.setItem('vp_theme', e.target.value);
        };

        $('#search').addEventListener('input', render);
        
        render();
    }

    function save(){
        localStorage.setItem('vp_items', JSON.stringify(items));
        render();
    }

    // --- RENDER ---
    function render(){
        // Sadece se√ßili dile ait kartlarƒ± filtrele
        const langItems = items.filter(i => i.sourceLang === activeLang);
        
        // Arama Filtresi
        const q = $('#search').value.toLowerCase();
        const filtered = langItems.filter(i => (i.term + i.meaning).toLowerCase().includes(q));
        
        // ƒ∞statistikler (Sadece aktif dil)
        const dueCount = langItems.filter(i => (i.due || 0) <= now()).length;
        $('#countDue').textContent = dueCount;
        $('#countTotal').textContent = langItems.length;
        
        // Grid Render
        const grid = $('#grid');
        grid.innerHTML = "";
        
        if(filtered.length === 0){
            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--muted); padding:40px">
                Bu dilde kart yok.<br>+ butonu ile ekle.
            </div>`;
            return;
        }

        // Due √∂nce, sonra yeni
        filtered.sort((a,b) => (a.due||0) - (b.due||0));

        filtered.forEach(it => {
            const isDue = (it.due || 0) <= now();
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `
                <div class="cardFlipWrap">
                    <div class="cardFlip">
                        <div class="face front">
                            <div class="meta">
                                <span class="badge" style="${isDue ? 'color:var(--warn)' : ''}">${isDue ? 'TEKRAR' : it.level || 'KELƒ∞ME'}</span>
                                <button class="sound-btn" onclick="event.stopPropagation(); speak('${it.term}', '${it.sourceLang}')">üîä</button>
                            </div>
                            ${it.img ? `<img src="${it.img}" style="width:100%; height:100px; object-fit:cover; border-radius:8px; margin-bottom:10px">` : ''}
                            <div class="term">${it.term}</div>
                            <div class="example">${it.example || ''}</div>
                        </div>
                        <div class="face back">
                            <div class="meta"><span class="badge">ANLAM</span></div>
                            <div class="term">${it.meaning}</div>
                            <div class="actions">
                                <button class="btn text-btn" onclick="event.stopPropagation(); openEdit('${it.id}')">D√ºzenle</button>
                                <button class="btn text-btn" onclick="event.stopPropagation(); flipCard(this)">D√∂n</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            el.onclick = () => el.querySelector('.cardFlip').classList.toggle('flipped');
            grid.appendChild(el);
        });
        
        // Kart Y√ºkseklikleri
        setTimeout(()=> {
             document.querySelectorAll('.cardFlipWrap').forEach(w => {
                 const h = Math.max(w.querySelector('.front').scrollHeight, w.querySelector('.back').scrollHeight);
                 w.style.height = (h < 200 ? 200 : h) + 'px';
             });
        }, 50);
    }

    function flipCard(btn){
        btn.closest('.cardFlip').classList.toggle('flipped');
    }

    // --- CRUD ---
    let editId = null;

    function openAdd(){
        editId = null;
        $('#modalTitle').textContent = "Yeni Kart";
        $('#lblSource').textContent = activeLang;
        $('#lblTarget').textContent = userLang;
        $('#term').value = ""; $('#meaning').value = ""; $('#example').value = "";
        $('#imgUrl').value = ""; $('#tags').value = ""; $('#level').value = "B1";
        $('#deleteBtn').style.display = 'none';
        $('#modal').showModal();
        setTimeout(()=>$('#term').focus(), 100);
    }

    function openEdit(id){
        editId = id;
        const it = items.find(i => i.id === id);
        $('#modalTitle').textContent = "D√ºzenle";
        $('#term').value = it.term; $('#meaning').value = it.meaning; 
        $('#example').value = it.example; $('#imgUrl').value = it.img || "";
        $('#deleteBtn').style.display = 'block';
        $('#modal').showModal();
    }

    $('#saveBtn').onclick = () => {
        const term = $('#term').value.trim();
        const meaning = $('#meaning').value.trim();
        if(!term) return toast("Kelime gerekli");

        const data = {
            term, meaning, 
            example: $('#example').value, 
            img: $('#imgUrl').value,
            level: $('#level').value,
            tags: $('#tags').value,
            sourceLang: activeLang,
            meaningLang: userLang,
            due: now() // Yeni kart hemen √ßalƒ±≈üƒ±labilir
        };

        if(editId){
            const idx = items.findIndex(i=>i.id === editId);
            items[idx] = { ...items[idx], ...data };
        } else {
            items.push({ id: uuid(), ...data, interval: 0, ease: 2.5 });
        }
        save();
        $('#modal').close();
    };

    $('#deleteBtn').onclick = () => {
        if(confirm("Silmek istiyor musun?")){
            items = items.filter(i => i.id !== editId);
            save(); $('#modal').close();
        }
    };

    // --- QUICK ADD (EXCEL) ---
    function openSettings(){ $('#settingsModal').showModal(); }
    
    function quickAdd(){
        const txt = $('#quickText').value;
        if(!txt) return;
        const lines = txt.split('\n');
        let count = 0;
        lines.forEach(line => {
            // Ayƒ±rƒ±cƒ±: " - " veya Tab
            let parts = line.split(' - ');
            if(parts.length < 2) parts = line.split('\t');
            if(parts.length >= 2){
                items.push({
                    id: uuid(), term: parts[0].trim(), meaning: parts[1].trim(),
                    sourceLang: activeLang, meaningLang: userLang,
                    due: now(), interval: 0, ease: 2.5
                });
                count++;
            }
        });
        save();
        $('#settingsModal').close();
        $('#quickText').value = "";
        toast(`${count} kart eklendi`);
    }

    // --- QUIZ ---
    let quizPool = [];
    let quizIdx = 0;

    function startQuizCheck(){
        // Sadece aktif dilden, zamanƒ± gelmi≈ü (DUE) kartlarƒ± al
        quizPool = items.filter(i => i.sourceLang === activeLang && (i.due || 0) <= now());
        if(quizPool.length === 0){
            // Hi√ß due yoksa rastgele 10 tane al
            quizPool = items.filter(i => i.sourceLang === activeLang).sort(()=>Math.random()-0.5).slice(0, 10);
            if(quizPool.length === 0) return toast("Quiz i√ßin kart yok.");
            toast("Tekrar yok, rastgele pratik!");
        } else {
            // Karƒ±≈ütƒ±r
            quizPool.sort(()=>Math.random()-0.5);
        }
        
        quizIdx = 0;
        $('#quizOverlay').classList.add('on');
        showQuestion();
    }

    function showQuestion(){
        if(quizIdx >= quizPool.length){
            closeQuiz();
            return toast("Quiz Bitti! üéâ");
        }
        const q = quizPool[quizIdx];
        $('#qText').textContent = q.term;
        $('#qBadge').textContent = q.sourceLang;
        
        // ≈ûƒ±klar (3 Yanlƒ±≈ü + 1 Doƒüru)
        let others = items.filter(i => i.id !== q.id && i.sourceLang === activeLang).sort(()=>Math.random()-0.5).slice(0, 3);
        let opts = [...others, q].sort(()=>Math.random()-0.5);
        
        const area = $('#quizOptions');
        area.innerHTML = "";
        opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'opt';
            btn.textContent = o.meaning;
            btn.onclick = () => {
                if(btn.disabled) return;
                // Kilit
                Array.from(area.children).forEach(b => b.disabled = true);
                
                const correct = o.id === q.id;
                btn.classList.add(correct ? 'correct' : 'wrong');
                
                if(correct){
                    // SRS Mantƒ±ƒüƒ± (Doƒüru bildi, arayƒ± a√ß)
                    let ivl = q.interval === 0 ? 1 : Math.round(q.interval * 2.5);
                    q.interval = ivl;
                    q.due = now() + (ivl * 24 * 60 * 60 * 1000);
                    setTimeout(() => { quizIdx++; showQuestion(); }, 800);
                } else {
                    // Bilemedi, sƒ±fƒ±rla
                    q.interval = 0;
                    q.due = now(); // Hemen tekrar sor
                    // Doƒüruyu g√∂ster
                    Array.from(area.children).forEach(b => {
                        if(b.textContent === q.meaning) b.classList.add('correct');
                    });
                    setTimeout(() => { quizIdx++; showQuestion(); }, 1500);
                }
                save(); // G√ºncelle
            };
            area.appendChild(btn);
        });
    }

    function closeQuiz(){ $('#quizOverlay').classList.remove('on'); render(); }
    function speakCurrent(){ if(quizPool[quizIdx]) speak(quizPool[quizIdx].term, activeLang); }

    // --- UTILS ---
    function speak(txt, lang){
        if(!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        // Basit dil e≈üleme
        const m = {'EN':'en-US','DE':'de-DE','TR':'tr-TR','FR':'fr-FR','ES':'es-ES'};
        u.lang = m[lang] || lang;
        window.speechSynthesis.speak(u);
    }

    function toast(msg){
        const t = $('#toast'); t.textContent = msg; t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 2000);
    }

    function exportData(){
        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(items));
        const a = document.createElement('a');
        a.href = str; a.download = 'vocab_backup.json';
        document.body.appendChild(a); a.click(); a.remove();
    }
    
    function importData(input){
        const f = input.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            try{ items = JSON.parse(e.target.result); save(); toast("Y√ºklendi"); $('#settingsModal').close(); }
            catch(x){ toast("Hata"); }
        };
        r.readAsText(f);
    }

    init();
  </script>
</body>
</html>
