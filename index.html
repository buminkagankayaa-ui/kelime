<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LingoMaster</title>
  <meta name="theme-color" content="#0b1220" id="meta-theme">
  <link rel="icon" href="data:,">

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --header-h: 60px;
      --nav-h: 78px;
      --radius: 18px;

      --bg:#0b1220;
      --card:#111b2d;
      --card2:#0f172a;
      --border:#25324a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#6366f1;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --card2:#f1f5f9; --border:#cbd5e1;
      --text:#0f172a; --muted:#64748b; --primary:#4f46e5;
      --danger:#dc2626; --warn:#d97706; --ok:#059669;
    }
    [data-theme="ocean"]{
      --bg:#06131f; --card:#0b2236; --card2:#0a1b2a; --border:#245070;
      --text:#e6f2ff; --muted:#9bb7d3; --primary:#38bdf8;
    }
    [data-theme="emerald"]{
      --bg:#071a14; --card:#0b2a21; --card2:#082018; --border:#1f6b52;
      --text:#ecfdf5; --muted:#9fe3c7; --primary:#10b981;
    }
    [data-theme="sunset"]{
      --bg:#1b1020; --card:#2a1731; --card2:#1f1225; --border:#6b2a59;
      --text:#fff7ed; --muted:#fbcfe8; --primary:#fb7185;
    }
    [data-theme="rose"]{
      --bg:#120a10; --card:#1f0f1b; --card2:#160b13; --border:#7f1d1d;
      --text:#fff1f2; --muted:#fda4af; --primary:#f43f5e;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,system-ui,sans-serif;
      background:var(--bg); color:var(--text);
      height:100vh; overflow:hidden;
    }

    header{
      position:sticky; top:0; z-index:20;
      height:calc(var(--header-h) + var(--safe-top));
      padding-top:var(--safe-top);
      display:flex; align-items:center; justify-content:space-between;
      padding-left:16px; padding-right:16px;
      background:color-mix(in srgb, var(--bg) 78%, transparent);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:950;}
    .logo{width:18px; height:18px; border:2px solid var(--primary); border-radius:6px; transform:rotate(15deg);}
    .iconBtn{
      width:44px; height:44px; border-radius:14px;
      background:transparent; border:1px solid var(--border);
      color:var(--muted); display:grid; place-items:center;
      cursor:pointer; user-select:none;
    }
    .iconBtn:active{transform:scale(.98); opacity:.9;}

    #viewport{position:relative; height:calc(100vh - (var(--header-h) + var(--safe-top)));}
    .view{
      position:absolute; inset:0;
      padding:18px;
      padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 18px);
      overflow:auto;
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:.25s ease;
    }
    .view.active{opacity:1; pointer-events:auto; transform:none;}

    .row{display:flex; gap:12px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px;}
    .muted{color:var(--muted);}
    .big{font-size:34px; font-weight:980;}
    .h2{font-size:20px; font-weight:980; margin:0 0 12px 0;}
    .secTitle{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); font-weight:950; margin:4px 0 10px;}

    .btn{
      border:0; cursor:pointer; border-radius:16px;
      padding:14px 16px; font-weight:980;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
    }
    .btn:active{transform:scale(.985); opacity:.92;}
    .btnPrimary{background:var(--primary); color:white;}
    .btnSoft{background:var(--card2); color:var(--text); border:1px solid var(--border);}
    .btnDanger{background:var(--danger); color:white;}
    .btnOk{background:var(--ok); color:white;}
    .btnWarn{background:var(--warn); color:#111827;}
    .btnHalf{flex:1;}

    nav{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      height:calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom:var(--safe-bottom);
      background:var(--card2);
      border-top:1px solid var(--border);
      display:flex;
    }
    .navBtn{
      flex:1; background:transparent; border:0; color:var(--muted);
      cursor:pointer; user-select:none;
      display:grid; grid-template-rows: 36px 18px;
      align-items:center; justify-items:center;
      padding:6px 0; line-height:1;
      min-width:0;
    }
    .navBtn .ico{
      width:46px; height:36px;
      display:grid; place-items:center;
      font-size:20px; line-height:1;
    }
    .navBtn span{
      font-size:11.5px; font-weight:980; line-height:1;
      transform:translateY(-1px);
      white-space:nowrap;
    }
    .navBtn.active{color:var(--primary);}
    .navBtn.active .ico{background:color-mix(in srgb, var(--primary) 15%, transparent); border-radius:14px;}

    .readerTop{
      position:sticky; top:0;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      padding:10px 0 12px; margin-bottom:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .readerTop .titleWrap{min-width:0; text-align:center;}
    .readerTop .title{font-weight:980; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .readerTop .sub{font-size:12px; color:var(--muted); font-weight:950;}
    .reader{
      max-width:720px; margin:0 auto;
      font-family: ui-serif, Georgia, "Times New Roman", serif;
      font-size:19px; line-height:1.75; text-align:justify;
    }
    .token{cursor:pointer; padding:2px 0; border-radius:6px;}
    .token:active{background:color-mix(in srgb, var(--primary) 25%, transparent);}

    .backdrop{
      position:fixed; inset:0; z-index:40;
      background:rgba(0,0,0,.55);
      opacity:0; pointer-events:none; transition:.2s ease;
    }
    .backdrop.open{opacity:1; pointer-events:auto;}
    .sheet{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      background:var(--card);
      border-radius:26px 26px 0 0;
      border:1px solid var(--border);
      transform:translateY(110%);
      transition:.25s ease;
      max-height:85vh; overflow:auto;
      padding:14px 16px calc(16px + var(--safe-bottom));
    }
    .sheet.open{transform:none;}
    .handle{width:48px; height:5px; border-radius:99px; background:var(--border); margin:6px auto 14px;}
    .sheetHeader{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:10px;}
    .sheetHeader .word{font-size:34px; font-weight:980; margin:2px 0;}
    .sheetHeader .lang{font-size:12px; font-weight:980; color:var(--primary); letter-spacing:.08em;}
    .field{margin:10px 0;}
    label{display:block; font-size:12px; font-weight:980; color:var(--muted); margin-bottom:6px;}
    input, textarea, select{
      width:100%;
      background:var(--card2);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px; color:var(--text);
      font-size:16px; outline:none;
    }
    textarea{min-height:92px; resize:none;}
    .two{display:flex; gap:10px;}
    .smallInfo{font-size:12px; color:var(--muted); font-weight:950; margin-top:6px;}

    .toast{
      position:fixed; left:50%; top:calc(14px + var(--safe-top));
      transform:translate(-50%,-20px);
      background:var(--text); color:var(--bg);
      padding:10px 14px; border-radius:99px;
      font-weight:980; opacity:0; pointer-events:none;
      transition:.25s ease; z-index:200;
      max-width:calc(100vw - 20px); text-align:center;
    }
    .toast.show{opacity:1; transform:translate(-50%,0);}

    /* Quiz Overlay */
    .overlay{
      position:fixed; inset:0; z-index:120;
      background:var(--bg);
      transform:translateX(110%);
      transition:.25s ease;
      display:flex; flex-direction:column;
    }
    .overlay.open{transform:none;}
    .overlayTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px calc(14px + var(--safe-top));
      padding-top:calc(14px + var(--safe-top));
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb, var(--bg) 85%, transparent);
      backdrop-filter: blur(12px);
    }
    .qwrap{flex:1; display:flex; flex-direction:column; justify-content:center; padding:18px;}
    .qWord{font-size:44px; font-weight:980; text-align:center; margin:10px 0 18px;}
    .qMeta{font-size:12px; color:var(--muted); font-weight:950; text-align:center;}
    .qChoices{max-width:520px; width:100%; margin:16px auto 0; display:flex; flex-direction:column; gap:10px;}
    .qChoice{
      text-align:left; background:var(--card);
      border:1px solid var(--border);
      padding:14px 14px; border-radius:16px; cursor:pointer; font-weight:950;
    }
    .qChoice.correct{border-color: color-mix(in srgb, var(--ok) 70%, var(--border)); background:color-mix(in srgb, var(--ok) 12%, var(--card));}
    .qChoice.wrong{border-color: color-mix(in srgb, var(--danger) 70%, var(--border)); background:color-mix(in srgb, var(--danger) 10%, var(--card));}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>LingoMaster</div>
  </div>
  <div style="display:flex; gap:10px; align-items:center;">
    <button class="iconBtn" id="btnTheme" title="Tema">üé®</button>
    <button class="iconBtn" id="btnSettings" title="Ayarlar">‚öôÔ∏è</button>
  </div>
</header>

<div id="viewport">

  <!-- HOME -->
  <section class="view active" id="home">
    <div class="secTitle">Genel Bakƒ±≈ü</div>

    <div class="row">
      <div class="card" style="flex:1;">
        <div class="muted" style="font-weight:980;">Toplam Kart</div>
        <div class="big" id="dashTotal">0</div>
      </div>
      <div class="card" style="flex:1; border-color:color-mix(in srgb, var(--warn) 45%, var(--border));">
        <div style="font-weight:980; color:var(--warn);">Tekrar (Due)</div>
        <div class="big" style="color:var(--warn);" id="dashDue">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:18px; font-weight:980;">√áalƒ±≈üma Zinciri</div>
        <div style="font-weight:980; color:var(--primary);" id="dashStreak">0 G√ºn</div>
      </div>
      <div class="muted" style="margin-top:10px; font-weight:950;">
        Son 7 g√ºn toplam: <span id="dashWeek">0</span>
      </div>
    </div>

    <div class="secTitle" style="margin-top:16px;">Hƒ±zlƒ± ƒ∞≈ülemler</div>

    <button class="btn btnPrimary" style="width:100%; font-size:16px;" onclick="go('review')">üß† Bug√ºnk√º Tekrarlar</button>

    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="go('library')">üìö Kitap Okumaya Devam Et</button>
      <button class="btn btnSoft btnHalf" onclick="go('cards')">üóÇÔ∏è Kartlar</button>
    </div>

    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="openManualAdd()">‚ûï Elle Kelime Ekle</button>
      <button class="btn btnSoft btnHalf" onclick="go('depot')">üßæ Kelime Deposu</button>
    </div>
  </section>

  <!-- REVIEW / TEKRAR -->
  <section class="view" id="review">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">Tekrar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="startReviewQuiz()">Ba≈ülat</button>
    </div>

    <div class="card">
      <div style="font-weight:980; font-size:16px;">Bug√ºn tekrar edilecek kartlar</div>
      <div class="smallInfo">Due olan kartlar √∂ncelikli gelir. Kart yoksa rastgele pratik a√ßƒ±lƒ±r.</div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Due</div>
          <div class="big" id="rvDue">0</div>
        </div>
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Toplam</div>
          <div class="big" id="rvTotal">0</div>
        </div>
      </div>

      <div class="two" style="margin-top:12px;">
        <button class="btn btnOk btnHalf" onclick="startReviewQuiz()">üéØ Quiz Ba≈ülat</button>
        <button class="btn btnSoft btnHalf" onclick="resetTodaysQueue()">üîÅ Kuyruƒüu Yenile</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="font-weight:980;">Tekrar Ayarlarƒ±</div>
      <div class="smallInfo">SRS (aralƒ±klƒ± tekrar) aktif. Yanƒ±tƒ±na g√∂re kartƒ±n tekrar tarihi otomatik g√ºncellenir.</div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="toast('SRS aktif ‚úÖ')">SRS Durumu</button>
        <button class="btn btnSoft btnHalf" onclick="clearProgress()">ƒ∞lerlemeyi Sƒ±fƒ±rla</button>
      </div>
    </div>
  </section>

  <!-- LIBRARY -->
  <section class="view" id="library">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">K√ºt√ºphane</h2>
      <div style="display:flex; gap:10px;">
        <button class="iconBtn" onclick="openAddBook()" title="Metin ekle">‚ûï</button>
      </div>
    </div>
    <div id="libraryList"></div>
  </section>

  <!-- READER -->
  <section class="view" id="reader">
    <div class="readerTop">
      <button class="iconBtn" onclick="go('library')" title="Geri">‚Üê</button>
      <div class="titleWrap">
        <div class="title" id="rTitle">‚Äî</div>
        <div class="sub" id="rPage">Sayfa 1 / 1</div>
      </div>
      <button class="iconBtn" onclick="toggleFont()" title="Yazƒ±">T</button>
    </div>

    <div class="reader" id="readerText"></div>

    <div class="two" style="margin-top:16px;">
      <button class="btn btnSoft btnHalf" onclick="prevPage()">√ñnceki</button>
      <button class="btn btnSoft btnHalf" onclick="nextPage()">Sonraki</button>
    </div>
  </section>

  <!-- CARDS -->
  <section class="view" id="cards">
    <h2 class="h2">Kartlar</h2>
    <input id="search" placeholder="Kart ara..." />
    <div id="cardsList" style="margin-top:12px;"></div>
  </section>

  <!-- DEPOT / CACHE -->
  <section class="view" id="depot">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">Kelime Deposu</h2>
      <div style="display:flex; gap:10px;">
        <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="exportDepot()">Dƒ±≈üa Aktar</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:980;">√ñnbellek + Offline S√∂zl√ºk</div>
      <div class="smallInfo">Otomatik √ßevirilen kelimeler cache‚Äôe kaydolur. Buradan arayƒ±p kopyalayabilirsin.</div>
      <div class="two" style="margin-top:10px;">
        <input id="depotSearch" placeholder="Depoda ara (word/meaning)..." />
        <button class="btn btnSoft" style="padding:12px 12px;" onclick="renderDepot()">Ara</button>
      </div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="clearCache()">Cache Temizle</button>
        <button class="btn btnDanger btnHalf" onclick="clearDepotAll()">Hepsini Sil</button>
      </div>
    </div>

    <div id="depotList" style="margin-top:12px;"></div>
  </section>

</div>

<nav>
  <button class="navBtn active" id="navHome" onclick="go('home')">
    <div class="ico">üè†</div><span>Ana Sayfa</span>
  </button>
  <button class="navBtn" id="navReview" onclick="go('review')">
    <div class="ico">üß†</div><span>Tekrar</span>
  </button>
  <button class="navBtn" id="navLibrary" onclick="go('library')">
    <div class="ico">üìö</div><span>K√ºt√ºphane</span>
  </button>
  <button class="navBtn" id="navCards" onclick="go('cards')">
    <div class="ico">üóÇÔ∏è</div><span>Kartlar</span>
  </button>
</nav>

<div class="backdrop" id="backdrop" onclick="closeSheets()"></div>

<!-- WORD SHEET -->
<div class="sheet" id="wordSheet">
  <div class="handle"></div>

  <div class="sheetHeader">
    <div style="min-width:0;">
      <div class="lang" id="wsLang">EN</div>
      <div class="word" id="wsWord">word</div>
      <div class="smallInfo" id="wsStatus">Yeni kart</div>
      <div class="smallInfo" id="wsSource">√áeviri: ‚Äî</div>
    </div>
    <button class="iconBtn" onclick="speakWord()" title="Oku">üîä</button>
  </div>

  <div class="field">
    <label>Anlamƒ± (TR)</label>
    <input id="wsMeaning" placeholder="T√ºrk√ßesi nedir?" />
  </div>

  <div class="field">
    <label>√ñrnek / Baƒülam</label>
    <textarea id="wsContext"></textarea>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="autoTranslate()">Otomatik √áevir</button>
    <button class="btn btnPrimary btnHalf" onclick="saveCard()">Kaydet</button>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="editCard()">D√ºzenle</button>
    <button class="btn btnDanger btnHalf" onclick="deleteCard()">Sil</button>
  </div>
</div>

<!-- ADD BOOK SHEET -->
<div class="sheet" id="addBookSheet">
  <div class="handle"></div>
  <h2 class="h2">Yeni Metin Ekle</h2>

  <div class="field">
    <label>Ba≈ülƒ±k</label>
    <input id="bTitle" placeholder="Kitap / Makale Ba≈ülƒ±ƒüƒ±" />
  </div>

  <div class="field">
    <label>Dil</label>
    <select id="bLang">
      <option value="EN">ƒ∞ngilizce</option>
      <option value="RU">Rus√ßa</option>
      <option value="DE">Almanca</option>
      <option value="FR">Fransƒ±zca</option>
    </select>
  </div>

  <div class="field">
    <label>ƒ∞√ßerik</label>
    <textarea id="bText" placeholder="Metni buraya yapƒ±≈ütƒ±r..."></textarea>
  </div>

  <button class="btn btnPrimary" style="width:100%;" onclick="saveBook()">K√ºt√ºphaneye Ekle</button>
</div>

<!-- SETTINGS SHEET -->
<div class="sheet" id="settingsSheet">
  <div class="handle"></div>
  <h2 class="h2">Ayarlar</h2>

  <div class="card" style="margin-top:10px;">
    <div style="font-weight:980;">Tema</div>
    <div class="smallInfo">Tema se√ßimi burada. √ústteki üé® butonu da temayƒ± d√∂nd√ºr√ºr.</div>
    <div class="two" style="margin-top:10px;">
      <select id="themeSelect" onchange="applyThemeFromSelect()">
        <option value="dark">dark</option>
        <option value="light">light</option>
        <option value="ocean">ocean</option>
        <option value="emerald">emerald</option>
        <option value="sunset">sunset</option>
        <option value="rose">rose</option>
      </select>
      <button class="btn btnSoft" style="padding:12px 12px;" onclick="document.getElementById('btnTheme').click()">D√∂nd√ºr</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Okuma Yazƒ± Boyutu</div>
    <div class="smallInfo">Reader font b√ºy√ºkl√ºƒü√º</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="decFont()">-</button>
      <button class="btn btnSoft btnHalf" onclick="incFont()">+</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Veri Y√∂netimi</div>
    <div class="smallInfo">Kartlarƒ±nƒ± ve cache‚Äôi dƒ±≈üa aktar / i√ße aktar</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="exportAll()">Export</button>
      <button class="btn btnSoft btnHalf" onclick="importAllPrompt()">Import</button>
    </div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="clearCache()">Cache Temizle</button>
      <button class="btn btnDanger btnHalf" onclick="hardReset()">Her ≈ûeyi Sƒ±fƒ±rla</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Kƒ±sayollar</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="go('depot'); closeSheets();">Kelime Deposu</button>
      <button class="btn btnSoft btnHalf" onclick="openManualAdd()">Elle Kelime Ekle</button>
    </div>
  </div>

  <div class="smallInfo" style="margin-top:12px;">S√ºr√ºm: full-single-file + review + depot + settings + manual-add</div>
</div>

<!-- MANUAL ADD SHEET -->
<div class="sheet" id="manualAddSheet">
  <div class="handle"></div>
  <h2 class="h2">Elle Kelime Ekle</h2>

  <div class="field">
    <label>Dil</label>
    <select id="maLang">
      <option value="EN">ƒ∞ngilizce</option>
      <option value="RU">Rus√ßa</option>
      <option value="DE">Almanca</option>
      <option value="FR">Fransƒ±zca</option>
      <option value="TR">T√ºrk√ße</option>
    </select>
  </div>

  <div class="field">
    <label>Kelime / Terim</label>
    <input id="maTerm" placeholder="√ñrn: despite" />
  </div>

  <div class="field">
    <label>Anlamƒ± (TR)</label>
    <input id="maMeaning" placeholder="√ñrn: -e raƒümen" />
  </div>

  <div class="two">
    <div style="flex:1;">
      <label>T√ºr</label>
      <select id="maType">
        <option value="word">Kelime</option>
        <option value="phrase">Kalƒ±p</option>
        <option value="idiom">Deyim</option>
        <option value="phrasal">Phrasal Verb</option>
        <option value="noun">ƒ∞sim</option>
        <option value="verb">Fiil</option>
        <option value="adj">Sƒ±fat</option>
        <option value="adv">Zarf</option>
      </select>
    </div>
    <div style="flex:1;">
      <label>Seviye</label>
      <select id="maLevel">
        <option value="A1">A1</option><option value="A2">A2</option>
        <option value="B1">B1</option><option value="B2">B2</option>
        <option value="C1">C1</option><option value="C2">C2</option>
        <option value="UNK">Bilinmiyor</option>
      </select>
    </div>
  </div>

  <div class="field">
    <label>Kategori</label>
    <input id="maCategory" placeholder="√ñrn: Travel / Business / Daily" />
  </div>

  <div class="field">
    <label>√ñrnek C√ºmle</label>
    <textarea id="maExample" placeholder="√ñrn: Despite the rain, we went outside."></textarea>
  </div>

  <div class="field">
    <label>Not</label>
    <input id="maNote" placeholder="ƒ∞pucu/Not (opsiyonel)" />
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="closeSheets()">Vazge√ß</button>
    <button class="btn btnPrimary btnHalf" onclick="saveManualCard()">Kaydet</button>
  </div>
</div>

<!-- QUIZ OVERLAY -->
<div class="overlay" id="quizOverlay">
  <div class="overlayTop">
    <div style="font-weight:980;">Quiz</div>
    <button class="iconBtn" onclick="stopQuiz()">‚úï</button>
  </div>

  <div class="qwrap">
    <div class="qMeta" id="qMeta">‚Äî</div>
    <div class="qWord" id="qWord">‚Äî</div>
    <div class="qChoices" id="qChoices"></div>

    <div class="two" style="margin-top:14px; max-width:520px; width:100%; margin-left:auto; margin-right:auto;">
      <button class="btn btnSoft btnHalf" onclick="gradeCurrent(5)">Kolay</button>
      <button class="btn btnSoft btnHalf" onclick="gradeCurrent(3)">Orta</button>
      <button class="btn btnSoft btnHalf" onclick="gradeCurrent(1)">Zor</button>
    </div>

    <div class="smallInfo" style="text-align:center; margin-top:10px;">
      Se√ßeneklere dokun ‚Üí sonra Kolay/Orta/Zor ile not ver (SRS g√ºnceller).
    </div>
  </div>
</div>

<div class="toast" id="toast">‚Äî</div>

<script>
  // ---------------- Storage ----------------
  const DB = {
    get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  // ---------------- Toast ----------------
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  // ---------------- State ----------------
  const themes = ["dark","light","ocean","emerald","sunset","rose"];
  const state = {
    settings: DB.get("lm_settings", { theme:"dark", fontSize:19 }),
    cards: DB.get("lm_cards", []),
    books: DB.get("lm_books", []),
    txCache: DB.get("lm_tx_cache", {}),     // online+offline √ßeviri cache
    depot: DB.get("lm_depot", []),          // kelime deposu (cache + s√∂zl√ºkten gelen kayƒ±tlar)
    reviewQueue: DB.get("lm_review_queue", []) // bug√ºnk√º quiz kuyruƒüu
  };

  function saveAllState(){
    DB.set("lm_settings", state.settings);
    DB.set("lm_cards", state.cards);
    DB.set("lm_books", state.books);
    DB.set("lm_tx_cache", state.txCache);
    DB.set("lm_depot", state.depot);
    DB.set("lm_review_queue", state.reviewQueue);
  }

  function setTheme(name){
    document.documentElement.setAttribute("data-theme", name);
    state.settings.theme = name;
    DB.set("lm_settings", state.settings);
    const meta = document.getElementById("meta-theme");
    meta.setAttribute("content", getComputedStyle(document.documentElement).getPropertyValue("--bg").trim() || "#0b1220");
    const sel = document.getElementById("themeSelect");
    if(sel) sel.value = name;
  }

  function applyThemeFromSelect(){
    const v = document.getElementById("themeSelect").value;
    setTheme(v);
    toast("Tema: " + v);
  }

  document.getElementById("btnTheme").onclick = () => {
    const idx = (themes.indexOf(state.settings.theme) + 1) % themes.length;
    setTheme(themes[idx]);
    toast("Tema: " + themes[idx]);
  };

  // ‚úÖ Ayarlar butonu artƒ±k settings sheet a√ßƒ±yor
  document.getElementById("btnSettings").onclick = () => {
    document.getElementById("themeSelect").value = state.settings.theme;
    openSheet("settingsSheet");
  };

  // ---------------- Router (go) ----------------
  function go(id){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
    if(id==="home") document.getElementById("navHome").classList.add("active");
    if(id==="review") document.getElementById("navReview").classList.add("active");
    if(id==="library" || id==="reader") document.getElementById("navLibrary").classList.add("active");
    if(id==="cards") document.getElementById("navCards").classList.add("active");
    if(id==="depot"){ renderDepot(); }

    if(id === "home") renderDash();
    if(id === "library") renderLibrary();
    if(id === "cards") renderCards();
    if(id === "review") renderReview();
  }

  // ---------------- Demo books ----------------
  const BOOKS_SEED = [
    {
      id:"b_holmes",
      title:"Sherlock Holmes (Free)",
      lang:"EN",
      page:0,
      content:
`To Sherlock Holmes she is always THE woman. I have seldom heard him mention her under any other name.

It was not that he felt any emotion akin to love for Irene Adler. All emotions, and that one particularly, were abhorrent to his cold, precise mind.

Holmes remained in our lodgings in Baker Street... (demo)
`
    },
    {
      id:"b_alice",
      title:"Alice in Wonderland (Free)",
      lang:"EN",
      page:0,
      content:
`Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do.

Once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it.

"So she was considering in her own mind..." (demo)
`
    },
    {
      id:"b_pride",
      title:"Pride and Prejudice (Free)",
      lang:"EN",
      page:0,
      content:
`It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife.

However little known the feelings or views of such a man may be on his first entering a neighbourhood...
`
    }
  ];

  function seedBooks(){
    if(state.books.length === 0){
      state.books = [...BOOKS_SEED];
      DB.set("lm_books", state.books);
    }
  }

  // ---------------- Paging ----------------
  let activeBook = null;

  function getPages(text){
    const t = (text || "").replace(/\r\n/g,"\n");
    const size = 1400;
    const pages = [];
    let i=0;
    while(i < t.length){
      let end = Math.min(i + size, t.length);
      if(end < t.length){
        let cut = Math.max(
          t.lastIndexOf(". ", end),
          t.lastIndexOf("! ", end),
          t.lastIndexOf("? ", end),
          t.lastIndexOf("\n", end)
        );
        if(cut < i + Math.floor(size*0.45)){
          const sp = t.lastIndexOf(" ", end);
          if(sp > i) cut = sp;
        }
        if(cut > i) end = cut + 1;
      }
      pages.push(t.slice(i,end).trim());
      i=end;
    }
    return pages.length ? pages : ["(Bo≈ü)"];
  }

  function openBook(id){
    activeBook = state.books.find(b=>b.id===id);
    go("reader");
    renderReader();
  }

  function renderReader(){
    if(!activeBook) return;
    const pages = getPages(activeBook.content);
    if(activeBook.page >= pages.length) activeBook.page = pages.length-1;
    if(activeBook.page < 0) activeBook.page = 0;

    document.getElementById("rTitle").textContent = activeBook.title;
    document.getElementById("rPage").textContent = `Sayfa ${activeBook.page+1} / ${pages.length}`;

    const box = document.getElementById("readerText");
    box.style.fontSize = state.settings.fontSize + "px";
    box.innerHTML = "";

    const text = pages[activeBook.page];
    const parts = text.split(/(\s+)/);

    parts.forEach(ch=>{
      if(ch.trim().length===0){ box.appendChild(document.createTextNode(ch)); return; }
      const clean = ch.replace(/[.,!?;:"()¬´¬ª‚Äî‚Äì\[\]{}<>]+/g,"").trim();
      if(clean){
        const s = document.createElement("span");
        s.className = "token";
        s.textContent = ch;
        s.onclick = ()=>openWord(clean, activeBook.lang, text);
        box.appendChild(s);
      }else{
        box.appendChild(document.createTextNode(ch));
      }
    });

    DB.set("lm_books", state.books);
  }

  function nextPage(){ if(!activeBook) return; activeBook.page++; renderReader(); }
  function prevPage(){ if(!activeBook) return; activeBook.page--; renderReader(); }
  function toggleFont(){
    state.settings.fontSize = state.settings.fontSize >= 27 ? 17 : state.settings.fontSize + 2;
    DB.set("lm_settings", state.settings);
    renderReader();
  }
  function incFont(){ state.settings.fontSize = Math.min(40, (state.settings.fontSize||19)+1); DB.set("lm_settings", state.settings); toast("Font: "+state.settings.fontSize); if(activeBook) renderReader(); }
  function decFont(){ state.settings.fontSize = Math.max(12, (state.settings.fontSize||19)-1); DB.set("lm_settings", state.settings); toast("Font: "+state.settings.fontSize); if(activeBook) renderReader(); }

  // ---------------- Library ----------------
  function renderLibrary(){
    const wrap = document.getElementById("libraryList");
    wrap.innerHTML = "";
    state.books.forEach(b=>{
      const total = getPages(b.content).length;
      const el = document.createElement("div");
      el.className = "card";
      el.style.marginTop = "12px";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div style="min-width:0;">
            <div style="font-weight:980; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
            <div class="smallInfo">${b.lang} ‚Ä¢ Sayfa ${b.page+1} / ${total}</div>
          </div>
          <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" data-open="${b.id}">Oku</button>
        </div>
      `;
      el.querySelector("[data-open]").onclick = ()=>openBook(b.id);
      wrap.appendChild(el);
    });
  }

  // ---------------- Sheets ----------------
  const backdrop = document.getElementById("backdrop");
  function openSheet(id){
    backdrop.classList.add("open");
    document.getElementById(id).classList.add("open");
  }
  function closeSheets(){
    backdrop.classList.remove("open");
    document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open"));
  }

  // ---------------- Add book ----------------
  function openAddBook(){
    document.getElementById("bTitle").value = "";
    document.getElementById("bText").value = "";
    openSheet("addBookSheet");
  }

  function saveBook(){
    const title = document.getElementById("bTitle").value.trim() || "Adsƒ±z Metin";
    const lang = document.getElementById("bLang").value;
    const content = document.getElementById("bText").value.trim();
    if(!content) return toast("ƒ∞√ßerik bo≈ü olamaz.");

    state.books.push({ id:"b_"+Math.random().toString(36).slice(2), title, lang, page:0, content });
    DB.set("lm_books", state.books);
    toast("K√ºt√ºphaneye eklendi ‚úÖ");
    closeSheets();
    renderLibrary();
  }

  // ---------------- Word sheet ----------------
  let currentCardId = null;

  function openWord(word, lang, ctx){
    currentCardId = null;
    document.getElementById("wsLang").textContent = lang;
    document.getElementById("wsWord").textContent = word;
    document.getElementById("wsMeaning").value = "";
    document.getElementById("wsContext").value = (ctx || "").slice(0,240) + ((ctx||"").length>240 ? "..." : "");
    document.getElementById("wsStatus").textContent = "Yeni kart";
    document.getElementById("wsSource").textContent = "√áeviri: ‚Äî";
    openSheet("wordSheet");
  }

  function speakWord(){
    const txt = document.getElementById("wsWord").textContent;
    const lang = document.getElementById("wsLang").textContent;
    const u = new SpeechSynthesisUtterance(txt);
    const map = {EN:"en-US", RU:"ru-RU", DE:"de-DE", FR:"fr-FR", TR:"tr-TR"};
    u.lang = map[lang] || "en-US";
    u.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ---------------- Offline dictionary (GENƒ∞≈ûLETƒ∞LDƒ∞) ----------------
  // ƒ∞stersen bunu 10.000+ entry ile a≈üƒ±rƒ± b√ºy√ºt√ºr√ºz (dosya ≈üi≈üer).
  const OFFLINE_EN_TR = {
    "that":"≈üu / o / -diƒüi ≈üey","this":"bu","into":"i√ßine","past":"ge√ßmi≈ü / ge√ßmi≈üten","met":"tanƒ±≈ütƒ± / bulu≈ütu",
    "above":"√ºst√ºnde","from":"-den/-dan","seem":"gibi g√∂r√ºnmek","still":"hala","rose":"g√ºl / y√ºkseldi",
    "would":"-erdi","wonder":"merak etmek","even":"bile","notice":"fark etmek","matter":"mesele / √∂nemsemek",
    "anyone":"kimse / herhangi biri","at once":"hemen / aynƒ± anda","badly":"k√∂t√º bir ≈üekilde",
    "across":"kar≈üƒ±dan kar≈üƒ±ya / boyunca","round":"etrafƒ±nda / yuvarlak","passage":"ge√ßit / koridor","bend":"viraj / kƒ±vrƒ±m",
    "dark":"karanlƒ±k","went":"gitti","down":"a≈üaƒüƒ±","and":"ve","the":"(belirli artikel)","a":"bir","in":"i√ßinde","on":"√ºzerinde","to":"-e/-a",
    "always":"her zaman","woman":"kadƒ±n","seldom":"nadiren","mention":"bahsetmek","under":"altƒ±nda","other":"diƒüer","name":"isim",
    "eyes":"g√∂zler","whole":"t√ºm","sex":"cinsiyet","felt":"hissetti","emotion":"duygu","love":"a≈ük","particularly":"√∂zellikle",
    "cold":"soƒüuk","precise":"kesin / net","mind":"zihin","perfect":"m√ºkemmel","machine":"makine",
    "beginning":"ba≈ülangƒ±√ß","tired":"yorgun","sitting":"oturmak","bank":"nehir kƒ±yƒ±sƒ± / banka","nothing":"hi√ßbir ≈üey",
    "pictures":"resimler","conversations":"konu≈ümalar","truth":"ger√ßek","universally":"evrensel olarak","acknowledged":"kabul edilmi≈ü",
    "single":"bekar / tek","possession":"sahiplik","fortune":"servet","want":"istemek / ihtiya√ß duymak","wife":"e≈ü"
  };

  function normalizeKey(w){ return (w || "").toLowerCase().trim(); }

  function depotUpsert(entry){
    // entry: { key, lang, word, meaning, source, ts }
    const k = entry.key;
    const idx = state.depot.findIndex(x=>x.key===k);
    if(idx >= 0){
      state.depot[idx] = { ...state.depot[idx], ...entry, ts: Date.now() };
    }else{
      state.depot.push({ ...entry, ts: Date.now() });
    }
    DB.set("lm_depot", state.depot);
  }

  async function autoTranslate(){
    const word = document.getElementById("wsWord").textContent.trim();
    const lang = document.getElementById("wsLang").textContent.trim();
    const key = `${lang}|${normalizeKey(word)}`;

    // Cache
    if(state.txCache[key]){
      document.getElementById("wsMeaning").value = state.txCache[key];
      document.getElementById("wsSource").textContent = "√áeviri: Cache ‚úÖ";
      depotUpsert({ key, lang, word, meaning: state.txCache[key], source:"cache" });
      toast("Cache √ßeviri ‚úÖ");
      return;
    }

    // Online translate (gtx)
    try{
      const sl = ({EN:"en", RU:"ru", DE:"de", FR:"fr"})[lang] || "auto";
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=tr&dt=t&q=${encodeURIComponent(word)}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error("gtx_fail");
      const data = await r.json();
      const out = (data?.[0]?.[0]?.[0] || "").trim();
      if(out){
        document.getElementById("wsMeaning").value = out;
        document.getElementById("wsSource").textContent = "√áeviri: Online ‚úÖ";
        state.txCache[key] = out;
        DB.set("lm_tx_cache", state.txCache);
        depotUpsert({ key, lang, word, meaning: out, source:"online" });
        toast("Online √ßeviri ‚úÖ");
        return;
      }
      throw new Error("gtx_empty");
    }catch(e){
      // Offline fallback (EN)
      if(lang === "EN"){
        const k = normalizeKey(word);
        if(OFFLINE_EN_TR[k]){
          const out = OFFLINE_EN_TR[k];
          document.getElementById("wsMeaning").value = out;
          document.getElementById("wsSource").textContent = "√áeviri: Offline ‚úÖ";
          state.txCache[key] = out;
          DB.set("lm_tx_cache", state.txCache);
          depotUpsert({ key, lang, word, meaning: out, source:"offline" });
          toast("Offline s√∂zl√ºk ‚úÖ");
          return;
        }
      }
      document.getElementById("wsSource").textContent = "√áeviri: Bulunamadƒ±";
      toast("√áeviri bulunamadƒ± (manuel gir).");
    }
  }

  // ---------------- SRS (Aralƒ±klƒ± Tekrar) ----------------
  // Card: {id, term, meaning, lang, context, type, level, category, example, note, due, srs:{interval,reps,ef}}
  function srsCalc(card, quality){
    // quality 0-5
    let s = card.srs || { interval:0, reps:0, ef:2.5 };
    let { interval, reps, ef } = s;

    if(quality >= 3){
      if(reps === 0) interval = 1;
      else if(reps === 1) interval = 6;
      else interval = Math.round(interval * ef);

      reps++;
      ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
      if(ef < 1.3) ef = 1.3;
    }else{
      reps = 0;
      interval = 1;
    }

    const nextDue = Date.now() + interval * 24*60*60*1000;
    return { due: nextDue, srs:{ interval, reps, ef } };
  }

  // ---------------- Cards CRUD ----------------
  function saveCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const lang = document.getElementById("wsLang").textContent.trim();
    const meaning = document.getElementById("wsMeaning").value.trim();
    const context = document.getElementById("wsContext").value.trim();

    if(!term) return toast("Kelime bo≈ü olamaz.");
    if(!meaning) return toast("Anlamƒ± (TR) doldur.");

    const now = Date.now();
    const card = {
      id: currentCardId || ("c_" + Math.random().toString(36).slice(2)),
      term, lang, meaning,
      context,
      type: "word",
      level: "UNK",
      category: "",
      example: "",
      note: "",
      due: now,
      srs: { interval:0, reps:0, ef:2.5 }
    };

    const idx = state.cards.findIndex(c=>c.id===card.id);
    if(idx >= 0) state.cards[idx] = { ...state.cards[idx], ...card };
    else state.cards.push(card);

    DB.set("lm_cards", state.cards);

    const activity = DB.get("lm_activity", {});
    const k = new Date().toISOString().slice(0,10);
    activity[k] = (activity[k] || 0) + 1;
    DB.set("lm_activity", activity);

    toast("Kaydedildi ‚úÖ");
    closeSheets();
    renderDash();
    renderReview();
  }

  function editCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const found = state.cards.find(c => c.term.toLowerCase() === term.toLowerCase());
    if(!found) return toast("Bu kelime kartlarda yok.");
    currentCardId = found.id;
    document.getElementById("wsMeaning").value = found.meaning || "";
    document.getElementById("wsContext").value = found.context || "";
    document.getElementById("wsStatus").textContent = "D√ºzenleme modu";
    toast("D√ºzenleme a√ßƒ±ldƒ±");
  }

  function deleteCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const idx = state.cards.findIndex(c => c.term.toLowerCase() === term.toLowerCase());
    if(idx < 0) return toast("Silinecek kart yok.");
    state.cards.splice(idx,1);
    DB.set("lm_cards", state.cards);
    toast("Silindi");
    closeSheets();
    renderDash();
    renderReview();
    renderCards();
  }

  // ---------------- Manual Add ----------------
  function openManualAdd(){
    document.getElementById("maLang").value = "EN";
    document.getElementById("maTerm").value = "";
    document.getElementById("maMeaning").value = "";
    document.getElementById("maType").value = "word";
    document.getElementById("maLevel").value = "UNK";
    document.getElementById("maCategory").value = "";
    document.getElementById("maExample").value = "";
    document.getElementById("maNote").value = "";
    openSheet("manualAddSheet");
  }

  function saveManualCard(){
    const lang = document.getElementById("maLang").value;
    const term = document.getElementById("maTerm").value.trim();
    const meaning = document.getElementById("maMeaning").value.trim();
    const type = document.getElementById("maType").value;
    const level = document.getElementById("maLevel").value;
    const category = document.getElementById("maCategory").value.trim();
    const example = document.getElementById("maExample").value.trim();
    const note = document.getElementById("maNote").value.trim();

    if(!term) return toast("Kelime/terim bo≈ü olamaz.");
    if(!meaning) return toast("Anlam bo≈ü olamaz.");

    const card = {
      id: "c_" + Math.random().toString(36).slice(2),
      term, meaning, lang,
      context: example || "",
      type, level, category, example, note,
      due: Date.now(),
      srs: { interval:0, reps:0, ef:2.5 }
    };

    state.cards.push(card);
    DB.set("lm_cards", state.cards);

    toast("Elle eklendi ‚úÖ");
    closeSheets();
    renderDash();
    renderCards();
    renderReview();
  }

  // ---------------- Cards view ----------------
  document.getElementById("search").addEventListener("input", renderCards);

  function renderCards(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const list = document.getElementById("cardsList");
    list.innerHTML = "";

    const items = state.cards
      .filter(c => !q || c.term.toLowerCase().includes(q) || (c.meaning||"").toLowerCase().includes(q) || (c.category||"").toLowerCase().includes(q))
      .sort((a,b)=>a.term.localeCompare(b.term));

    if(items.length===0){
      const e = document.createElement("div");
      e.className = "card";
      e.innerHTML = `<div style="font-weight:980;">Hen√ºz kart yok</div><div class="smallInfo">Kitapta kelimeye dokun ‚Üí Otomatik √áevir ‚Üí Kaydet</div>`;
      list.appendChild(e);
      return;
    }

    items.forEach(c=>{
      const isDue = (c.due||0) <= Date.now();
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-weight:980; color:var(--primary); font-size:20px;">${c.term}</div>
          <div class="smallInfo" style="font-weight:980; color:${isDue?'var(--warn)':'var(--muted)'}">${isDue?'DUE':'OK'}</div>
        </div>
        <div class="smallInfo">${c.lang} ‚Ä¢ ${c.meaning}</div>
        <div class="smallInfo" style="margin-top:6px;">T√ºr: ${c.type||'-'} ‚Ä¢ Seviye: ${c.level||'-'} ‚Ä¢ Kategori: ${(c.category||'-') || '-'}</div>
        <div class="smallInfo" style="margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.example || c.context || ""}</div>
      `;
      list.appendChild(e);
    });
  }

  // ---------------- Dashboard ----------------
  function renderDash(){
    document.getElementById("dashTotal").textContent = state.cards.length;
    document.getElementById("dashDue").textContent = state.cards.filter(c => (c.due||0) <= Date.now()).length;

    const activity = DB.get("lm_activity", {});
    const today = new Date();
    let streak = 0;
    for(let i=0;i<365;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      if((activity[k]||0)>0) streak++;
      else break;
    }
    document.getElementById("dashStreak").textContent = streak + " G√ºn";

    let week = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      week += (activity[k]||0);
    }
    document.getElementById("dashWeek").textContent = week;
  }

  // ---------------- Review Page ----------------
  function getDueCards(){
    const now = Date.now();
    return state.cards.filter(c => (c.due||0) <= now);
  }

  function renderReview(){
    document.getElementById("rvTotal").textContent = state.cards.length;
    document.getElementById("rvDue").textContent = getDueCards().length;
  }

  function resetTodaysQueue(){
    // due √∂ncelikli, yoksa random
    const due = getDueCards();
    let q = [];
    if(due.length > 0){
      q = due.map(c=>c.id);
    }else{
      q = [...state.cards].sort(()=>Math.random()-0.5).slice(0, Math.min(20, state.cards.length)).map(c=>c.id);
    }
    state.reviewQueue = q;
    DB.set("lm_review_queue", state.reviewQueue);
    toast("Kuyruk yenilendi ‚úÖ");
    renderReview();
  }

  function clearProgress(){
    // sadece srs sƒ±fƒ±rlama (kartlarƒ± silmez)
    state.cards = state.cards.map(c=>({
      ...c,
      due: Date.now(),
      srs:{ interval:0, reps:0, ef:2.5 }
    }));
    DB.set("lm_cards", state.cards);
    toast("SRS sƒ±fƒ±rlandƒ± ‚úÖ");
    renderDash(); renderReview(); renderCards();
  }

  // ---------------- Quiz Engine ----------------
  let quizCurrent = null; // { card, choices[], correctIndex }
  let quizSelectedChoiceIndex = null;

  function startReviewQuiz(){
    if(state.cards.length === 0){
      toast("Kart yok. √ñnce kart ekle.");
      return;
    }
    if(!state.reviewQueue || state.reviewQueue.length === 0){
      resetTodaysQueue();
    }
    openQuizOverlay();
    nextQuizQuestion();
  }

  function openQuizOverlay(){
    document.getElementById("quizOverlay").classList.add("open");
  }
  function stopQuiz(){
    document.getElementById("quizOverlay").classList.remove("open");
    quizCurrent = null;
    quizSelectedChoiceIndex = null;
    renderDash();
    renderReview();
  }

  function nextQuizQuestion(){
    if(!state.reviewQueue || state.reviewQueue.length === 0){
      toast("Bitti ‚úÖ");
      stopQuiz();
      return;
    }

    const id = state.reviewQueue.shift();
    DB.set("lm_review_queue", state.reviewQueue);

    const card = state.cards.find(c=>c.id===id);
    if(!card){
      nextQuizQuestion();
      return;
    }

    // choices: 3 yanlƒ±≈ü + 1 doƒüru
    const pool = state.cards.filter(c=>c.id!==card.id).sort(()=>Math.random()-0.5);
    const distractors = pool.slice(0,3).map(x=>x.meaning);
    const choices = [...distractors, card.meaning].sort(()=>Math.random()-0.5);
    const correctIndex = choices.indexOf(card.meaning);

    quizCurrent = { card, choices, correctIndex };
    quizSelectedChoiceIndex = null;

    document.getElementById("qMeta").textContent = `${card.lang} ‚Ä¢ ${card.type||'word'} ‚Ä¢ ${card.level||'UNK'} ‚Ä¢ Due: ${((card.due||0) <= Date.now()) ? 'YES' : 'NO'}`;
    document.getElementById("qWord").textContent = card.term;

    const box = document.getElementById("qChoices");
    box.innerHTML = "";
    choices.forEach((ch, idx)=>{
      const b = document.createElement("button");
      b.className = "qChoice";
      b.textContent = ch;
      b.onclick = ()=>selectChoice(idx, b);
      box.appendChild(b);
    });
  }

  function selectChoice(idx, btn){
    quizSelectedChoiceIndex = idx;
    document.querySelectorAll(".qChoice").forEach(b=>b.classList.remove("correct","wrong"));
    // se√ßimi hafif vurgula
    btn.style.outline = `2px solid color-mix(in srgb, var(--primary) 55%, transparent)`;
    setTimeout(()=>btn.style.outline = "", 250);
  }

  function gradeCurrent(q){
    if(!quizCurrent) return;
    const { card, correctIndex } = quizCurrent;

    // show correct/wrong
    const all = Array.from(document.querySelectorAll(".qChoice"));
    all.forEach((b,i)=>{
      b.disabled = true;
      if(i === correctIndex) b.classList.add("correct");
    });

    if(quizSelectedChoiceIndex !== null && quizSelectedChoiceIndex !== correctIndex){
      all[quizSelectedChoiceIndex]?.classList.add("wrong");
    }

    // SRS update
    const upd = srsCalc(card, q);
    card.due = upd.due;
    card.srs = upd.srs;

    // log activity
    const activity = DB.get("lm_activity", {});
    const k = new Date().toISOString().slice(0,10);
    activity[k] = (activity[k] || 0) + 1;
    DB.set("lm_activity", activity);

    DB.set("lm_cards", state.cards);

    setTimeout(()=>{
      all.forEach(b=>b.disabled=false);
      nextQuizQuestion();
    }, 900);
  }

  // ---------------- Depot ----------------
  function renderDepot(){
    const q = (document.getElementById("depotSearch")?.value || "").toLowerCase().trim();
    const list = document.getElementById("depotList");
    if(!list) return;

    const items = [...(state.depot||[])]
      .filter(x=>{
        if(!q) return true;
        return (x.word||"").toLowerCase().includes(q) || (x.meaning||"").toLowerCase().includes(q) || (x.lang||"").toLowerCase().includes(q);
      })
      .sort((a,b)=>(b.ts||0)-(a.ts||0));

    list.innerHTML = "";

    const info = document.createElement("div");
    info.className = "card";
    info.innerHTML = `<div style="font-weight:980;">Kayƒ±t: ${items.length}</div><div class="smallInfo">Kaynak: online / offline / cache</div>`;
    list.appendChild(info);

    if(items.length === 0){
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `<div style="font-weight:980;">Depo bo≈ü</div><div class="smallInfo">Otomatik √áevir yaptƒ±k√ßa burada birikir.</div>`;
      list.appendChild(e);
      return;
    }

    items.slice(0,200).forEach(x=>{
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div style="font-weight:980; font-size:18px; color:var(--primary);">${x.word}</div>
          <div class="smallInfo" style="font-weight:980;">${x.lang} ‚Ä¢ ${x.source}</div>
        </div>
        <div class="smallInfo" style="margin-top:6px;">${x.meaning}</div>
        <div class="two" style="margin-top:10px;">
          <button class="btn btnSoft btnHalf" onclick="copyText('${escapeQuotes(x.word)} ‚Äî ${escapeQuotes(x.meaning)}')">Kopyala</button>
          <button class="btn btnDanger btnHalf" onclick="deleteDepotItem('${escapeQuotes(x.key)}')">Sil</button>
        </div>
      `;
      list.appendChild(e);
    });
  }

  function escapeQuotes(s){
    return (s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"');
  }

  async function copyText(t){
    try{
      await navigator.clipboard.writeText(t);
      toast("Kopyalandƒ± ‚úÖ");
    }catch(e){
      toast("Kopyalama ba≈üarƒ±sƒ±z");
    }
  }

  function deleteDepotItem(key){
    state.depot = (state.depot||[]).filter(x=>x.key !== key);
    DB.set("lm_depot", state.depot);
    toast("Silindi");
    renderDepot();
  }

  function clearCache(){
    state.txCache = {};
    DB.set("lm_tx_cache", state.txCache);
    toast("Cache temizlendi ‚úÖ");
  }

  function clearDepotAll(){
    state.depot = [];
    DB.set("lm_depot", state.depot);
    toast("Depo temizlendi");
    renderDepot();
  }

  function exportDepot(){
    const data = JSON.stringify({ depot: state.depot, cache: state.txCache }, null, 2);
    prompt("Kopyala (Depo Export):", data);
  }

  // ---------------- Import/Export All ----------------
  function exportAll(){
    const data = JSON.stringify({
      settings: state.settings,
      cards: state.cards,
      books: state.books,
      cache: state.txCache,
      depot: state.depot
    }, null, 2);
    prompt("Kopyala (Export JSON):", data);
  }

  function importAllPrompt(){
    const txt = prompt("Import JSON yapƒ±≈ütƒ±r:");
    if(!txt) return;
    try{
      const obj = JSON.parse(txt);
      if(obj.settings) state.settings = obj.settings;
      if(obj.cards) state.cards = obj.cards;
      if(obj.books) state.books = obj.books;
      if(obj.cache) state.txCache = obj.cache;
      if(obj.depot) state.depot = obj.depot;

      saveAllState();
      setTheme(state.settings.theme || "dark");
      toast("Import tamam ‚úÖ");
      renderDash(); renderLibrary(); renderCards(); renderReview(); renderDepot();
    }catch(e){
      toast("Import hata");
    }
  }

  function hardReset(){
    if(!confirm("Her ≈üeyi sƒ±fƒ±rlamak istiyor musun?")) return;
    localStorage.removeItem("lm_settings");
    localStorage.removeItem("lm_cards");
    localStorage.removeItem("lm_books");
    localStorage.removeItem("lm_tx_cache");
    localStorage.removeItem("lm_depot");
    localStorage.removeItem("lm_review_queue");
    localStorage.removeItem("lm_activity");
    location.reload();
  }

  // ---------------- Misc ----------------
  function renderReviewOnEnter(){
    renderReview();
  }

  // ---------------- Init ----------------
  seedBooks();
  setTheme(state.settings.theme);
  renderDash();
  renderLibrary();
  renderCards();
  renderReview();
  renderDepot();

  // Ensure settings select sync
  window.addEventListener("load", ()=>{
    const sel = document.getElementById("themeSelect");
    if(sel) sel.value = state.settings.theme;
  });

  // If review queue empty but due exists, keep ok
  if(!state.reviewQueue) state.reviewQueue = [];
</script>
</body>
</html>
