<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Vocab Pocket Pro</title>

  <meta name="theme-color" content="#0b0b10" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VocabPro" />
  <link rel="manifest" id="manifestLink" href="">

  <style>
    :root{
      --bg:#0b0b10; --panel:#12121a; --card:#151523; --card2:#17172a;
      --line:#23233a; --text:#f2f2f7; --muted:#a6a6bb;
      --accent:#7c3aed; --accent2:#22c55e; --danger:#fb7185; --warn:#fbbf24;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius:18px; --radius2:14px;
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(34,197,94,.18), transparent 55%);
      --headerTop: rgba(11,11,16,.95); --headerBottom: rgba(11,11,16,.80);
      --inputBg: rgba(21,21,35,.85);
    }
    body[data-theme="emerald"]{
      --bg:#07110c; --panel:#0b1711; --card:#0f1f17; --card2:#11251b;
      --line:#1f3a2d; --text:#eafff3; --muted:#a2c8b3;
      --accent:#22c55e; --accent2:#7c3aed;
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(34,197,94,.22), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(124,58,237,.16), transparent 55%);
      --headerTop: rgba(7,17,12,.95); --headerBottom: rgba(7,17,12,.80);
      --inputBg: rgba(15,31,23,.88);
    }
    body[data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --card2:#f4f6ff;
      --line:#d7d9e6; --text:#0b0b10; --muted:#4b5563;
      --accent:#7c3aed; --accent2:#16a34a;
      --shadow: 0 16px 60px rgba(0,0,0,.12);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.16), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(22,163,74,.12), transparent 55%);
      --headerTop: rgba(246,247,251,.95); --headerBottom: rgba(246,247,251,.80);
      --inputBg: rgba(255,255,255,.92);
    }

    *{box-sizing:border-box}
    body{
      margin:0; background: var(--bgGrad1), var(--bgGrad2), var(--bg);
      background-attachment: fixed; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      padding: env(safe-area-inset-top) 14px 100px 14px;
      -webkit-tap-highlight-color: transparent; overflow-x: hidden;
    }

    /* HEADER & NAV */
    header{
      position:sticky; top:0; z-index:40;
      background: linear-gradient(to bottom, var(--headerTop), var(--headerBottom));
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      padding: 12px 14px; margin: -14px -14px 10px -14px;
      border-bottom: 1px solid var(--line);
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .brand h1{ margin:0; font-size:18px; letter-spacing:-0.5px; }
    .brand .sub{ font-size:11px; color:var(--muted); }
    .row{ display:flex; gap:8px; align-items:center; }

    /* BUTTONS */
    .btn{
      border:1px solid var(--line); background: rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:700; font-size:13px;
      display:inline-flex; gap:6px; align-items:center; justify-content:center;
      cursor:pointer; transition:transform 0.1s; user-select:none;
    }
    .btn:active{ transform:scale(0.96); }
    .btn.primary{ border-color:transparent; background: var(--accent); color:#fff; }
    .btn.good{ border-color:transparent; background: var(--accent2); color:#000; }
    body[data-theme="dark"] .btn.good { color: #fff; }
    .btn.danger{ border-color: color-mix(in srgb, var(--danger) 35%, transparent); background: color-mix(in srgb, var(--danger) 15%, transparent); color:var(--danger); }
    .btn.ghost{ background:transparent; border:none; color:var(--muted); padding: 8px; }
    
    /* INPUTS & FILTERS */
    .input, select, textarea{
      width:100%; border:1px solid var(--line); background: var(--inputBg); color:var(--text);
      padding:12px; border-radius:12px; outline:none; font-size:15px;
    }
    .filters{ display:flex; gap:8px; overflow-x:auto; padding-bottom:5px; -webkit-overflow-scrolling:touch; }
    .filters::-webkit-scrollbar { display:none; }
    .filters select { min-width: 120px; flex:0 0 auto; }

    /* DASHBOARD & HEATMAP */
    .dash-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
    .heatmap-panel {
        background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius2);
        padding: 10px; display: flex; flex-direction: column; gap: 8px;
    }
    .heatmap-title { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; }
    .heatmap-grid { display: flex; gap: 4px; justify-content: space-between; }
    .day-box {
        flex: 1; aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 4px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-size: 10px; color: var(--muted); position: relative;
    }
    .day-box.active { background: var(--accent2); color: #000; box-shadow: 0 0 10px color-mix(in srgb, var(--accent2) 40%, transparent); }
    .day-box .d-label { font-size: 9px; opacity: 0.7; }

    /* CARDS */
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:16px; margin-top:16px; }
    .card{
      position:relative; background:transparent; perspective:1000px;
      touch-action: pan-y; user-select:none;
    }
    .card.selecting { transform: scale(0.98); opacity: 0.8; }
    .card.selected { opacity: 1; transform: scale(1); box-shadow: 0 0 0 2px var(--accent); border-radius: var(--radius); }
    
    .cardFlipWrap{ position:relative; width:100%; min-height:240px; transform-style:preserve-3d; transition:height 0.3s; }
    .cardFlip{
      position:absolute; inset:0; transform-style:preserve-3d; transition:transform 0.6s cubic-bezier(0.175,0.885,0.32,1.275);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .cardFlip.flipped{ transform: rotateY(180deg); }
    
    .face{
      position:absolute; inset:0; backface-visibility:hidden; -webkit-backface-visibility:hidden;
      background: linear-gradient(145deg, var(--card), var(--panel)); border:1px solid var(--line);
      border-radius:var(--radius); padding:14px; display:flex; flex-direction:column;
    }
    .face.back{ transform: rotateY(180deg); background: linear-gradient(145deg, var(--card2), var(--panel)); }

    /* Card Content */
    .card-img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; background: rgba(0,0,0,0.2); display: none; }
    .card-img.show { display: block; }
    
    .meta{ display:flex; justify-content:space-between; align-items:center; }
    .badge{ font-size:11px; font-weight:700; color:var(--muted); background:rgba(255,255,255,0.05); padding:4px 8px; border-radius:6px; }
    .controls-row { display: flex; gap: 8px; }
    
    .sound-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--line); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .sound-btn:active { background: var(--accent); color: white; }

    .term{ font-size:24px; font-weight:800; margin:8px 0; word-break:break-word; line-height:1.1; }
    .example{ font-size:13px; color:var(--muted); font-style:italic; line-height:1.4; flex:1; }

    .check-overlay {
        position: absolute; top: 10px; right: 10px; z-index: 10;
        width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--muted);
        background: var(--panel); display: none; align-items: center; justify-content: center;
    }
    body.selection-mode .check-overlay { display: flex; }
    .card.selected .check-overlay { background: var(--accent); border-color: var(--accent); }
    .card.selected .check-overlay::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }

    .actions{ margin-top:auto; display:flex; gap:8px; padding-top:10px; border-top:1px solid var(--line); }
    .actions .btn{ flex:1; padding:8px; font-size:12px; }

    /* BULK BAR */
    .bulk-bar {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%);
        background: var(--panel); border: 1px solid var(--line); padding: 10px 14px;
        border-radius: 16px; display: flex; gap: 10px; align-items: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 90; transition: transform 0.3s;
        width: min(90%, 500px);
    }
    .bulk-bar.active { transform: translateX(-50%) translateY(0); }

    /* MODALS */
    dialog{
      width:min(90vw, 500px); border:none; border-radius:20px; background:var(--panel);
      color:var(--text); box-shadow:0 25px 50px rgba(0,0,0,0.5); padding:0; margin:auto;
      max-height:90vh; overflow-y:auto;
    }
    dialog::backdrop{ background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); }
    .modalHead{ padding:16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; background:var(--headerTop); position:sticky; top:0; z-index:10; align-items: center;}
    .modalBody{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .modalFoot{ padding:16px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:flex-end; background:var(--panel); }
    .two{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* QUIZ OVERLAY */
    .quizOverlay{
      position:fixed; inset:0; z-index:100; background:var(--bg); display:none; flex-direction:column;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    }
    .quizOverlay.on{ display:flex; }
    .timer-bar { height: 4px; background: var(--line); margin-top: 10px; border-radius: 2px; overflow: hidden; }
    .timer-fill { height: 100%; background: var(--accent); width: 100%; transition: width 1s linear; }
    
    .quizCard { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; gap:16px; overflow-y:auto; }
    .qText { font-size:32px; font-weight:900; }
    
    .toast{
      position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px);
      background:var(--panel); border:1px solid var(--line); color:var(--text);
      padding:12px 20px; border-radius:30px; font-weight:600; opacity:0; pointer-events:none;
      transition:all 0.3s; z-index:200; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  </style>
</head>

<body data-theme="dark">
  <header>
    <div class="topbar">
      <div class="brand">
        <h1>Vocab Pocket Pro</h1>
        <div class="sub">Language Mastery</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="selectModeBtn">Se√ß</button>
        <button class="btn" id="settingsBtn">Ayarlar ‚öôÔ∏è</button>
        <button class="btn good" id="quizBtn">Quiz üß†</button>
        <button class="btn primary" id="addBtn">Ôºã</button>
      </div>
    </div>

    <div class="filters">
      <div class="row" style="width:100%">
        <input class="input" id="search" placeholder="Ara: #tag, lang:EN..." style="flex:1">
        <button class="btn" id="quickAddBtn">‚ö°</button>
      </div>
    </div>
    
    <div class="filters" style="margin-top:8px">
      <select id="statusFilter"><option value="ALL">Durum: T√ºm√º</option><option value="NEW">Yeni</option><option value="DUE">Bug√ºn (Due)</option></select>
      <select id="levelFilter"><option value="ALL">Seviye: T√ºm√º</option><option value="A1">A1</option><option value="B1">B1</option><option value="C1">C1</option></select>
      <select id="sort"><option value="due">Sƒ±ra: √ñnce Due</option><option value="date">Sƒ±ra: Son Eklenen</option></select>
    </div>

    <div class="dash-grid">
        <div class="heatmap-panel">
            <div style="display:flex; justify-content:space-between">
                <span class="heatmap-title">Son 7 G√ºn Aktivitesi</span>
                <span class="heatmap-title" id="streakCount">Zincir: 0 G√ºn</span>
            </div>
            <div class="heatmap-grid" id="heatmapGrid"></div>
        </div>
    </div>
  </header>

  <main>
    <div class="grid" id="grid"></div>
    <div class="bulk-bar" id="bulkBar">
        <span id="selCount" style="font-weight:bold; font-size:12px; color:var(--muted)">0 Se√ßildi</span>
        <div style="flex:1"></div>
        <button class="btn" onclick="bulkStatus('NEW')">Sƒ±fƒ±rla</button>
        <button class="btn" onclick="bulkStatus('MASTERED')">√ñƒürenildi</button>
        <button class="btn danger" onclick="bulkDelete()">Sil</button>
        <button class="btn ghost" onclick="toggleSelectMode()">Bitti</button>
    </div>
  </main>

  <dialog id="modal">
    <div class="modalHead">
      <h3 id="modalTitle" style="margin:0">Kart Ekle</h3>
      <button class="btn ghost" onclick="modal.close()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="two">
        <select id="sourceLang"></select>
        <select id="meaningLang"></select>
      </div>
      <input class="input" id="term" placeholder="Kelime (√ñrn: Apple)">
      <input class="input" id="meaning" placeholder="Anlam (√ñrn: Elma)">
      <textarea class="input" id="example" placeholder="√ñrnek c√ºmle..." rows="2"></textarea>
      
      <div class="two">
          <input class="input" id="level" placeholder="Seviye (B1)">
          <input class="input" id="tags" placeholder="Etiketler (virg√ºl)">
      </div>
      
      <input class="input" id="imgUrl" placeholder="üñºÔ∏è Resim URL (Opsiyonel)">
    </div>
    <div class="modalFoot">
      <button class="btn danger" id="deleteBtn" style="display:none; margin-right:auto">Sil</button>
      <button class="btn primary" id="saveBtn">Kaydet</button>
    </div>
  </dialog>

  <dialog id="quickModal">
    <div class="modalHead">
        <h3>Hƒ±zlƒ± / Excel Import</h3>
        <button class="btn ghost" onclick="quickModal.close()">‚úï</button>
    </div>
    <div class="modalBody">
        <div class="sub" style="color:var(--muted); font-size:12px">Excel'den kopyalayƒ±p yapƒ±≈ütƒ±rabilirsin. (Kelime [TAB] Anlam)</div>
        <textarea class="input" id="quickText" rows="10" placeholder="apple	elma&#10;run	ko≈ümak&#10;book - kitap - A1"></textarea>
    </div>
    <div class="modalFoot">
        <button class="btn primary" id="quickSaveBtn">ƒ∞√ßeri Aktar</button>
    </div>
  </dialog>

  <dialog id="settingsModal">
    <div class="modalHead">
        <h3>Ayarlar</h3>
        <button class="btn ghost" onclick="settingsModal.close()">‚úï</button>
    </div>
    <div class="modalBody">
        <div style="font-weight:bold; margin-bottom:5px">G√∂r√ºn√ºm</div>
        <select id="themeSelect" class="input">
            <option value="dark">Karanlƒ±k (Dark)</option>
            <option value="emerald">Z√ºmr√ºt (Emerald)</option>
            <option value="light">Aydƒ±nlƒ±k (Light)</option>
        </select>
        
        <hr style="border:0; border-top:1px solid var(--line); width:100%">
        
        <div style="font-weight:bold; margin-bottom:5px">Veri Y√∂netimi (Yedekleme)</div>
        <div class="two">
            <button class="btn" onclick="exportData()">üíæ Yedek ƒ∞ndir (JSON)</button>
            <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Yedek Y√ºkle</button>
            <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importData(this)">
        </div>
        <div class="help">Verilerin tarayƒ±cƒ±da saklanƒ±r. Silinmemesi i√ßin d√ºzenli yedek al.</div>
    </div>
  </dialog>

  <dialog id="quizSetupModal">
    <div class="modalHead"><h3>Quiz Ayarlarƒ±</h3><button class="btn ghost" onclick="quizSetupModal.close()">‚úï</button></div>
    <div class="modalBody">
        <div class="two">
            <button class="btn primary" onclick="startQuiz(false)" style="height:80px; font-size:16px">Normal Mod<br><span style="font-size:12px; font-weight:400">Sakin sakin √ß√∂z</span></button>
            <button class="btn danger" onclick="startQuiz(true)" style="height:80px; font-size:16px">Zaman Yarƒ±≈üƒ± ‚è±Ô∏è<br><span style="font-size:12px; font-weight:400">60 saniye</span></button>
        </div>
        <select id="quizScope" class="input"><option value="DUE">Sadece Tekrar Zamanƒ± Gelenler (Due)</option><option value="ALL">T√ºm Kelimeler</option></select>
    </div>
  </dialog>

  <div class="quizOverlay" id="quizOverlay">
    <div class="topbar">
      <div class="brand"><h1>Quiz</h1></div>
      <div class="row">
          <span class="pill" id="timerBadge" style="display:none; color:var(--danger)">‚è±Ô∏è <b id="timeLeft">60</b></span>
          <button class="btn" onclick="closeQuiz()">√áƒ±kƒ±≈ü</button>
      </div>
    </div>
    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
    
    <div class="quizCard" id="quizCardArea">
      <div style="display:flex; gap:10px; margin-bottom:10px">
        <span class="badge" id="qLang">EN</span>
        <button class="sound-btn" onclick="speakCurrentQuiz()">üîä</button>
      </div>
      <div class="qText" id="qText">...</div>
      
      <div class="options" id="quizOptions" style="width:100%; max-width:400px; display:grid; gap:10px"></div>
    </div>
    
    <div class="quizCard" id="quizResult" style="display:none">
        <h1>Bitti! üéâ</h1>
        <p id="quizFinalScore" style="font-size:18px; color:var(--muted)">Skorun: 0</p>
        <button class="btn primary" onclick="closeQuiz()">Tamam</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* --- UTILS --- */
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    const now = () => Date.now();
    const makeId = () => 'id_' + Math.random().toString(36).substr(2, 9);
    const DAY = 24*60*60*1000;

    /* --- STATE --- */
    let items = JSON.parse(localStorage.getItem('vp_items_v7') || "[]");
    let activity = JSON.parse(localStorage.getItem('vp_activity') || "{}");
    let langs = [{code:"EN",name:"English"}, {code:"TR",name:"T√ºrk√ße"}, {code:"DE",name:"Deutsch"}, {code:"FR",name:"Fran√ßais"}, {code:"ES",name:"Espa√±ol"}];
    let editingId = null;
    let selectionMode = false;
    let selectedIds = new Set();
    
    /* --- INIT --- */
    function init(){
        renderLangSelects();
        renderHeatmap();
        applyTheme(localStorage.getItem('vp_theme') || 'dark');
        render();
        setupEvents();
    }

    function save(){
        localStorage.setItem('vp_items_v7', JSON.stringify(items));
        localStorage.setItem('vp_activity', JSON.stringify(activity));
        render();
    }
    
    function logActivity(){
        const today = new Date().toISOString().split('T')[0];
        activity[today] = (activity[today] || 0) + 1;
        save();
        renderHeatmap();
    }

    /* --- RENDER --- */
    function render(){
        const grid = $('#grid');
        grid.innerHTML = "";
        
        // Filtering
        const sFilter = $('#search').value.toLowerCase();
        const stFilter = $('#statusFilter').value;
        const lFilter = $('#levelFilter').value;
        const sType = $('#sort').value;

        let filtered = items.filter(it => {
            const matchesSearch = !sFilter || (it.term+" "+it.meaning+" "+it.tags.join(" ")).toLowerCase().includes(sFilter);
            const matchesStatus = stFilter === "ALL" ? true : (stFilter === "DUE" ? it.srs.due <= now() : it.status === stFilter);
            const matchesLevel = lFilter === "ALL" ? true : it.level === lFilter;
            return matchesSearch && matchesStatus && matchesLevel;
        });

        // Sorting
        if(sType === 'due') filtered.sort((a,b) => a.srs.due - b.srs.due);
        else filtered.sort((a,b) => b.createdAt - a.createdAt);

        // Render Cards
        filtered.forEach(it => {
            const isDue = it.srs.due <= now();
            const el = document.createElement('div');
            el.className = `card ${selectedIds.has(it.id) ? 'selected' : ''}`;
            el.dataset.id = it.id;
            
            // Image handling
            const imgHtml = it.imgUrl ? `<img src="${it.imgUrl}" class="card-img show" alt="img">` : '';

            el.innerHTML = `
                <div class="check-overlay"></div>
                <div class="cardFlipWrap">
                    <div class="cardFlip">
                        <div class="face front">
                            <div class="meta">
                                <span class="badge">${it.level||'B1'}</span>
                                <div class="controls-row">
                                    <button class="sound-btn" data-act="speak" data-txt="${it.term}" data-lang="${it.sourceLang}">üîä</button>
                                    <div class="star ${it.fav?'on':''}">‚òÖ</div>
                                </div>
                            </div>
                            ${imgHtml}
                            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                                <div class="term">${it.term}</div>
                                <div class="example">${it.example||''}</div>
                            </div>
                            <div class="tags">
                                ${isDue ? '<span class="badge" style="color:var(--warn)">Due</span>' : ''}
                                ${it.status === 'MASTERED' ? '<span class="badge" style="color:var(--accent2)">Mastered</span>' : ''}
                            </div>
                        </div>
                        <div class="face back">
                            <div class="meta">
                                <span class="badge">Anlam</span>
                                <button class="sound-btn" data-act="speak" data-txt="${it.meaning}" data-lang="${it.meaningLang}">üîä</button>
                            </div>
                            <div class="term" style="flex:1">${it.meaning}</div>
                            <div class="actions">
                                <button class="btn" data-act="flip">‚Ü∫</button>
                                <button class="btn" data-act="edit">‚úé</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Event Listeners for Card
            el.addEventListener('click', (e) => handleCardClick(e, el, it));
            
            grid.appendChild(el);
        });
        
        // Update Bulk Bar UI
        $('#selCount').textContent = `${selectedIds.size} Se√ßildi`;
        $('#bulkBar').classList.toggle('active', selectionMode);
        document.body.classList.toggle('selection-mode', selectionMode);
    }

    function handleCardClick(e, el, it){
        // Special actions
        if(e.target.dataset.act === 'speak'){
            e.stopPropagation();
            speak(e.target.dataset.txt, e.target.dataset.lang);
            return;
        }
        if(e.target.classList.contains('star')){
            e.stopPropagation();
            it.fav = !it.fav; save();
            return;
        }

        // Selection Mode Logic
        if(selectionMode){
            if(selectedIds.has(it.id)) selectedIds.delete(it.id);
            else selectedIds.add(it.id);
            render();
            return;
        }

        // Normal Mode Logic
        const act = e.target.dataset.act;
        if(act === 'flip'){
            el.querySelector('.cardFlip').classList.toggle('flipped');
        } else if(act === 'edit'){
            openEdit(it.id);
        } else {
            // Flip on card body click
            el.querySelector('.cardFlip').classList.toggle('flipped');
        }
    }

    /* --- FEATURES: HEATMAP --- */
    function renderHeatmap(){
        const grid = $('#heatmapGrid');
        grid.innerHTML = "";
        const today = new Date();
        let streak = 0;
        let streakBroken = false;

        // Last 7 days reversed for display
        for(let i=6; i>=0; i--){
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const k = d.toISOString().split('T')[0];
            const count = activity[k] || 0;
            
            // Streak Calc
            if(count > 0 && !streakBroken) streak++;
            else if(i !== 0) streakBroken = true; // Don't break on today if not done yet

            const box = document.createElement('div');
            box.className = `day-box ${count > 0 ? 'active' : ''}`;
            const days = ['Pz','Pt','Sa','√áa','Pe','Cu','Ct'];
            box.innerHTML = `<span class="d-label">${days[d.getDay()]}</span>`;
            grid.appendChild(box);
        }
        $('#streakCount').textContent = `Zincir: ${streak} G√ºn`;
    }

    /* --- FEATURES: TTS --- */
    function speak(text, langCode){
        if(!window.speechSynthesis) return toast("Cihaz desteklemiyor");
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = langCode === 'EN' ? 'en-US' : (langCode === 'TR' ? 'tr-TR' : langCode.toLowerCase());
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    /* --- FEATURES: BULK ACTIONS --- */
    function toggleSelectMode(){
        selectionMode = !selectionMode;
        selectedIds.clear();
        $('#selectModeBtn').classList.toggle('primary');
        render();
    }
    
    function bulkDelete(){
        if(!confirm(`${selectedIds.size} kart silinecek?`)) return;
        items = items.filter(i => !selectedIds.has(i.id));
        toggleSelectMode();
        save();
        toast("Silindi");
    }
    
    function bulkStatus(st){
        items.forEach(i => { if(selectedIds.has(i.id)) i.status = st; });
        toggleSelectMode();
        save();
        toast("G√ºncellendi");
    }

    /* --- FEATURES: EXPORT/IMPORT --- */
    function exportData(){
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({items, activity}));
        const el = document.createElement('a');
        el.setAttribute("href", dataStr);
        el.setAttribute("download", "vocab_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(el);
        el.click();
        el.remove();
    }

    function importData(input){
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(data.items) items = data.items;
                if(data.activity) activity = data.activity;
                save();
                toast("Yedek Y√ºklendi ‚úÖ");
                $('#settingsModal').close();
            } catch(err){ toast("Hatalƒ± Dosya!"); }
        };
        reader.readAsText(file);
    }

    /* --- CRUD --- */
    $('#addBtn').onclick = () => { editingId=null; openModal(); };
    $('#quickAddBtn').onclick = () => $('#quickModal').showModal();
    $('#quickSaveBtn').onclick = () => {
        const lines = $('#quickText').value.split('\n');
        let added=0;
        lines.forEach(l => {
            // Split by tab (excel) or dash
            let p = l.split(/\t| - /); 
            if(p.length < 2) p = l.split(','); // Fallback csv
            if(p.length >= 2){
                items.push(createItem(p[0].trim(), p[1].trim(), p[2]?.trim()));
                added++;
            }
        });
        save(); $('#quickModal').close(); toast(`${added} Eklendi`);
    };

    function openModal(id){
        $('#term').value = ""; $('#meaning').value = ""; $('#example').value = ""; $('#imgUrl').value = ""; $('#level').value = "B1"; $('#tags').value = "";
        if(editingId = id){
            const it = items.find(i=>i.id===id);
            $('#term').value = it.term; $('#meaning').value = it.meaning; $('#example').value = it.example;
            $('#imgUrl').value = it.imgUrl||""; $('#level').value = it.level; $('#tags').value = it.tags.join(",");
            $('#sourceLang').value = it.sourceLang; $('#meaningLang').value = it.meaningLang;
            $('#deleteBtn').style.display='block';
        } else { $('#deleteBtn').style.display='none'; }
        $('#modal').showModal();
    }
    
    function openEdit(id){ openModal(id); }

    $('#saveBtn').onclick = () => {
        const data = {
            term: $('#term').value, meaning: $('#meaning').value, example: $('#example').value,
            imgUrl: $('#imgUrl').value, level: $('#level').value, tags: $('#tags').value.split(',').filter(Boolean),
            sourceLang: $('#sourceLang').value, meaningLang: $('#meaningLang').value
        };
        if(!data.term) return toast("Kelime gerekli");
        
        if(editingId){
            const idx = items.findIndex(i=>i.id===editingId);
            items[idx] = { ...items[idx], ...data };
        } else {
            items.push(createItem(data.term, data.meaning, data.level, data));
        }
        save(); $('#modal').close();
    };
    
    $('#deleteBtn').onclick = () => {
        items = items.filter(i=>i.id!==editingId);
        save(); $('#modal').close();
    };

    function createItem(term, meaning, level, extras={}){
        return {
            id: makeId(), term, meaning, level: level||"B1", example: extras.example||"",
            tags: extras.tags||[], imgUrl: extras.imgUrl||"", sourceLang: extras.sourceLang||"EN", meaningLang: extras.meaningLang||"TR",
            status: "NEW", fav: false, createdAt: now(),
            srs: { due: now(), interval: 0, ease: 2.5 }
        };
    }

    /* --- QUIZ --- */
    let quizPool = [], quizIdx = 0, quizScore = 0, quizTimer = null, isTimeAttack = false;

    $('#quizBtn').onclick = () => $('#quizSetupModal').showModal();
    
    function startQuiz(timeAttack){
        isTimeAttack = timeAttack;
        const scope = $('#quizScope').value;
        quizPool = items.filter(i => scope === "DUE" ? i.srs.due <= now() : true)
                        .sort(()=>Math.random()-0.5).slice(0, 20); // Max 20 questions
        
        if(!quizPool.length) return toast("Kart bulunamadƒ±");
        
        $('#quizSetupModal').close();
        $('#quizOverlay').classList.add('on');
        $('#quizCardArea').style.display = 'flex';
        $('#quizResult').style.display = 'none';
        
        quizIdx = 0; quizScore = 0;
        
        if(isTimeAttack) startTimeAttack();
        else $('#timerBadge').style.display = 'none';
        
        nextQuestion();
    }

    function startTimeAttack(){
        $('#timerBadge').style.display = 'block';
        $('#timerFill').style.width = '100%';
        let tl = 60;
        $('#timeLeft').textContent = tl;
        
        if(quizTimer) clearInterval(quizTimer);
        quizTimer = setInterval(() => {
            tl--;
            $('#timeLeft').textContent = tl;
            $('#timerFill').style.width = (tl/60*100) + '%';
            if(tl <= 0) endQuiz();
        }, 1000);
    }

    function nextQuestion(){
        if(quizIdx >= quizPool.length) return endQuiz();
        
        const q = quizPool[quizIdx];
        const optsDiv = $('#quizOptions');
        $('#qText').textContent = q.term;
        $('#qLang').textContent = q.sourceLang;
        
        // MCQ Logic
        let others = items.filter(i => i.id !== q.id).sort(()=>Math.random()-0.5).slice(0,3);
        let choices = [...others, q].sort(()=>Math.random()-0.5);
        
        optsDiv.innerHTML = "";
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.textAlign = 'left';
            btn.style.padding = '16px';
            btn.textContent = c.meaning;
            btn.onclick = () => {
                const correct = c.id === q.id;
                btn.className = correct ? 'btn good' : 'btn danger';
                if(correct) {
                    quizScore++;
                    if(!isTimeAttack) speak(q.term, q.sourceLang);
                    // SRS logic: If correct, push due date
                    q.srs.interval = q.srs.interval === 0 ? 1 : q.srs.interval * 2;
                    q.srs.due = now() + (q.srs.interval * DAY);
                    logActivity();
                } else {
                    q.srs.interval = 0;
                    q.srs.due = now();
                }
                setTimeout(() => { quizIdx++; nextQuestion(); }, 800);
            };
            optsDiv.appendChild(btn);
        });
    }

    function endQuiz(){
        if(quizTimer) clearInterval(quizTimer);
        $('#quizCardArea').style.display = 'none';
        $('#quizResult').style.display = 'flex';
        $('#quizFinalScore').textContent = `Toplam: ${quizPool.length} | Doƒüru: ${quizScore}`;
        save();
    }
    
    function closeQuiz(){
        $('#quizOverlay').classList.remove('on');
        if(quizTimer) clearInterval(quizTimer);
        render();
    }
    
    function speakCurrentQuiz(){
        if(quizPool[quizIdx]) speak(quizPool[quizIdx].term, quizPool[quizIdx].sourceLang);
    }

    /* --- HELPERS --- */
    $('#settingsBtn').onclick = () => $('#settingsModal').showModal();
    $('#themeSelect').onchange = (e) => applyTheme(e.target.value);
    
    function applyTheme(t){
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('vp_theme', t);
        $('#themeSelect').value = t;
    }
    function renderLangSelects(){
        const h = langs.map(l=>`<option value="${l.code}">${l.name}</option>`).join('');
        $('#sourceLang').innerHTML = h; $('#meaningLang').innerHTML = h; $('#meaningLang').value="TR";
    }
    function setupEvents(){
        $('#search').addEventListener('input', render);
        $('#statusFilter').addEventListener('change', render);
        $('#levelFilter').addEventListener('change', render);
        $('#sort').addEventListener('change', render);
    }
    
    init();
  </script>
</body>
</html>
