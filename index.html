<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Vocab Master Reader</title>

  <meta name="theme-color" content="#121212" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <style>
    :root {
      --bg: #121212; --panel: #1e1e24; --card: #252530; --line: #333340;
      --text: #e0e0e0; --muted: #9090a0; 
      --accent: #bb86fc; --accent-dark: #8050b0;
      --success: #03dac6; --danger: #cf6679; --warn: #ffb74d;
      
      --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-read: "Georgia", "Times New Roman", serif;
      
      --nav-height: 60px;
      --header-height: 50px;
    }

    /* THEMES */
    body[data-theme="light"] {
      --bg: #f5f5f7; --panel: #ffffff; --card: #ffffff; --line: #d1d1d6;
      --text: #1c1c1e; --muted: #8e8e93;
      --accent: #007aff; --accent-dark: #005bb5;
      --success: #34c759; --danger: #ff3b30; --warn: #ff9500;
    }
    body[data-theme="sepia"] {
      --bg: #f4ecd8; --panel: #eaddcf; --card: #fdf6e3; --line: #d7c9b3;
      --text: #5b4636; --muted: #988574;
      --accent: #a67c52; --accent-dark: #7a5a3a;
      --success: #6c8c5e; --danger: #b35a50; --warn: #c58f38;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: var(--font-ui);
      height: 100vh; display: flex; flex-direction: column;
      overflow: hidden; /* App-like structure */
    }

    /* --- LAYOUT --- */
    #app-container {
      flex: 1; overflow-y: auto; position: relative;
      padding-bottom: 80px; /* Space for FAB/Nav */
    }

    /* Views (Pages) */
    .view { display: none; padding: 16px; animation: fadeIn 0.2s; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- NAVIGATION --- */
    .nav-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: var(--nav-height); background: var(--panel);
      border-top: 1px solid var(--line);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 100; padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      color: var(--muted); font-size: 10px; font-weight: 600;
      background: none; border: none; cursor: pointer; flex: 1;
    }
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 20px; }

    /* --- HEADER --- */
    .header {
      position: sticky; top: 0; z-index: 50;
      background: var(--bg); border-bottom: 1px solid var(--line);
      padding: 0 16px; height: var(--header-height);
      display: flex; align-items: center; justify-content: space-between;
    }
    .header-title { font-weight: 800; font-size: 18px; }

    /* --- COMMON UI --- */
    .btn {
      padding: 10px 16px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 14px;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--line); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    .input {
      width: 100%; background: var(--panel); border: 1px solid var(--line);
      color: var(--text); padding: 12px; border-radius: 12px; outline: none; font-size: 16px;
    }
    
    .fab {
      position: fixed; bottom: 80px; right: 20px;
      width: 56px; height: 56px; border-radius: 50%;
      background: var(--accent); color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 90; cursor: pointer; border: none;
    }

    /* --- READER STYLES --- */
    .reader-content {
      font-family: var(--font-read); font-size: 18px; line-height: 1.6;
      color: var(--text); max-width: 800px; margin: 0 auto;
      text-align: justify;
    }
    .reader-word { cursor: pointer; border-radius: 4px; }
    .reader-word:hover { background: color-mix(in srgb, var(--accent) 20%, transparent); }
    
    .page-controls {
      display: flex; justify-content: space-between; margin-top: 20px; align-items: center;
      padding: 20px 0; border-top: 1px solid var(--line);
    }

    /* --- LIBRARY STYLES --- */
    .book-list { display: grid; gap: 12px; }
    .book-item {
      background: var(--card); padding: 16px; border-radius: 12px;
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid var(--line);
    }
    .book-info h3 { margin: 0 0 4px 0; font-size: 16px; }
    .book-meta { font-size: 12px; color: var(--muted); display: flex; gap: 8px; }
    .lang-badge { 
      background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px;
    }

    /* --- FLASHCARD STYLES --- */
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 12px; }
    @media (min-width: 600px) { .card-grid { grid-template-columns: 1fr 1fr; } }

    .flashcard {
      background: var(--card); border-radius: 16px; padding: 16px;
      border: 1px solid var(--line); position: relative;
    }
    .flashcard-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .term { font-size: 20px; font-weight: 800; color: var(--accent); }
    .meaning { font-size: 16px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--line); }
    .fc-stats { font-size: 10px; color: var(--muted); margin-top: 10px; display: flex; gap: 10px; }

    /* --- BOTTOM SHEET (Word Action) --- */
    .sheet-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150;
      display: none; opacity: 0; transition: opacity 0.3s;
    }
    .sheet-overlay.open { display: block; opacity: 1; }
    
    .sheet {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      padding: 20px; z-index: 160; transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
      box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
    }
    .sheet.open { transform: translateY(0); }
    
    .sheet-handle {
      width: 40px; height: 5px; background: var(--line);
      border-radius: 10px; margin: 0 auto 15px auto;
    }

    /* --- QUIZ OVERLAY --- */
    .quiz-overlay {
      position: fixed; inset: 0; background: var(--bg); z-index: 200;
      display: flex; flex-direction: column; padding: 20px;
      transform: translateX(100%); transition: transform 0.3s;
    }
    .quiz-overlay.active { transform: translateX(0); }
    
    .q-card {
      flex: 1; display: flex; flex-direction: column; justify-content: center;
      align-items: center; text-align: center;
    }
    .q-term { font-size: 32px; font-weight: 900; margin-bottom: 20px; }
    .q-opts { display: grid; gap: 10px; width: 100%; max-width: 400px; }
    .q-btn { padding: 16px; background: var(--card); border: 1px solid var(--line); color: var(--text); border-radius: 12px; font-size: 16px; text-align: left; }
    .q-btn.correct { background: var(--success); color: #000; border-color: transparent; }
    .q-btn.wrong { background: var(--danger); color: #fff; border-color: transparent; }

    /* UTILS */
    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: var(--text); color: var(--bg); padding: 10px 20px;
      border-radius: 20px; font-size: 12px; font-weight: bold;
      opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 300;
    }
    .toast.show { opacity: 1; }
    
    /* Selection Popup */
    #selectionPopup {
        position: absolute; display: none; background: var(--panel);
        border: 1px solid var(--accent); padding: 8px 12px;
        border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        z-index: 95; font-size: 12px; font-weight: bold; color: var(--accent);
        cursor: pointer;
    }
  </style>
</head>
<body data-theme="dark">

  <div class="header">
    <div class="header-title" id="pageTitle">K√ºt√ºphane</div>
    <div style="display:flex; gap:10px">
        <button class="btn btn-ghost btn-sm" onclick="toggleTheme()">üåó</button>
        <button class="btn btn-ghost btn-sm" onclick="backupData()">üíæ</button>
    </div>
  </div>

  <div id="app-container">
    
    <div id="view-library" class="view active">
      <div style="margin-bottom: 20px;">
        <h2 style="margin-top:0">Okuma Listesi</h2>
        <div class="book-list" id="bookList"></div>
      </div>
      <button class="btn btn-primary" onclick="openAddBookModal()" style="width:100%">+ Kendi Metnini Ekle</button>
    </div>

    <div id="view-reader" class="view">
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
           <button class="btn btn-ghost btn-sm" onclick="nav('library')">‚Üê Kitaplar</button>
           <span style="font-size:12px; color:var(--muted)" id="readProgress">Sayfa 1/1</span>
           <button class="btn btn-ghost btn-sm" onclick="changeFontSize()">Aa</button>
       </div>
       
       <div id="readerCanvas" class="reader-content">
           </div>

       <div class="page-controls">
           <button class="btn btn-ghost" onclick="prevPage()">√ñnceki</button>
           <button class="btn btn-ghost" onclick="nextPage()">Sonraki</button>
       </div>
       
       <div id="selectionPopup" onclick="addSelectionToCard()">+ Ekle</div>
    </div>

    <div id="view-cards" class="view">
      <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:10px">
          <button class="btn btn-ghost btn-sm" onclick="filterCards('ALL')">T√ºm√º</button>
          <button class="btn btn-ghost btn-sm" onclick="filterCards('NEW')">Yeni</button>
          <button class="btn btn-ghost btn-sm" onclick="filterCards('DUE')">Tekrar (Due)</button>
      </div>
      <div class="card-grid" id="cardGrid"></div>
      <div id="emptyState" style="text-align:center; padding:40px; color:var(--muted); display:none">
          Hen√ºz kart yok. Kitap okurken kelimelere tƒ±kla!
      </div>
    </div>

  </div>

  <nav class="nav-bar">
    <button class="nav-item active" onclick="nav('library')" id="nav-lib">
      <span class="nav-icon">üìö</span> K√ºt√ºphane
    </button>
    <button class="nav-item" onclick="nav('cards')" id="nav-cards">
      <span class="nav-icon">üóÇÔ∏è</span> Kartlar
    </button>
    <button class="nav-item" onclick="startQuiz()" id="nav-quiz">
      <span class="nav-icon">üß†</span> Quiz
    </button>
  </nav>

  <div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
  <div class="sheet" id="wordSheet">
    <div class="sheet-handle"></div>
    <h3 id="sheetWord" style="margin-top:0; font-size:24px; color:var(--accent)">Word</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px">
        <span class="lang-badge" id="sheetLang">EN</span>
        <button class="btn btn-ghost btn-sm" onclick="speakSheetWord()">üîä Dinle</button>
        <a href="#" id="translateLink" target="_blank" class="btn btn-ghost btn-sm">üåç √áevir</a>
    </div>
    
    <label style="font-size:12px; color:var(--muted)">Anlamƒ±</label>
    <input type="text" class="input" id="sheetMeaning" placeholder="T√ºrk√ßesi nedir?">
    
    <label style="font-size:12px; color:var(--muted); margin-top:10px; display:block">√ñrnek C√ºmle (Otomatik)</label>
    <textarea class="input" id="sheetExample" rows="2" style="font-size:14px; color:var(--muted)"></textarea>
    
    <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="saveSheetCard()">Kartlara Ekle</button>
  </div>

  <div class="sheet-overlay" id="bookModalOverlay" onclick="closeBookModal()"></div>
  <div class="sheet" id="bookModal" style="height:80vh">
      <h3>Yeni Metin Ekle</h3>
      <input class="input" id="newBookTitle" placeholder="Ba≈ülƒ±k (√ñrn: Haber Makalesi)">
      <select class="input" id="newBookLang" style="margin-top:10px">
          <option value="EN">ƒ∞ngilizce</option>
          <option value="RU">Rus√ßa</option>
      </select>
      <textarea class="input" id="newBookContent" style="flex:1; height:200px; margin-top:10px" placeholder="Metni buraya yapƒ±≈ütƒ±r..."></textarea>
      <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="saveNewBook()">Kaydet</button>
  </div>

  <div class="quiz-overlay" id="quizOverlay">
      <div class="header">
          <h3>Quiz</h3>
          <button class="btn btn-ghost" onclick="closeQuiz()">‚úï</button>
      </div>
      <div id="quizContent" style="flex:1; display:flex; flex-direction:column;">
          </div>
  </div>

  <div class="toast" id="toast">Mesaj</div>

<script>
/* ================= DATA & STATE ================= */
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const LS_BOOKS = 'vm_books';
const LS_CARDS = 'vm_cards';
const LS_THEME = 'vm_theme';

// Default Books
const DEFAULT_BOOKS = [
    {
        id: 'b1', title: 'Sherlock Holmes (Demo)', lang: 'EN', currentPage: 0,
        content: `To Sherlock Holmes she is always the woman. I have seldom heard him mention her under any other name. In his eyes she eclipses and predominates the whole of her sex. It was not that he felt any emotion akin to love for Irene Adler. All emotions, and that one particularly, were abhorrent to his cold, precise but admirably balanced mind. He was, I take it, the most perfect reasoning and observing machine that the world has seen, but as a lover he would have placed himself in a false position. He never spoke of the softer passions, save with a gibe and a sneer. They were admirable things for the observer‚Äîexcellent for drawing the veil from men‚Äôs motives and actions. But for the trained reasoner to admit such intrusions into his own delicate and finely adjusted temperament was to introduce a distracting factor which might throw a doubt upon all his mental results.`
    },
    {
        id: 'b2', title: '–¢–æ–ª—Å—Ç—ã–π –∏ —Ç–æ–Ω–∫–∏–π (–ß–µ—Ö–æ–≤)', lang: 'RU', currentPage: 0,
        content: `–ù–∞ –≤–æ–∫–∑–∞–ª–µ –ù–∏–∫–æ–ª–∞–µ–≤—Å–∫–æ–π –∂–µ–ª–µ–∑–Ω–æ–π –¥–æ—Ä–æ–≥–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å –¥–≤–∞ –ø—Ä–∏—è—Ç–µ–ª—è: –æ–¥–∏–Ω —Ç–æ–ª—Å—Ç—ã–π, –¥—Ä—É–≥–æ–π —Ç–æ–Ω–∫–∏–π. –¢–æ–ª—Å—Ç—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–æ–±–µ–¥–∞–ª –Ω–∞ –≤–æ–∫–∑–∞–ª–µ, –∏ –≥—É–±—ã –µ–≥–æ, –ø–æ–¥–µ—Ä–Ω—É—Ç—ã–µ –º–∞—Å–ª–æ–º, –ª–æ—Å–Ω–∏–ª–∏—Å—å, –∫–∞–∫ —Å–ø–µ–ª—ã–µ –≤–∏—à–Ω–∏. –ü–∞—Ö–ª–æ –æ—Ç –Ω–µ–≥–æ —Ö–µ—Ä–µ—Å–æ–º –∏ —Ñ–ª–µ—Ä-–¥‚Äô–æ—Ä–∞–Ω–∂–µ–º. –¢–æ–Ω–∫–∏–π –∂–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã—à–µ–ª –∏–∑ –≤–∞–≥–æ–Ω–∞ –∏ –±—ã–ª –Ω–∞–≤—å—é—á–µ–Ω —á–µ–º–æ–¥–∞–Ω–∞–º–∏, —É–∑–ª–∞–º–∏ –∏ –∫–∞—Ä—Ç–æ–Ω–∫–∞–º–∏. –ü–∞—Ö–ª–æ –æ—Ç –Ω–µ–≥–æ –≤–µ—Ç—á–∏–Ω–æ–π –∏ –∫–æ—Ñ–µ–π–Ω–æ–π –≥—É—â–µ–π. –ò–∑-–∑–∞ –µ–≥–æ —Å–ø–∏–Ω—ã –≤—ã–≥–ª—è–¥—ã–≤–∞–ª–∞ —Ö—É–¥–µ–Ω—å–∫–∞—è –∂–µ–Ω—â–∏–Ω–∞ —Å –¥–ª–∏–Ω–Ω—ã–º –ø–æ–¥–±–æ—Ä–æ–¥–∫–æ–º ‚Äî –µ–≥–æ –∂–µ–Ω–∞, –∏ –≤—ã—Å–æ–∫–∏–π –≥–∏–º–Ω–∞–∑–∏—Å—Ç —Å –ø—Ä–∏—â—É—Ä–µ–Ω–Ω—ã–º –≥–ª–∞–∑–æ–º ‚Äî –µ–≥–æ —Å—ã–Ω.`
    }
];

let books = JSON.parse(localStorage.getItem(LS_BOOKS)) || DEFAULT_BOOKS;
let cards = JSON.parse(localStorage.getItem(LS_CARDS)) || [];
let activeBook = null;
let currentFontSize = 18;

/* ================= INIT ================= */
function init() {
    renderBookList();
    applyTheme(localStorage.getItem(LS_THEME) || 'dark');
}

/* ================= NAVIGATION ================= */
function nav(viewName) {
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${viewName}`).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const btn = document.getElementById(`nav-${viewName === 'library' ? 'lib' : viewName}`);
    if(btn) btn.classList.add('active');
    
    document.getElementById('pageTitle').textContent = 
        viewName === 'library' ? 'K√ºt√ºphane' : (viewName === 'cards' ? 'Kartlarƒ±m' : 'Okuyucu');
        
    if(viewName === 'cards') renderCards();
}

/* ================= LIBRARY LOGIC ================= */
function renderBookList() {
    const list = document.getElementById('bookList');
    list.innerHTML = '';
    books.forEach(book => {
        const div = document.createElement('div');
        div.className = 'book-item';
        div.innerHTML = `
            <div class="book-info" onclick="openBook('${book.id}')" style="flex:1; cursor:pointer">
                <h3>${book.title}</h3>
                <div class="book-meta">
                    <span class="lang-badge">${book.lang}</span>
                    <span>Sayfa: ${book.currentPage + 1}</span>
                </div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="deleteBook('${book.id}')">üóëÔ∏è</button>
        `;
        list.appendChild(div);
    });
}

function openAddBookModal() {
    document.getElementById('bookModalOverlay').classList.add('open');
    document.getElementById('bookModal').classList.add('open');
}
function closeBookModal() {
    document.getElementById('bookModalOverlay').classList.remove('open');
    document.getElementById('bookModal').classList.remove('open');
}

function saveNewBook() {
    const title = document.getElementById('newBookTitle').value;
    const content = document.getElementById('newBookContent').value;
    const lang = document.getElementById('newBookLang').value;
    
    if(!title || !content) return toast('Ba≈ülƒ±k ve metin gerekli');
    
    books.push({ id: uuid(), title, lang, content, currentPage: 0 });
    localStorage.setItem(LS_BOOKS, JSON.stringify(books));
    renderBookList();
    closeBookModal();
    toast('Kitap Eklendi');
}

function deleteBook(id) {
    if(confirm('Silmek istiyor musun?')) {
        books = books.filter(b => b.id !== id);
        localStorage.setItem(LS_BOOKS, JSON.stringify(books));
        renderBookList();
    }
}

/* ================= READER LOGIC (CORE) ================= */
function openBook(id) {
    activeBook = books.find(b => b.id === id);
    if(!activeBook) return;
    nav('reader');
    renderPage();
}

// Split text into pages of approx 1000 chars
function getPages(text) {
    const pageSize = 800;
    const pages = [];
    let i = 0;
    while(i < text.length) {
        let end = Math.min(i + pageSize, text.length);
        // Try to end on a period or space
        if(end < text.length) {
            const period = text.lastIndexOf('.', end);
            const space = text.lastIndexOf(' ', end);
            end = (period > i + 500) ? period + 1 : (space > i ? space : end);
        }
        pages.push(text.slice(i, end).trim());
        i = end;
    }
    return pages;
}

function renderPage() {
    if(!activeBook) return;
    const pages = getPages(activeBook.content);
    // Boundary check
    if(activeBook.currentPage >= pages.length) activeBook.currentPage = pages.length - 1;
    if(activeBook.currentPage < 0) activeBook.currentPage = 0;
    
    const pageText = pages[activeBook.currentPage];
    
    // Tokenize words for clicking
    const canvas = document.getElementById('readerCanvas');
    canvas.innerHTML = '';
    
    // Split by spaces but keep punctuation logic simple for wrapping
    // This regex splits by spaces but keeps delimiters.
    const words = pageText.split(/(\s+)/); 
    
    words.forEach(chunk => {
        if(chunk.trim().length > 0 && !/^\d+$/.test(chunk) && !/^[.,!?;:"¬´¬ª‚Äî-]+$/.test(chunk)) {
            const span = document.createElement('span');
            span.textContent = chunk;
            span.className = 'reader-word';
            span.onclick = (e) => handleWordClick(e, chunk);
            canvas.appendChild(span);
        } else {
            // Punctuation or space
            canvas.appendChild(document.createTextNode(chunk));
        }
    });

    document.getElementById('readProgress').textContent = `Sayfa ${activeBook.currentPage + 1} / ${pages.length}`;
    
    // Save progress
    const idx = books.findIndex(b => b.id === activeBook.id);
    if(idx !== -1) {
        books[idx].currentPage = activeBook.currentPage;
        localStorage.setItem(LS_BOOKS, JSON.stringify(books));
    }
}

function nextPage() { activeBook.currentPage++; renderPage(); }
function prevPage() { activeBook.currentPage--; renderPage(); }
function changeFontSize() {
    currentFontSize = currentFontSize >= 24 ? 16 : currentFontSize + 2;
    document.getElementById('readerCanvas').style.fontSize = currentFontSize + 'px';
}

/* ================= INTERACTION & ADD CARD ================= */
let selectedTextContext = ""; // To store the sentence for example

function handleWordClick(e, word) {
    e.stopPropagation();
    // Clean word
    const cleanWord = word.replace(/[.,!?;:"()¬´¬ª]/g, "");
    
    // Find context (sentence)
    // Simple heuristic: grab 50 chars around
    const fullText = document.getElementById('readerCanvas').textContent;
    const idx = fullText.indexOf(word); // This is approximate in rendered view
    const sentence = "..." + word + "..."; // Placeholder context if real one fails
    
    openSheet(cleanWord, activeBook.lang, sentence);
}

// Handle Text Selection (Phrase)
document.addEventListener('selectionchange', () => {
    const sel = window.getSelection();
    const popup = document.getElementById('selectionPopup');
    if(sel.toString().trim().length > 0 && document.getElementById('view-reader').classList.contains('active')) {
        const range = sel.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        popup.style.display = 'block';
        popup.style.top = (rect.bottom + window.scrollY + 10) + 'px';
        popup.style.left = (rect.left + window.scrollX) + 'px';
    } else {
        popup.style.display = 'none';
    }
});

function addSelectionToCard() {
    const txt = window.getSelection().toString().trim();
    if(txt) openSheet(txt, activeBook.lang, txt);
    window.getSelection().removeAllRanges();
}

/* ================= WORD SHEET LOGIC ================= */
function openSheet(word, lang, context) {
    document.getElementById('sheetWord').textContent = word;
    document.getElementById('sheetLang').textContent = lang;
    document.getElementById('sheetMeaning').value = "";
    document.getElementById('sheetExample').value = context || "";
    
    // Translate Link (Google Translate)
    const sl = lang.toLowerCase();
    const tl = 'tr';
    const url = `https://translate.google.com/?sl=${sl}&tl=${tl}&text=${encodeURIComponent(word)}&op=translate`;
    document.getElementById('translateLink').href = url;
    
    document.getElementById('sheetOverlay').classList.add('open');
    document.getElementById('wordSheet').classList.add('open');
    setTimeout(() => document.getElementById('sheetMeaning').focus(), 100);
}

function closeSheet() {
    document.getElementById('sheetOverlay').classList.remove('open');
    document.getElementById('wordSheet').classList.remove('open');
}

function saveSheetCard() {
    const term = document.getElementById('sheetWord').textContent;
    const meaning = document.getElementById('sheetMeaning').value;
    const example = document.getElementById('sheetExample').value;
    const lang = document.getElementById('sheetLang').textContent;
    
    if(!meaning) return toast('Anlamƒ±nƒ± yazmalƒ±sƒ±n!');
    
    cards.push({
        id: uuid(),
        term, meaning, example,
        lang: lang,
        box: 0, // SRS Box (0-5)
        nextReview: Date.now(),
        createdAt: Date.now()
    });
    
    localStorage.setItem(LS_CARDS, JSON.stringify(cards));
    closeSheet();
    toast('Kart Eklendi! üéâ');
}

function speakSheetWord() {
    const txt = document.getElementById('sheetWord').textContent;
    const lang = document.getElementById('sheetLang').textContent;
    speak(txt, lang);
}

/* ================= FLASHCARD & SRS LOGIC ================= */
function renderCards(filterType = 'ALL') {
    const grid = document.getElementById('cardGrid');
    const empty = document.getElementById('emptyState');
    grid.innerHTML = '';
    
    const now = Date.now();
    let filtered = cards;
    
    if(filterType === 'NEW') filtered = cards.filter(c => c.box === 0);
    if(filterType === 'DUE') filtered = cards.filter(c => c.nextReview <= now);
    
    if(filtered.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        return;
    }
    
    grid.style.display = 'grid';
    empty.style.display = 'none';
    
    filtered.sort((a,b) => b.createdAt - a.createdAt);
    
    filtered.forEach(c => {
        const div = document.createElement('div');
        div.className = 'flashcard';
        // Check if due
        const isDue = c.nextReview <= now;
        const dueBadge = isDue ? `<span style="color:var(--warn); font-weight:bold; font-size:10px">TEKRAR</span>` : '';
        
        div.innerHTML = `
            <div class="flashcard-header">
                <span class="lang-badge">${c.lang}</span>
                ${dueBadge}
                <button class="btn btn-ghost btn-sm" onclick="speak('${c.term}', '${c.lang}')">üîä</button>
            </div>
            <div class="term">${c.term}</div>
            <div class="meaning">${c.meaning}</div>
            <div style="font-size:12px; color:var(--muted); font-style:italic; margin-top:5px">"${c.example || ''}"</div>
            <div class="fc-stats">
                <span>Kutu: ${c.box}</span>
                <button class="btn btn-ghost btn-sm" style="margin-left:auto; color:var(--danger)" onclick="deleteCard('${c.id}')">Sil</button>
            </div>
        `;
        grid.appendChild(div);
    });
}

function deleteCard(id) {
    if(confirm('Kartƒ± sil?')) {
        cards = cards.filter(c => c.id !== id);
        localStorage.setItem(LS_CARDS, JSON.stringify(cards));
        renderCards();
    }
}

/* ================= QUIZ LOGIC ================= */
let quizQueue = [];
let currentCard = null;

function startQuiz() {
    // Select cards due for review, or random new ones
    const now = Date.now();
    quizQueue = cards.filter(c => c.nextReview <= now);
    
    if(quizQueue.length === 0) {
        // Fallback: Random 5
        quizQueue = [...cards].sort(() => 0.5 - Math.random()).slice(0, 5);
        if(quizQueue.length === 0) return toast('Hi√ß kartƒ±n yok!');
        toast('Tekrar zamanƒ± gelen yok, rastgele pratik!');
    }
    
    document.getElementById('quizOverlay').classList.add('active');
    nextQuestion();
}

function nextQuestion() {
    if(quizQueue.length === 0) {
        closeQuiz();
        return toast('Quiz bitti! üéâ');
    }
    
    currentCard = quizQueue.pop();
    const container = document.getElementById('quizContent');
    
    container.innerHTML = `
        <div class="q-card">
            <div style="margin-bottom:10px"><span class="lang-badge">${currentCard.lang}</span></div>
            <div class="q-term">${currentCard.term}</div>
            <button class="btn btn-ghost" onclick="speak('${currentCard.term}', '${currentCard.lang}')">üîä Dinle</button>
            
            <div style="margin-top:40px; width:100%; display:flex; justify-content:center;">
                <button class="btn btn-primary" id="showAnsBtn" onclick="showAnswer()">Cevabƒ± G√∂ster</button>
            </div>
            
            <div id="ansArea" style="display:none; margin-top:20px; width:100%; max-width:400px; animation:fadeIn 0.3s">
                <div style="font-size:24px; font-weight:bold; color:var(--success)">${currentCard.meaning}</div>
                <div style="margin-top:20px; display:flex; gap:10px;">
                    <button class="btn btn-ghost" style="border-color:var(--danger); color:var(--danger); flex:1" onclick="rateCard(1)">Unuttum</button>
                    <button class="btn btn-ghost" style="border-color:var(--success); color:var(--success); flex:1" onclick="rateCard(4)">Bildim</button>
                </div>
            </div>
        </div>
    `;
}

function showAnswer() {
    document.getElementById('showAnsBtn').style.display = 'none';
    document.getElementById('ansArea').style.display = 'block';
}

// Simple Leitner System / SRS
function rateCard(quality) {
    // quality: 1 (fail), 4 (pass)
    const DAY = 86400000;
    
    if(quality === 1) {
        currentCard.box = 0; // Reset
        currentCard.nextReview = Date.now(); // Review immediately/tomorrow
    } else {
        currentCard.box += 1;
        // Intervals: 1d, 3d, 7d, 14d, 30d...
        const intervals = [1, 3, 7, 14, 30, 90];
        const days = intervals[Math.min(currentCard.box, intervals.length - 1)] || 90;
        currentCard.nextReview = Date.now() + (days * DAY);
    }
    
    // Save state
    const idx = cards.findIndex(c => c.id === currentCard.id);
    if(idx !== -1) cards[idx] = currentCard;
    localStorage.setItem(LS_CARDS, JSON.stringify(cards));
    
    nextQuestion();
}

function closeQuiz() {
    document.getElementById('quizOverlay').classList.remove('active');
    renderCards(); // Refresh UI
}

/* ================= HELPERS ================= */
function speak(text, lang) {
    if(!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    // Map simple codes to full locales
    const locales = { 'EN': 'en-US', 'RU': 'ru-RU', 'TR': 'tr-TR' };
    u.lang = locales[lang] || 'en-US';
    window.speechSynthesis.speak(u);
}

function toggleTheme() {
    const current = document.body.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : (current === 'light' ? 'sepia' : 'dark');
    document.body.setAttribute('data-theme', next);
    localStorage.setItem(LS_THEME, next);
}

function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2500);
}

function backupData() {
    const data = { books, cards };
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vocab_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

// Start app
init();
</script>
</body>
</html>
