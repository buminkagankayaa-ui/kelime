<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LingoMaster</title>
  <meta name="theme-color" content="#0b1220" id="meta-theme">
  <link rel="icon" href="data:,">

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --header-h: 60px;
      --nav-h: 78px;
      --radius: 18px;

      --bg:#0b1220;
      --card:#111b2d;
      --card2:#0f172a;
      --border:#25324a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#6366f1;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --card2:#f1f5f9; --border:#cbd5e1;
      --text:#0f172a; --muted:#64748b; --primary:#4f46e5;
      --danger:#dc2626; --warn:#d97706; --ok:#059669;
    }
    [data-theme="ocean"]{
      --bg:#06131f; --card:#0b2236; --card2:#0a1b2a; --border:#245070;
      --text:#e6f2ff; --muted:#9bb7d3; --primary:#38bdf8;
    }
    [data-theme="emerald"]{
      --bg:#071a14; --card:#0b2a21; --card2:#082018; --border:#1f6b52;
      --text:#ecfdf5; --muted:#9fe3c7; --primary:#10b981;
    }
    [data-theme="sunset"]{
      --bg:#1b1020; --card:#2a1731; --card2:#1f1225; --border:#6b2a59;
      --text:#fff7ed; --muted:#fbcfe8; --primary:#fb7185;
    }
    [data-theme="rose"]{
      --bg:#120a10; --card:#1f0f1b; --card2:#160b13; --border:#7f1d1d;
      --text:#fff1f2; --muted:#fda4af; --primary:#f43f5e;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,system-ui,sans-serif;
      background:var(--bg); color:var(--text);
      height:100vh; overflow:hidden;
    }

    header{
      position:sticky; top:0; z-index:20;
      height:calc(var(--header-h) + var(--safe-top));
      padding-top:var(--safe-top);
      display:flex; align-items:center; justify-content:space-between;
      padding-left:16px; padding-right:16px;
      background:color-mix(in srgb, var(--bg) 78%, transparent);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:950;}
    .logo{width:18px; height:18px; border:2px solid var(--primary); border-radius:6px; transform:rotate(15deg);}
    .iconBtn{
      width:44px; height:44px; border-radius:14px;
      background:transparent; border:1px solid var(--border);
      color:var(--muted); display:grid; place-items:center;
      cursor:pointer; user-select:none;
    }
    .iconBtn:active{transform:scale(.98); opacity:.9;}

    #viewport{position:relative; height:calc(100vh - (var(--header-h) + var(--safe-top)));}
    .view{
      position:absolute; inset:0;
      padding:18px;
      padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 18px);
      overflow:auto;
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:.25s ease;
    }
    .view.active{opacity:1; pointer-events:auto; transform:none;}

    .row{display:flex; gap:12px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px;}
    .muted{color:var(--muted);}
    .big{font-size:34px; font-weight:980;}
    .h2{font-size:20px; font-weight:980; margin:0 0 12px 0;}
    .secTitle{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); font-weight:950; margin:4px 0 10px;}

    .btn{
      border:0; cursor:pointer; border-radius:16px;
      padding:14px 16px; font-weight:980;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
    }
    .btn:active{transform:scale(.985); opacity:.92;}
    .btnPrimary{background:var(--primary); color:white;}
    .btnSoft{background:var(--card2); color:var(--text); border:1px solid var(--border);}
    .btnDanger{background:var(--danger); color:white;}
    .btnOk{background:var(--ok); color:white;}
    .btnWarn{background:var(--warn); color:#111827;}
    .btnHalf{flex:1;}

    nav{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      height:calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom:var(--safe-bottom);
      background:var(--card2);
      border-top:1px solid var(--border);
      display:flex;
    }
    .navBtn{
      flex:1; background:transparent; border:0; color:var(--muted);
      cursor:pointer; user-select:none;
      display:grid; grid-template-rows: 36px 18px;
      align-items:center; justify-items:center;
      padding:6px 0; line-height:1;
      min-width:0;
    }
    .navBtn .ico{
      width:46px; height:36px;
      display:grid; place-items:center;
      font-size:20px; line-height:1;
    }
    .navBtn span{
      font-size:11.5px; font-weight:980; line-height:1;
      transform:translateY(-1px);
      white-space:nowrap;
    }
    .navBtn.active{color:var(--primary);}
    .navBtn.active .ico{background:color-mix(in srgb, var(--primary) 15%, transparent); border-radius:14px;}

    .backdrop{
      position:fixed; inset:0; z-index:40;
      background:rgba(0,0,0,.55);
      opacity:0; pointer-events:none; transition:.2s ease;
    }
    .backdrop.open{opacity:1; pointer-events:auto;}
    .sheet{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      background:var(--card);
      border-radius:26px 26px 0 0;
      border:1px solid var(--border);
      transform:translateY(110%);
      transition:.25s ease;
      max-height:85vh; overflow:auto;
      padding:14px 16px calc(16px + var(--safe-bottom));
    }
    .sheet.open{transform:none;}
    .handle{width:48px; height:5px; border-radius:99px; background:var(--border); margin:6px auto 14px;}
    .field{margin:10px 0;}
    label{display:block; font-size:12px; font-weight:980; color:var(--muted); margin-bottom:6px;}
    input, textarea, select{
      width:100%;
      background:var(--card2);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px; color:var(--text);
      font-size:16px; outline:none;
    }
    textarea{min-height:92px; resize:none;}
    .two{display:flex; gap:10px;}
    .smallInfo{font-size:12px; color:var(--muted); font-weight:950; margin-top:6px;}

    .toast{
      position:fixed; left:50%; top:calc(14px + var(--safe-top));
      transform:translate(-50%,-20px);
      background:var(--text); color:var(--bg);
      padding:10px 14px; border-radius:99px;
      font-weight:980; opacity:0; pointer-events:none;
      transition:.25s ease; z-index:200;
      max-width:calc(100vw - 20px); text-align:center;
    }
    .toast.show{opacity:1; transform:translate(-50%,0);}

    /* Quiz Overlay */
    .overlay{
      position:fixed; inset:0; z-index:120;
      background:var(--bg);
      transform:translateX(110%);
      transition:.25s ease;
      display:flex; flex-direction:column;
    }
    .overlay.open{transform:none;}
    .overlayTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px calc(14px + var(--safe-top));
      padding-top:calc(14px + var(--safe-top));
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb, var(--bg) 85%, transparent);
      backdrop-filter: blur(12px);
    }
    .qTopStats{display:flex; gap:10px; justify-content:space-between; align-items:center;}
    .qPill{
      border:1px solid var(--border);
      background:var(--card);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      color:var(--muted);
      white-space:nowrap;
    }
    .qProgOuter{
      margin-top:10px;
      width:100%;
      height:10px;
      background:color-mix(in srgb, var(--border) 70%, transparent);
      border-radius:999px;
      overflow:hidden;
    }
    .qProgInner{
      height:100%;
      width:0%;
      background:var(--primary);
      border-radius:999px;
      transition:width .25s ease;
    }
    .qChoice{
      text-align:left; background:var(--card);
      border:1px solid var(--border);
      padding:14px 14px; border-radius:16px; cursor:pointer; font-weight:950;
    }
    .qChoice.correct{border-color: color-mix(in srgb, var(--ok) 70%, var(--border)); background:color-mix(in srgb, var(--ok) 12%, var(--card));}
    .qChoice.wrong{border-color: color-mix(in srgb, var(--danger) 70%, var(--border)); background:color-mix(in srgb, var(--danger) 10%, var(--card));}

    /* typing */
    .qInputWrap{
      width:100%;
      max-width:420px;
      margin:10px auto 0;
      display:flex;
      gap:10px;
    }
    .qInput{
      flex:1;
      padding:14px;
      border-radius:14px;
      border:2px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-size:16px;
      font-weight:900;
      outline:none;
    }
    .qInput.correct{border-color:#22c55e; background:rgba(34,197,94,.12);}
    .qInput.wrong{border-color:#ef4444; background:rgba(239,68,68,.12);}
    .qCheckBtn{
      padding:14px 18px;
      border-radius:14px;
      border:none;
      background:var(--primary);
      color:#fff;
      font-weight:950;
    }
    .qAnswerReveal{
      margin-top:10px;
      font-size:14px;
      font-weight:900;
      color:var(--muted);
      text-align:center;
    }

    /* summary */
    #quizSummary{
      max-width:420px;
      margin:0 auto;
    }

    /* small utilities */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:var(--card2);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      color:var(--muted);
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>LingoMaster</div>
  </div>
  <div style="display:flex; gap:10px; align-items:center;">
    <button class="iconBtn" id="btnTheme" title="Tema">üé®</button>
    <button class="iconBtn" id="btnSettings" title="Ayarlar">‚öôÔ∏è</button>
  </div>
</header>

<div id="viewport">

  <!-- HOME -->
  <section class="view active" id="home">
    <div class="secTitle">Genel Bakƒ±≈ü</div>

    <div class="row">
      <div class="card" style="flex:1;">
        <div class="muted" style="font-weight:980;">Toplam Kart</div>
        <div class="big" id="dashTotal">0</div>
      </div>
      <div class="card" style="flex:1; border-color:color-mix(in srgb, var(--warn) 45%, var(--border));">
        <div style="font-weight:980; color:var(--warn);">Tekrar (Due)</div>
        <div class="big" style="color:var(--warn);" id="dashDue">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:18px; font-weight:980;">√áalƒ±≈üma Zinciri</div>
        <div style="font-weight:980; color:var(--primary);" id="dashStreak">0 G√ºn</div>
      </div>
      <div class="muted" style="margin-top:10px; font-weight:950;">
        Son 7 g√ºn toplam: <span id="dashWeek">0</span>
      </div>
    </div>

    <div class="secTitle" style="margin-top:16px;">Hƒ±zlƒ± ƒ∞≈ülemler</div>

    <button class="btn btnPrimary" style="width:100%; font-size:16px;" onclick="go('review')">üß† Bug√ºnk√º Tekrarlar</button>

    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="go('cards')">üóÇÔ∏è Kartlar</button>
      <button class="btn btnSoft btnHalf" onclick="openManualAdd()">‚ûï Elle Kelime Ekle</button>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="font-weight:980;">ƒ∞pucu</div>
      <div class="smallInfo">Elle kelime eklediƒüinde: anlam + seviye otomatik doldurulur (bo≈üsa). ƒ∞stersen elle de d√ºzenleyebilirsin.</div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">‚úÖ Online √ßeviri</span>
        <span class="pill">‚úÖ Offline s√∂zl√ºk</span>
        <span class="pill">‚úÖ SRS tekrar</span>
        <span class="pill">‚úÖ Quiz</span>
      </div>
    </div>
  </section>

  <!-- REVIEW / TEKRAR -->
  <section class="view" id="review">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">Tekrar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="startReviewQuiz()">Ba≈ülat</button>
    </div>

    <div class="card">
      <div style="font-weight:980; font-size:16px;">Bug√ºn tekrar edilecek kartlar</div>
      <div class="smallInfo">Due olan kartlar √∂ncelikli gelir. Kart yoksa rastgele pratik a√ßƒ±lƒ±r.</div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Due</div>
          <div class="big" id="rvDue">0</div>
        </div>
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Toplam</div>
          <div class="big" id="rvTotal">0</div>
        </div>
      </div>

      <div class="two" style="margin-top:12px;">
        <button class="btn btnOk btnHalf" onclick="startReviewQuiz()">üéØ Quiz Ba≈ülat</button>
        <button class="btn btnSoft btnHalf" onclick="resetTodaysQueue()">üîÅ Kuyruƒüu Yenile</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="font-weight:980;">Tekrar Ayarlarƒ±</div>
      <div class="smallInfo">SRS (aralƒ±klƒ± tekrar) aktif. Yanƒ±tƒ±na g√∂re kartƒ±n tekrar tarihi otomatik g√ºncellenir.</div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="toast('SRS aktif ‚úÖ')">SRS Durumu</button>
        <button class="btn btnSoft btnHalf" onclick="clearProgress()">ƒ∞lerlemeyi Sƒ±fƒ±rla</button>
      </div>
    </div>
  </section>

  <!-- CARDS -->
  <section class="view" id="cards">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">Kartlar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="openManualAdd()">‚ûï Ekle</button>
    </div>

    <input id="search" placeholder="Kart ara (term / meaning / category)..." />
    <div class="smallInfo" style="margin-top:10px;">
      Kartƒ±n √ºst√ºne tƒ±klayƒ±nca d√ºzenleme sheet‚Äôi a√ßƒ±lƒ±r.
    </div>

    <div id="cardsList" style="margin-top:12px;"></div>
  </section>

</div>

<!-- ALT MEN√ú (SADECE 3) -->
<nav>
  <button class="navBtn active" id="navHome" onclick="go('home')">
    <div class="ico">üè†</div><span>Ana Sayfa</span>
  </button>
  <button class="navBtn" id="navReview" onclick="go('review')">
    <div class="ico">üß†</div><span>Tekrar</span>
  </button>
  <button class="navBtn" id="navCards" onclick="go('cards')">
    <div class="ico">üóÇÔ∏è</div><span>Kartlar</span>
  </button>
</nav>

<div class="toast" id="toast">‚Äî</div>
<div class="backdrop" id="backdrop" onclick="closeSheets()"></div>

<!-- SETTINGS SHEET -->
<div class="sheet" id="settingsSheet">
  <div class="handle"></div>
  <h2 class="h2">Ayarlar</h2>

  <div class="card" style="margin-top:10px;">
    <div style="font-weight:980;">Tema</div>
    <div class="smallInfo">üé® butonu temayƒ± d√∂nd√ºr√ºr.</div>
    <div class="two" style="margin-top:10px;">
      <select id="themeSelect" onchange="applyThemeFromSelect()">
        <option value="dark">dark</option>
        <option value="light">light</option>
        <option value="ocean">ocean</option>
        <option value="emerald">emerald</option>
        <option value="sunset">sunset</option>
        <option value="rose">rose</option>
      </select>
      <button class="btn btnSoft" style="padding:12px 12px;" onclick="document.getElementById('btnTheme').click()">D√∂nd√ºr</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Veri Y√∂netimi</div>
    <div class="smallInfo">Kartlarƒ±nƒ± dƒ±≈üa aktar / i√ße aktar</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="exportAll()">Export</button>
      <button class="btn btnSoft btnHalf" onclick="importAllPrompt()">Import</button>
    </div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnDanger btnHalf" onclick="hardReset()">Her ≈ûeyi Sƒ±fƒ±rla</button>
      <button class="btn btnSoft btnHalf" onclick="toast('ƒ∞pucu: Import ile geri y√ºkleyebilirsin')">ƒ∞pucu</button>
    </div>
  </div>

  <div class="smallInfo" style="margin-top:12px;">S√ºr√ºm: 3-tab (home/review/cards) + auto-manual-fill + quiz</div>
</div>

<!-- CARD SHEET (MANUAL ADD + EDIT) -->
<div class="sheet" id="cardSheet">
  <div class="handle"></div>
  <h2 class="h2" id="csTitle">Kelime Ekle</h2>

  <div class="field">
    <label>Dil</label>
    <select id="csLang">
      <option value="EN">ƒ∞ngilizce</option>
      <option value="RU">Rus√ßa</option>
      <option value="DE">Almanca</option>
      <option value="FR">Fransƒ±zca</option>
      <option value="TR">T√ºrk√ße</option>
    </select>
  </div>

  <div class="field">
    <label>Kelime / Terim</label>
    <input id="csTerm" placeholder="√ñrn: reinforcement" />
    <div class="smallInfo">Yazƒ±nca anlam + seviye otomatik doldurulur (bo≈üsa).</div>
  </div>

  <div class="field">
    <label>Anlamƒ± (TR)</label>
    <input id="csMeaning" placeholder="Otomatik √ßeviri..." />
  </div>

  <div class="two">
    <div style="flex:1;">
      <label>T√ºr</label>
      <select id="csType">
        <option value="word">Kelime</option>
        <option value="phrase">Kalƒ±p</option>
        <option value="idiom">Deyim</option>
        <option value="phrasal">Phrasal Verb</option>
        <option value="noun">ƒ∞sim</option>
        <option value="verb">Fiil</option>
        <option value="adj">Sƒ±fat</option>
        <option value="adv">Zarf</option>
      </select>
    </div>
    <div style="flex:1;">
      <label>Seviye</label>
      <select id="csLevel">
        <option value="A1">A1</option><option value="A2">A2</option>
        <option value="B1">B1</option><option value="B2">B2</option>
        <option value="C1">C1</option><option value="C2">C2</option>
        <option value="UNK" selected>Bilinmiyor</option>
      </select>
    </div>
  </div>

  <div class="field">
    <label>Kategori</label>
    <input id="csCategory" placeholder="√ñrn: Civil / Site / Concrete / Steel" />
  </div>

  <div class="field">
    <label>√ñrnek C√ºmle</label>
    <textarea id="csExample" placeholder="√ñrn: The reinforcement bars were placed according to the drawing."></textarea>
  </div>

  <div class="field">
    <label>Not</label>
    <input id="csNote" placeholder="ƒ∞pucu/Not (opsiyonel)" />
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="autoTranslateForSheet()">Otomatik √áevir</button>
    <button class="btn btnPrimary btnHalf" onclick="saveCardFromSheet()">Kaydet</button>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="closeSheets()">Kapat</button>
    <button class="btn btnDanger btnHalf" id="csDeleteBtn" onclick="deleteCardFromSheet()" style="display:none;">Sil</button>
  </div>
</div>

<!-- QUIZ OVERLAY -->
<div class="overlay" id="quizOverlay">

  <div class="overlayTop">
    <div style="font-weight:980;">Quiz</div>
    <button class="iconBtn" onclick="stopQuiz()">√ó</button>
  </div>

  <div id="quizBody" style="padding:18px 18px 24px 18px;">
    <div class="qTopStats" style="margin-top:6px;">
      <div class="qPill">Kalan: <span id="qRemain">0</span>/<span id="qTotal">0</span></div>
      <div class="qPill">‚úÖ <span id="qCorrect">0</span>  ‚ùå <span id="qWrong">0</span></div>
    </div>

    <div class="qProgOuter">
      <div class="qProgInner" id="qProg"></div>
    </div>

    <div id="qMeta" style="margin-top:12px; opacity:.85; font-weight:900; font-size:12px; text-align:center;">
      ‚Äî
    </div>

    <div id="qWord" style="margin-top:14px; font-size:40px; font-weight:1000; text-align:center;">
      ‚Äî
    </div>

    <div id="qChoices" style="margin-top:18px; display:flex; flex-direction:column; gap:10px;">
    </div>

    <div class="qInputWrap" id="qTyping" style="display:none">
      <input id="qInput" class="qInput" placeholder="Anlamƒ±nƒ± yaz..." />
      <button class="qCheckBtn" onclick="checkTypingAnswer()">Kontrol</button>
    </div>

    <div class="qAnswerReveal" id="qReveal"></div>

    <div class="two" style="margin-top:14px;">
      <button class="btn btnSoft btnHalf" onclick="toggleQuizMode()">Mod: <span id="qModeLabel">√áoktan Se√ßmeli</span></button>
      <button class="btn btnSoft btnHalf" onclick="speakQuizWord()">üîä Oku</button>
    </div>
  </div>

  <div id="quizSummary" style="display:none; padding:24px; text-align:center">
    <h2 style="margin-bottom:10px">Quiz Bitti</h2>

    <div style="font-size:14px; font-weight:900; margin-bottom:16px">
      Doƒüru: <span id="sumCorrect">0</span> |
      Yanlƒ±≈ü: <span id="sumWrong">0</span> |
      Ba≈üarƒ±: <span id="sumRate">0%</span>
    </div>

    <button class="btn btnPrimary" onclick="repeatWrongQuiz()" style="width:100%; margin-bottom:10px">
      Yanlƒ±≈ülarƒ± Tekrar Sor
    </button>

    <button class="btn btnSoft" onclick="stopQuiz()" style="width:100%">
      √áƒ±k
    </button>
  </div>

</div>

<script>
  // ---------------- Storage ----------------
  const DB = {
    get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  // ---------------- Toast ----------------
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  // ---------------- State ----------------
  const themes = ["dark","light","ocean","emerald","sunset","rose"];
  const state = {
    settings: DB.get("lm_settings", { theme:"dark" }),
    cards: DB.get("lm_cards", []),
    txCache: DB.get("lm_tx_cache", {}),        // √ßeviri cache
    reviewQueue: DB.get("lm_review_queue", []) // bug√ºnk√º quiz kuyruƒüu
  };

  function saveAllState(){
    DB.set("lm_settings", state.settings);
    DB.set("lm_cards", state.cards);
    DB.set("lm_tx_cache", state.txCache);
    DB.set("lm_review_queue", state.reviewQueue);
  }

  function setTheme(name){
    document.documentElement.setAttribute("data-theme", name);
    state.settings.theme = name;
    DB.set("lm_settings", state.settings);
    const meta = document.getElementById("meta-theme");
    meta.setAttribute("content", getComputedStyle(document.documentElement).getPropertyValue("--bg").trim() || "#0b1220");
    const sel = document.getElementById("themeSelect");
    if(sel) sel.value = name;
  }

  function applyThemeFromSelect(){
    const v = document.getElementById("themeSelect").value;
    setTheme(v);
    toast("Tema: " + v);
  }

  document.getElementById("btnTheme").onclick = () => {
    const idx = (themes.indexOf(state.settings.theme) + 1) % themes.length;
    setTheme(themes[idx]);
    toast("Tema: " + themes[idx]);
  };

  document.getElementById("btnSettings").onclick = () => {
    document.getElementById("themeSelect").value = state.settings.theme;
    openSheet("settingsSheet");
  };

  // ---------------- Router (go) ----------------
  function go(id){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
    if(id==="home") document.getElementById("navHome").classList.add("active");
    if(id==="review") document.getElementById("navReview").classList.add("active");
    if(id==="cards") document.getElementById("navCards").classList.add("active");

    if(id === "home") renderDash();
    if(id === "cards") renderCards();
    if(id === "review") renderReview();
  }

  // ---------------- Sheets ----------------
  const backdrop = document.getElementById("backdrop");
  function openSheet(id){
    backdrop.classList.add("open");
    document.getElementById(id).classList.add("open");
  }
  function closeSheets(){
    backdrop.classList.remove("open");
    document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open"));
  }

  // ---------------- Utils ----------------
  function normKey(w){ return (w||"").toLowerCase().trim(); }

  function debounce(fn, wait=450){
    let t;
    return (...args)=>{
      clearTimeout(t);
      t = setTimeout(()=>fn(...args), wait);
    };
  }

  // ---------------- Offline dictionary (EN->TR) ----------------
  // Not: Bu listeyi istersen 10.000+ yapabiliriz. ≈ûu an "√ßekirdek + civil" karƒ±≈üƒ±k.
  const OFFLINE_EN_TR = {
    "that":"≈üu / o / -diƒüi ≈üey","this":"bu","into":"i√ßine","past":"ge√ßmi≈ü / ge√ßmi≈üten","met":"tanƒ±≈ütƒ± / bulu≈ütu",
    "above":"√ºst√ºnde","from":"-den/-dan","seem":"gibi g√∂r√ºnmek","still":"hala","rose":"g√ºl / y√ºkseldi",
    "would":"-erdi","wonder":"merak etmek","even":"bile","notice":"fark etmek","matter":"mesele / √∂nemsemek",
    "anyone":"kimse / herhangi biri","at once":"hemen / aynƒ± anda","badly":"k√∂t√º bir ≈üekilde",
    "across":"kar≈üƒ±dan kar≈üƒ±ya / boyunca","round":"etrafƒ±nda / yuvarlak","passage":"ge√ßit / koridor","bend":"viraj / kƒ±vrƒ±m",
    "dark":"karanlƒ±k","went":"gitti","down":"a≈üaƒüƒ±","and":"ve","the":"(belirli artikel)","a":"bir","in":"i√ßinde","on":"√ºzerinde","to":"-e/-a",
    "always":"her zaman","woman":"kadƒ±n","seldom":"nadiren","mention":"bahsetmek","under":"altƒ±nda","other":"diƒüer","name":"isim",
    "beginning":"ba≈ülangƒ±√ß","tired":"yorgun","nothing":"hi√ßbir ≈üey",
    "truth":"ger√ßek","universally":"evrensel olarak","acknowledged":"kabul edilmi≈ü",
    "single":"bekar / tek","possession":"sahiplik","fortune":"servet","want":"istemek / ihtiya√ß duymak","wife":"e≈ü",

    /* Civil / Construction core */
    "concrete":"beton",
    "cement":"√ßimento",
    "aggregate":"agrega",
    "sand":"kum",
    "gravel":"√ßakƒ±l",
    "water-cement ratio":"su/√ßimento oranƒ±",
    "slump":"√ß√∂kme (slump)",
    "curing":"k√ºr (bakƒ±m)",
    "reinforcement":"donatƒ±",
    "rebar":"in≈üaat demiri (donatƒ± √ßeliƒüi)",
    "stirrup":"etriye",
    "formwork":"kalƒ±p",
    "scaffolding":"iskele",
    "foundation":"temel",
    "footing":"temel pabucu / radye altƒ±",
    "pile":"kazƒ±k",
    "bored pile":"fore kazƒ±k",
    "driven pile":"√ßakma kazƒ±k",
    "retaining wall":"istinat duvarƒ±",
    "shear wall":"perde duvar",
    "beam":"kiri≈ü",
    "column":"kolon",
    "slab":"d√∂≈üeme",
    "lintel":"lent√∂",
    "masonry":"yƒ±ƒüma",
    "brick":"tuƒüla",
    "block":"blok",
    "mortar":"har√ß",
    "plaster":"sƒ±va",
    "screed":"≈üap",
    "waterproofing":"su yalƒ±tƒ±mƒ±",
    "insulation":"yalƒ±tƒ±m",
    "thermal insulation":"ƒ±sƒ± yalƒ±tƒ±mƒ±",
    "sound insulation":"ses yalƒ±tƒ±mƒ±",
    "expansion joint":"dilatasyon derzi",
    "construction joint":"soƒüuk derz",
    "crack":"√ßatlak",
    "deflection":"sehim",
    "settlement":"oturma",
    "bearing capacity":"ta≈üƒ±ma g√ºc√º",
    "soil":"zemin",
    "clay":"kil",
    "silt":"silt",
    "compaction":"sƒ±kƒ±≈ütƒ±rma",
    "density":"yoƒüunluk",
    "excavation":"kazƒ±",
    "backfill":"geri dolgu",
    "survey":"√∂l√ß√ºm / harita √ßalƒ±≈ümasƒ±",
    "level":"kot / nivo",
    "plumb":"d√º≈üey (≈üak√ºl)",
    "tolerance":"tolerans",
    "specification":"≈üartname",
    "drawing":"√ßizim / proje",
    "blueprint":"proje kopyasƒ±",
    "quantity":"miktar",
    "bill of quantities":"metraj",
    "estimate":"ke≈üif / tahmin",
    "tender":"ihale",
    "contract":"s√∂zle≈üme",
    "site":"≈üantiye",
    "supervisor":"≈üantiye ≈üefi / kontrol",
    "inspection":"kontrol / muayene",
    "nonconformance":"uygunsuzluk",
    "workmanship":"i≈ü√ßilik kalitesi",
    "schedule":"takvim / i≈ü programƒ±",
    "delay":"gecikme",
    "critical path":"kritik yol",
    "safety":"i≈ü g√ºvenliƒüi",
    "ppe":"ki≈üisel koruyucu donanƒ±m",
    "risk assessment":"risk deƒüerlendirmesi",
    "load":"y√ºk",
    "dead load":"sabit y√ºk",
    "live load":"hareketli y√ºk",
    "wind load":"r√ºzgar y√ºk√º",
    "seismic load":"deprem y√ºk√º",
    "stress":"gerilme",
    "strain":"birim ≈üekil deƒüi≈ütirme",
    "yield strength":"akma dayanƒ±mƒ±",
    "ultimate strength":"nihai dayanƒ±m",
    "steel":"√ßelik",
    "weld":"kaynak",
    "bolt":"cƒ±vata",
    "anchor bolt":"ankraj cƒ±vatasƒ±",
    "base plate":"taban plakasƒ±",
    "girder":"ana kiri≈ü",
    "truss":"kafes kiri≈ü",
    "connection":"baƒülantƒ±",
    "moment":"moment",
    "shear":"kesme",
    "torsion":"burulma",
    "buckling":"burkulma"
  };

  // ---------------- CEFR Guess (EN) ----------------
  // Not: Bunu b√ºy√ºt√ºrsek (binlerce kelime) seviye tahmini daha ‚Äúger√ßek‚Äù olur.
  const CEFR_HINTS_EN = {
    A1: new Set(["this","that","in","on","to","from","into","across","still","even"]),
    A2: new Set(["notice","matter","wonder","past","met","above","round"]),
    B1: new Set(["estimate","schedule","delay","contract","inspection","settlement","deflection"]),
    B2: new Set(["nevertheless","subsequently","nonconformance","workmanship","specification","bearing capacity"]),
    C1: new Set(["scrutinize","substantiate","torsion","buckling"])
  };

  function inferLevel(lang, term){
    const t = normKey(term);
    if(!t) return "UNK";
    if(lang !== "EN") return "UNK";
    for(const lvl of ["A1","A2","B1","B2","C1"]){
      if(CEFR_HINTS_EN[lvl]?.has(t)) return lvl;
    }
    // k√º√ß√ºk heuristik
    if(t.includes("non") || t.includes("tion") || t.length >= 12) return "B2";
    if(t.length >= 9) return "B1";
    return "UNK";
  }

  // ---------------- Auto Translate (sheet) ----------------
  async function autoTranslateForSheet(){
    const term = document.getElementById("csTerm").value.trim();
    const lang = document.getElementById("csLang").value.trim();
    if(!term) return toast("Kelime bo≈ü olamaz.");

    const key = `${lang}|${normKey(term)}`;

    // cache
    if(state.txCache[key]){
      if(!document.getElementById("csMeaning").value.trim()){
        document.getElementById("csMeaning").value = state.txCache[key];
      }
      toast("Cache √ßeviri ‚úÖ");
      return state.txCache[key];
    }

    // offline (EN)
    if(lang === "EN"){
      const k = normKey(term);
      if(OFFLINE_EN_TR[k]){
        const out = OFFLINE_EN_TR[k];
        state.txCache[key] = out;
        DB.set("lm_tx_cache", state.txCache);
        if(!document.getElementById("csMeaning").value.trim()){
          document.getElementById("csMeaning").value = out;
        }
        toast("Offline s√∂zl√ºk ‚úÖ");
        return out;
      }
    }

    // online
    try{
      const sl = ({EN:"en", RU:"ru", DE:"de", FR:"fr", TR:"tr"})[lang] || "auto";
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=tr&dt=t&q=${encodeURIComponent(term)}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error("gtx_fail");
      const data = await r.json();
      const out = (data?.[0]?.[0]?.[0] || "").trim();
      if(out){
        state.txCache[key] = out;
        DB.set("lm_tx_cache", state.txCache);
        if(!document.getElementById("csMeaning").value.trim()){
          document.getElementById("csMeaning").value = out;
        }
        toast("Online √ßeviri ‚úÖ");
        return out;
      }
      throw new Error("gtx_empty");
    }catch(e){
      toast("√áeviri bulunamadƒ± (manuel gir).");
      return "";
    }
  }

  // ---------------- Auto Fill for manual entry ----------------
  async function autoFillManualEntry(){
    const termEl = document.getElementById("csTerm");
    const langEl = document.getElementById("csLang");
    const meaningEl = document.getElementById("csMeaning");
    const levelEl = document.getElementById("csLevel");
    const typeEl = document.getElementById("csType");

    const term = termEl.value.trim();
    const lang = langEl.value;

    if(!term) return;

    // type hint
    if(typeEl.value === "word"){
      if(term.includes(" ") && term.length >= 4){
        // phrase
        typeEl.value = "phrase";
      }
    }

    // level auto only if UNK
    if(levelEl.value === "UNK"){
      const guessed = inferLevel(lang, term);
      if(guessed !== "UNK") levelEl.value = guessed;
    }

    // meaning auto only if empty
    if(!meaningEl.value.trim()){
      await autoTranslateForSheet();
    }
  }
  const autoFillManualEntryDebounced = debounce(autoFillManualEntry, 500);

  // ---------------- SRS (SM-2 like) ----------------
  // Card: {id, term, meaning, lang, type, level, category, example, note, due, srs:{interval,reps,ef}}
  function srsCalc(card, quality){
    let s = card.srs || { interval:0, reps:0, ef:2.5 };
    let { interval, reps, ef } = s;

    if(quality >= 3){
      if(reps === 0) interval = 1;
      else if(reps === 1) interval = 6;
      else interval = Math.round(interval * ef);

      reps++;
      ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
      if(ef < 1.3) ef = 1.3;
    }else{
      reps = 0;
      interval = 1;
    }

    const nextDue = Date.now() + interval * 24*60*60*1000;
    return { due: nextDue, srs:{ interval, reps, ef } };
  }

  // ---------------- Cards CRUD ----------------
  let editingCardId = null;

  function openManualAdd(){
    editingCardId = null;
    document.getElementById("csTitle").textContent = "Kelime Ekle";
    document.getElementById("csDeleteBtn").style.display = "none";

    document.getElementById("csLang").value = "EN";
    document.getElementById("csTerm").value = "";
    document.getElementById("csMeaning").value = "";
    document.getElementById("csType").value = "word";
    document.getElementById("csLevel").value = "UNK";
    document.getElementById("csCategory").value = "";
    document.getElementById("csExample").value = "";
    document.getElementById("csNote").value = "";
    openSheet("cardSheet");
  }

  function openEditCard(cardId){
    const c = state.cards.find(x=>x.id===cardId);
    if(!c) return;
    editingCardId = c.id;

    document.getElementById("csTitle").textContent = "Kartƒ± D√ºzenle";
    document.getElementById("csDeleteBtn").style.display = "flex";

    document.getElementById("csLang").value = c.lang || "EN";
    document.getElementById("csTerm").value = c.term || "";
    document.getElementById("csMeaning").value = c.meaning || "";
    document.getElementById("csType").value = c.type || "word";
    document.getElementById("csLevel").value = c.level || "UNK";
    document.getElementById("csCategory").value = c.category || "";
    document.getElementById("csExample").value = c.example || "";
    document.getElementById("csNote").value = c.note || "";
    openSheet("cardSheet");
  }

  async function saveCardFromSheet(){
    // auto-fill once more before save (only if fields empty)
    await autoFillManualEntry();

    const lang = document.getElementById("csLang").value;
    const term = document.getElementById("csTerm").value.trim();
    const meaning = document.getElementById("csMeaning").value.trim();
    const type = document.getElementById("csType").value;
    const level = document.getElementById("csLevel").value;
    const category = document.getElementById("csCategory").value.trim();
    const example = document.getElementById("csExample").value.trim();
    const note = document.getElementById("csNote").value.trim();

    if(!term) return toast("Kelime/terim bo≈ü olamaz.");
    if(!meaning) return toast("Anlam bo≈ü olamaz.");

    // term uniqueness per lang (optional)
    const dup = state.cards.find(x=>x.id!==editingCardId && x.lang===lang && normKey(x.term)===normKey(term));
    if(dup){
      return toast("Bu kelime zaten var (aynƒ± dil).");
    }

    const now = Date.now();

    if(!editingCardId){
      const card = {
        id: "c_" + Math.random().toString(36).slice(2),
        term, meaning, lang,
        type, level, category, example, note,
        due: now,
        srs: { interval:0, reps:0, ef:2.5 }
      };
      state.cards.push(card);
    }else{
      const idx = state.cards.findIndex(x=>x.id===editingCardId);
      if(idx>=0){
        state.cards[idx] = {
          ...state.cards[idx],
          term, meaning, lang, type, level, category, example, note
        };
      }
    }

    DB.set("lm_cards", state.cards);

    // activity
    const activity = DB.get("lm_activity", {});
    const k = new Date().toISOString().slice(0,10);
    activity[k] = (activity[k] || 0) + 1;
    DB.set("lm_activity", activity);

    toast("Kaydedildi ‚úÖ");
    closeSheets();
    renderDash();
    renderReview();
    renderCards();
  }

  function deleteCardFromSheet(){
    if(!editingCardId) return closeSheets();
    const idx = state.cards.findIndex(x=>x.id===editingCardId);
    if(idx<0) return toast("Kart bulunamadƒ±.");
    state.cards.splice(idx,1);
    DB.set("lm_cards", state.cards);
    toast("Silindi");
    editingCardId = null;
    closeSheets();
    renderDash();
    renderReview();
    renderCards();
  }

  // ---------------- Cards view ----------------
  document.getElementById("search").addEventListener("input", renderCards);

  function renderCards(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const list = document.getElementById("cardsList");
    list.innerHTML = "";

    const items = state.cards
      .filter(c => !q
        || (c.term||"").toLowerCase().includes(q)
        || (c.meaning||"").toLowerCase().includes(q)
        || (c.category||"").toLowerCase().includes(q)
        || (c.level||"").toLowerCase().includes(q)
      )
      .sort((a,b)=> (a.term||"").localeCompare((b.term||""), "tr", {sensitivity:"base"}));

    if(items.length===0){
      const e = document.createElement("div");
      e.className = "card";
      e.innerHTML = `<div style="font-weight:980;">Hen√ºz kart yok</div><div class="smallInfo">‚ûï Elle Kelime Ekle ile eklemeye ba≈üla.</div>`;
      list.appendChild(e);
      return;
    }

    items.forEach(c=>{
      const isDue = (c.due||0) <= Date.now();
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.style.cursor = "pointer";
      e.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-weight:980; color:var(--primary); font-size:20px;">${escapeHtml(c.term)}</div>
          <div class="smallInfo" style="font-weight:980; color:${isDue?'var(--warn)':'var(--muted)'}">${isDue?'DUE':'OK'}</div>
        </div>
        <div class="smallInfo">${escapeHtml(c.lang||'')} ‚Ä¢ ${escapeHtml(c.meaning||'')}</div>
        <div class="smallInfo" style="margin-top:6px;">T√ºr: ${escapeHtml(c.type||'-')} ‚Ä¢ Seviye: ${escapeHtml(c.level||'-')} ‚Ä¢ Kategori: ${escapeHtml((c.category||'-') || '-')}</div>
        <div class="smallInfo" style="margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(c.example || c.note || "")}</div>
      `;
      e.onclick = ()=>openEditCard(c.id);
      list.appendChild(e);
    });
  }

  function escapeHtml(s){
    return (s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------------- Dashboard ----------------
  function renderDash(){
    document.getElementById("dashTotal").textContent = state.cards.length;
    document.getElementById("dashDue").textContent = state.cards.filter(c => (c.due||0) <= Date.now()).length;

    const activity = DB.get("lm_activity", {});
    const today = new Date();
    let streak = 0;
    for(let i=0;i<365;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      if((activity[k]||0)>0) streak++;
      else break;
    }
    document.getElementById("dashStreak").textContent = streak + " G√ºn";

    let week = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      week += (activity[k]||0);
    }
    document.getElementById("dashWeek").textContent = week;
  }

  // ---------------- Review Page ----------------
  function getDueCards(){
    const now = Date.now();
    return state.cards.filter(c => (c.due||0) <= now);
  }

  function renderReview(){
    document.getElementById("rvTotal").textContent = state.cards.length;
    document.getElementById("rvDue").textContent = getDueCards().length;
  }

  function resetTodaysQueue(){
    const due = getDueCards();
    let q = [];
    if(due.length > 0){
      q = due.map(c=>c.id);
    }else{
      q = [...state.cards].sort(()=>Math.random()-0.5).slice(0, Math.min(30, state.cards.length)).map(c=>c.id);
    }
    state.reviewQueue = q;
    DB.set("lm_review_queue", state.reviewQueue);
    toast("Kuyruk yenilendi ‚úÖ");
    renderReview();
  }

  function clearProgress(){
    state.cards = state.cards.map(c=>({
      ...c,
      due: Date.now(),
      srs:{ interval:0, reps:0, ef:2.5 }
    }));
    DB.set("lm_cards", state.cards);
    toast("SRS sƒ±fƒ±rlandƒ± ‚úÖ");
    renderDash(); renderReview(); renderCards();
  }

  // ---------------- Quiz Engine ----------------
  let quizCurrent = null; // { card, choices[], correctIndex }
  let quizSelectedChoiceIndex = null;
  let quizMode = "choice"; // "choice" | "typing"
  let wrongCardsThisQuiz = [];

  function updateQuizProgressUI(){
    const total = parseInt(document.getElementById("qTotal").textContent) || 0;
    const remain = parseInt(document.getElementById("qRemain").textContent) || 0;
    const done = total - remain;
    const pct = total ? Math.round((done/total)*100) : 0;
    document.getElementById("qProg").style.width = pct + "%";
  }

  function startReviewQuiz(){
    if(state.cards.length === 0){
      toast("Kart yok. √ñnce kart ekle.");
      return;
    }
    if(!state.reviewQueue || state.reviewQueue.length === 0){
      resetTodaysQueue();
    }

    const total = state.reviewQueue.length;
    document.getElementById("qTotal").textContent = total;
    document.getElementById("qRemain").textContent = total;
    document.getElementById("qCorrect").textContent = 0;
    document.getElementById("qWrong").textContent = 0;
    document.getElementById("qReveal").textContent = "";
    wrongCardsThisQuiz = [];

    document.getElementById("quizBody").style.display = "block";
    document.getElementById("quizSummary").style.display = "none";

    syncQuizModeUI();
    openQuizOverlay();
    nextQuizQuestion();
  }

  function openQuizOverlay(){
    document.getElementById("quizOverlay").classList.add("open");
  }
  function stopQuiz(){
    document.getElementById("quizOverlay").classList.remove("open");
    quizCurrent = null;
    quizSelectedChoiceIndex = null;
    renderDash();
    renderReview();
  }

  function syncQuizModeUI(){
    document.getElementById("qModeLabel").textContent = (quizMode === "choice") ? "√áoktan Se√ßmeli" : "Yazma";
    document.getElementById("qChoices").style.display = (quizMode === "choice") ? "flex" : "none";
    document.getElementById("qTyping").style.display = (quizMode === "typing") ? "flex" : "none";
    document.getElementById("qReveal").textContent = "";
    const input = document.getElementById("qInput");
    input.value = "";
    input.classList.remove("correct","wrong");
  }

  function toggleQuizMode(){
    quizMode = (quizMode === "choice") ? "typing" : "choice";
    toast("Quiz modu: " + (quizMode === "choice" ? "√áoktan Se√ßmeli" : "Yazma"));
    syncQuizModeUI();
    // mevcut soru varsa yeniden bas
    if(quizCurrent){
      if(quizMode === "choice"){
        renderChoices(quizCurrent);
      }else{
        document.getElementById("qChoices").innerHTML = "";
      }
    }
  }

  function nextQuizQuestion(){
    if(state.reviewQueue.length === 0){
      showQuizSummary();
      return;
    }

    const total = parseInt(document.getElementById("qTotal").textContent) || 0;
    document.getElementById("qRemain").textContent = state.reviewQueue.length;
    updateQuizProgressUI();

    const id = state.reviewQueue.shift();
    DB.set("lm_review_queue", state.reviewQueue);

    const card = state.cards.find(c=>c.id===id);
    if(!card){
      nextQuizQuestion();
      return;
    }

    // generate choices
    const pool = state.cards.filter(c=>c.id!==card.id).sort(()=>Math.random()-0.5);
    const distractors = pool.slice(0,3).map(x=>x.meaning).filter(Boolean);
    const baseChoices = [...new Set([...distractors, card.meaning])];
    while(baseChoices.length < 4 && pool.length){
      const extra = pool.pop()?.meaning;
      if(extra && !baseChoices.includes(extra)) baseChoices.push(extra);
    }
    const choices = baseChoices.sort(()=>Math.random()-0.5);
    const correctIndex = choices.indexOf(card.meaning);

    quizCurrent = { card, choices, correctIndex };
    quizSelectedChoiceIndex = null;

    document.getElementById("qMeta").textContent =
      `${card.lang} ‚Ä¢ ${card.type||'word'} ‚Ä¢ ${card.level||'UNK'} ‚Ä¢ Due: ${((card.due||0) <= Date.now()) ? 'YES' : 'NO'}`;
    document.getElementById("qWord").textContent = card.term;

    document.getElementById("qReveal").textContent = "";
    const input = document.getElementById("qInput");
    input.value = "";
    input.classList.remove("correct","wrong");

    if(quizMode === "choice"){
      renderChoices(quizCurrent);
    }else{
      document.getElementById("qChoices").innerHTML = "";
      document.getElementById("qTyping").style.display = "flex";
      document.getElementById("qChoices").style.display = "none";
      setTimeout(()=>document.getElementById("qInput").focus(), 80);
    }
  }

  function renderChoices(qc){
    const box = document.getElementById("qChoices");
    box.innerHTML = "";
    qc.choices.forEach((ch, idx)=>{
      const b = document.createElement("button");
      b.className = "qChoice";
      b.textContent = ch;
      b.onclick = ()=>selectChoice(idx);
      box.appendChild(b);
    });
  }

  function bumpCounters(isCorrect){
    const correct = parseInt(document.getElementById("qCorrect").textContent) || 0;
    const wrong = parseInt(document.getElementById("qWrong").textContent) || 0;
    if(isCorrect) document.getElementById("qCorrect").textContent = correct + 1;
    else document.getElementById("qWrong").textContent = wrong + 1;
  }

  function selectChoice(idx){
    quizSelectedChoiceIndex = idx;
    const all = Array.from(document.querySelectorAll(".qChoice"));
    all.forEach(b=>b.disabled = true);

    const qc = quizCurrent;
    if(!qc) return;

    const isCorrect = idx === qc.correctIndex;

    all.forEach((b,i)=>{
      if(i === qc.correctIndex) b.classList.add("correct");
    });
    if(!isCorrect){
      all[idx]?.classList.add("wrong");
      wrongCardsThisQuiz.push(qc.card.id);
      document.getElementById("qReveal").textContent = `Doƒüru: ${qc.card.meaning}`;
    }

    bumpCounters(isCorrect);

    // grade: correct -> 4, wrong -> 2
    gradeAndContinue(isCorrect ? 4 : 2);
  }

  function normalizeMeaningForCompare(s){
    return (s||"")
      .toLowerCase()
      .trim()
      .replaceAll("‚Äô","'")
      .replaceAll("‚Äú","\"")
      .replaceAll("‚Äù","\"")
      .replace(/[^\p{L}\p{N}\s-]/gu, "")
      .replace(/\s+/g, " ");
  }

  function checkTypingAnswer(){
    if(!quizCurrent) return;
    const input = document.getElementById("qInput");
    const user = normalizeMeaningForCompare(input.value);
    const ans = normalizeMeaningForCompare(quizCurrent.card.meaning);

    const ok = user.length >= 2 && (ans.includes(user) || user.includes(ans));
    input.classList.remove("correct","wrong");
    input.classList.add(ok ? "correct" : "wrong");

    if(!ok){
      wrongCardsThisQuiz.push(quizCurrent.card.id);
      document.getElementById("qReveal").textContent = `Doƒüru: ${quizCurrent.card.meaning}`;
    }else{
      document.getElementById("qReveal").textContent = "‚úÖ Doƒüru";
    }

    bumpCounters(ok);

    // typing grading: ok->4, wrong->1
    setTimeout(()=>gradeAndContinue(ok ? 4 : 1), 650);
  }

  function gradeAndContinue(q){
    if(!quizCurrent) return;
    const card = quizCurrent.card;

    // SRS update
    const upd = srsCalc(card, q);
    card.due = upd.due;
    card.srs = upd.srs;

    // activity
    const activity = DB.get("lm_activity", {});
    const k = new Date().toISOString().slice(0,10);
    activity[k] = (activity[k] || 0) + 1;
    DB.set("lm_activity", activity);

    DB.set("lm_cards", state.cards);

    // remaining UI
    document.getElementById("qRemain").textContent = state.reviewQueue.length;
    updateQuizProgressUI();

    setTimeout(()=>nextQuizQuestion(), 650);
  }

  function showQuizSummary(){
    const correctCount = parseInt(document.getElementById('qCorrect').textContent) || 0;
    const wrongCount = parseInt(document.getElementById('qWrong').textContent) || 0;
    document.getElementById('sumCorrect').textContent = correctCount;
    document.getElementById('sumWrong').textContent = wrongCount;
    const total = correctCount + wrongCount;
    const rate = total ? Math.round((correctCount / total) * 100) : 0;
    document.getElementById('sumRate').textContent = rate + '%';

    document.getElementById('quizBody').style.display = 'none';
    document.getElementById('quizSummary').style.display = 'block';
  }

  function repeatWrongQuiz(){
    if(wrongCardsThisQuiz.length === 0){
      toast('Yanlƒ±≈ü yok.');
      stopQuiz();
      return;
    }
    state.reviewQueue = [...new Set(wrongCardsThisQuiz)];
    DB.set('lm_review_queue', state.reviewQueue);
    wrongCardsThisQuiz = [];

    document.getElementById('quizSummary').style.display = 'none';
    document.getElementById('quizBody').style.display = 'block';

    const total = state.reviewQueue.length;
    document.getElementById('qTotal').textContent = total;
    document.getElementById('qRemain').textContent = total;
    document.getElementById('qCorrect').textContent = 0;
    document.getElementById('qWrong').textContent = 0;
    updateQuizProgressUI();

    nextQuizQuestion();
  }

  // ---------------- Speech ----------------
  function speakQuizWord(){
    const txt = document.getElementById("qWord").textContent || "";
    const lang = (quizCurrent?.card?.lang) || "EN";
    const u = new SpeechSynthesisUtterance(txt);
    const map = {EN:"en-US", RU:"ru-RU", DE:"de-DE", FR:"fr-FR", TR:"tr-TR"};
    u.lang = map[lang] || "en-US";
    u.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ---------------- Import/Export ----------------
  function exportAll(){
    const data = JSON.stringify({
      settings: state.settings,
      cards: state.cards,
      cache: state.txCache
    }, null, 2);
    prompt("Kopyala (Export JSON):", data);
  }

  function importAllPrompt(){
    const txt = prompt("Import JSON yapƒ±≈ütƒ±r:");
    if(!txt) return;
    try{
      const obj = JSON.parse(txt);
      if(obj.settings) state.settings = obj.settings;
      if(obj.cards) state.cards = obj.cards;
      if(obj.cache) state.txCache = obj.cache;

      saveAllState();
      setTheme(state.settings.theme || "dark");
      toast("Import tamam ‚úÖ");
      renderDash(); renderCards(); renderReview();
    }catch(e){
      toast("Import hata");
    }
  }

  function hardReset(){
    if(!confirm("Her ≈üeyi sƒ±fƒ±rlamak istiyor musun?")) return;
    localStorage.removeItem("lm_settings");
    localStorage.removeItem("lm_cards");
    localStorage.removeItem("lm_tx_cache");
    localStorage.removeItem("lm_review_queue");
    localStorage.removeItem("lm_activity");
    location.reload();
  }

  // ---------------- Wire auto-fill events ----------------
  document.getElementById("csTerm").addEventListener("input", autoFillManualEntryDebounced);
  document.getElementById("csLang").addEventListener("change", autoFillManualEntryDebounced);

  // ---------------- Init ----------------
  setTheme(state.settings.theme || "dark");
  renderDash();
  renderCards();
  renderReview();

  // make sure select sync
  window.addEventListener("load", ()=>{
    const sel = document.getElementById("themeSelect");
    if(sel) sel.value = state.settings.theme || "dark";
  });

  // Ensure review queue exists
  if(!state.reviewQueue) state.reviewQueue = [];
</script>
</body>
</html>