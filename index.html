<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Vocab Pocket Ultimate</title>

  <meta name="theme-color" content="#0b0b10" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root {
      --bg: #0b0b10; --panel: #16161e; --card: #1c1c26; 
      --line: #2e2e3e; --text: #e2e2e8; --muted: #8c8c9a;
      --accent: #7c3aed; --accent2: #10b981; --danger: #ef4444; --warn: #f59e0b;
      --nav-height: 64px;
      --radius: 16px;
      --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-read: "Georgia", serif;
    }
    body[data-theme="light"] {
      --bg: #f4f4f5; --panel: #ffffff; --card: #ffffff;
      --line: #e4e4e7; --text: #18181b; --muted: #71717a;
      --accent: #6366f1; --accent2: #10b981;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: var(--font-ui);
      display: flex; flex-direction: column; height: 100vh;
      overflow: hidden;
    }

    /* --- LAYOUT --- */
    main { flex: 1; overflow-y: auto; position: relative; padding-bottom: 80px; }
    .view { display: none; padding: 16px; animation: fadeIn 0.2s; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- NAVIGATION --- */
    .nav-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: var(--nav-height); background: var(--panel);
      border-top: 1px solid var(--line);
      display: flex; justify-content: space-around; align-items: center;
      padding-bottom: env(safe-area-inset-bottom); z-index: 50;
    }
    .nav-item {
      background: none; border: none; color: var(--muted);
      font-size: 10px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px;
      flex: 1; padding: 8px 0; cursor: pointer;
    }
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 22px; margin-bottom: 2px; }

    /* --- HEADER --- */
    .header {
      padding: 16px; background: var(--panel); border-bottom: 1px solid var(--line);
      position: sticky; top: 0; z-index: 40; display: flex; justify-content: space-between; align-items: center;
    }
    .header h1 { margin: 0; font-size: 20px; font-weight: 800; }
    .header-btns { display: flex; gap: 10px; }

    /* --- COMMON COMPONENTS --- */
    .btn {
      padding: 10px 16px; border-radius: 12px; border: 1px solid var(--line);
      background: rgba(255,255,255,0.05); color: var(--text); font-weight: 600; font-size: 13px;
      cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn:active { transform: scale(0.96); }
    .btn.primary { background: var(--accent); border-color: transparent; color: white; }
    .btn.ghost { background: transparent; border: none; color: var(--muted); }
    .btn.sm { padding: 6px 10px; font-size: 12px; }

    .input {
      width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--line);
      border-radius: 12px; color: var(--text); outline: none; font-size: 16px; margin-bottom: 10px;
    }

    /* --- DASHBOARD (HOME) --- */
    .dash-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--card); padding: 16px; border-radius: var(--radius); border: 1px solid var(--line); }
    .stat-val { font-size: 24px; font-weight: 900; }
    .stat-label { font-size: 12px; color: var(--muted); }

    .heatmap { display: flex; gap: 4px; justify-content: space-between; margin-top: 10px; }
    .day-box { flex: 1; aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 4px; position: relative; }
    .day-box.fill { background: var(--accent2); }
    .day-label { font-size: 9px; color: var(--muted); text-align: center; margin-top: 4px; }

    /* --- LIBRARY & READER --- */
    .book-list { display: grid; gap: 12px; }
    .book-item {
      background: var(--card); padding: 16px; border-radius: var(--radius);
      display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--line);
    }
    .lang-tag { font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; margin-right: 6px; }

    .reader-area { 
        font-family: var(--font-read); font-size: 19px; line-height: 1.7; 
        text-align: justify; padding-bottom: 40px; 
    }
    .r-word { cursor: pointer; border-radius: 4px; }
    .r-word:hover { background: rgba(124, 58, 237, 0.2); }
    
    .page-nav { display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid var(--line); margin-top: 20px; }

    /* --- CARDS --- */
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 12px; }
    .flashcard {
      background: var(--card); padding: 16px; border-radius: var(--radius); border: 1px solid var(--line); position: relative;
    }
    .fc-top { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .fc-term { font-size: 20px; font-weight: 800; color: var(--text); }
    .fc-meaning { font-size: 16px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--line); color: var(--muted); }
    
    /* --- QUIZ OVERLAY --- */
    .quiz-overlay {
      position: fixed; inset: 0; background: var(--bg); z-index: 100;
      display: flex; flex-direction: column; padding: 20px;
      transform: translateY(100%); transition: transform 0.3s;
    }
    .quiz-overlay.open { transform: translateY(0); }
    .timer-bar { height: 4px; background: var(--line); border-radius: 2px; overflow: hidden; margin-top: 10px; }
    .timer-fill { height: 100%; background: var(--accent); width: 100%; transition: width 1s linear; }

    /* --- BOTTOM SHEET (Word Add) --- */
    .sheet-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 80; display: none; }
    .sheet-bg.open { display: block; }
    .sheet {
      position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel);
      border-radius: 20px 20px 0 0; padding: 20px; z-index: 90;
      transform: translateY(100%); transition: transform 0.3s;
    }
    .sheet.open { transform: translateY(0); }
    
    .selection-popup {
        position: absolute; background: var(--accent); color: white; padding: 8px 12px;
        border-radius: 8px; font-size: 12px; font-weight: bold; pointer-events: none;
        opacity: 0; transition: opacity 0.2s; z-index: 70;
    }
    .selection-popup.show { opacity: 1; pointer-events: auto; }

    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: var(--text); color: var(--bg); padding: 8px 16px;
      border-radius: 20px; font-size: 12px; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200;
    }
    .toast.show { opacity: 1; }

  </style>
</head>
<body data-theme="dark">

  <header class="header">
    <h1 id="headerTitle">Ana Sayfa</h1>
    <div class="header-btns">
      <button class="btn ghost sm" onclick="toggleTheme()">üåó</button>
      <button class="btn ghost sm" onclick="exportData()">üíæ</button>
    </div>
  </header>

  <main>
    <div id="view-home" class="view active">
       <div class="dash-stats">
           <div class="stat-card">
               <div class="stat-val" id="d-total">0</div>
               <div class="stat-label">Toplam Kelime</div>
           </div>
           <div class="stat-card">
               <div class="stat-val" id="d-due" style="color:var(--warn)">0</div>
               <div class="stat-label">Bug√ºn Tekrar</div>
           </div>
       </div>

       <div class="stat-card">
           <div class="stat-label">Son 7 G√ºn Aktivitesi</div>
           <div class="heatmap" id="heatmap"></div>
       </div>

       <div style="margin-top:20px">
           <button class="btn primary" style="width:100%; padding:16px" onclick="startQuiz(false)">Hƒ±zlƒ± Pratik Ba≈ülat (Quiz)</button>
           <button class="btn" style="width:100%; padding:16px; margin-top:10px" onclick="startQuiz(true)">Zaman Yarƒ±≈üƒ± (60sn) ‚è±Ô∏è</button>
       </div>
    </div>

    <div id="view-library" class="view">
       <div id="library-list" class="book-list"></div>
       <button class="btn primary" style="width:100%; margin-top:20px" onclick="$('#addBookModal').classList.add('open'); $('.sheet-bg').classList.add('open')">+ Yeni Kitap / Metin Ekle</button>
    </div>

    <div id="view-reader" class="view">
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid var(--line); padding-bottom:10px;">
           <button class="btn ghost sm" onclick="nav('library')">‚Üê Kitaplar</button>
           <span style="font-size:12px; color:var(--muted)" id="page-indicator">1/10</span>
           <button class="btn ghost sm" onclick="changeFontSize()">Aa</button>
       </div>
       <div id="reader-canvas" class="reader-area"></div>
       <div class="page-nav">
           <button class="btn ghost" onclick="changePage(-1)">√ñnceki</button>
           <button class="btn ghost" onclick="changePage(1)">Sonraki</button>
       </div>
       <div id="selPopup" class="selection-popup" onclick="addSelection()">+ Karta Ekle</div>
    </div>

    <div id="view-cards" class="view">
       <input class="input" id="search" placeholder="Kelime ara..." oninput="renderCards()">
       <div style="display:flex; gap:8px; margin-bottom:15px; overflow-x:auto">
           <button class="btn sm" onclick="filterCards('ALL')">T√ºm√º</button>
           <button class="btn sm" onclick="filterCards('NEW')">Yeni</button>
           <button class="btn sm" onclick="filterCards('DUE')">Tekrar</button>
       </div>
       <div id="card-grid" class="card-grid"></div>
    </div>
  </main>

  <nav class="nav-bar">
    <button class="nav-item active" onclick="nav('home')" id="nav-home">
      <span class="nav-icon">üè†</span> Ana Sayfa
    </button>
    <button class="nav-item" onclick="nav('library')" id="nav-library">
      <span class="nav-icon">üìö</span> K√ºt√ºphane
    </button>
    <button class="nav-item" onclick="nav('cards')" id="nav-cards">
      <span class="nav-icon">üóÇÔ∏è</span> Kartlar
    </button>
  </nav>

  <div class="sheet-bg" onclick="closeSheets()"></div>
  
  <div class="sheet" id="wordSheet">
    <div style="display:flex; justify-content:space-between; align-items:center">
        <h3 id="sheet-term" style="margin:0; color:var(--accent); font-size:24px;">Word</h3>
        <div style="display:flex; gap:5px">
             <button class="btn ghost sm" onclick="speakSheet()">üîä</button>
             <a id="sheet-translate" href="#" target="_blank" class="btn ghost sm">üåç</a>
        </div>
    </div>
    <div style="margin-top:15px">
        <input class="input" id="sheet-meaning" placeholder="Anlamƒ± nedir?">
        <textarea class="input" id="sheet-example" rows="2" placeholder="√ñrnek c√ºmle"></textarea>
    </div>
    <button class="btn primary" style="width:100%; margin-top:10px" onclick="saveCardFromSheet()">Kaydet</button>
  </div>

  <div class="sheet" id="addBookModal" style="height:80vh">
      <h3>Yeni Metin Ekle</h3>
      <input class="input" id="nb-title" placeholder="Ba≈ülƒ±k (√ñrn: Haber)">
      <select class="input" id="nb-lang">
          <option value="EN">ƒ∞ngilizce</option>
          <option value="RU">Rus√ßa</option>
          <option value="DE">Almanca</option>
      </select>
      <textarea class="input" id="nb-content" style="height:200px" placeholder="Metni buraya yapƒ±≈ütƒ±r..."></textarea>
      <button class="btn primary" style="width:100%" onclick="saveBook()">Ekle</button>
  </div>

  <div class="quiz-overlay" id="quizOverlay">
      <div class="header" style="background:transparent; padding:0; margin-bottom:20px">
          <h2 id="q-mode-title">Quiz</h2>
          <button class="btn ghost" onclick="closeQuiz()">‚úï</button>
      </div>
      <div class="timer-bar" id="timerBar" style="display:none"><div class="timer-fill" id="timerFill"></div></div>
      
      <div id="quiz-card" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
          <div id="q-lang" style="font-size:12px; font-weight:bold; color:var(--muted); margin-bottom:10px">EN</div>
          <div id="q-word" style="font-size:36px; font-weight:900; margin-bottom:20px">Word</div>
          <button class="btn ghost" onclick="speakQuiz()">üîä Dinle</button>
          
          <div id="q-options" style="width:100%; max-width:400px; display:grid; gap:10px; margin-top:30px;">
              </div>
      </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ================== UTILS & STATE ================== */
const $ = s => document.querySelector(s);
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const now = () => Date.now();
const DAY = 86400000;

// Default Data
const DEF_BOOKS = [
    {id:'b1', title:'Sherlock Holmes', lang:'EN', page:0, content:`To Sherlock Holmes she is always the woman. I have seldom heard him mention her under any other name. In his eyes she eclipses and predominates the whole of her sex. It was not that he felt any emotion akin to love for Irene Adler. All emotions, and that one particularly, were abhorrent to his cold, precise but admirably balanced mind.`},
    {id:'b2', title:'Anton Chekhov (RU)', lang:'RU', page:0, content:`–ù–∞ –≤–æ–∫–∑–∞–ª–µ –ù–∏–∫–æ–ª–∞–µ–≤—Å–∫–æ–π –∂–µ–ª–µ–∑–Ω–æ–π –¥–æ—Ä–æ–≥–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å –¥–≤–∞ –ø—Ä–∏—è—Ç–µ–ª—è: –æ–¥–∏–Ω —Ç–æ–ª—Å—Ç—ã–π, –¥—Ä—É–≥–æ–π —Ç–æ–Ω–∫–∏–π. –¢–æ–ª—Å—Ç—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–æ–±–µ–¥–∞–ª –Ω–∞ –≤–æ–∫–∑–∞–ª–µ, –∏ –≥—É–±—ã –µ–≥–æ, –ø–æ–¥–µ—Ä–Ω—É—Ç—ã–µ –º–∞—Å–ª–æ–º, –ª–æ—Å–Ω–∏–ª–∏—Å—å, –∫–∞–∫ —Å–ø–µ–ª—ã–µ –≤–∏—à–Ω–∏.`}
];

let state = {
    cards: JSON.parse(localStorage.getItem('vp_cards') || "[]"),
    books: JSON.parse(localStorage.getItem('vp_books')) || DEF_BOOKS,
    activity: JSON.parse(localStorage.getItem('vp_activity') || "{}"),
    activeBook: null,
    fontSize: 19
};

function save() {
    localStorage.setItem('vp_cards', JSON.stringify(state.cards));
    localStorage.setItem('vp_books', JSON.stringify(state.books));
    localStorage.setItem('vp_activity', JSON.stringify(state.activity));
    updateDash();
}

function init() {
    updateDash();
    renderLibrary();
    // Theme init
    const t = localStorage.getItem('vp_theme') || 'dark';
    document.body.setAttribute('data-theme', t);
}

/* ================== NAVIGATION ================== */
function nav(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    $(`#view-${view}`).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const btn = $(`#nav-${view === 'reader' ? 'library' : view}`);
    if(btn) btn.classList.add('active');

    // Title update
    const titles = { 'home': 'Ana Sayfa', 'library': 'K√ºt√ºphane', 'reader': 'Okuyucu', 'cards': 'Kartlarƒ±m' };
    $('#headerTitle').textContent = titles[view] || 'Vocab Pocket';
    
    if(view === 'cards') renderCards();
    if(view === 'home') updateDash();
}

/* ================== DASHBOARD & HEATMAP ================== */
function updateDash() {
    $('#d-total').textContent = state.cards.length;
    $('#d-due').textContent = state.cards.filter(c => c.due <= now()).length;
    
    // Heatmap
    const hm = $('#heatmap');
    hm.innerHTML = '';
    const today = new Date();
    for(let i=6; i>=0; i--){
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const k = d.toISOString().split('T')[0];
        const val = state.activity[k] || 0;
        
        const box = document.createElement('div');
        box.className = `day-box ${val > 0 ? 'fill' : ''}`;
        box.innerHTML = `<div class="day-label">${['Pz','Pt','Sa','√áa','Pe','Cu','Ct'][d.getDay()]}</div>`;
        hm.appendChild(box);
    }
}

function logActivity() {
    const k = new Date().toISOString().split('T')[0];
    state.activity[k] = (state.activity[k] || 0) + 1;
    save();
}

/* ================== LIBRARY & READER ================== */
function renderLibrary() {
    const list = $('#library-list');
    list.innerHTML = '';
    state.books.forEach(b => {
        const div = document.createElement('div');
        div.className = 'book-item';
        div.innerHTML = `
            <div onclick="openBook('${b.id}')" style="flex:1">
                <div style="font-weight:bold; font-size:16px">${b.title}</div>
                <div style="font-size:12px; color:var(--muted); margin-top:4px">
                    <span class="lang-tag">${b.lang}</span> Sayfa ${b.page+1}
                </div>
            </div>
            <button class="btn ghost sm" onclick="deleteBook('${b.id}')">üóëÔ∏è</button>
        `;
        list.appendChild(div);
    });
}

function saveBook() {
    const t = $('#nb-title').value, c = $('#nb-content').value, l = $('#nb-lang').value;
    if(t && c) {
        state.books.push({ id:uuid(), title:t, content:c, lang:l, page:0 });
        save(); renderLibrary(); closeSheets(); toast("Kitap Eklendi");
    }
}

function deleteBook(id) {
    if(confirm('Sil?')) { state.books = state.books.filter(b=>b.id!==id); save(); renderLibrary(); }
}

// READER CORE
function openBook(id) {
    state.activeBook = state.books.find(b=>b.id===id);
    nav('reader');
    renderPage();
}

function getPages(txt) {
    const pages = [];
    const size = 600; 
    let i=0;
    while(i < txt.length) {
        let e = Math.min(i+size, txt.length);
        if(e < txt.length) {
            let sp = txt.lastIndexOf(' ', e);
            e = sp > i ? sp : e;
        }
        pages.push(txt.slice(i,e).trim());
        i = e;
    }
    return pages;
}

function renderPage() {
    const b = state.activeBook;
    const pages = getPages(b.content);
    if(b.page >= pages.length) b.page = pages.length - 1;
    
    const txt = pages[b.page];
    const canvas = $('#reader-canvas');
    canvas.style.fontSize = state.fontSize + 'px';
    canvas.innerHTML = '';
    
    // Tokenize
    txt.split(/(\s+)/).forEach(chunk => {
        if(chunk.trim().length > 0 && !/^[.,!?;:"¬´¬ª‚Äî-]+$/.test(chunk)) {
            const s = document.createElement('span');
            s.className = 'r-word';
            s.textContent = chunk;
            s.onclick = (e) => clickWord(e, chunk);
            canvas.appendChild(s);
        } else {
            canvas.appendChild(document.createTextNode(chunk));
        }
    });
    
    $('#page-indicator').textContent = `${b.page+1}/${pages.length}`;
}

function changePage(d) {
    state.activeBook.page = Math.max(0, state.activeBook.page + d);
    save(); renderPage();
}

function changeFontSize() {
    state.fontSize = state.fontSize > 24 ? 16 : state.fontSize + 2;
    renderPage();
}

// WORD CLICK & ADD
function clickWord(e, word) {
    e.stopPropagation();
    const clean = word.replace(/[.,!?;:"()]/g, "");
    // Context: Find containing sentence approx
    const txt = document.getElementById('reader-canvas').textContent;
    const idx = txt.indexOf(word);
    const ctx = "..." + txt.substring(Math.max(0, idx-20), Math.min(txt.length, idx+30)) + "...";
    
    $('#sheet-term').textContent = clean;
    $('#sheet-meaning').value = "";
    $('#sheet-example').value = ctx;
    
    const url = `https://translate.google.com/?sl=${state.activeBook.lang}&tl=tr&text=${clean}&op=translate`;
    $('#sheet-translate').href = url;
    
    $('.sheet-bg').classList.add('open');
    $('#wordSheet').classList.add('open');
}

function saveCardFromSheet() {
    const term = $('#sheet-term').textContent;
    const meaning = $('#sheet-meaning').value;
    const example = $('#sheet-example').value;
    const lang = state.activeBook ? state.activeBook.lang : 'EN';
    
    if(!meaning) return toast('Anlam gerekli');
    
    state.cards.push({
        id: uuid(), term, meaning, example, lang,
        due: now(), box: 0, createdAt: now()
    });
    save(); closeSheets(); toast('Kart Eklendi');
}

// SELECTION
document.addEventListener('selectionchange', () => {
    const sel = window.getSelection();
    const pop = $('#selPopup');
    if(sel.toString().length > 1 && $('#view-reader').classList.contains('active')) {
        const r = sel.getRangeAt(0).getBoundingClientRect();
        pop.style.top = (r.bottom + window.scrollY + 10) + 'px';
        pop.style.left = (r.left + window.scrollX) + 'px';
        pop.classList.add('show');
    } else {
        pop.classList.remove('show');
    }
});

function addSelection() {
    const txt = window.getSelection().toString().trim();
    if(txt) clickWord({stopPropagation:()=>{}}, txt);
}

/* ================== CARDS & GRID ================== */
function renderCards(filter='ALL') {
    const g = $('#card-grid'); g.innerHTML = '';
    const q = $('#search').value.toLowerCase();
    
    let list = state.cards.filter(c => (c.term+c.meaning).toLowerCase().includes(q));
    if(filter === 'NEW') list = list.filter(c => c.box === 0);
    if(filter === 'DUE') list = list.filter(c => c.due <= now());
    
    list.sort((a,b) => b.createdAt - a.createdAt);
    
    list.forEach(c => {
        const d = document.createElement('div');
        d.className = 'flashcard';
        const due = c.due <= now() ? '<span style="color:var(--warn); font-size:10px; font-weight:bold">TEKRAR</span>' : '';
        d.innerHTML = `
            <div class="fc-top">
                <span class="lang-tag">${c.lang}</span> ${due}
                <button class="btn ghost sm" onclick="deleteCard('${c.id}')">‚úï</button>
            </div>
            <div class="fc-term">${c.term}</div>
            <div class="fc-meaning">${c.meaning}</div>
        `;
        g.appendChild(d);
    });
}

function deleteCard(id) {
    if(confirm('Sil?')) { state.cards = state.cards.filter(c=>c.id!==id); save(); renderCards(); }
}

/* ================== QUIZ SYSTEM ================== */
let quizQ = [], qIdx = 0, qTimer = null;

function startQuiz(timeAttack) {
    // Priority: Due cards -> Then random
    let due = state.cards.filter(c => c.due <= now());
    if(due.length < 5) due = state.cards; // Fallback
    
    if(due.length === 0) return toast("Kart yok!");
    
    quizQ = due.sort(()=>Math.random()-0.5).slice(0, 20);
    qIdx = 0;
    
    $('#quizOverlay').classList.add('open');
    $('#q-mode-title').textContent = timeAttack ? "Zaman Yarƒ±≈üƒ± (60sn)" : "Quiz";
    
    if(timeAttack) {
        $('#timerBar').style.display = 'block';
        $('#timerFill').style.width = '100%';
        let t = 60;
        if(qTimer) clearInterval(qTimer);
        qTimer = setInterval(() => {
            t--; $('#timerFill').style.width = (t/60*100)+'%';
            if(t<=0) closeQuiz();
        }, 1000);
    } else {
        $('#timerBar').style.display = 'none';
    }
    
    showQ();
}

function showQ() {
    if(qIdx >= quizQ.length) { closeQuiz(); return toast("Quiz Bitti! üéâ"); }
    const c = quizQ[qIdx];
    
    $('#q-word').textContent = c.term;
    $('#q-lang').textContent = c.lang;
    
    // Options
    let opts = state.cards.filter(x => x.id !== c.id).sort(()=>Math.random()-0.5).slice(0,3);
    opts.push(c);
    opts.sort(()=>Math.random()-0.5);
    
    const div = $('#q-options'); div.innerHTML = '';
    opts.forEach(o => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.style.textAlign = 'left'; b.style.width = '100%'; b.style.padding='14px';
        b.textContent = o.meaning;
        b.onclick = () => answer(o.id === c.id, b);
        div.appendChild(b);
    });
}

function answer(correct, btn) {
    const c = quizQ[qIdx];
    if(correct) {
        btn.style.background = 'var(--accent2)';
        btn.style.color = '#000';
        // SRS
        let ivl = c.box === 0 ? 1 : Math.round(Math.pow(2.5, c.box));
        c.box++;
        c.due = now() + (ivl * DAY);
        logActivity();
    } else {
        btn.style.background = 'var(--danger)';
        c.box = 0;
        c.due = now(); // Reset
    }
    save();
    setTimeout(() => { qIdx++; showQ(); }, 600);
}

function closeQuiz() {
    $('#quizOverlay').classList.remove('open');
    if(qTimer) clearInterval(qTimer);
    updateDash();
}

function speakQuiz() { speak($('#q-word').textContent, $('#q-lang').textContent); }

/* ================== GENERAL HELPERS ================== */
function closeSheets() {
    $('.sheet-bg').classList.remove('open');
    $('#wordSheet').classList.remove('open');
    $('#addBookModal').classList.remove('open');
}

function speakSheet() { speak($('#sheet-term').textContent, 'EN'); }

function speak(txt, lang) {
    if(!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    const m = {'EN':'en-US', 'RU':'ru-RU', 'TR':'tr-TR', 'DE':'de-DE'};
    u.lang = m[lang] || 'en-US';
    window.speechSynthesis.speak(u);
}

function toast(msg) {
    const t = $('#toast'); t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
}

function toggleTheme() {
    const n = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', n);
    localStorage.setItem('vp_theme', n);
}

function exportData() {
    const d = JSON.stringify({cards:state.cards, books:state.books});
    const a = document.createElement('a');
    a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(d);
    a.download = 'backup.json';
    a.click();
}

init();
</script>
</body>
</html>
