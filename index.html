<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vocab Pocket Pro</title>

  <meta name="theme-color" content="#0b0b10" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VocabPocket" />

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12121a;
      --card:#151523;
      --card2:#17172a;
      --line:#23233a;
      --text:#f2f2f7;
      --muted:#a6a6bb;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#fb7185;
      --warn:#fbbf24;

      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;

      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(34,197,94,.18), transparent 55%);
      --headerTop: rgba(11,11,16,.92);
      --headerBottom: rgba(11,11,16,.60);
      --inputBg: rgba(21,21,35,.85);
    }

    body[data-theme="dark"]{
      --bg:#0b0b10; --panel:#12121a; --card:#151523; --card2:#17172a;
      --line:#23233a; --text:#f2f2f7; --muted:#a6a6bb;
      --accent:#7c3aed; --accent2:#22c55e;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(34,197,94,.18), transparent 55%);
      --headerTop: rgba(11,11,16,.92);
      --headerBottom: rgba(11,11,16,.60);
      --inputBg: rgba(21,21,35,.85);
    }
    body[data-theme="emerald"]{
      --bg:#07110c; --panel:#0b1711; --card:#0f1f17; --card2:#11251b;
      --line:#1f3a2d; --text:#eafff3; --muted:#a2c8b3;
      --accent:#22c55e; --accent2:#7c3aed;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(34,197,94,.22), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(124,58,237,.16), transparent 55%);
      --headerTop: rgba(7,17,12,.92);
      --headerBottom: rgba(7,17,12,.60);
      --inputBg: rgba(15,31,23,.88);
    }
    /* LIGHT FIX: gradients + header + input backgrounds */
    body[data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --card2:#f4f6ff;
      --line:#d7d9e6; --text:#0b0b10; --muted:#4b5563;
      --accent:#7c3aed; --accent2:#16a34a;
      --shadow: 0 16px 60px rgba(0,0,0,.12);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.16), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(22,163,74,.12), transparent 55%);
      --headerTop: rgba(246,247,251,.92);
      --headerBottom: rgba(246,247,251,.72);
      --inputBg: rgba(255,255,255,.92);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: var(--bgGrad1), var(--bgGrad2), var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(to bottom, var(--headerTop), var(--headerBottom));
      backdrop-filter: blur(10px);
      padding: 12px 0 12px 0;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; flex-direction:column; gap:4px}
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: color-mix(in srgb, var(--accent) 35%, transparent);
      background: color-mix(in srgb, var(--accent) 16%, transparent);
    }
    .btn.ghost{background: transparent;}
    .btn.danger{
      border-color: color-mix(in srgb, var(--danger) 35%, transparent);
      background: color-mix(in srgb, var(--danger) 12%, transparent);
    }
    .btn.ok{
      border-color: color-mix(in srgb, var(--accent2) 35%, transparent);
      background: color-mix(in srgb, var(--accent2) 14%, transparent);
    }

    .controls{
      margin-top:12px;
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }

    .input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: var(--inputBg);
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      outline:none;
      font-size:15px;
    }
    textarea{min-height:88px; resize:vertical}

    .chips{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:9px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      flex:1;
      min-width: 90px;
      text-align:center;
      user-select:none;
    }
    .chip.active{
      border-color: color-mix(in srgb, var(--accent2) 35%, transparent);
      background: color-mix(in srgb, var(--accent2) 14%, transparent);
    }

    .bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      color: var(--muted); font-size:12px; margin-top:10px;
    }
    .bar .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:999px;
      color: var(--muted);
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .pill strong{color:var(--text); font-weight:900}

    main{margin-top:12px}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 680px){ .grid{ grid-template-columns: 1fr 1fr; } }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1fr 1fr 1fr; } }

    /* Card shell */
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), color-mix(in srgb, var(--panel) 92%, transparent));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* Selection checkbox */
    .selBox{
      position:absolute; top:12px; right:12px;
      width:22px; height:22px;
      border-radius: 7px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:none;
      align-items:center; justify-content:center;
      font-weight:950;
      cursor:pointer;
      z-index:5;
    }
    .card.select-on .selBox{ display:flex; }
    .selBox.on{
      border-color: color-mix(in srgb, var(--accent2) 45%, transparent);
      background: color-mix(in srgb, var(--accent2) 18%, transparent);
    }

    /* Flip section */
    .cardFlipWrap{
      position: relative;
      min-height: 240px;
      perspective: 1000px;
    }
    .cardFlip{
      position:absolute; inset:0;
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
      transition: transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .cardFlip.flipped{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      padding:14px;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      display:flex; flex-direction:column; gap:10px;
    }
    .back{
      transform: rotateY(180deg);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card2) 95%, transparent), color-mix(in srgb, var(--panel) 92%, transparent));
    }

    .meta{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .badge .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    /* Favorite star */
    .star{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:grid; place-items:center;
      font-size:20px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
    }
    .star.on{
      border-color: color-mix(in srgb, var(--warn) 35%, transparent);
      background: color-mix(in srgb, var(--warn) 12%, transparent);
      color: var(--warn);
    }

    .term{
      margin:0;
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.05;
      word-break: break-word;
    }
    .meaning{
      margin:0;
      color: color-mix(in srgb, var(--text) 92%, transparent);
      font-size:14px;
      line-height:1.35;
    }
    .example{
      margin:0;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
    }

    .miniStats{
      display:flex; gap:8px; flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
      margin-top: 2px;
    }
    .miniStats b{ color:var(--text); }

    .tags{
      display:flex; flex-wrap:wrap; gap:6px; margin-top:auto;
    }
    .tag{
      font-size:11px;
      color: var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding:6px 8px;
      border-radius: 999px;
    }
    .tag.good{ border-color: color-mix(in srgb, var(--accent2) 35%, transparent); background: color-mix(in srgb, var(--accent2) 10%, transparent); }
    .tag.bad{ border-color: color-mix(in srgb, var(--danger) 35%, transparent); background: color-mix(in srgb, var(--danger) 10%, transparent); }

    /* Bottom action bar */
    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    body.selecting .actions{ display:none !important; }

    /* Selection bar */
    .selectBar{
      position:fixed;
      left:50%; transform: translateX(-50%);
      bottom: 18px;
      width:min(860px, 96vw);
      border:1px solid var(--line);
      background: rgba(18,18,26,.92);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      padding:10px;
      display:none;
      z-index:9998;
      box-shadow: var(--shadow);
    }
    body.selecting .selectBar{ display:block; }
    .selectBarRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .selectBar .count{ color:var(--muted); font-size:12px; }
    .selectBar .count b{ color:var(--text); }

    /* Dialog */
    dialog{
      width:min(760px, 96vw);
      border:none;
      border-radius: 18px;
      background: rgba(18,18,26,.98);
      color: var(--text);
      box-shadow: var(--shadow);
      padding:0;
      overflow:hidden;
    }
    body[data-theme="light"] dialog{ background: rgba(255,255,255,.98); }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .modalHead{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modalHead h2{margin:0; font-size:15px}
    .modalHead .small{font-size:12px; color:var(--muted); margin-top:6px}
    .modalBody{padding:14px; display:grid; gap:10px}
    .two{display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 680px){ .two{grid-template-columns: 1fr 1fr;} }
    .modalFoot{
      padding:14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .help{
      font-size:12px; color:var(--muted);
      border:1px dashed color-mix(in srgb, var(--text) 18%, transparent);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.02);
    }

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      background: rgba(18,18,26,.95);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--text);
      display:none;
      z-index:9999;
    }
    body[data-theme="light"] .toast{ background: rgba(255,255,255,.95); }

    /* FULLSCREEN QUIZ */
    .quizScreen{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      z-index:9999;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }
    .quizScreen.on{ display:block; }

    .quizShell{
      width:min(860px, 96vw);
      margin: 0 auto;
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(18,18,26,.98), rgba(12,12,18,.98));
      overflow:hidden;
    }
    body[data-theme="light"] .quizShell{
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(246,247,251,.98));
    }

    .quizHead{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .quizTitle{ font-weight:950; font-size:18px; }
    .quizSub{ color:var(--muted); font-size:12px; margin-top:6px; }

    .quizPanel{ padding:14px; display:grid; gap:12px; }

    .quizTopRow, .quizBottomRow{
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }

    .progress{
      height:10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 80%, white 0%), color-mix(in srgb, var(--accent2) 80%, white 0%));
      transition: width .35s ease;
    }

    .quizQuestion{
      font-size:22px;
      font-weight:950;
      line-height:1.15;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
    }

    .quizChoices{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 680px){
      .quizChoices{ grid-template-columns: 1fr 1fr; }
    }

    .choiceBtn{
      text-align:left;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:12px 12px;
      border-radius: 16px;
      font-weight:900;
      font-size:14px;
      transition: transform .08s ease;
    }
    .choiceBtn:active{ transform: scale(.995); }
    .choiceBtn.correct{
      border-color: color-mix(in srgb, var(--accent2) 45%, transparent);
      background: color-mix(in srgb, var(--accent2) 14%, transparent);
    }
    .choiceBtn.wrong{
      border-color: color-mix(in srgb, var(--danger) 45%, transparent);
      background: color-mix(in srgb, var(--danger) 12%, transparent);
    }

    .quizFeedback{
      color: var(--muted);
      font-size:13px;
      padding:10px 12px;
      border:1px dashed color-mix(in srgb, var(--text) 18%, transparent);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
    }

    .resultBox{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding:12px;
    }
    .resultTitle{ font-weight:950; margin-bottom:8px; }
    .resultList{
      display:grid; gap:8px;
      max-height: 260px;
      overflow:auto;
      padding-right: 4px;
    }
    .resultItem{
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
      border-radius: 14px;
      padding:10px;
    }
    .resultItem .t{ font-weight:950; }
    .resultItem .m{ color:var(--muted); font-size:12px; margin-top:4px; }

    .quizBig{
      font-size:22px;
      font-weight:950;
    }
  </style>
</head>

<body data-theme="dark">
  <header>
    <div class="topbar">
      <div class="brand">
        <h1>Vocab Pocket Pro</h1>
        <div class="sub">Kart gibi ‚Ä¢ Flip ‚Ä¢ Favori ‚Ä¢ Etiket ‚Ä¢ Seviye ‚Ä¢ Quiz</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="selectToggleBtn">‚òëÔ∏é Se√ß</button>
        <button class="btn ghost" id="langManageBtn">üåê Diller</button>
        <button class="btn ghost" id="quizToggleBtn">üß† Quiz</button>
        <button class="btn primary" id="addBtn">Ôºã Ekle</button>
      </div>
    </div>

    <div class="controls">
      <input class="input" id="search" placeholder="Ara: kelime / anlam / √∂rnek / etiket..." />

      <!-- Dynamic chips (ALL + languages + FAV) -->
      <div class="chips" id="chips"></div>

      <div class="bar">
        <div class="left">
          <span class="pill">Toplam <strong id="countAll">0</strong></span>
          <span class="pill">G√∂r√ºnen <strong id="countVisible">0</strong></span>
        </div>

        <div class="row" style="flex:1; justify-content:flex-end;">
          <!-- Filters -->
          <select id="levelFilter" title="Seviye filtresi">
            <option value="ALL" selected>Seviye: T√ºm√º</option>
            <option value="A1">Seviye: A1</option>
            <option value="A2">Seviye: A2</option>
            <option value="B1">Seviye: B1</option>
            <option value="B2">Seviye: B2</option>
            <option value="C1">Seviye: C1</option>
            <option value="C2">Seviye: C2</option>
          </select>

          <select id="tagFilter" title="Etiket filtresi">
            <option value="ALL" selected>Etiket: T√ºm√º</option>
          </select>

          <!-- Theme -->
          <select id="themeSelect" title="Tema">
            <option value="dark" selected>Tema: Dark</option>
            <option value="emerald">Tema: Emerald</option>
            <option value="light">Tema: Light</option>
          </select>

          <select id="sort">
            <option value="updated">Sƒ±rala: Son g√ºncellenen</option>
            <option value="created">Sƒ±rala: Son eklenen</option>
            <option value="az">Sƒ±rala: A ‚Üí Z</option>
            <option value="za">Sƒ±rala: Z ‚Üí A</option>
          </select>

          <button class="btn" id="exportJsonBtn">‚¨áÔ∏é JSON</button>
          <button class="btn" id="exportCsvBtn">‚¨áÔ∏é CSV</button>
          <label class="btn" for="importFile" style="cursor:pointer;">‚¨ÜÔ∏é ƒ∞√ße Aktar</label>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button class="btn danger" id="wipeBtn">üóëÔ∏è Hepsini Sil</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid" id="grid"></div>
  </main>

  <!-- Selection Bar -->
  <div class="selectBar" id="selectBar">
    <div class="selectBarRow">
      <div class="count">Se√ßili: <b id="selectedCount">0</b></div>
      <div class="row">
        <button class="btn" id="selectAllVisibleBtn">‚úÖ Hepsini se√ß</button>
        <button class="btn" id="clearSelectionBtn">‚úï Temizle</button>
        <button class="btn ok" id="bulkFavBtn">‚òÖ Favori</button>
        <button class="btn" id="bulkTagBtn">üè∑Ô∏è Etiket ekle</button>
        <button class="btn danger" id="bulkDeleteBtn">üóëÔ∏è Sil</button>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN QUIZ SCREEN -->
  <section class="quizScreen" id="quizScreen" aria-hidden="true">
    <div class="quizShell">
      <div class="quizHead">
        <div>
          <div class="quizTitle">üß† Quiz</div>
          <div class="quizSub" id="quizSub">Hazƒ±r mƒ±sƒ±n?</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="quizCloseBtn" type="button">‚úï Kapat</button>
        </div>
      </div>

      <!-- Setup -->
      <div class="quizPanel" id="quizSetup">
        <div class="two">
          <div>
            <label class="small">Soru modu</label>
            <select id="quizModeSelect">
              <option value="TR2TERM" selected>TR ‚Üí Kelime</option>
              <option value="TERM2TR">Kelime ‚Üí TR</option>
            </select>
          </div>

          <div>
            <label class="small">Soru sayƒ±sƒ±</label>
            <select id="quizCountSelect">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="15">15</option>
              <option value="20">20</option>
              <option value="9999">Hepsi</option>
            </select>
          </div>
        </div>

        <div class="two">
          <div>
            <label class="small">≈ûƒ±k sayƒ±sƒ±</label>
            <select id="quizChoiceCount">
              <option value="4" selected>4 ≈üƒ±k</option>
              <option value="6">6 ≈üƒ±k</option>
            </select>
          </div>

          <div>
            <label class="small">Kapsam</label>
            <select id="quizScope">
              <option value="CURRENT" selected>Mevcut filtre/arama</option>
              <option value="FAV">Sadece favoriler</option>
              <option value="WRONG">Sadece daha √∂nce yanlƒ±≈ülar</option>
            </select>
          </div>
        </div>

        <div class="two">
          <div>
            <label class="small">Tekrar</label>
            <select id="quizRepeat">
              <option value="NO" selected>Aynƒ± kelimeyi tekrar sorma</option>
              <option value="YES">Tekrar sorabilir</option>
            </select>
          </div>
          <div>
            <label class="small">Ba≈ülat</label>
            <button class="btn primary" id="quizStartBtn" type="button" style="width:100%; justify-content:center;">
              ‚ñ∂Ô∏è Quiz‚Äôi Ba≈ülat
            </button>
          </div>
        </div>

        <div class="help">
          Quiz; se√ßtiƒüin kapsama g√∂re kelimeleri se√ßer, doƒüru/yanlƒ±≈ü sayƒ±sƒ±nƒ± kaydeder ve bitince ‚Äúbildiklerin / bilemediklerin‚Äù verir.
        </div>
      </div>

      <!-- Play -->
      <div class="quizPanel" id="quizPlay" style="display:none;">
        <div class="quizTopRow">
          <span class="pill">Soru <strong id="quizIdx">1</strong>/<strong id="quizTotal">10</strong></span>
          <span class="pill">Puan <strong id="quizScore">0</strong></span>
        </div>

        <div class="progress"><div id="quizProgress"></div></div>

        <div class="quizQuestion" id="quizQuestion">‚Äî</div>
        <div class="quizChoices" id="quizChoices"></div>

        <div class="quizBottomRow">
          <button class="btn" id="quizSkipBtn" type="button">‚è≠Ô∏è Pas</button>
          <button class="btn primary" id="quizNextBtn2" type="button" disabled>‚û°Ô∏è Sonraki</button>
        </div>

        <div class="quizFeedback" id="quizFeedback"></div>
      </div>

      <!-- Result -->
      <div class="quizPanel" id="quizResult" style="display:none;">
        <div class="quizResultTop">
          <div class="quizBig" id="quizFinalScore">Skor: 0/0</div>
          <div class="quizSub" id="quizFinalSub">‚Äî</div>
        </div>

        <div class="two">
          <div class="resultBox">
            <div class="resultTitle">‚úÖ Bildiklerin</div>
            <div class="resultList" id="quizKnownList"></div>
          </div>
          <div class="resultBox">
            <div class="resultTitle">‚ùå Bilemediklerin</div>
            <div class="resultList" id="quizUnknownList"></div>
          </div>
        </div>

        <div class="quizBottomRow" style="margin-top:12px;">
          <button class="btn" id="quizBackToSetupBtn" type="button">‚Ü©Ô∏è Ayarlara d√∂n</button>
          <button class="btn primary" id="quizRetryWrongBtn" type="button">üîÅ Yanlƒ±≈ülarƒ± tekrar √ß√∂z</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal: Word add/edit -->
  <dialog id="modal">
    <div class="modalHead">
      <div>
        <h2 id="modalTitle">Kelime Ekle</h2>
        <div class="small" id="modalSub">Kelime + TR anlam + √∂rnek + etiket</div>
      </div>
      <button class="btn" id="closeBtn" type="button">‚úï</button>
    </div>

    <form class="modalBody" id="form">
      <div class="two">
        <div>
          <label class="small">Dil</label>
          <select id="language"></select>
        </div>

        <div>
          <label class="small">Seviye</label>
          <select id="level">
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1" selected>B1</option>
            <option value="B2">B2</option>
            <option value="C1">C1</option>
            <option value="C2">C2</option>
          </select>
        </div>
      </div>

      <div class="two">
        <div>
          <label class="small">Kelime</label>
          <input class="input" id="term" placeholder="beneath / shone / ... veya yeni dil kelimesi" autocomplete="off" />
        </div>
        <div>
          <label class="small">T√ºrk√ße anlam</label>
          <input class="input" id="meaningTR" placeholder="T√ºrk√ße anlamƒ±..." autocomplete="off" />
        </div>
      </div>

      <div>
        <label class="small">√ñrnek c√ºmle (kelimenin dilinde)</label>
        <textarea id="example" placeholder="√ñrn: George found an old, heavy key beneath a mass of rough stones."></textarea>
      </div>

      <div class="two">
        <div>
          <label class="small">Etiketler (virg√ºlle)</label>
          <input class="input" id="tags" placeholder="travel, story, daily..." autocomplete="off" />
        </div>
        <div class="help">
          <div><strong>ƒ∞pucu</strong></div>
          <div>‚Ä¢ Kartƒ± √ßevirmek i√ßin karta dokun</div>
          <div>‚Ä¢ ‚òÖ favori: Favoriler filtresi</div>
          <div>‚Ä¢ Quiz: √ºstte üß†</div>
        </div>
      </div>
    </form>

    <div class="modalFoot">
      <button class="btn danger" id="deleteBtn" type="button" style="display:none;">Sil</button>
      <button class="btn" id="cancelBtn" type="button">ƒ∞ptal</button>
      <button class="btn primary" id="saveBtn" type="button">Kaydet</button>
    </div>
  </dialog>

  <!-- Modal: Language manager -->
  <dialog id="langModal">
    <div class="modalHead">
      <div>
        <h2>Diller</h2>
        <div class="small">Yeni dil ekle (√∂r: DE - Deutsch). Dil kodu 2-5 harf olsun.</div>
      </div>
      <button class="btn" id="langCloseBtn" type="button">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="two">
        <div>
          <label class="small">Dil Kodu</label>
          <input class="input" id="newLangCode" placeholder="DE" maxlength="5" />
        </div>
        <div>
          <label class="small">Dil Adƒ±</label>
          <input class="input" id="newLangName" placeholder="Deutsch" />
        </div>
      </div>

      <div class="two">
        <button class="btn primary" id="addLangBtn" type="button" style="justify-content:center;">Ôºã Dil Ekle</button>
        <button class="btn danger" id="resetLangBtn" type="button" style="justify-content:center;">‚Ü∫ Varsayƒ±lanlara d√∂n</button>
      </div>

      <div class="help" id="langListBox">‚Äî</div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="langDoneBtn" type="button">Tamam</button>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

  <script>
    const KEY = "vocab_pocket_pro_v3";
    const THEME_KEY = "vocab_theme_v1";
    const LANG_KEY = "vocab_languages_v1";

    const now = () => Date.now();
    const clean = (s) => (s ?? "").toString().trim();

    function loadItems(){
      try{ return JSON.parse(localStorage.getItem(KEY)) ?? []; }
      catch{ return []; }
    }
    function saveItems(items){ localStorage.setItem(KEY, JSON.stringify(items)); }

    function escapeHtml(str){
      return (str ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[m]));
    }

    function parseTags(input){
      return clean(input).split(",").map(t=>t.trim()).filter(Boolean).slice(0,10);
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display="none", 1600);
    }

    function haptic(type){
      try{
        if(!("vibrate" in navigator)) return;
        if(type === "good") navigator.vibrate([18, 10, 18]);
        else if(type === "bad") navigator.vibrate([40, 12, 40]);
        else navigator.vibrate(15);
      }catch{}
    }

    // ===== Languages =====
    const DEFAULT_LANGS = [
      { code:"EN", name:"English" },
      { code:"RU", name:"–†—É—Å—Å–∫–∏–π" }
    ];

    function loadLangs(){
      try{
        const v = JSON.parse(localStorage.getItem(LANG_KEY));
        if(Array.isArray(v) && v.length) return normalizeLangs(v);
      }catch{}
      return DEFAULT_LANGS.slice();
    }
    function saveLangs(list){
      localStorage.setItem(LANG_KEY, JSON.stringify(normalizeLangs(list)));
    }
    function normalizeLangs(list){
      const map = new Map();
      for(const x of (list||[])){
        const code = clean(x.code).toUpperCase();
        const name = clean(x.name);
        if(!code || code.length < 2 || code.length > 5) continue;
        if(!name) continue;
        map.set(code, {code, name});
      }
      // ensure defaults exist
      for(const d of DEFAULT_LANGS){
        if(!map.has(d.code)) map.set(d.code, d);
      }
      return Array.from(map.values()).sort((a,b)=>a.code.localeCompare(b.code));
    }

    // ===== State =====
    let items = loadItems().map(patchItem);
    let langs = loadLangs();

    let filter = "ALL";        // ALL / FAV / LANG_CODE
    let levelFilter = "ALL";   // ALL / A1..C2
    let tagFilter = "ALL";     // ALL / tag
    let editingId = null;

    let selecting = false;
    let selectedIds = new Set();

    // ===== Elements =====
    const gridEl = document.getElementById("grid");
    const chipsEl = document.getElementById("chips");
    const searchEl = document.getElementById("search");
    const sortEl = document.getElementById("sort");
    const levelFilterEl = document.getElementById("levelFilter");
    const tagFilterEl = document.getElementById("tagFilter");

    const countAll = document.getElementById("countAll");
    const countVisible = document.getElementById("countVisible");

    const themeSelect = document.getElementById("themeSelect");
    const toastEl = document.getElementById("toast");

    // Selection
    const selectToggleBtn = document.getElementById("selectToggleBtn");
    const selectBar = document.getElementById("selectBar");
    const selectedCountEl = document.getElementById("selectedCount");
    const selectAllVisibleBtn = document.getElementById("selectAllVisibleBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const bulkFavBtn = document.getElementById("bulkFavBtn");
    const bulkTagBtn = document.getElementById("bulkTagBtn");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");

    // Modal word
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const deleteBtn = document.getElementById("deleteBtn");
    const langEl = document.getElementById("language");
    const levelEl = document.getElementById("level");
    const termEl = document.getElementById("term");
    const meaningEl = document.getElementById("meaningTR");
    const exampleEl = document.getElementById("example");
    const tagsEl = document.getElementById("tags");

    // Language manager modal
    const langManageBtn = document.getElementById("langManageBtn");
    const langModal = document.getElementById("langModal");
    const langCloseBtn = document.getElementById("langCloseBtn");
    const langDoneBtn = document.getElementById("langDoneBtn");
    const newLangCode = document.getElementById("newLangCode");
    const newLangName = document.getElementById("newLangName");
    const addLangBtn = document.getElementById("addLangBtn");
    const resetLangBtn = document.getElementById("resetLangBtn");
    const langListBox = document.getElementById("langListBox");

    // Quiz
    const quizToggleBtn = document.getElementById("quizToggleBtn");
    const quizScreen = document.getElementById("quizScreen");
    const quizCloseBtn = document.getElementById("quizCloseBtn");
    const quizSubEl = document.getElementById("quizSub");

    const quizSetup = document.getElementById("quizSetup");
    const quizPlay = document.getElementById("quizPlay");
    const quizResult = document.getElementById("quizResult");

    const quizModeSelect = document.getElementById("quizModeSelect");
    const quizCountSelect = document.getElementById("quizCountSelect");
    const quizChoiceCountEl = document.getElementById("quizChoiceCount");
    const quizScopeEl = document.getElementById("quizScope");
    const quizRepeatEl = document.getElementById("quizRepeat");
    const quizStartBtn = document.getElementById("quizStartBtn");

    const quizIdxEl = document.getElementById("quizIdx");
    const quizTotalEl = document.getElementById("quizTotal");
    const quizScoreEl = document.getElementById("quizScore");
    const quizProgressEl = document.getElementById("quizProgress");
    const quizQuestionEl2 = document.getElementById("quizQuestion");
    const quizChoicesEl = document.getElementById("quizChoices");
    const quizFeedbackEl = document.getElementById("quizFeedback");
    const quizSkipBtn = document.getElementById("quizSkipBtn");
    const quizNextBtn2 = document.getElementById("quizNextBtn2");

    const quizFinalScore = document.getElementById("quizFinalScore");
    const quizFinalSub = document.getElementById("quizFinalSub");
    const quizKnownList = document.getElementById("quizKnownList");
    const quizUnknownList = document.getElementById("quizUnknownList");
    const quizBackToSetupBtn = document.getElementById("quizBackToSetupBtn");
    const quizRetryWrongBtn = document.getElementById("quizRetryWrongBtn");

    // ===== Patch item (spaced repetition stats) =====
    function patchItem(it){
      const x = {...it};
      x.lang = clean(x.lang).toUpperCase() || "EN";
      x.level = clean(x.level) || "B1";
      x.term = clean(x.term);
      x.meaningTR = clean(x.meaningTR);
      x.example = clean(x.example);
      x.tags = Array.isArray(x.tags) ? x.tags.map(clean).filter(Boolean).slice(0,10) : parseTags(x.tags||"");
      x.fav = !!x.fav;

      const s = x.stats || {};
      x.stats = {
        correct: Number(s.correct || 0),
        wrong: Number(s.wrong || 0),
        lastReviewed: Number(s.lastReviewed || 0),
        lastResult: (s.lastResult === "good" || s.lastResult === "bad") ? s.lastResult : ""
      };

      x.createdAt = Number(x.createdAt || now());
      x.updatedAt = Number(x.updatedAt || now());
      x.id = String(x.id || (crypto.randomUUID ? crypto.randomUUID() : (String(x.createdAt)+Math.random().toString(16).slice(2))));
      return x;
    }

    // ===== Theme =====
    function applyTheme(t){
      const theme = (t === "emerald" || t === "light") ? t : "dark";
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      themeSelect.value = theme;
    }

    // ===== Helpers =====
    function matchesQuery(it, q){
      if(!q) return true;
      const hay = (it.term + " " + it.meaningTR + " " + (it.example||"") + " " + (it.tags||[]).join(" ")).toLowerCase();
      return hay.includes(q);
    }

    function applyChipFilter(arr){
      if(filter === "ALL") return arr;
      if(filter === "FAV") return arr.filter(x=>x.fav);
      // language code
      return arr.filter(x=>x.lang === filter);
    }

    function applyLevelFilter(arr){
      if(levelFilter === "ALL") return arr;
      return arr.filter(x => (x.level || "B1") === levelFilter);
    }

    function applyTagFilter(arr){
      if(tagFilter === "ALL") return arr;
      return arr.filter(x => (x.tags||[]).includes(tagFilter));
    }

    function applySort(arr){
      const s = sortEl.value;
      const copy = [...arr];
      if(s === "updated") copy.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      else if(s === "created") copy.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      else if(s === "az") copy.sort((a,b)=> (a.term||"").localeCompare(b.term||"", undefined, {sensitivity:"base"}));
      else if(s === "za") copy.sort((a,b)=> (b.term||"").localeCompare(a.term||"", undefined, {sensitivity:"base"}));
      return copy;
    }

    function getVisibleItems(){
      const q = searchEl.value.trim().toLowerCase();
      let view = items.filter(it => matchesQuery(it, q));
      view = applyChipFilter(view);
      view = applyLevelFilter(view);
      view = applyTagFilter(view);
      view = applySort(view);
      return view;
    }

    function updateTagFilterOptions(){
      const tags = new Set();
      for(const it of items){
        for(const t of (it.tags||[])) tags.add(t);
      }
      const list = Array.from(tags).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
      const prev = tagFilterEl.value || "ALL";
      tagFilterEl.innerHTML = `<option value="ALL">Etiket: T√ºm√º</option>` + list.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml("#"+t)}</option>`).join("");
      if(list.includes(prev)) tagFilterEl.value = prev;
      else tagFilterEl.value = "ALL";
      tagFilter = tagFilterEl.value;
    }

    function renderChips(){
      chipsEl.innerHTML = "";

      function addChip(label, value){
        const b = document.createElement("button");
        b.className = "chip" + (filter === value ? " active" : "");
        b.textContent = label;
        b.dataset.value = value;
        b.addEventListener("click", ()=>{
          filter = value;
          renderChips();
          render();
        });
        chipsEl.appendChild(b);
      }

      addChip("T√ºm√º", "ALL");
      for(const l of langs){
        addChip(l.name, l.code);
      }
      addChip("Favoriler", "FAV");
    }

    function renderLanguageSelect(){
      const prev = langEl.value || "EN";
      langEl.innerHTML = langs.map(l => `<option value="${l.code}">${escapeHtml(l.name)} (${escapeHtml(l.code)})</option>`).join("");
      if(langs.some(x=>x.code===prev)) langEl.value = prev;
      else langEl.value = "EN";
    }

    // ===== Selection mode =====
    function setSelecting(on){
      selecting = !!on;
      document.body.classList.toggle("selecting", selecting);
      selectToggleBtn.textContent = selecting ? "‚òëÔ∏é Se√ßim: A√ßƒ±k" : "‚òëÔ∏é Se√ß";
      if(!selecting){
        selectedIds.clear();
      }
      render(); // re-render to show/hide checkboxes
      updateSelectionBar();
    }

    function updateSelectionBar(){
      selectedCountEl.textContent = String(selectedIds.size);
    }

    // ===== Render =====
    function render(){
      countAll.textContent = items.length;

      const view = getVisibleItems();
      countVisible.textContent = view.length;
      gridEl.innerHTML = "";

      updateTagFilterOptions();

      if(view.length === 0){
        gridEl.innerHTML = `
          <div class="card">
            <div class="cardFlipWrap">
              <div class="cardFlip">
                <div class="face">
                  <div class="meta">
                    <span class="badge"><span class="dot"></span> ƒ∞pucu</span>
                  </div>
                  <p class="term">Kayƒ±t yok</p>
                  <p class="meaning">Yeni kelime eklemek i√ßin <strong>Ôºã Ekle</strong> butonuna bas.</p>
                  <div class="tags">
                    <span class="tag">Dil</span>
                    <span class="tag">TR anlam</span>
                    <span class="tag">√ñrnek</span>
                    <span class="tag">Quiz puanƒ±</span>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
        return;
      }

      for(const it of view){
        const langName = (langs.find(x=>x.code===it.lang)?.name) || it.lang;
        const tagsHtml = (it.tags||[]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join("");

        const lastBadge =
          it.stats.lastResult === "good" ? `<span class="tag good">‚úÖ son: doƒüru</span>` :
          it.stats.lastResult === "bad"  ? `<span class="tag bad">‚ùå son: yanlƒ±≈ü</span>` :
          ``;

        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = it.id;

        if(selecting) card.classList.add("select-on");

        const selOn = selectedIds.has(it.id);

        card.innerHTML = `
          <div class="selBox ${selOn ? "on":""}" data-action="sel" title="Se√ß">
            ${selOn ? "‚úì" : ""}
          </div>

          <div class="cardFlipWrap">
            <div class="cardFlip" data-id="${it.id}">
              <div class="face front">
                <div class="meta">
                  <span class="badge">
                    <span class="dot"></span>
                    ${escapeHtml(it.lang)} ‚Ä¢ ${escapeHtml(it.level||"B1")}
                  </span>
                  <div class="star ${it.fav ? "on":""}" data-action="fav" title="Favori">
                    ${it.fav ? "‚òÖ" : "‚òÜ"}
                  </div>
                </div>

                <p class="term">${escapeHtml(it.term)}</p>
                <p class="example">${escapeHtml(it.example || "Karta dokun ‚Üí √ßevir")}</p>

                <div class="miniStats">
                  <span>‚úÖ <b>${it.stats.correct}</b></span>
                  <span>‚ùå <b>${it.stats.wrong}</b></span>
                  <span>‚Ä¢ ${escapeHtml(langName)}</span>
                </div>

                <div class="tags">
                  ${lastBadge}
                  ${tagsHtml || `<span class="tag">#etiket</span>`}
                </div>
              </div>

              <div class="face back">
                <div class="meta">
                  <span class="badge">
                    <span class="dot"></span>
                    TR anlam
                  </span>
                  <div class="star ${it.fav ? "on":""}" data-action="fav" title="Favori">
                    ${it.fav ? "‚òÖ" : "‚òÜ"}
                  </div>
                </div>

                <p class="term">${escapeHtml(it.meaningTR)}</p>
                <p class="example" style="-webkit-line-clamp:4">${escapeHtml(it.example || "")}</p>

                <div class="tags">
                  <span class="tag">${escapeHtml(it.lang)} ‚Ä¢ ${escapeHtml(it.level||"B1")}</span>
                  ${lastBadge}
                  ${tagsHtml}
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" data-action="flip" data-id="${it.id}">‚Ü∫ √áevir</button>
            <button class="btn" data-action="edit" data-id="${it.id}">‚úé D√ºzenle</button>
            <button class="btn danger" data-action="delete" data-id="${it.id}">üóëÔ∏è Sil</button>
          </div>
        `;

        gridEl.appendChild(card);
      }

      updateSelectionBar();
    }

    // ===== Word modal =====
    function openAdd(){
      editingId = null;
      modalTitle.textContent = "Kelime Ekle";
      deleteBtn.style.display = "none";

      renderLanguageSelect();

      langEl.value = (langs.some(x=>x.code==="EN") ? "EN" : langs[0]?.code || "EN");
      levelEl.value = "B1";
      termEl.value = "";
      meaningEl.value = "";
      exampleEl.value = "";
      tagsEl.value = "";

      modal.showModal();
      setTimeout(()=>termEl.focus(), 50);
    }

    function openEdit(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;

      editingId = id;
      modalTitle.textContent = "Kelime D√ºzenle";
      deleteBtn.style.display = "inline-flex";

      renderLanguageSelect();

      langEl.value = it.lang;
      levelEl.value = it.level || "B1";
      termEl.value = it.term || "";
      meaningEl.value = it.meaningTR || "";
      exampleEl.value = it.example || "";
      tagsEl.value = (it.tags||[]).join(", ");

      modal.showModal();
      setTimeout(()=>termEl.focus(), 50);
    }

    function upsert(){
      const lang = (langEl.value || "EN").toUpperCase();
      const level = levelEl.value || "B1";
      const term = clean(termEl.value);
      const meaningTR = clean(meaningEl.value);
      const example = clean(exampleEl.value);
      const tags = parseTags(tagsEl.value);

      if(!term || !meaningTR){
        toast("Kelime ve T√ºrk√ße anlam zorunlu.");
        return;
      }

      const t = now();

      if(editingId){
        const it = items.find(x=>x.id===editingId);
        if(!it) return;

        it.lang = lang;
        it.level = level;
        it.term = term;
        it.meaningTR = meaningTR;
        it.example = example;
        it.tags = tags;
        it.updatedAt = t;

        toast("G√ºncellendi ‚úÖ");
      } else {
        const id = (crypto.randomUUID ? crypto.randomUUID() : String(t) + Math.random().toString(16).slice(2));
        items.push(patchItem({
          id, lang, level, term, meaningTR, example, tags,
          fav:false,
          createdAt:t, updatedAt:t,
          stats:{correct:0, wrong:0, lastReviewed:0, lastResult:""}
        }));
        toast("Eklendi ‚úÖ");
      }

      saveItems(items);
      modal.close();
      render();
    }

    function deleteById(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      if(confirm(`Silinsin mi?\n\n${it.term} (${it.lang})`)){
        items = items.filter(x=>x.id!==id);
        saveItems(items);
        toast("Silindi üóëÔ∏è");
        selectedIds.delete(id);
        render();
      }
    }

    // ===== Export / Import =====
    function downloadFile(name, content, mime){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportJSON(){
      const data = JSON.stringify({version:3, exportedAt: now(), langs, items}, null, 2);
      downloadFile("vocab-pocket-pro-backup.json", data, "application/json");
    }

    function csvEscape(v){
      const s = (v ?? "").toString();
      if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function exportCSV(){
      const header = ["lang","level","term","meaningTR","example","tags","fav","correct","wrong","createdAt","updatedAt"];
      const rows = items.map(it => [
        it.lang,
        it.level || "",
        it.term,
        it.meaningTR,
        it.example || "",
        (it.tags||[]).join("|"),
        it.fav ? "1":"0",
        String(it.stats?.correct||0),
        String(it.stats?.wrong||0),
        new Date(it.createdAt).toISOString(),
        new Date(it.updatedAt).toISOString()
      ].map(csvEscape).join(","));
      downloadFile("vocab-pocket-pro.csv", header.join(",") + "\n" + rows.join("\n"), "text/csv");
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          const incomingItems = obj.items ?? obj;
          const incomingLangs = obj.langs;

          if(incomingLangs && Array.isArray(incomingLangs)){
            langs = normalizeLangs(incomingLangs);
            saveLangs(langs);
          }

          const incoming = incomingItems;
          if(!Array.isArray(incoming)) throw new Error("Format");

          const map = new Map(items.map(x=>[x.id, x]));
          for(const raw of incoming){
            const it = patchItem(raw);
            map.set(it.id, it);
          }
          items = Array.from(map.values());
          saveItems(items);
          toast("ƒ∞√ße aktarƒ±ldƒ± ‚úÖ");
          renderChips();
          renderLanguageSelect();
          render();
        }catch(e){
          toast("JSON okunamadƒ± ‚ùå");
        }
      };
      reader.readAsText(file);
    }

    // ===== Language manager modal =====
    function openLangModal(){
      renderLangListBox();
      newLangCode.value = "";
      newLangName.value = "";
      langModal.showModal();
      setTimeout(()=>newLangCode.focus(), 50);
    }

    function renderLangListBox(){
      const lines = langs.map(l => `‚Ä¢ ${l.code} ‚Äî ${l.name}`).join("\n");
      langListBox.textContent = lines || "‚Äî";
    }

    function addLanguage(){
      const code = clean(newLangCode.value).toUpperCase();
      const name = clean(newLangName.value);

      if(!code || code.length < 2 || code.length > 5){
        toast("Dil kodu 2-5 harf olmalƒ±.");
        return;
      }
      if(!name){
        toast("Dil adƒ± bo≈ü olamaz.");
        return;
      }

      langs = normalizeLangs([...langs, {code, name}]);
      saveLangs(langs);
      toast("Dil eklendi ‚úÖ");
      renderLangListBox();
      renderChips();
      renderLanguageSelect();
      render();
    }

    function resetLanguages(){
      if(confirm("Diller varsayƒ±lana d√∂necek (EN/RU). Emin misin?")){
        langs = DEFAULT_LANGS.slice();
        saveLangs(langs);
        toast("Sƒ±fƒ±rlandƒ± ‚úÖ");
        renderLangListBox();
        renderChips();
        renderLanguageSelect();
        render();
      }
    }

    // ===== Quiz engine =====
    let quizSession = null;

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function uniqById(arr){
      const m = new Map();
      for(const it of arr){
        if(it?.id) m.set(it.id, it);
      }
      return Array.from(m.values());
    }

    function resultItem(it){
      const div = document.createElement("div");
      div.className = "resultItem";
      div.innerHTML = `
        <div class="t">${escapeHtml(it.term)} <span style="opacity:.7">(${escapeHtml(it.level||"")}, ${escapeHtml(it.lang||"")})</span></div>
        <div class="m">${escapeHtml(it.meaningTR)}</div>
      `;
      return div;
    }

    function pickQuizPool(scope){
      // CURRENT: respects chips + level + tag + search
      if(scope === "CURRENT") return getVisibleItems();

      if(scope === "FAV"){
        const q = searchEl.value.trim().toLowerCase();
        let pool = items.filter(x=>x.fav);
        // still allow search/level/tag to narrow
        if(q) pool = pool.filter(it=>matchesQuery(it, q));
        pool = applyLevelFilter(pool);
        pool = applyTagFilter(pool);
        pool = applySort(pool);
        return pool;
      }

      if(scope === "WRONG"){
        const q = searchEl.value.trim().toLowerCase();
        let pool = items.filter(x => (x.stats?.wrong || 0) > 0);
        if(q) pool = pool.filter(it=>matchesQuery(it, q));
        pool = applyLevelFilter(pool);
        pool = applyTagFilter(pool);
        pool = applySort(pool);
        return pool;
      }

      return getVisibleItems();
    }

    function openQuizScreen(){
      quizScreen.classList.add("on");
      quizScreen.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      showQuizSetup();
      quizToggleBtn.textContent = "üß† Quiz: A√ßƒ±k";
    }

    function closeQuizScreen(){
      quizScreen.classList.remove("on");
      quizScreen.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      quizToggleBtn.textContent = "üß† Quiz";
    }

    function showQuizSetup(){
      quizSetup.style.display = "grid";
      quizPlay.style.display = "none";
      quizResult.style.display = "none";
      quizSession = null;
      if(quizSubEl) quizSubEl.textContent = "Kapsamƒ± se√ß, ba≈ülat. Bitince puan + listeler gelir.";
    }

    function startQuizSession({mode, count, pool, choiceCount, allowRepeat}){
      const list = shuffle(pool);
      const total = (count >= 9999) ? list.length : Math.min(count, list.length);

      quizSession = {
        mode,
        list: list.slice(0, total),
        total,
        idx: 0,
        score: 0,
        known: [],
        unknown: [],
        current: null,
        locked: false,
        choiceCount,
        allowRepeat,
        askedIds: new Set()
      };

      quizSetup.style.display = "none";
      quizPlay.style.display = "grid";
      quizResult.style.display = "none";

      nextQuizQuestion();
    }

    function makeChoices(correctText, poolTexts, n){
      const set = new Set([correctText]);
      const shuffled = shuffle(poolTexts.filter(Boolean));
      for(const t of shuffled){
        if(set.size >= n) break;
        if(t !== correctText) set.add(t);
      }
      return shuffle(Array.from(set));
    }

    function pickNextQuestion(){
      if(!quizSession) return null;

      if(quizSession.allowRepeat) return quizSession.list[quizSession.idx];

      // no repeat: try to find next not asked
      for(let k=0;k<quizSession.list.length;k++){
        const candidate = quizSession.list[quizSession.idx];
        if(!quizSession.askedIds.has(candidate.id)){
          return candidate;
        }
        quizSession.idx += 1;
        if(quizSession.idx >= quizSession.total) break;
      }
      return null;
    }

    function nextQuizQuestion(){
      if(!quizSession) return;

      if(quizSession.idx >= quizSession.total){
        finishQuiz();
        return;
      }

      quizSession.locked = false;
      quizNextBtn2.disabled = true;
      quizFeedbackEl.textContent = "Bir ≈üƒ±k se√ß. Doƒüru/yanlƒ±≈ü anƒ±nda g√∂sterilir.";

      const it = pickNextQuestion();
      if(!it){
        finishQuiz();
        return;
      }

      quizSession.current = it;
      quizSession.askedIds.add(it.id);

      quizIdxEl.textContent = String(quizSession.idx + 1);
      quizTotalEl.textContent = String(quizSession.total);
      quizScoreEl.textContent = String(quizSession.score);

      const pct = Math.round(((quizSession.idx) / Math.max(1, quizSession.total)) * 100);
      quizProgressEl.style.width = pct + "%";

      const question = (quizSession.mode === "TR2TERM") ? it.meaningTR : it.term;
      const correct = (quizSession.mode === "TR2TERM") ? it.term : it.meaningTR;
      quizQuestionEl2.textContent = question || "‚Äî";

      const poolTexts = quizSession.list.map(x => (quizSession.mode === "TR2TERM") ? x.term : x.meaningTR);
      const choices = makeChoices(correct, poolTexts, quizSession.choiceCount);

      quizChoicesEl.innerHTML = "";
      for(const c of choices){
        const b = document.createElement("button");
        b.className = "choiceBtn";
        b.type = "button";
        b.textContent = c;
        b.addEventListener("click", ()=> chooseAnswer(c, correct));
        quizChoicesEl.appendChild(b);
      }
    }

    function updateItemStats(it, isCorrect){
      it.stats = it.stats || {correct:0, wrong:0, lastReviewed:0, lastResult:""};
      it.stats.lastReviewed = now();
      it.stats.lastResult = isCorrect ? "good" : "bad";
      if(isCorrect) it.stats.correct = Number(it.stats.correct||0) + 1;
      else it.stats.wrong = Number(it.stats.wrong||0) + 1;
      it.updatedAt = now();
    }

    function chooseAnswer(chosen, correct){
      if(!quizSession || quizSession.locked) return;
      quizSession.locked = true;

      const it = quizSession.current;
      if(!it) return;

      const isCorrect = chosen === correct;

      // UI highlight
      const btns = Array.from(quizChoicesEl.querySelectorAll(".choiceBtn"));
      for(const b of btns){
        if(b.textContent === correct) b.classList.add("correct");
        if(b.textContent === chosen && chosen !== correct) b.classList.add("wrong");
        b.disabled = true;
      }

      // update stats & session
      updateItemStats(it, isCorrect);

      if(isCorrect){
        quizSession.score += 1;
        quizScoreEl.textContent = String(quizSession.score);
        quizSession.known.push(it);
        quizFeedbackEl.textContent = `‚úÖ Doƒüru! (${correct})`;
        haptic("good");
      } else {
        quizSession.unknown.push(it);
        quizFeedbackEl.textContent = `‚ùå Yanlƒ±≈ü. Doƒüru: ${correct}`;
        haptic("bad");
      }

      saveItems(items);
      quizNextBtn2.disabled = false;
    }

    function skipQuestion(){
      if(!quizSession) return;
      if(quizSession.locked) return;
      const it = quizSession.current;
      if(it){
        quizSession.unknown.push(it);
        updateItemStats(it, false);
        saveItems(items);
      }
      quizFeedbackEl.textContent = "‚è≠Ô∏è Pas ge√ßildi. Bu soru bilemediklere eklendi.";
      haptic("tap");
      quizSession.locked = true;
      for(const b of quizChoicesEl.querySelectorAll(".choiceBtn")) b.disabled = true;
      quizNextBtn2.disabled = false;
    }

    function goNextFromPlay(){
      if(!quizSession) return;
      quizSession.idx += 1;
      nextQuizQuestion();
    }

    function finishQuiz(){
      if(!quizSession) return;

      quizSetup.style.display = "none";
      quizPlay.style.display = "none";
      quizResult.style.display = "grid";

      quizProgressEl.style.width = "100%";

      const total = quizSession.total;
      const score = quizSession.score;

      quizFinalScore.textContent = `Skor: ${score}/${total}`;
      quizFinalSub.textContent = score === total
        ? "M√ºkemmel! Hepsi doƒüru ‚úÖ"
        : "Bitti. ƒ∞stersen yanlƒ±≈ülarƒ± tekrar √ß√∂zebilirsin.";

      quizKnownList.innerHTML = "";
      quizUnknownList.innerHTML = "";

      const knownUnique = uniqById(quizSession.known);
      const unknownUnique = uniqById(quizSession.unknown);

      for(const it of knownUnique) quizKnownList.appendChild(resultItem(it));
      for(const it of unknownUnique) quizUnknownList.appendChild(resultItem(it));

      quizRetryWrongBtn.disabled = unknownUnique.length === 0;

      // refresh cards to show last result + stats
      render();
    }

    // ===== Bulk operations =====
    function bulkDelete(){
      if(selectedIds.size === 0) return toast("Se√ßili yok.");
      if(confirm(`${selectedIds.size} kayƒ±t silinecek. Emin misin?`)){
        items = items.filter(x => !selectedIds.has(x.id));
        saveItems(items);
        toast("Silindi üóëÔ∏è");
        selectedIds.clear();
        render();
        updateSelectionBar();
      }
    }

    function bulkFav(){
      if(selectedIds.size === 0) return toast("Se√ßili yok.");
      for(const it of items){
        if(selectedIds.has(it.id)){
          it.fav = true;
          it.updatedAt = now();
        }
      }
      saveItems(items);
      toast("Favori yapƒ±ldƒ± ‚òÖ");
      render();
    }

    function bulkTag(){
      if(selectedIds.size === 0) return toast("Se√ßili yok.");
      const t = prompt("Eklenecek etiket (√∂r: story). Virg√ºl ile √ßoklu da yazabilirsin:");
      if(!t) return;
      const add = parseTags(t);
      if(add.length === 0) return;

      for(const it of items){
        if(!selectedIds.has(it.id)) continue;
        const set = new Set([...(it.tags||[])]);
        for(const a of add) set.add(a);
        it.tags = Array.from(set).slice(0,10);
        it.updatedAt = now();
      }
      saveItems(items);
      toast("Etiket eklendi üè∑Ô∏è");
      render();
    }

    function selectAllVisible(){
      const view = getVisibleItems();
      for(const it of view) selectedIds.add(it.id);
      render();
      toast("G√∂r√ºnenlerin hepsi se√ßildi ‚úÖ");
    }

    function clearSelection(){
      selectedIds.clear();
      render();
      toast("Se√ßim temizlendi ‚úï");
    }

    // ===== Events =====
    document.getElementById("addBtn").addEventListener("click", openAdd);
    document.getElementById("cancelBtn").addEventListener("click", ()=>modal.close());
    document.getElementById("closeBtn").addEventListener("click", ()=>modal.close());
    document.getElementById("saveBtn").addEventListener("click", upsert);

    deleteBtn.addEventListener("click", ()=>{
      if(editingId) deleteById(editingId);
      modal.close();
    });

    // Search + filters
    searchEl.addEventListener("input", render);
    sortEl.addEventListener("change", render);

    levelFilterEl.addEventListener("change", ()=>{
      levelFilter = levelFilterEl.value;
      render();
    });

    tagFilterEl.addEventListener("change", ()=>{
      tagFilter = tagFilterEl.value;
      render();
    });

    // Theme
    themeSelect.addEventListener("change", (e)=> applyTheme(e.target.value));

    // Selection toggle + actions
    selectToggleBtn.addEventListener("click", ()=> setSelecting(!selecting));
    selectAllVisibleBtn.addEventListener("click", selectAllVisible);
    clearSelectionBtn.addEventListener("click", clearSelection);
    bulkDeleteBtn.addEventListener("click", bulkDelete);
    bulkFavBtn.addEventListener("click", bulkFav);
    bulkTagBtn.addEventListener("click", bulkTag);

    // Card actions + flip + selection
    gridEl.addEventListener("click", (e)=>{
      const sel = e.target.closest(".selBox");
      if(sel){
        const id = e.target.closest(".card")?.dataset.id;
        if(!id) return;
        if(selectedIds.has(id)) selectedIds.delete(id);
        else selectedIds.add(id);
        haptic("tap");
        render();
        return;
      }

      const actionBtn = e.target.closest("[data-action]");
      if(actionBtn){
        const action = actionBtn.dataset.action;
        const id = actionBtn.dataset.id || e.target.closest(".card")?.dataset.id;
        if(!id) return;

        if(action === "flip"){
          const flipEl = document.querySelector(`.cardFlip[data-id="${id}"]`);
          if(flipEl) flipEl.classList.toggle("flipped");
          return;
        }
        if(action === "edit"){ openEdit(id); return; }
        if(action === "delete"){ deleteById(id); return; }
        if(action === "fav"){
          const it = items.find(x=>x.id===id);
          if(!it) return;
          it.fav = !it.fav;
          it.updatedAt = now();
          saveItems(items);
          toast(it.fav ? "Favorilere eklendi ‚òÖ" : "Favoriden √ßƒ±ktƒ± ‚òÜ");
          render();
          return;
        }
      }

      // Tap on flip area (disabled in selection mode)
      if(selecting) return;

      const flipEl = e.target.closest(".cardFlip");
      if(flipEl && !e.target.closest(".actions") && !e.target.closest(".star")){
        flipEl.classList.toggle("flipped");
      }
    });

    // Export / Import / wipe
    document.getElementById("exportJsonBtn").addEventListener("click", exportJSON);
    document.getElementById("exportCsvBtn").addEventListener("click", exportCSV);

    document.getElementById("importFile").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(f) importJSON(f);
      e.target.value = "";
    });

    document.getElementById("wipeBtn").addEventListener("click", ()=>{
      if(items.length === 0) return toast("Zaten bo≈ü.");
      if(confirm("T√ºm kelimeler silinecek. Emin misin?")){
        items = [];
        saveItems(items);
        toast("Hepsi silindi üóëÔ∏è");
        selectedIds.clear();
        render();
      }
    });

    // Language manager events
    langManageBtn.addEventListener("click", openLangModal);
    langCloseBtn.addEventListener("click", ()=> langModal.close());
    langDoneBtn.addEventListener("click", ()=> langModal.close());
    addLangBtn.addEventListener("click", addLanguage);
    resetLangBtn.addEventListener("click", resetLanguages);

    // Quiz events
    quizToggleBtn.addEventListener("click", openQuizScreen);
    quizCloseBtn.addEventListener("click", closeQuizScreen);

    quizStartBtn.addEventListener("click", ()=>{
      const scope = quizScopeEl.value || "CURRENT";
      let pool = pickQuizPool(scope);

      if(pool.length === 0){
        toast("Quiz i√ßin havuz bo≈ü. Filtre/arama √ßok dar olabilir.");
        return;
      }

      const mode = quizModeSelect.value === "TERM2TR" ? "TERM2TR" : "TR2TERM";
      const count = Number(quizCountSelect.value || 10);
      const choiceCount = Number(quizChoiceCountEl.value || 4);
      const allowRepeat = (quizRepeatEl.value === "YES");

      startQuizSession({mode, count, pool, choiceCount, allowRepeat});
    });

    quizSkipBtn.addEventListener("click", skipQuestion);
    quizNextBtn2.addEventListener("click", goNextFromPlay);

    quizBackToSetupBtn.addEventListener("click", showQuizSetup);

    quizRetryWrongBtn.addEventListener("click", ()=>{
      if(!quizSession) return;
      const wrongIds = uniqById(quizSession.unknown).map(x=>x.id);
      if(wrongIds.length === 0){
        toast("Yanlƒ±≈ü yok ‚úÖ");
        return;
      }
      // build pool only from wrong ids (respect current search/level/tag if you want)
      let pool = items.filter(x => wrongIds.includes(x.id));
      // still apply level/tag/search filters to narrow:
      const q = searchEl.value.trim().toLowerCase();
      if(q) pool = pool.filter(it=>matchesQuery(it, q));
      pool = applyLevelFilter(pool);
      pool = applyTagFilter(pool);
      pool = applySort(pool);

      startQuizSession({
        mode: quizSession.mode,
        count: 9999,
        pool,
        choiceCount: quizSession.choiceCount,
        allowRepeat: true
      });
    });

    // ===== Init =====
    langs = loadLangs();
    saveLangs(langs); // normalize & persist
    renderChips();
    renderLanguageSelect();

    applyTheme(localStorage.getItem(THEME_KEY) || "dark");

    // If old versions exist, keep current KEY only (no migration tool needed)
    saveItems(items);

    // initial tag filter + render
    updateTagFilterOptions();
    render();

    // keep level/tag in sync
    levelFilterEl.value = levelFilter;
    tagFilterEl.value = tagFilter;
  </script>
</body>
</html>
