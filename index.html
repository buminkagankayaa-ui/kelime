<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vocab Pocket Pro</title>

  <meta name="theme-color" content="#0b0b10" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VocabPocket" />

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12121a;
      --card:#151523;
      --card2:#17172a;
      --line:#23233a;
      --text:#f2f2f7;
      --muted:#a6a6bb;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#fb7185;
      --warn:#fbbf24;

      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;

      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(34,197,94,.18), transparent 55%);
      --headerTop: rgba(11,11,16,.92);
      --headerBottom: rgba(11,11,16,.60);
      --inputBg: rgba(21,21,35,.85);
    }

    body[data-theme="dark"]{
      --bg:#0b0b10; --panel:#12121a; --card:#151523; --card2:#17172a;
      --line:#23233a; --text:#f2f2f7; --muted:#a6a6bb;
      --accent:#7c3aed; --accent2:#22c55e;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.25), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(34,197,94,.18), transparent 55%);
      --headerTop: rgba(11,11,16,.92);
      --headerBottom: rgba(11,11,16,.60);
      --inputBg: rgba(21,21,35,.85);
    }
    body[data-theme="emerald"]{
      --bg:#07110c; --panel:#0b1711; --card:#0f1f17; --card2:#11251b;
      --line:#1f3a2d; --text:#eafff3; --muted:#a2c8b3;
      --accent:#22c55e; --accent2:#7c3aed;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(34,197,94,.22), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(124,58,237,.16), transparent 55%);
      --headerTop: rgba(7,17,12,.92);
      --headerBottom: rgba(7,17,12,.60);
      --inputBg: rgba(15,31,23,.88);
    }
    body[data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --card2:#f4f6ff;
      --line:#d7d9e6; --text:#0b0b10; --muted:#4b5563;
      --accent:#7c3aed; --accent2:#16a34a;
      --shadow: 0 16px 60px rgba(0,0,0,.12);
      --bgGrad1: radial-gradient(1100px 600px at 20% -10%, rgba(124,58,237,.16), transparent 55%);
      --bgGrad2: radial-gradient(900px 520px at 110% 10%, rgba(22,163,74,.12), transparent 55%);
      --headerTop: rgba(246,247,251,.92);
      --headerBottom: rgba(246,247,251,.72);
      --inputBg: rgba(255,255,255,.92);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: var(--bgGrad1), var(--bgGrad2), var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(to bottom, var(--headerTop), var(--headerBottom));
      backdrop-filter: blur(10px);
      padding: 12px 0 12px 0;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; flex-direction:column; gap:4px}
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: color-mix(in srgb, var(--accent) 35%, transparent);
      background: color-mix(in srgb, var(--accent) 16%, transparent);
    }
    .btn.ghost{background: transparent;}
    .btn.danger{
      border-color: color-mix(in srgb, var(--danger) 35%, transparent);
      background: color-mix(in srgb, var(--danger) 12%, transparent);
    }

    .controls{
      margin-top:12px;
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }

    .input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: var(--inputBg);
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      outline:none;
      font-size:15px;
    }
    textarea{min-height:88px; resize:vertical}

    .chips{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:9px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      flex:1;
      min-width: 110px;
      text-align:center;
      user-select:none;
    }
    .chip.active{
      border-color: color-mix(in srgb, var(--accent2) 35%, transparent);
      background: color-mix(in srgb, var(--accent2) 14%, transparent);
    }

    /* ‚úÖ NEW: filters on ONE row (wrap nicely) */
    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }
    .filters select{
      width:auto;
      min-width: 160px;
      flex: 1;
    }
    @media (max-width: 420px){
      .filters select{ min-width: 140px; }
    }

    .bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      color: var(--muted); font-size:12px; margin-top:4px;
    }
    .bar .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:999px;
      color: var(--muted);
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .pill strong{color:var(--text); font-weight:900}

    main{margin-top:12px}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 680px){ .grid{ grid-template-columns: 1fr 1fr; } }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1fr 1fr 1fr; } }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), color-mix(in srgb, var(--panel) 92%, transparent));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .cardFlipWrap{
      position: relative;
      min-height: 240px;
      perspective: 1000px;
    }
    .cardFlip{
      position:absolute; inset:0;
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
      transition: transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .cardFlip.flipped{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      padding:14px;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      display:flex; flex-direction:column; gap:10px;
    }
    .back{
      transform: rotateY(180deg);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card2) 95%, transparent), color-mix(in srgb, var(--panel) 92%, transparent));
    }

    .meta{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .badge .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .star{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:grid; place-items:center;
      font-size:20px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
    }
    .star.on{
      border-color: color-mix(in srgb, var(--warn) 35%, transparent);
      background: color-mix(in srgb, var(--warn) 12%, transparent);
      color: var(--warn);
    }

    .term{
      margin:0;
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.05;
      word-break: break-word;
    }
    .meaning{
      margin:0;
      color: color-mix(in srgb, var(--text) 92%, transparent);
      font-size:14px;
      line-height:1.35;
    }
    .example{
      margin:0;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
    }

    .miniStats{
      display:flex; gap:8px; flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
      margin-top: 2px;
    }
    .miniStats b{ color:var(--text); }

    .tags{
      display:flex; flex-wrap:wrap; gap:6px; margin-top:auto;
    }
    .tag{
      font-size:11px;
      color: var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding:6px 8px;
      border-radius: 999px;
    }
    .tag.good{ border-color: color-mix(in srgb, var(--accent2) 35%, transparent); background: color-mix(in srgb, var(--accent2) 10%, transparent); }
    .tag.bad{ border-color: color-mix(in srgb, var(--danger) 35%, transparent); background: color-mix(in srgb, var(--danger) 10%, transparent); }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }

    dialog{
      width:min(760px, 96vw);
      border:none;
      border-radius: 18px;
      background: rgba(18,18,26,.98);
      color: var(--text);
      box-shadow: var(--shadow);
      padding:0;
      overflow:hidden;
    }
    body[data-theme="light"] dialog{ background: rgba(255,255,255,.98); }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .modalHead{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modalHead h2{margin:0; font-size:15px}
    .modalHead .small{font-size:12px; color:var(--muted); margin-top:6px}
    .modalBody{padding:14px; display:grid; gap:10px}
    .two{display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 680px){ .two{grid-template-columns: 1fr 1fr;} }
    .modalFoot{
      padding:14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .help{
      font-size:12px; color:var(--muted);
      border:1px dashed color-mix(in srgb, var(--text) 18%, transparent);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.02);
    }

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      background: rgba(18,18,26,.95);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--text);
      display:none;
      z-index:9999;
    }
    body[data-theme="light"] .toast{ background: rgba(255,255,255,.95); }
  </style>
</head>

<body data-theme="dark">
  <header>
    <div class="topbar">
      <div class="brand">
        <h1>Vocab Pocket Pro</h1>
        <div class="sub">Kart gibi ‚Ä¢ Flip ‚Ä¢ Favori ‚Ä¢ Etiket ‚Ä¢ Seviye</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="langManageBtn">üåê Diller</button>
        <button class="btn primary" id="addBtn">Ôºã Ekle</button>
      </div>
    </div>

    <div class="controls">
      <input class="input" id="search" placeholder="Ara: kelime / anlam / √∂rnek / etiket..." />

      <!-- Chips: T√ºm√º + diller (Favoriler kaldƒ±rƒ±ldƒ±) -->
      <div class="chips" id="chips"></div>

      <!-- ‚úÖ Filters: side-by-side (wrap) -->
      <div class="filters">
        <select id="levelFilter" title="Seviye filtresi">
          <option value="ALL" selected>Seviye: T√ºm√º</option>
          <option value="A1">Seviye: A1</option>
          <option value="A2">Seviye: A2</option>
          <option value="B1">Seviye: B1</option>
          <option value="B2">Seviye: B2</option>
          <option value="C1">Seviye: C1</option>
          <option value="C2">Seviye: C2</option>
        </select>

        <select id="tagFilter" title="Etiket filtresi">
          <option value="ALL" selected>Etiket: T√ºm√º</option>
        </select>

        <select id="themeSelect" title="Tema">
          <option value="dark" selected>Tema: Dark</option>
          <option value="emerald">Tema: Emerald</option>
          <option value="light">Tema: Light</option>
        </select>

        <select id="sort" title="Sƒ±rala">
          <option value="updated">Sƒ±rala: Son g√ºncellenen</option>
          <option value="created">Sƒ±rala: Son eklenen</option>
          <option value="az">Sƒ±rala: A ‚Üí Z</option>
          <option value="za">Sƒ±rala: Z ‚Üí A</option>
        </select>
      </div>

      <div class="bar">
        <div class="left">
          <span class="pill">Toplam <strong id="countAll">0</strong></span>
          <span class="pill">G√∂r√ºnen <strong id="countVisible">0</strong></span>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button class="btn danger" id="wipeBtn">üóëÔ∏è Hepsini Sil</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid" id="grid"></div>
  </main>

  <!-- Modal: Word add/edit -->
  <dialog id="modal">
    <div class="modalHead">
      <div>
        <h2 id="modalTitle">Kelime Ekle</h2>
        <div class="small" id="modalSub">Kelime + TR anlam + √∂rnek + etiket</div>
      </div>
      <button class="btn" id="closeBtn" type="button">‚úï</button>
    </div>

    <form class="modalBody" id="form">
      <div class="two">
        <div>
          <label class="small">Dil</label>
          <select id="language"></select>
        </div>

        <div>
          <label class="small">Seviye</label>
          <select id="level">
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1" selected>B1</option>
            <option value="B2">B2</option>
            <option value="C1">C1</option>
            <option value="C2">C2</option>
          </select>
        </div>
      </div>

      <div class="two">
        <div>
          <label class="small">Kelime</label>
          <input class="input" id="term" placeholder="beneath / shone / ..." autocomplete="off" />
        </div>
        <div>
          <label class="small">T√ºrk√ße anlam</label>
          <input class="input" id="meaningTR" placeholder="T√ºrk√ße anlamƒ±..." autocomplete="off" />
        </div>
      </div>

      <div>
        <label class="small">√ñrnek c√ºmle (kelimenin dilinde)</label>
        <textarea id="example" placeholder="√ñrn: George found a mass of gold beneath the dusty floor."></textarea>
      </div>

      <div class="two">
        <div>
          <label class="small">Etiketler (virg√ºlle)</label>
          <input class="input" id="tags" placeholder="story, daily..." autocomplete="off" />
        </div>
        <div class="help">
          <div><strong>ƒ∞pucu</strong></div>
          <div>‚Ä¢ Kartƒ± √ßevirmek i√ßin karta dokun</div>
          <div>‚Ä¢ ‚òÖ favori: kart √ºst√ºndeki yƒ±ldƒ±z</div>
        </div>
      </div>
    </form>

    <div class="modalFoot">
      <button class="btn danger" id="deleteBtn" type="button" style="display:none;">Sil</button>
      <button class="btn" id="cancelBtn" type="button">ƒ∞ptal</button>
      <button class="btn primary" id="saveBtn" type="button">Kaydet</button>
    </div>
  </dialog>

  <!-- Modal: Language manager -->
  <dialog id="langModal">
    <div class="modalHead">
      <div>
        <h2>Diller</h2>
        <div class="small">Yeni dil ekle (√∂r: DE - Deutsch). Dil kodu 2-5 harf olsun.</div>
      </div>
      <button class="btn" id="langCloseBtn" type="button">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="two">
        <div>
          <label class="small">Dil Kodu</label>
          <input class="input" id="newLangCode" placeholder="DE" maxlength="5" />
        </div>
        <div>
          <label class="small">Dil Adƒ±</label>
          <input class="input" id="newLangName" placeholder="Deutsch" />
        </div>
      </div>

      <div class="two">
        <button class="btn primary" id="addLangBtn" type="button" style="justify-content:center;">Ôºã Dil Ekle</button>
        <button class="btn danger" id="resetLangBtn" type="button" style="justify-content:center;">‚Ü∫ Varsayƒ±lanlara d√∂n</button>
      </div>

      <div class="help" id="langListBox">‚Äî</div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="langDoneBtn" type="button">Tamam</button>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

  <script>
    const KEY = "vocab_pocket_pro_v4";
    const THEME_KEY = "vocab_theme_v1";
    const LANG_KEY = "vocab_languages_v1";

    const now = () => Date.now();
    const clean = (s) => (s ?? "").toString().trim();

    function loadItems(){
      try{ return JSON.parse(localStorage.getItem(KEY)) ?? []; }
      catch{ return []; }
    }
    function saveItems(items){ localStorage.setItem(KEY, JSON.stringify(items)); }

    function escapeHtml(str){
      return (str ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[m]));
    }

    function parseTags(input){
      return clean(input).split(",").map(t=>t.trim()).filter(Boolean).slice(0,10);
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display="none", 1600);
    }

    // ===== Languages =====
    const DEFAULT_LANGS = [
      { code:"EN", name:"English" },
      { code:"RU", name:"–†—É—Å—Å–∫–∏–π" }
    ];

    function loadLangs(){
      try{
        const v = JSON.parse(localStorage.getItem(LANG_KEY));
        if(Array.isArray(v) && v.length) return normalizeLangs(v);
      }catch{}
      return DEFAULT_LANGS.slice();
    }
    function saveLangs(list){
      localStorage.setItem(LANG_KEY, JSON.stringify(normalizeLangs(list)));
    }
    function normalizeLangs(list){
      const map = new Map();
      for(const x of (list||[])){
        const code = clean(x.code).toUpperCase();
        const name = clean(x.name);
        if(!code || code.length < 2 || code.length > 5) continue;
        if(!name) continue;
        map.set(code, {code, name});
      }
      for(const d of DEFAULT_LANGS){
        if(!map.has(d.code)) map.set(d.code, d);
      }
      return Array.from(map.values()).sort((a,b)=>a.code.localeCompare(b.code));
    }

    // ===== State =====
    let items = loadItems().map(patchItem);
    let langs = loadLangs();

    let filter = "ALL";        // ALL / LANG_CODE
    let levelFilter = "ALL";   // ALL / A1..C2
    let tagFilter = "ALL";     // ALL / tag
    let editingId = null;

    // ===== Elements =====
    const gridEl = document.getElementById("grid");
    const chipsEl = document.getElementById("chips");
    const searchEl = document.getElementById("search");
    const sortEl = document.getElementById("sort");
    const levelFilterEl = document.getElementById("levelFilter");
    const tagFilterEl = document.getElementById("tagFilter");

    const countAll = document.getElementById("countAll");
    const countVisible = document.getElementById("countVisible");

    const themeSelect = document.getElementById("themeSelect");
    const toastEl = document.getElementById("toast");

    // Modal word
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const deleteBtn = document.getElementById("deleteBtn");
    const langEl = document.getElementById("language");
    const levelEl = document.getElementById("level");
    const termEl = document.getElementById("term");
    const meaningEl = document.getElementById("meaningTR");
    const exampleEl = document.getElementById("example");
    const tagsEl = document.getElementById("tags");

    // Language manager modal
    const langManageBtn = document.getElementById("langManageBtn");
    const langModal = document.getElementById("langModal");
    const langCloseBtn = document.getElementById("langCloseBtn");
    const langDoneBtn = document.getElementById("langDoneBtn");
    const newLangCode = document.getElementById("newLangCode");
    const newLangName = document.getElementById("newLangName");
    const addLangBtn = document.getElementById("addLangBtn");
    const resetLangBtn = document.getElementById("resetLangBtn");
    const langListBox = document.getElementById("langListBox");

    // ===== Patch item =====
    function patchItem(it){
      const x = {...it};
      x.lang = clean(x.lang).toUpperCase() || "EN";
      x.level = clean(x.level) || "B1";
      x.term = clean(x.term);
      x.meaningTR = clean(x.meaningTR);
      x.example = clean(x.example);
      x.tags = Array.isArray(x.tags) ? x.tags.map(clean).filter(Boolean).slice(0,10) : parseTags(x.tags||"");
      x.fav = !!x.fav;

      x.createdAt = Number(x.createdAt || now());
      x.updatedAt = Number(x.updatedAt || now());
      x.id = String(x.id || (crypto.randomUUID ? crypto.randomUUID() : (String(x.createdAt)+Math.random().toString(16).slice(2))));
      return x;
    }

    // ===== Theme =====
    function applyTheme(t){
      const theme = (t === "emerald" || t === "light") ? t : "dark";
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      themeSelect.value = theme;
    }

    // ===== Helpers =====
    function matchesQuery(it, q){
      if(!q) return true;
      const hay = (it.term + " " + it.meaningTR + " " + (it.example||"") + " " + (it.tags||[]).join(" ")).toLowerCase();
      return hay.includes(q);
    }

    function applyChipFilter(arr){
      if(filter === "ALL") return arr;
      return arr.filter(x=>x.lang === filter);
    }
    function applyLevelFilter(arr){
      if(levelFilter === "ALL") return arr;
      return arr.filter(x => (x.level || "B1") === levelFilter);
    }
    function applyTagFilter(arr){
      if(tagFilter === "ALL") return arr;
      return arr.filter(x => (x.tags||[]).includes(tagFilter));
    }

    function applySort(arr){
      const s = sortEl.value;
      const copy = [...arr];
      if(s === "updated") copy.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      else if(s === "created") copy.sort((a,b)=> (b.createdAt||0) - (a.updatedAt||0));
      else if(s === "az") copy.sort((a,b)=> (a.term||"").localeCompare(b.term||"", undefined, {sensitivity:"base"}));
      else if(s === "za") copy.sort((a,b)=> (b.term||"").localeCompare(a.term||"", undefined, {sensitivity:"base"}));
      return copy;
    }

    function getVisibleItems(){
      const q = searchEl.value.trim().toLowerCase();
      let view = items.filter(it => matchesQuery(it, q));
      view = applyChipFilter(view);
      view = applyLevelFilter(view);
      view = applyTagFilter(view);
      view = applySort(view);
      return view;
    }

    function updateTagFilterOptions(){
      const tags = new Set();
      for(const it of items){
        for(const t of (it.tags||[])) tags.add(t);
      }
      const list = Array.from(tags).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
      const prev = tagFilterEl.value || "ALL";
      tagFilterEl.innerHTML = `<option value="ALL">Etiket: T√ºm√º</option>` + list.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml("#"+t)}</option>`).join("");
      if(list.includes(prev)) tagFilterEl.value = prev;
      else tagFilterEl.value = "ALL";
      tagFilter = tagFilterEl.value;
    }

    function renderChips(){
      chipsEl.innerHTML = "";

      function addChip(label, value){
        const b = document.createElement("button");
        b.className = "chip" + (filter === value ? " active" : "");
        b.textContent = label;
        b.dataset.value = value;
        b.addEventListener("click", ()=>{
          filter = value;
          renderChips();
          render();
        });
        chipsEl.appendChild(b);
      }

      addChip("T√ºm√º", "ALL");
      for(const l of langs){
        addChip(l.name, l.code);
      }
    }

    function renderLanguageSelect(){
      const prev = langEl.value || "EN";
      langEl.innerHTML = langs.map(l => `<option value="${l.code}">${escapeHtml(l.name)} (${escapeHtml(l.code)})</option>`).join("");
      if(langs.some(x=>x.code===prev)) langEl.value = prev;
      else langEl.value = "EN";
    }

    // ===== Render =====
    function render(){
      countAll.textContent = items.length;

      const view = getVisibleItems();
      countVisible.textContent = view.length;
      gridEl.innerHTML = "";

      updateTagFilterOptions();

      if(view.length === 0){
        gridEl.innerHTML = `
          <div class="card">
            <div class="cardFlipWrap">
              <div class="cardFlip">
                <div class="face">
                  <div class="meta">
                    <span class="badge"><span class="dot"></span> ƒ∞pucu</span>
                  </div>
                  <p class="term">Kayƒ±t yok</p>
                  <p class="meaning">Yeni kelime eklemek i√ßin <strong>Ôºã Ekle</strong> butonuna bas.</p>
                  <div class="tags">
                    <span class="tag">Dil</span>
                    <span class="tag">TR anlam</span>
                    <span class="tag">√ñrnek</span>
                    <span class="tag">Etiket</span>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
        return;
      }

      for(const it of view){
        const langName = (langs.find(x=>x.code===it.lang)?.name) || it.lang;
        const tagsHtml = (it.tags||[]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join("");

        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = it.id;

        card.innerHTML = `
          <div class="cardFlipWrap">
            <div class="cardFlip" data-id="${it.id}">
              <div class="face front">
                <div class="meta">
                  <span class="badge">
                    <span class="dot"></span>
                    ${escapeHtml(it.lang)} ‚Ä¢ ${escapeHtml(it.level||"B1")}
                  </span>
                  <div class="star ${it.fav ? "on":""}" data-action="fav" title="Favori">
                    ${it.fav ? "‚òÖ" : "‚òÜ"}
                  </div>
                </div>

                <p class="term">${escapeHtml(it.term)}</p>
                <p class="example">${escapeHtml(it.example || "Karta dokun ‚Üí √ßevir")}</p>

                <div class="miniStats">
                  <span>‚Ä¢ ${escapeHtml(langName)}</span>
                </div>

                <div class="tags">
                  ${tagsHtml || `<span class="tag">#etiket</span>`}
                </div>
              </div>

              <div class="face back">
                <div class="meta">
                  <span class="badge">
                    <span class="dot"></span>
                    TR anlam
                  </span>
                  <div class="star ${it.fav ? "on":""}" data-action="fav" title="Favori">
                    ${it.fav ? "‚òÖ" : "‚òÜ"}
                  </div>
                </div>

                <p class="term">${escapeHtml(it.meaningTR)}</p>
                <p class="example" style="-webkit-line-clamp:4">${escapeHtml(it.example || "")}</p>

                <div class="tags">
                  <span class="tag">${escapeHtml(it.lang)} ‚Ä¢ ${escapeHtml(it.level||"B1")}</span>
                  ${tagsHtml}
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" data-action="flip" data-id="${it.id}">‚Ü∫ √áevir</button>
            <button class="btn" data-action="edit" data-id="${it.id}">‚úé D√ºzenle</button>
            <button class="btn danger" data-action="delete" data-id="${it.id}">üóëÔ∏è Sil</button>
          </div>
        `;

        gridEl.appendChild(card);
      }
    }

    // ===== Word modal =====
    function openAdd(){
      editingId = null;
      modalTitle.textContent = "Kelime Ekle";
      deleteBtn.style.display = "none";

      renderLanguageSelect();

      langEl.value = (langs.some(x=>x.code==="EN") ? "EN" : langs[0]?.code || "EN");
      levelEl.value = "B1";
      termEl.value = "";
      meaningEl.value = "";
      exampleEl.value = "";
      tagsEl.value = "";

      modal.showModal();
      setTimeout(()=>termEl.focus(), 50);
    }

    function openEdit(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;

      editingId = id;
      modalTitle.textContent = "Kelime D√ºzenle";
      deleteBtn.style.display = "inline-flex";

      renderLanguageSelect();

      langEl.value = it.lang;
      levelEl.value = it.level || "B1";
      termEl.value = it.term || "";
      meaningEl.value = it.meaningTR || "";
      exampleEl.value = it.example || "";
      tagsEl.value = (it.tags||[]).join(", ");

      modal.showModal();
      setTimeout(()=>termEl.focus(), 50);
    }

    function upsert(){
      const lang = (langEl.value || "EN").toUpperCase();
      const level = levelEl.value || "B1";
      const term = clean(termEl.value);
      const meaningTR = clean(meaningEl.value);
      const example = clean(exampleEl.value);
      const tags = parseTags(tagsEl.value);

      if(!term || !meaningTR){
        toast("Kelime ve T√ºrk√ße anlam zorunlu.");
        return;
      }

      const t = now();

      if(editingId){
        const it = items.find(x=>x.id===editingId);
        if(!it) return;

        it.lang = lang;
        it.level = level;
        it.term = term;
        it.meaningTR = meaningTR;
        it.example = example;
        it.tags = tags;
        it.updatedAt = t;

        toast("G√ºncellendi ‚úÖ");
      } else {
        const id = (crypto.randomUUID ? crypto.randomUUID() : String(t) + Math.random().toString(16).slice(2));
        items.push(patchItem({
          id, lang, level, term, meaningTR, example, tags,
          fav:false,
          createdAt:t, updatedAt:t
        }));
        toast("Eklendi ‚úÖ");
      }

      saveItems(items);
      modal.close();
      render();
    }

    function deleteById(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      if(confirm(`Silinsin mi?\n\n${it.term} (${it.lang})`)){
        items = items.filter(x=>x.id!==id);
        saveItems(items);
        toast("Silindi üóëÔ∏è");
        render();
      }
    }

    // ===== Language manager modal =====
    function openLangModal(){
      renderLangListBox();
      newLangCode.value = "";
      newLangName.value = "";
      langModal.showModal();
      setTimeout(()=>newLangCode.focus(), 50);
    }

    function renderLangListBox(){
      const lines = langs.map(l => `‚Ä¢ ${l.code} ‚Äî ${l.name}`).join("\n");
      langListBox.textContent = lines || "‚Äî";
    }

    function addLanguage(){
      const code = clean(newLangCode.value).toUpperCase();
      const name = clean(newLangName.value);

      if(!code || code.length < 2 || code.length > 5){
        toast("Dil kodu 2-5 harf olmalƒ±.");
        return;
      }
      if(!name){
        toast("Dil adƒ± bo≈ü olamaz.");
        return;
      }

      langs = normalizeLangs([...langs, {code, name}]);
      saveLangs(langs);
      toast("Dil eklendi ‚úÖ");
      renderLangListBox();
      renderChips();
      renderLanguageSelect();
      render();
    }

    function resetLanguages(){
      if(confirm("Diller varsayƒ±lana d√∂necek (EN/RU). Emin misin?")){
        langs = DEFAULT_LANGS.slice();
        saveLangs(langs);
        toast("Sƒ±fƒ±rlandƒ± ‚úÖ");
        renderLangListBox();
        renderChips();
        renderLanguageSelect();
        render();
      }
    }

    // ===== Events =====
    document.getElementById("addBtn").addEventListener("click", openAdd);
    document.getElementById("cancelBtn").addEventListener("click", ()=>modal.close());
    document.getElementById("closeBtn").addEventListener("click", ()=>modal.close());
    document.getElementById("saveBtn").addEventListener("click", upsert);

    deleteBtn.addEventListener("click", ()=>{
      if(editingId) deleteById(editingId);
      modal.close();
    });

    searchEl.addEventListener("input", render);
    sortEl.addEventListener("change", render);

    levelFilterEl.addEventListener("change", ()=>{
      levelFilter = levelFilterEl.value;
      render();
    });

    tagFilterEl.addEventListener("change", ()=>{
      tagFilter = tagFilterEl.value;
      render();
    });

    themeSelect.addEventListener("change", (e)=> applyTheme(e.target.value));

    // Card actions + flip
    gridEl.addEventListener("click", (e)=>{
      const actionBtn = e.target.closest("[data-action]");
      if(actionBtn){
        const action = actionBtn.dataset.action;
        const id = actionBtn.dataset.id || e.target.closest(".card")?.dataset.id;
        if(!id) return;

        if(action === "flip"){
          const flipEl = document.querySelector(`.cardFlip[data-id="${id}"]`);
          if(flipEl) flipEl.classList.toggle("flipped");
          return;
        }
        if(action === "edit"){ openEdit(id); return; }
        if(action === "delete"){ deleteById(id); return; }
        if(action === "fav"){
          const it = items.find(x=>x.id===id);
          if(!it) return;
          it.fav = !it.fav;
          it.updatedAt = now();
          saveItems(items);
          toast(it.fav ? "Favorilere eklendi ‚òÖ" : "Favoriden √ßƒ±ktƒ± ‚òÜ");
          render();
          return;
        }
      }

      const flipEl = e.target.closest(".cardFlip");
      if(flipEl && !e.target.closest(".actions") && !e.target.closest(".star")){
        flipEl.classList.toggle("flipped");
      }
    });

    // Wipe
    document.getElementById("wipeBtn").addEventListener("click", ()=>{
      if(items.length === 0) return toast("Zaten bo≈ü.");
      if(confirm("T√ºm kelimeler silinecek. Emin misin?")){
        items = [];
        saveItems(items);
        toast("Hepsi silindi üóëÔ∏è");
        render();
      }
    });

    // Language manager events
    langManageBtn.addEventListener("click", openLangModal);
    langCloseBtn.addEventListener("click", ()=> langModal.close());
    langDoneBtn.addEventListener("click", ()=> langModal.close());
    addLangBtn.addEventListener("click", addLanguage);
    resetLangBtn.addEventListener("click", resetLanguages);

    // ===== Init =====
    langs = loadLangs();
    saveLangs(langs);

    renderChips();
    renderLanguageSelect();

    applyTheme(localStorage.getItem(THEME_KEY) || "dark");

    saveItems(items);
    updateTagFilterOptions();
    render();

    levelFilterEl.value = levelFilter;
    tagFilterEl.value = tagFilter;
  </script>
</body>
</html>
