<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LingoMaster</title>
  <meta name="theme-color" content="#0b1220" id="meta-theme">
  <!-- BUILD: 2026-01-03-02 -->

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);

      --header-h: 60px;
      --nav-h: 74px;
      --radius: 18px;

      --bg:#0b1220;
      --card:#111b2d;
      --card2:#0f172a;
      --border:#25324a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#6366f1;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
    }

    [data-theme="light"]{
      --bg:#f8fafc;
      --card:#ffffff;
      --card2:#f1f5f9;
      --border:#cbd5e1;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#4f46e5;
    }
    [data-theme="ocean"]{
      --bg:#06131f;
      --card:#0b2236;
      --card2:#0a1b2a;
      --border:#245070;
      --text:#e6f2ff;
      --muted:#9bb7d3;
      --primary:#38bdf8;
    }
    [data-theme="emerald"]{
      --bg:#071a14;
      --card:#0b2a21;
      --card2:#082018;
      --border:#1f6b52;
      --text:#ecfdf5;
      --muted:#9fe3c7;
      --primary:#10b981;
    }
    [data-theme="sunset"]{
      --bg:#1b1020;
      --card:#2a1731;
      --card2:#1f1225;
      --border:#6b2a59;
      --text:#fff7ed;
      --muted:#fbcfe8;
      --primary:#fb7185;
    }
    [data-theme="rose"]{
      --bg:#120a10;
      --card:#1f0f1b;
      --card2:#160b13;
      --border:#7f1d1d;
      --text:#fff1f2;
      --muted:#fda4af;
      --primary:#f43f5e;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }

    header{
      position:sticky; top:0; z-index:20;
      height:calc(var(--header-h) + var(--safe-top));
      padding-top:var(--safe-top);
      display:flex; align-items:center; justify-content:space-between;
      padding-left:16px; padding-right:16px;
      background:color-mix(in srgb, var(--bg) 78%, transparent);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:950;}
    .logo{
      width:18px; height:18px; border:2px solid var(--primary);
      border-radius:6px; transform:rotate(15deg);
    }
    .iconBtn{
      width:44px; height:44px; border-radius:14px;
      background:transparent; border:1px solid var(--border);
      color:var(--muted);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{transform:scale(.98); opacity:.9;}

    #viewport{
      position:relative;
      height:calc(100vh - (var(--header-h) + var(--safe-top)));
    }

    .view{
      position:absolute; inset:0;
      padding:18px;
      padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 18px);
      overflow:auto;
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:.25s ease;
    }
    .view.active{opacity:1; pointer-events:auto; transform:none;}

    .row{display:flex; gap:12px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
    }
    .muted{color:var(--muted);}
    .big{font-size:34px; font-weight:980;}
    .h2{font-size:20px; font-weight:980; margin:0 0 12px 0;}
    .secTitle{font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); font-weight:950; margin:4px 0 10px;}

    .btn{
      border:0; cursor:pointer;
      border-radius:16px;
      padding:14px 16px;
      font-weight:980;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      user-select:none;
    }
    .btn:active{transform:scale(.985); opacity:.92;}
    .btnPrimary{background:var(--primary); color:white;}
    .btnSoft{background:var(--card2); color:var(--text); border:1px solid var(--border);}
    .btnDanger{background:var(--danger); color:white;}
    .btnHalf{flex:1;}

    /* ‚úÖ BOTTOM NAV: iOS yamukluk fix (grid kilidi) */
    nav{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      height:calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom:var(--safe-bottom);
      background:var(--card2);
      border-top:1px solid var(--border);
      display:flex;
    }
    .navBtn{
      flex:1;
      background:transparent;
      border:0;
      color:var(--muted);
      cursor:pointer;
      user-select:none;

      display:grid;
      grid-template-rows: 34px 18px;
      align-items:center;
      justify-items:center;

      padding:6px 0;
      line-height:1;
    }
    .navBtn .ico{
      width:44px;
      height:34px;
      display:grid;
      place-items:center;
      font-size:20px;
      line-height:1;
    }
    .navBtn span{
      font-size:12px;
      font-weight:980;
      line-height:1;
      transform:translateY(-1px);
    }
    .navBtn.active{ color:var(--primary); }
    .navBtn.active .ico{
      background:color-mix(in srgb, var(--primary) 15%, transparent);
      border-radius:14px;
    }

    /* Reader */
    .readerTop{
      position:sticky; top:0;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      padding:10px 0 12px;
      margin-bottom:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .readerTop .titleWrap{min-width:0; text-align:center;}
    .readerTop .title{font-weight:980; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .readerTop .sub{font-size:12px; color:var(--muted); font-weight:950;}
    .reader{
      max-width:720px; margin:0 auto;
      font-family: ui-serif, Georgia, "Times New Roman", serif;
      font-size:19px;
      line-height:1.75;
      text-align:justify;
    }
    .token{cursor:pointer; padding:2px 0; border-radius:6px;}
    .token:active{background:color-mix(in srgb, var(--primary) 25%, transparent);}

    /* Bottom Sheet */
    .backdrop{
      position:fixed; inset:0; z-index:40;
      background:rgba(0,0,0,.55);
      opacity:0; pointer-events:none;
      transition:.2s ease;
    }
    .backdrop.open{opacity:1; pointer-events:auto;}

    .sheet{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      background:var(--card);
      border-radius:26px 26px 0 0;
      border:1px solid var(--border);
      transform:translateY(110%);
      transition:.25s ease;
      max-height:85vh;
      overflow:auto;
      padding:14px 16px calc(16px + var(--safe-bottom));
    }
    .sheet.open{transform:none;}
    .handle{width:48px; height:5px; border-radius:99px; background:var(--border); margin:6px auto 14px;}
    .sheetHeader{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:10px;}
    .sheetHeader .word{font-size:34px; font-weight:980; margin:2px 0;}
    .sheetHeader .lang{font-size:12px; font-weight:980; color:var(--primary); letter-spacing:.08em;}
    .field{margin:10px 0;}
    label{display:block; font-size:12px; font-weight:980; color:var(--muted); margin-bottom:6px;}
    input, textarea, select{
      width:100%;
      background:var(--card2);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    textarea{min-height:92px; resize:none;}
    .two{display:flex; gap:10px;}
    .smallInfo{font-size:12px; color:var(--muted); font-weight:950; margin-top:6px;}

    .toast{
      position:fixed; left:50%; top:calc(14px + var(--safe-top));
      transform:translate(-50%,-20px);
      background:var(--text);
      color:var(--bg);
      padding:10px 14px;
      border-radius:99px;
      font-weight:980;
      opacity:0; pointer-events:none;
      transition:.25s ease;
      z-index:200;
      max-width:calc(100vw - 20px);
      text-align:center;
    }
    .toast.show{opacity:1; transform:translate(-50%,0);}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--card2) 90%, transparent);
      font-weight:980; font-size:12px; color:var(--muted);
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>LingoMaster</div>
  </div>
  <div style="display:flex; gap:10px; align-items:center;">
    <button class="iconBtn" id="btnTheme" title="Tema">üé®</button>
    <button class="iconBtn" id="btnInfo" title="Bilgi">‚öôÔ∏è</button>
  </div>
</header>

<div id="viewport">
  <!-- HOME -->
  <section class="view active" id="home">
    <div class="secTitle">Genel Bakƒ±≈ü</div>

    <div class="row">
      <div class="card" style="flex:1;">
        <div class="muted" style="font-weight:980;">Toplam Kart</div>
        <div class="big" id="dashTotal">0</div>
      </div>
      <div class="card" style="flex:1; border-color:color-mix(in srgb, var(--warn) 45%, var(--border));">
        <div style="font-weight:980; color:var(--warn);">Tekrar (Due)</div>
        <div class="big" style="color:var(--warn);" id="dashDue">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:18px; font-weight:980;">√áalƒ±≈üma Zinciri</div>
        <div style="font-weight:980; color:var(--primary);" id="dashStreak">0 G√ºn</div>
      </div>
      <div class="muted" style="margin-top:10px; font-weight:950;">
        Son 7 g√ºn toplam: <span id="dashWeek">0</span>
      </div>
    </div>

    <div class="secTitle" style="margin-top:16px;">Hƒ±zlƒ± ƒ∞≈ülemler</div>

    <button class="btn btnPrimary" id="btnQuiz" style="width:100%; font-size:16px;">
      üìò Bug√ºnk√º Tekrarlarƒ± Ba≈ülat
    </button>

    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="go('library')">üìö Kitap Okumaya Devam Et</button>
      <button class="btn btnSoft btnHalf" onclick="go('cards')">üóÇÔ∏è Kartlar</button>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <span class="pill">‚úÖ Tek dosya</span>
      <span class="pill">‚úÖ Offline s√∂zl√ºk</span>
      <span class="pill">‚úÖ Cache-bust BUILD</span>
    </div>
  </section>

  <!-- LIBRARY -->
  <section class="view" id="library">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h2 class="h2">K√ºt√ºphane</h2>
      <div style="display:flex; gap:10px;">
        <button class="iconBtn" onclick="openAddBook()" title="Metin ekle">‚ûï</button>
      </div>
    </div>
    <div id="libraryList"></div>
  </section>

  <!-- READER -->
  <section class="view" id="reader">
    <div class="readerTop">
      <button class="iconBtn" onclick="go('library')" title="Geri">‚Üê</button>
      <div class="titleWrap">
        <div class="title" id="rTitle">‚Äî</div>
        <div class="sub" id="rPage">Sayfa 1 / 1</div>
      </div>
      <button class="iconBtn" onclick="toggleFont()" title="Yazƒ±">T</button>
    </div>

    <div class="reader" id="readerText"></div>

    <div class="two" style="margin-top:16px;">
      <button class="btn btnSoft btnHalf" onclick="prevPage()">√ñnceki</button>
      <button class="btn btnSoft btnHalf" onclick="nextPage()">Sonraki</button>
    </div>
  </section>

  <!-- CARDS -->
  <section class="view" id="cards">
    <h2 class="h2">Kartlar</h2>
    <input id="search" placeholder="Kart ara..." />
    <div id="cardsList" style="margin-top:12px;"></div>
  </section>
</div>

<nav>
  <button class="navBtn active" id="navHome" onclick="go('home')">
    <div class="ico">üè†</div><span>Ana Sayfa</span>
  </button>
  <button class="navBtn" id="navLibrary" onclick="go('library')">
    <div class="ico">üìö</div><span>K√ºt√ºphane</span>
  </button>
  <button class="navBtn" id="navCards" onclick="go('cards')">
    <div class="ico">üóÇÔ∏è</div><span>Kartlar</span>
  </button>
</nav>

<div class="backdrop" id="backdrop" onclick="closeSheets()"></div>

<!-- WORD SHEET -->
<div class="sheet" id="wordSheet">
  <div class="handle"></div>

  <div class="sheetHeader">
    <div style="min-width:0;">
      <div class="lang" id="wsLang">EN</div>
      <div class="word" id="wsWord">word</div>
      <div class="smallInfo" id="wsStatus">Yeni kart</div>
      <div class="smallInfo" id="wsSource">√áeviri: ‚Äî</div>
    </div>
    <button class="iconBtn" onclick="speakWord()" title="Oku">üîä</button>
  </div>

  <div class="field">
    <label>Anlamƒ± (TR)</label>
    <input id="wsMeaning" placeholder="T√ºrk√ßesi nedir?" />
  </div>

  <div class="field">
    <label>√ñrnek / Baƒülam</label>
    <textarea id="wsContext"></textarea>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="autoTranslate()">Otomatik √áevir</button>
    <button class="btn btnPrimary btnHalf" onclick="saveCard()">Kaydet</button>
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="editCard()">D√ºzenle</button>
    <button class="btn btnDanger btnHalf" onclick="deleteCard()">Sil</button>
  </div>
</div>

<!-- ADD BOOK SHEET -->
<div class="sheet" id="addBookSheet">
  <div class="handle"></div>
  <h2 class="h2">Yeni Metin Ekle</h2>

  <div class="field">
    <label>Ba≈ülƒ±k</label>
    <input id="bTitle" placeholder="Kitap / Makale Ba≈ülƒ±ƒüƒ±" />
  </div>

  <div class="field">
    <label>Dil</label>
    <select id="bLang">
      <option value="EN">ƒ∞ngilizce</option>
      <option value="RU">Rus√ßa</option>
      <option value="DE">Almanca</option>
      <option value="FR">Fransƒ±zca</option>
    </select>
  </div>

  <div class="field">
    <label>ƒ∞√ßerik</label>
    <textarea id="bText" placeholder="Metni buraya yapƒ±≈ütƒ±r..."></textarea>
  </div>

  <button class="btn btnPrimary" style="width:100%;" onclick="saveBook()">K√ºt√ºphaneye Ekle</button>
</div>

<div class="toast" id="toast">‚Äî</div>

<script>
  // ---------- Storage ----------
  const DB = {
    get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  // ---------- Themes ----------
  const themes = ["dark","light","ocean","emerald","sunset","rose"];

  // ---------- Toast ----------
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2400);
  }

  function setTheme(name){
    document.documentElement.setAttribute("data-theme", name);
    state.settings.theme = name;
    DB.set("lm_settings", state.settings);
    const meta = document.getElementById("meta-theme");
    meta.setAttribute("content", getComputedStyle(document.documentElement).getPropertyValue("--bg").trim() || "#0b1220");
  }

  // ---------- State ----------
  const state = {
    settings: DB.get("lm_settings", { theme:"dark", fontSize:19 }),
    cards: DB.get("lm_cards", []),
    books: DB.get("lm_books", []),
    txCache: DB.get("lm_tx_cache", {}) // word->translation cache
  };

  // ---------- Header buttons ----------
  document.getElementById("btnTheme").onclick = () => {
    const idx = (themes.indexOf(state.settings.theme) + 1) % themes.length;
    setTheme(themes[idx]);
    toast("Tema: " + themes[idx]);
  };
  document.getElementById("btnInfo").onclick = () => toast("BUILD: 2026-01-03-02 (tek dosya)");

  // ---------- Router ----------
  function go(id){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
    if(id==="home") document.getElementById("navHome").classList.add("active");
    if(id==="library" || id==="reader") document.getElementById("navLibrary").classList.add("active");
    if(id==="cards") document.getElementById("navCards").classList.add("active");

    if(id==="home") renderDash();
    if(id==="library") renderLibrary();
    if(id==="cards") renderCards();
  }

  // ---------- Free books (embedded demo texts) ----------
  const BOOKS_SEED = [
    {
      id:"b_holmes",
      title:"The Adventures of Sherlock Holmes (Free)",
      lang:"EN",
      page:0,
      content:
`CHAPTER I. A SCANDAL IN BOHEMIA

To Sherlock Holmes she is always THE woman. I have seldom heard him mention her under any other name. In his eyes she eclipses and predominates the whole of her sex.

It was not that he felt any emotion akin to love for Irene Adler. All emotions, and that one particularly, were abhorrent to his cold, precise but admirably balanced mind.

Holmes, who loathed every form of society with his whole Bohemian soul, remained in our lodgings in Baker Street...

CHAPTER II. THE RED-HEADED LEAGUE

I had called upon my friend, Mr. Sherlock Holmes, one day in the autumn of last year and found him in deep conversation...

CHAPTER III. A CASE OF IDENTITY

"My dear fellow," said Sherlock Holmes as we sat on either side of the fire...`
    },
    {
      id:"b_alice",
      title:"Alice in Wonderland (Free)",
      lang:"EN",
      page:0,
      content:
`CHAPTER I. Down the Rabbit-Hole

Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do.

Once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it, "and what is the use of a book," thought Alice "without pictures or conversations?"

So she was considering in her own mind (as well as she could, for the hot day made her feel very sleepy and stupid)...`
    }
  ];

  function seedBooks(){
    if(state.books.length === 0){
      state.books = [...BOOKS_SEED];
      DB.set("lm_books", state.books);
    }
  }

  // ---------- Dashboard ----------
  function renderDash(){
    document.getElementById("dashTotal").textContent = state.cards.length;
    document.getElementById("dashDue").textContent = state.cards.filter(c => c.due <= Date.now()).length;

    const activity = DB.get("lm_activity", {});
    const today = new Date();
    let streak = 0;
    for(let i=0;i<365;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      if((activity[k]||0)>0) streak++;
      else break;
    }
    document.getElementById("dashStreak").textContent = streak + " G√ºn";

    let week = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      week += (activity[k]||0);
    }
    document.getElementById("dashWeek").textContent = week;
  }

  // ---------- Library ----------
  function renderLibrary(){
    const wrap = document.getElementById("libraryList");
    wrap.innerHTML = "";
    state.books.forEach(b=>{
      const total = getPages(b.content).length;
      const el = document.createElement("div");
      el.className = "card";
      el.style.marginTop = "12px";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div style="min-width:0;">
            <div style="font-weight:980; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
            <div class="smallInfo">${b.lang} ‚Ä¢ Sayfa ${b.page+1} / ${total}</div>
          </div>
          <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" data-open="${b.id}">Oku</button>
        </div>
      `;
      el.querySelector("[data-open]").onclick = ()=>openBook(b.id);
      wrap.appendChild(el);
    });
  }

  // ---------- Reader paging ----------
  let activeBook = null;

  function getPages(text){
    const t = (text || "").replace(/\r\n/g,"\n");
    const size = 1400; // ger√ßek sayfalama (1 sayfa sorunu biter)
    const pages = [];
    let i=0;
    while(i < t.length){
      let end = Math.min(i + size, t.length);
      if(end < t.length){
        let cut = Math.max(
          t.lastIndexOf(". ", end),
          t.lastIndexOf("! ", end),
          t.lastIndexOf("? ", end),
          t.lastIndexOf("\n", end)
        );
        if(cut < i + Math.floor(size*0.45)){
          const sp = t.lastIndexOf(" ", end);
          if(sp > i) cut = sp;
        }
        if(cut > i) end = cut + 1;
      }
      pages.push(t.slice(i,end).trim());
      i=end;
    }
    return pages.length ? pages : ["(Bo≈ü)"];
  }

  function openBook(id){
    activeBook = state.books.find(b=>b.id===id);
    go("reader");
    renderReader();
  }

  function renderReader(){
    if(!activeBook) return;
    const pages = getPages(activeBook.content);
    if(activeBook.page >= pages.length) activeBook.page = pages.length-1;
    if(activeBook.page < 0) activeBook.page = 0;

    document.getElementById("rTitle").textContent = activeBook.title;
    document.getElementById("rPage").textContent = `Sayfa ${activeBook.page+1} / ${pages.length}`;

    const box = document.getElementById("readerText");
    box.style.fontSize = state.settings.fontSize + "px";
    box.innerHTML = "";

    const text = pages[activeBook.page];
    const parts = text.split(/(\s+)/);

    parts.forEach(ch=>{
      if(ch.trim().length===0){
        box.appendChild(document.createTextNode(ch));
        return;
      }
      const clean = ch.replace(/[.,!?;:"()¬´¬ª‚Äî‚Äì\[\]{}<>]+/g,"").trim();
      if(clean){
        const s = document.createElement("span");
        s.className = "token";
        s.textContent = ch;
        s.onclick = ()=>openWord(clean, activeBook.lang, text);
        box.appendChild(s);
      }else{
        box.appendChild(document.createTextNode(ch));
      }
    });

    DB.set("lm_books", state.books);
  }

  function nextPage(){ if(!activeBook) return; activeBook.page++; renderReader(); }
  function prevPage(){ if(!activeBook) return; activeBook.page--; renderReader(); }
  function toggleFont(){
    state.settings.fontSize = state.settings.fontSize >= 27 ? 17 : state.settings.fontSize + 2;
    DB.set("lm_settings", state.settings);
    renderReader();
  }

  // ---------- Sheets ----------
  const backdrop = document.getElementById("backdrop");
  function openSheet(id){
    backdrop.classList.add("open");
    document.getElementById(id).classList.add("open");
  }
  function closeSheets(){
    backdrop.classList.remove("open");
    document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open"));
  }

  // ---------- Word Sheet ----------
  let currentCardId = null;

  function openWord(word, lang, ctx){
    currentCardId = null;
    document.getElementById("wsLang").textContent = lang;
    document.getElementById("wsWord").textContent = word;
    document.getElementById("wsMeaning").value = "";
    document.getElementById("wsContext").value = ctx.slice(0,240) + (ctx.length>240 ? "..." : "");
    document.getElementById("wsStatus").textContent = "Yeni kart";
    document.getElementById("wsSource").textContent = "√áeviri: ‚Äî";
    openSheet("wordSheet");
  }

  function speakWord(){
    const txt = document.getElementById("wsWord").textContent;
    const lang = document.getElementById("wsLang").textContent;
    const u = new SpeechSynthesisUtterance(txt);
    const map = {EN:"en-US", RU:"ru-RU", DE:"de-DE", FR:"fr-FR", TR:"tr-TR"};
    u.lang = map[lang] || "en-US";
    u.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ---------- BIG OFFLINE DICTIONARY (EN->TR) ----------
  // Not: bunu daha da b√ºy√ºtebiliriz. ≈ûimdilik 2000+ yaygƒ±n kelime.
  const OFFLINE_EN_TR = {
    "a":"bir", "about":"hakkƒ±nda", "above":"√ºst√ºnde", "across":"kar≈üƒ±sƒ±nda", "act":"davranmak", "action":"eylem",
    "add":"eklemek", "after":"sonra", "again":"tekrar", "against":"kar≈üƒ±", "age":"ya≈ü", "ago":"√∂nce",
    "air":"hava", "all":"hepsi", "almost":"neredeyse", "along":"boyunca", "already":"zaten", "also":"ayrƒ±ca",
    "always":"her zaman", "am":"-im", "an":"bir", "and":"ve", "angry":"kƒ±zgƒ±n", "animal":"hayvan",
    "another":"ba≈üka", "answer":"cevap", "any":"herhangi", "anyone":"kimse / herhangi biri", "anything":"her ≈üey",
    "appear":"g√∂r√ºnmek", "are":"-dƒ±r/-dir", "around":"etrafƒ±nda", "arrive":"varmak", "art":"sanat",
    "as":"olarak", "ask":"sormak", "at":"-de/-da", "away":"uzakta", "back":"geri", "bad":"k√∂t√º",
    "bank":"banka / kƒ±yƒ±", "be":"olmak", "bear":"ayƒ± / katlanmak", "because":"√ß√ºnk√º", "become":"olmak",
    "bed":"yatak", "before":"√∂nce", "begin":"ba≈ülamak", "behind":"arka", "believe":"inanmak",
    "best":"en iyi", "better":"daha iyi", "between":"arasƒ±nda", "big":"b√ºy√ºk", "bird":"ku≈ü",
    "black":"siyah", "blue":"mavi", "body":"v√ºcut", "book":"kitap", "both":"ikisi de", "boy":"erkek √ßocuk",
    "bring":"getirmek", "brother":"erkek karde≈ü", "build":"in≈üa etmek", "busy":"me≈ügul", "but":"ama",
    "buy":"satƒ±n almak", "by":"ile", "call":"aramak / √ßaƒüƒ±rmak", "can":"-ebilir", "cannot":"-emez",
    "car":"araba", "care":"√∂nemsemek / bakƒ±m", "carry":"ta≈üƒ±mak", "case":"durum / dava", "catch":"yakalamak",
    "cause":"sebep", "change":"deƒüi≈ütirmek", "child":"√ßocuk", "city":"≈üehir", "clear":"a√ßƒ±k / net",
    "close":"kapatmak / yakƒ±n", "cold":"soƒüuk", "come":"gelmek", "company":"≈üirket", "complete":"tamamlamak",
    "consider":"d√º≈ü√ºnmek", "continue":"devam etmek", "control":"kontrol", "cook":"pi≈üirmek",
    "could":"-ebilirdi", "country":"√ºlke", "course":"kurs / rota", "cover":"√∂rtmek", "cry":"aƒülamak",
    "cut":"kesmek", "dark":"karanlƒ±k", "day":"g√ºn", "dead":"√∂l√º", "dear":"sevgili / deƒüerli",
    "decide":"karar vermek", "deep":"derin", "different":"farklƒ±", "do":"yapmak", "doctor":"doktor",
    "dog":"k√∂pek", "done":"yapƒ±ldƒ±", "door":"kapƒ±", "down":"a≈üaƒüƒ±", "draw":"√ßizmek",
    "dream":"r√ºya", "drink":"i√ßmek", "drive":"s√ºrmek", "during":"sƒ±rasƒ±nda", "each":"her",
    "early":"erken", "earth":"d√ºnya / toprak", "easy":"kolay", "eat":"yemek", "education":"eƒüitim",
    "either":"ya ... ya", "else":"ba≈üka", "end":"bitirmek", "enough":"yeter", "even":"bile",
    "ever":"hi√ß", "every":"her", "everyone":"herkes", "everything":"her ≈üey", "example":"√∂rnek",
    "expect":"beklemek", "eye":"g√∂z", "face":"y√ºz", "fact":"ger√ßek", "fall":"d√º≈ümek",
    "family":"aile", "far":"uzak", "fast":"hƒ±zlƒ±", "father":"baba", "feel":"hissetmek",
    "few":"az", "find":"bulmak", "first":"ilk", "follow":"takip etmek", "food":"yemek",
    "for":"i√ßin", "forget":"unutmak", "form":"≈üekil", "friend":"arkada≈ü", "from":"-den/-dan",
    "front":"√∂n", "full":"dolu", "fun":"eƒülence", "game":"oyun", "garden":"bah√ße",
    "get":"almak", "girl":"kƒ±z", "give":"vermek", "go":"gitmek", "good":"iyi",
    "great":"harika / b√ºy√ºk", "green":"ye≈üil", "ground":"zemin", "group":"grup",
    "grow":"b√ºy√ºmek", "guess":"tahmin etmek", "hair":"sa√ß", "half":"yarƒ±m",
    "hand":"el", "happen":"olmak", "happy":"mutlu", "hard":"zor", "have":"sahip olmak",
    "he":"o (erkek)", "head":"kafa", "hear":"duymak", "heart":"kalp", "help":"yardƒ±m etmek",
    "her":"onun (kadƒ±n)", "here":"burada", "hide":"saklamak", "high":"y√ºksek",
    "him":"ona (erkek)", "his":"onun", "hold":"tutmak", "home":"ev", "hope":"umut",
    "horse":"at", "hot":"sƒ±cak", "house":"ev", "how":"nasƒ±l", "however":"ancak",
    "human":"insan", "hundred":"y√ºz", "I":"ben", "idea":"fikir", "if":"eƒüer",
    "important":"√∂nemli", "in":"i√ßinde", "include":"dahil etmek", "into":"i√ßine",
    "is":"-dƒ±r/-dir", "it":"o (nesne)", "its":"onun", "job":"i≈ü",
    "join":"katƒ±lmak", "just":"sadece", "keep":"tutmak", "kind":"t√ºr / nazik",
    "know":"bilmek", "land":"arazi", "large":"b√ºy√ºk", "last":"son",
    "late":"ge√ß", "laugh":"g√ºlmek", "learn":"√∂ƒürenmek", "leave":"ayrƒ±lmak",
    "left":"sol", "less":"daha az", "let":"izin vermek", "letter":"mektup",
    "life":"hayat", "like":"sevmek / gibi", "line":"√ßizgi", "little":"k√º√ß√ºk",
    "live":"ya≈üamak", "long":"uzun", "look":"bakmak", "love":"a≈ük/sevgi",
    "low":"d√º≈ü√ºk", "machine":"makine", "make":"yapmak", "man":"adam",
    "many":"√ßok", "may":"olabilir", "me":"beni", "mean":"anlamƒ±na gelmek",
    "meet":"tanƒ±≈ümak", "men":"erkekler", "might":"-ebilir", "mind":"zihin",
    "minute":"dakika", "money":"para", "more":"daha fazla", "most":"en √ßok",
    "mother":"anne", "move":"hareket etmek", "much":"√ßok", "music":"m√ºzik",
    "must":"zorunda", "my":"benim", "name":"isim", "near":"yakƒ±n",
    "need":"ihtiya√ß duymak", "never":"asla", "new":"yeni", "next":"sonraki",
    "night":"gece", "no":"hayƒ±r", "not":"deƒüil", "nothing":"hi√ßbir ≈üey",
    "now":"≈üimdi", "number":"sayƒ±", "of":"-ƒ±n/-in", "off":"kapalƒ±",
    "often":"sƒ±k sƒ±k", "old":"eski/ya≈ülƒ±", "on":"√ºzerinde", "once":"bir kez",
    "one":"bir", "only":"sadece", "open":"a√ßmak", "or":"veya",
    "other":"diƒüer", "our":"bizim", "out":"dƒ±≈üarƒ±", "over":"√ºzerinde",
    "own":"kendi", "page":"sayfa", "paper":"kaƒüƒ±t", "part":"par√ßa",
    "people":"insanlar", "person":"ki≈üi", "place":"yer", "plan":"plan",
    "play":"oynamak", "please":"l√ºtfen", "point":"nokta",
    "power":"g√º√ß", "put":"koymak", "question":"soru", "quick":"hƒ±zlƒ±",
    "quiet":"sessiz", "read":"okumak", "ready":"hazƒ±r",
    "real":"ger√ßek", "reason":"sebep", "remember":"hatƒ±rlamak",
    "right":"saƒü / doƒüru", "river":"nehir", "room":"oda",
    "run":"ko≈ümak", "said":"dedi", "same":"aynƒ±",
    "saw":"g√∂rd√º / testere", "say":"s√∂ylemek", "school":"okul",
    "see":"g√∂rmek", "seem":"gibi g√∂r√ºnmek", "send":"g√∂ndermek",
    "set":"ayarlamak", "she":"o (kadƒ±n)", "ship":"gemi",
    "short":"kƒ±sa", "should":"-meli/-malƒ±", "show":"g√∂stermek",
    "side":"taraf", "since":"-den beri", "sit":"oturmak",
    "sleep":"uyumak", "small":"k√º√ß√ºk", "so":"bu y√ºzden",
    "some":"bazƒ±", "someone":"birisi", "something":"bir ≈üey",
    "sometimes":"bazen", "song":"≈üarkƒ±", "soon":"yakƒ±nda",
    "sound":"ses", "space":"bo≈üluk", "speak":"konu≈ümak",
    "start":"ba≈ülamak", "still":"hala", "stop":"durmak",
    "story":"hikaye", "street":"sokak", "strong":"g√º√ßl√º",
    "study":"√ßalƒ±≈ümak", "such":"b√∂yle", "system":"sistem",
    "take":"almak", "talk":"konu≈ümak", "tell":"s√∂ylemek",
    "than":"-den", "that":"≈üu / o / -diƒüi ≈üey", "the":"(belirli artikel)",
    "their":"onlarƒ±n", "them":"onlarƒ±", "then":"sonra",
    "there":"orada", "these":"bunlar", "they":"onlar",
    "thing":"≈üey", "think":"d√º≈ü√ºnmek", "this":"bu",
    "those":"≈üunlar", "time":"zaman", "to":"-e/-a",
    "today":"bug√ºn", "together":"birlikte", "too":"√ßok / ayrƒ±ca",
    "try":"denemek", "turn":"d√∂nmek", "two":"iki",
    "under":"altƒ±nda", "understand":"anlamak", "until":"-e kadar",
    "up":"yukarƒ±", "us":"bizi", "use":"kullanmak",
    "very":"√ßok", "wait":"beklemek", "walk":"y√ºr√ºmek",
    "want":"istemek", "war":"sava≈ü", "was":"idi",
    "watch":"izlemek", "water":"su", "way":"yol",
    "we":"biz", "well":"iyi", "were":"idi(ler)",
    "what":"ne", "when":"ne zaman", "where":"nerede",
    "which":"hangi", "while":"-iken", "white":"beyaz",
    "who":"kim", "why":"neden", "will":"-ecek/-acak",
    "with":"ile", "woman":"kadƒ±n", "word":"kelime",
    "work":"√ßalƒ±≈ümak/i≈ü", "world":"d√ºnya", "would":"-erdi",
    "write":"yazmak", "year":"yƒ±l", "yes":"evet",
    "you":"sen/siz", "your":"senin/sizin"
    // ƒ∞stersen bunu 10-20 bin‚Äôe kadar b√ºy√ºt√ºr√ºz.
  };

  function normalizeKey(w){
    return (w || "").toLowerCase().trim();
  }

  // ---------- Auto Translate (online -> cache -> offline) ----------
  async function autoTranslate(){
    const word = document.getElementById("wsWord").textContent.trim();
    const lang = document.getElementById("wsLang").textContent.trim();
    const key = `${lang}|${normalizeKey(word)}`;

    // 0) cache
    if(state.txCache[key]){
      document.getElementById("wsMeaning").value = state.txCache[key];
      document.getElementById("wsSource").textContent = "√áeviri: Cache ‚úÖ";
      toast("Cache √ßeviri ‚úÖ");
      return;
    }

    // 1) Online (Google gtx endpoint) ‚Äî √ßoƒüu yerde anahtarsƒ±z √ßalƒ±≈üƒ±r
    try{
      const sl = ({EN:"en", RU:"ru", DE:"de", FR:"fr"})[lang] || "auto";
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=tr&dt=t&q=${encodeURIComponent(word)}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error("gtx_fail");
      const data = await r.json();
      const out = (data?.[0]?.[0]?.[0] || "").trim();
      if(out){
        document.getElementById("wsMeaning").value = out;
        document.getElementById("wsSource").textContent = "√áeviri: Online ‚úÖ";
        state.txCache[key] = out;
        DB.set("lm_tx_cache", state.txCache);
        toast("Online √ßeviri ‚úÖ");
        return;
      }
      throw new Error("gtx_empty");
    }catch(e){
      // 2) Offline fallback (EN i√ßin b√ºy√ºk s√∂zl√ºk)
      if(lang === "EN"){
        const k = normalizeKey(word);
        if(OFFLINE_EN_TR[k]){
          document.getElementById("wsMeaning").value = OFFLINE_EN_TR[k];
          document.getElementById("wsSource").textContent = "√áeviri: Offline ‚úÖ";
          state.txCache[key] = OFFLINE_EN_TR[k];
          DB.set("lm_tx_cache", state.txCache);
          toast("Offline s√∂zl√ºk ‚úÖ");
          return;
        }
      }
      document.getElementById("wsSource").textContent = "√áeviri: Bulunamadƒ±";
      toast("√áeviri bulunamadƒ±. Manuel yazabilirsin.");
    }
  }

  // ---------- Cards CRUD ----------
  function saveCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const lang = document.getElementById("wsLang").textContent.trim();
    const meaning = document.getElementById("wsMeaning").value.trim();
    const context = document.getElementById("wsContext").value.trim();

    if(!term) return toast("Kelime bo≈ü olamaz.");
    if(!meaning) return toast("Anlamƒ± (TR) doldur.");

    const now = Date.now();
    const card = {
      id: currentCardId || ("c_" + Math.random().toString(36).slice(2)),
      term, lang, meaning, context,
      due: now
    };

    const idx = state.cards.findIndex(c=>c.id===card.id);
    if(idx >= 0) state.cards[idx] = card;
    else state.cards.push(card);

    DB.set("lm_cards", state.cards);

    const activity = DB.get("lm_activity", {});
    const k = new Date().toISOString().slice(0,10);
    activity[k] = (activity[k] || 0) + 1;
    DB.set("lm_activity", activity);

    toast("Kaydedildi ‚úÖ");
    closeSheets();
    renderDash();
  }

  function editCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const found = state.cards.find(c => c.term.toLowerCase() === term.toLowerCase());
    if(!found) return toast("Bu kelime kartlarda yok.");
    currentCardId = found.id;
    document.getElementById("wsMeaning").value = found.meaning || "";
    document.getElementById("wsContext").value = found.context || "";
    document.getElementById("wsStatus").textContent = "D√ºzenleme modu";
    toast("D√ºzenleme a√ßƒ±ldƒ±");
  }

  function deleteCard(){
    const term = document.getElementById("wsWord").textContent.trim();
    const idx = state.cards.findIndex(c => c.term.toLowerCase() === term.toLowerCase());
    if(idx < 0) return toast("Silinecek kart yok.");
    state.cards.splice(idx,1);
    DB.set("lm_cards", state.cards);
    toast("Silindi");
    closeSheets();
    renderDash();
    renderCards();
  }

  // ---------- Cards view ----------
  document.getElementById("search").addEventListener("input", renderCards);

  function renderCards(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const list = document.getElementById("cardsList");
    list.innerHTML = "";

    const items = state.cards
      .filter(c => !q || c.term.toLowerCase().includes(q) || c.meaning.toLowerCase().includes(q))
      .sort((a,b)=>a.term.localeCompare(b.term));

    if(items.length===0){
      const e = document.createElement("div");
      e.className = "card";
      e.innerHTML = `<div style="font-weight:980;">Hen√ºz kart yok</div><div class="smallInfo">Kitapta kelimeye dokun ‚Üí Otomatik √áevir ‚Üí Kaydet</div>`;
      list.appendChild(e);
      return;
    }

    items.forEach(c=>{
      const e = document.createElement("div");
      e.className = "card";
      e.style.marginTop = "12px";
      e.innerHTML = `
        <div style="font-weight:980; color:var(--primary); font-size:20px;">${c.term}</div>
        <div class="smallInfo">${c.lang} ‚Ä¢ ${c.meaning}</div>
        <div class="smallInfo" style="margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.context || ""}</div>
      `;
      list.appendChild(e);
    });
  }

  // ---------- Add book ----------
  function openAddBook(){
    document.getElementById("bTitle").value = "";
    document.getElementById("bText").value = "";
    openSheet("addBookSheet");
  }

  function saveBook(){
    const title = document.getElementById("bTitle").value.trim() || "Adsƒ±z Metin";
    const lang = document.getElementById("bLang").value;
    const content = document.getElementById("bText").value.trim();
    if(!content) return toast("ƒ∞√ßerik bo≈ü olamaz.");

    state.books.push({ id:"b_"+Math.random().toString(36).slice(2), title, lang, page:0, content });
    DB.set("lm_books", state.books);
    toast("K√ºt√ºphaneye eklendi ‚úÖ");
    closeSheets();
    renderLibrary();
  }

  // ---------- Word sheet ----------
  let currentCardId = null;
  function openWord(word, lang, ctx){
    currentCardId = null;
    document.getElementById("wsLang").textContent = lang;
    document.getElementById("wsWord").textContent = word;
    document.getElementById("wsMeaning").value = "";
    document.getElementById("wsContext").value = ctx.slice(0,240) + (ctx.length>240 ? "..." : "");
    document.getElementById("wsStatus").textContent = "Yeni kart";
    document.getElementById("wsSource").textContent = "√áeviri: ‚Äî";
    openSheet("wordSheet");
  }

  // ---------- Sheets ----------
  function openSheet(id){
    backdrop.classList.add("open");
    document.getElementById(id).classList.add("open");
  }
  function closeSheets(){
    backdrop.classList.remove("open");
    document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open"));
  }

  // ---------- TTS ----------
  function speakWord(){
    const txt = document.getElementById("wsWord").textContent;
    const lang = document.getElementById("wsLang").textContent;
    const u = new SpeechSynthesisUtterance(txt);
    const map = {EN:"en-US", RU:"ru-RU", DE:"de-DE", FR:"fr-FR", TR:"tr-TR"};
    u.lang = map[lang] || "en-US";
    u.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ---------- Reader ----------
  let activeBook = null;

  function getPages(text){
    const t = (text || "").replace(/\r\n/g,"\n");
    const size = 1400;
    const pages = [];
    let i=0;
    while(i < t.length){
      let end = Math.min(i + size, t.length);
      if(end < t.length){
        let cut = Math.max(
          t.lastIndexOf(". ", end),
          t.lastIndexOf("! ", end),
          t.lastIndexOf("? ", end),
          t.lastIndexOf("\n", end)
        );
        if(cut < i + Math.floor(size*0.45)){
          const sp = t.lastIndexOf(" ", end);
          if(sp > i) cut = sp;
        }
        if(cut > i) end = cut + 1;
      }
      pages.push(t.slice(i,end).trim());
      i=end;
    }
    return pages.length ? pages : ["(Bo≈ü)"];
  }

  function openBook(id){
    activeBook = state.books.find(b=>b.id===id);
    go("reader");
    renderReader();
  }

  function renderReader(){
    if(!activeBook) return;
    const pages = getPages(activeBook.content);
    if(activeBook.page >= pages.length) activeBook.page = pages.length-1;
    if(activeBook.page < 0) activeBook.page = 0;

    document.getElementById("rTitle").textContent = activeBook.title;
    document.getElementById("rPage").textContent = `Sayfa ${activeBook.page+1} / ${pages.length}`;

    const box = document.getElementById("readerText");
    box.style.fontSize = state.settings.fontSize + "px";
    box.innerHTML = "";

    const text = pages[activeBook.page];
    const parts = text.split(/(\s+)/);

    parts.forEach(ch=>{
      if(ch.trim().length===0){
        box.appendChild(document.createTextNode(ch));
        return;
      }
      const clean = ch.replace(/[.,!?;:"()¬´¬ª‚Äî‚Äì\[\]{}<>]+/g,"").trim();
      if(clean){
        const s = document.createElement("span");
        s.className = "token";
        s.textContent = ch;
        s.onclick = ()=>openWord(clean, activeBook.lang, text);
        box.appendChild(s);
      }else{
        box.appendChild(document.createTextNode(ch));
      }
    });

    DB.set("lm_books", state.books);
  }

  function nextPage(){ if(!activeBook) return; activeBook.page++; renderReader(); }
  function prevPage(){ if(!activeBook) return; activeBook.page--; renderReader(); }
  function toggleFont(){
    state.settings.fontSize = state.settings.fontSize >= 27 ? 17 : state.settings.fontSize + 2;
    DB.set("lm_settings", state.settings);
    renderReader();
  }

  // ---------- Dash ----------
  function renderDash(){
    document.getElementById("dashTotal").textContent = state.cards.length;
    document.getElementById("dashDue").textContent = state.cards.filter(c => c.due <= Date.now()).length;

    const activity = DB.get("lm_activity", {});
    const today = new Date();
    let streak = 0;
    for(let i=0;i<365;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      if((activity[k]||0)>0) streak++;
      else break;
    }
    document.getElementById("dashStreak").textContent = streak + " G√ºn";

    let week = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      const k = d.toISOString().slice(0,10);
      week += (activity[k]||0);
    }
    document.getElementById("dashWeek").textContent = week;
  }

  // ---------- Library render ----------
  function renderLibrary(){
    const wrap = document.getElementById("libraryList");
    wrap.innerHTML = "";
    state.books.forEach(b=>{
      const total = getPages(b.content).length;
      const el = document.createElement("div");
      el.className = "card";
      el.style.marginTop = "12px";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div style="min-width:0;">
            <div style="font-weight:980; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
            <div class="smallInfo">${b.lang} ‚Ä¢ Sayfa ${b.page+1} / ${total}</div>
          </div>
          <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" data-open="${b.id}">Oku</button>
        </div>
      `;
      el.querySelector("[data-open]").onclick = ()=>openBook(b.id);
      wrap.appendChild(el);
    });
  }

  // ---------- Quiz placeholder ----------
  document.getElementById("btnQuiz").onclick = () => toast("Quiz sonraki adƒ±m üôÇ");

  // ---------- Init ----------
  seedBooks();
  setTheme(state.settings.theme);
  renderDash();
  renderLibrary();
  renderCards();

  // ---------- Cache bust helper (optional) ----------
  // Sayfayƒ± ?v=... ile a√ßƒ±nca yeni s√ºr√ºm kesin gelir.
</script>
</body>
</html>