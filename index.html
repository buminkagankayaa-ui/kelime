<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Vocabify</title>
  <meta name="theme-color" content="#0b1220" id="meta-theme">
  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --header-h: 60px;
      --nav-h: 78px;
      --radius: 18px;
      --bg:#0b1220;
      --card:#111b2d;
      --card2:#0f172a;
      --border:#25324a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#6366f1;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --card2:#f1f5f9; --border:#cbd5e1;
      --text:#0f172a; --muted:#64748b; --primary:#4f46e5;
      --danger:#dc2626; --warn:#d97706; --ok:#059669;
    }
    [data-theme="ocean"]{ --bg:#06131f; --card:#0b2236; --card2:#0a1b2a; --border:#245070; --text:#e6f2ff; --muted:#9bb7d3; --primary:#38bdf8;}
    [data-theme="emerald"]{ --bg:#071a14; --card:#0b2a21; --card2:#082018; --border:#1f6b52; --text:#ecfdf5; --muted:#9fe3c7; --primary:#10b981;}
    [data-theme="sunset"]{ --bg:#1b1020; --card:#2a1731; --card2:#1f1225; --border:#6b2a59; --text:#fff7ed; --muted:#fbcfe8; --primary:#fb7185;}
    [data-theme="rose"]{ --bg:#120a10; --card:#1f0f1b; --card2:#160b13; --border:#7f1d1d; --text:#fff1f2; --muted:#fda4af; --primary:#f43f5e;}
    *{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
  touch-action: manipulation; /* Ã‡ift tÄ±klama zoom'unu engeller */
}
    /* SAYFAYI EKRANA SABÄ°TLEME */
html, body {
  margin: 0; padding: 0;
  height: 100%; width: 100%;
  overflow: hidden; /* SayfanÄ±n komple kaymasÄ±nÄ± engeller */
  position: fixed; /* Ekrana Ã§iviler (iOS zÄ±plamasÄ±nÄ± Ã¶nler) */
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Inter", Roboto, system-ui, sans-serif;
}
   header {
  position: fixed; /* Ekrana yapÄ±ÅŸtÄ±rÄ±r */
  top: 0; left: 0; right: 0; /* SaÄŸa sola yaslar */
  z-index: 100; /* Her ÅŸeyin Ã¼stÃ¼nde dursun */
  height: calc(var(--header-h) + var(--safe-top));
  padding-top: var(--safe-top);
  display: flex; align-items: center; justify-content: space-between;
  padding-left: 16px; padding-right: 16px;
  background: color-mix(in srgb, var(--bg) 78%, transparent);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
}
    .brand{display:flex;align-items:center;gap:10px;font-weight:950;}
    .logo{width:18px;height:18px;border:2px solid var(--primary);border-radius:6px;transform:rotate(15deg);}
    .iconBtn{
      width:44px;height:44px;border-radius:14px;background:transparent;border:1px solid var(--border);
      color:var(--muted);display:grid;place-items:center;cursor:pointer;user-select:none;
    }
    .iconBtn:active{transform:scale(.98);opacity:.9;}
    /* SADECE ORTANIN KAYMASINI SAÄLAR */
#viewport {
  position: absolute;
  top: calc(var(--header-h) + var(--safe-top));
  bottom: calc(var(--nav-h) + var(--safe-bottom));
  left: 0; right: 0;
  overflow-y: auto !important; /* KaydÄ±rmayÄ± zorla */
  -webkit-overflow-scrolling: touch;
  z-index: 5; /* SayÄ±yÄ± biraz artÄ±rdÄ±k ki altta kalmasÄ±n */
  pointer-events: auto !important; /* TÄ±klamayÄ± zorla */
}
/* GÃœNCELLENMÄ°Å GÃ–RÃœNÃœM AYARLARI */
.view {
  width: 100%;
  min-height: 100%; 
  padding: 18px; 
  display: none; /* Pasifken gizle */
}

.view.active {
  display: block; /* Aktifken gÃ¶ster */
  /* pointer-events satÄ±rÄ±nÄ± sildik, varsayÄ±lan (auto) olsun */
}
    .view.active{opacity:1; pointer-events:auto; transform:none;}
    .row{display:flex;gap:12px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
    .muted{color:var(--muted);}
    .big{font-size:34px;font-weight:980;}
    .h2{font-size:20px;font-weight:980;margin:0 0 12px 0;}
    .secTitle{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:950;margin:4px 0 10px;}
    .btn{
      border:0;cursor:pointer;border-radius:16px;padding:14px 16px;font-weight:980;
      display:flex;align-items:center;justify-content:center;gap:10px;user-select:none;
    }
    .btn:active{transform:scale(.985);opacity:.92;}
    .btnPrimary{background:var(--primary);color:white;}
    .btnSoft{background:var(--card2);color:var(--text);border:1px solid var(--border);}
    .btnDanger{background:var(--danger);color:white;}
    .btnOk{background:var(--ok);color:white;}
    .btnHalf{flex:1;}
    nav{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      height:calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom:var(--safe-bottom);
      background:var(--card2);
      border-top:1px solid var(--border);
      display:flex;
    }
    .navBtn{
      flex:1;background:transparent;border:0;color:var(--muted);
      cursor:pointer;user-select:none;
      display:grid;grid-template-rows:36px 18px;
      align-items:center;justify-items:center;
      padding:6px 0;line-height:1;min-width:0;
    }
    .navBtn .ico{width:46px;height:36px;display:grid;place-items:center;font-size:20px;line-height:1;}
    .navBtn span{font-size:11.5px;font-weight:980;line-height:1;transform:translateY(-1px);white-space:nowrap;}
    .navBtn.active{color:var(--primary);}
    .navBtn.active .ico{background:color-mix(in srgb, var(--primary) 15%, transparent);border-radius:14px;}
    .backdrop {
  position: fixed; inset: 0; z-index: 40;
  background: rgba(0,0,0,.55);
  opacity: 0;
  pointer-events: none; /* <--- Ä°ÅTE BU EKSÄ°KTÄ°! KapalÄ±yken tÄ±klamayÄ± engelleme */
  transition: .2s ease;
}
.backdrop.open {
  opacity: 1;
  pointer-events: auto; /* AÃ§Ä±kken tÄ±klamayÄ± yakala */
}
   /* DÃœZELTÄ°LMÄ°Å SHEET SINIFI */
.sheet {
  position: fixed; left: 0; right: 0; bottom: 0; 
  z-index: 150; /* Header'Ä±n Ã¼stÃ¼ne Ã§Ä±ksÄ±n */
  background: var(--card);
  border-radius: 26px 26px 0 0;
  border: 1px solid var(--border);
  transform: translateY(110%);
  transition: .25s ease;
  
  /* ESNEK YÃœKSEKLÄ°K AYARI */
  max-height: 85dvh; /* EkranÄ±n %85'ini geÃ§mesin */
  height: auto;      /* Ä°Ã§erik kadar uzasÄ±n */
  
  /* FLEX YERÄ°NE BLOCK YAPIYORUZ (KaydÄ±rma Sorunu Ã‡Ã¶zÃ¼mÃ¼) */
  display: block; 
  padding: 14px 16px calc(16px + var(--safe-bottom));
  
  /* KAYDIRMA AYARLARI */
  overflow-y: auto !important; 
  -webkit-overflow-scrolling: touch; 
  overscroll-behavior: contain;
  pointer-events: auto !important;
}
.sheet.open { transform: none; }
    .sheet.open{transform:none;}
    .handle{width:48px;height:5px;border-radius:99px;background:var(--border);margin:6px auto 14px;}
    .field{margin:10px 0;}
    label{display:block;font-size:12px;font-weight:980;color:var(--muted);margin-bottom:6px;}
    input, textarea, select{
      width:100%;background:var(--card2);border:1px solid var(--border);border-radius:16px;
      padding:14px;color:var(--text);font-size:16px;outline:none;
    }
    textarea{min-height:92px;resize:none;}
    .two{display:flex;gap:10px;}
    .smallInfo{font-size:12px;color:var(--muted);font-weight:950;margin-top:6px;}
    .toast{
      position:fixed;left:50%;top:calc(14px + var(--safe-top));
      transform:translate(-50%,-20px);
      background:var(--text);color:var(--bg);
      padding:10px 14px;border-radius:99px;font-weight:980;
      opacity:0;pointer-events:none;transition:.25s ease;z-index:200;
      max-width:calc(100vw - 20px);text-align:center;
    }
    .toast.show{opacity:1;transform:translate(-50%,0);}
    .cardLine{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .termBig{font-weight:980;color:var(--primary);font-size:20px;}
    .badge{
      font-size:11px;font-weight:980;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      color:var(--muted);background:color-mix(in srgb, var(--card2) 60%, transparent);white-space:nowrap;
    }
    .badge.due{color:var(--warn);border-color:color-mix(in srgb, var(--warn) 45%, var(--border));background:color-mix(in srgb, var(--warn) 10%, transparent);}
    .divider{height:1px;background:var(--border);margin:12px 0;}
    .kbd{font-size:11px;font-weight:980;border:1px solid var(--border);padding:4px 8px;border-radius:10px;background:var(--card);color:var(--muted);}

    /* Quiz overlay (simple) */
    .overlay{position:fixed;inset:0;z-index:120;background:var(--bg);transform:translateX(110%);transition:.25s ease;display:flex;flex-direction:column;}
    .overlay.open{transform:none;}
    .overlayTop{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px calc(14px + var(--safe-top));
      padding-top:calc(14px + var(--safe-top));
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb, var(--bg) 85%, transparent);
      backdrop-filter: blur(12px);
    }
    .qChoice{ text-align:left;background:var(--card);border:1px solid var(--border);padding:14px;border-radius:16px;cursor:pointer;font-weight:950;}
    .qChoice.correct{border-color:color-mix(in srgb, var(--ok) 70%, var(--border));background:color-mix(in srgb, var(--ok) 12%, var(--card));}
    .qChoice.wrong{border-color:color-mix(in srgb, var(--danger) 70%, var(--border));background:color-mix(in srgb, var(--danger) 10%, var(--card));}
  /* --- DONMA SORUNU Ä°Ã‡Ä°N ACÄ°L TAMÄ°R KODU --- */
#viewport, .view.active, #cards {
    pointer-events: auto !important; /* TÄ±klamayÄ± ZORLA aÃ§ */
    overflow-y: auto !important;    /* KaydÄ±rmayÄ± ZORLA aÃ§ */
    touch-action: pan-y !important; /* Parmak hareketini algÄ±la */
    z-index: 10 !important;         /* Her ÅŸeyin Ã¼stÃ¼ne Ã§Ä±kar */
}
  </style>
</head>

<body>
<header>
  <div class="brand"><div class="logo"></div><div>Vocabify</div></div>
  <div style="display:flex; gap:10px;">
    <button class="iconBtn" id="btnTheme">ğŸ¨</button>
    <button class="iconBtn" id="btnSettings">âš™ï¸</button>
  </div>
</header>

<div id="viewport">
  <section class="view active" id="home">
    <div class="secTitle">Genel BakÄ±ÅŸ</div>
    <div class="row" style="gap:10px; margin-bottom:14px;">
  
  <div class="card" style="flex:1; border:1px solid var(--primary); padding:10px;">
    <div style="font-weight:bold; color:var(--primary); font-size:12px; margin-bottom:6px;">ğŸ‡¬ğŸ‡§ Ä°ngilizce â¡ï¸ ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</div>
    <div style="display:flex; gap:6px;">
      <input id="quickTransInput" placeholder="Ä°ngilizce yaz..." style="background:var(--bg); font-size:16px;" onkeydown="if(event.key==='Enter') doQuickTranslate()" />
      <button class="iconBtn" style="background:var(--primary); color:white; border:none; width:36px; height:36px;" onclick="doQuickTranslate()">ğŸ”</button>
    </div>
  </div>

  <div class="card" style="flex:1; border:1px solid var(--warn); padding:10px;">
    <div style="font-weight:bold; color:var(--warn); font-size:12px; margin-bottom:6px;">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e â¡ï¸ ğŸ‡¬ğŸ‡§ Ä°ngilizce</div>
    <div style="display:flex; gap:6px;">
      <input id="quickTransInputTR" placeholder="TÃ¼rkÃ§e yaz..." style="background:var(--bg); font-size:16px;" onkeydown="if(event.key==='Enter') doQuickTranslateTR()" />
      <button class="iconBtn" style="background:var(--warn); color:white; border:none; width:36px; height:36px;" onclick="doQuickTranslateTR()">ğŸ”</button>
    </div>
  </div>
</div>
    <div class="row">
      <div class="card" style="flex:1;">
        <div class="muted" style="font-weight:980;">Toplam Kart</div>
        <div class="big" id="dashTotal">0</div>
      </div>
      <div class="card" style="flex:1; border-color:color-mix(in srgb, var(--warn) 45%, var(--border));">
        <div style="font-weight:980; color:var(--warn);">Tekrar</div>
        <div class="big" style="color:var(--warn);" id="dashDue">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="font-weight:980;">HÄ±zlÄ± Ä°ÅŸlemler</div>
      <div class="two" style="margin-top:12px;">
        <button class="btn btnPrimary btnHalf" onclick="go('review')">ğŸ§  Tekrar</button>
        <button class="btn btnSoft btnHalf" onclick="go('cards')">ğŸ—‚ï¸ Kartlar</button>
      </div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="openManualAdd()">â• Elle Kelime Ekle</button>
        <button class="btn btnSoft btnHalf" onclick="resetTodaysQueue()">ğŸ” KuyruÄŸu Yenile</button>
      </div>
      <div class="two" style="margin-top:10px;">
   <button class="btn btnPrimary" style="width:100%;" onclick="openSheet('grammarSheet')">ğŸ“˜ HÄ±zlÄ± Gramer KitapÃ§Ä±ÄŸÄ±</button>
</div>
    </div>
  </section>

  <section class="view" id="review">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 class="h2">Tekrar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="startReviewQuiz()">BaÅŸlat</button>
    </div>

    <div class="card">
      <div style="font-weight:980;">BugÃ¼n tekrar edilecek kartlar</div>
      <div class="smallInfo">ZamanÄ± gelen kartlar Ã¶ncelikli gelir. Yoksa rastgele pratik aÃ§Ä±lÄ±r.</div>

      <div style="display:flex; gap:10px; margin-top:12px;">
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">SÄ±radaki</div>
          <div class="big" id="rvDue">0</div>
        </div>
        <div class="card" style="flex:1; padding:12px;">
          <div class="smallInfo">Toplam</div>
          <div class="big" id="rvTotal">0</div>
        </div>
      </div>

      <div style="margin-top:20px; margin-bottom:20px;">
  
<div style="text-align:center; font-weight:bold; color:var(--text); margin-bottom:12px;">
  KaÃ§ kart Ã§alÄ±ÅŸacaksÄ±n?
</div>

<div id="limitContainer" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
  <button class="btn btnSoft" style="flex:1; min-width:50px; padding:12px 0;" onclick="startReviewQuiz(5, this)">5</button>
  <button class="btn btnSoft" style="flex:1; min-width:50px; padding:12px 0;" onclick="startReviewQuiz(10, this)">10</button>
  <button class="btn btnSoft" style="flex:1; min-width:50px; padding:12px 0;" onclick="startReviewQuiz(15, this)">15</button>
  <button class="btn btnSoft" style="flex:1; min-width:50px; padding:12px 0;" onclick="startReviewQuiz(20, this)">20</button>
  <button class="btn btnSoft" style="flex:1.5; min-width:70px; padding:12px 0;" onclick="startReviewQuiz(9999, this)">Hepsi</button>
</div>

</div>
        <button class="btn btnSoft btnHalf" onclick="toggleQuizMode()">Mod: <span id="quizModeLabel">SeÃ§meli</span></button>
      </div>

      <div class="divider"></div>

      <div class="two">
        <button class="btn btnSoft btnHalf" onclick="toast('Online AutoFill aktif âœ…')">Durum</button>
      </div>
    </div>
  </section>

  <section class="view" id="cards">
    <div style="display:flex; justify-content:space-between; align-items:center; padding-top: 60px;">
      <h2 class="h2">Kartlar</h2>
      <button class="btn btnSoft" style="padding:10px 12px; border-radius:14px;" onclick="openManualAdd()">â• Ekle</button>
    </div>
<div class="row" style="margin-bottom:12px; gap:8px;">
  <div id="filterBtnNew" class="card" onclick="toggleFilter('new')" 
       style="flex:1; padding:10px; border:1px solid var(--border); text-align:center; background:var(--card2); cursor:pointer; transition:0.2s;">
    <div style="font-size:11px; font-weight:bold; color:var(--muted);">âšª Yeni</div>
    <div style="font-size:18px; font-weight:900; color:var(--text);" id="statNew">0</div>
  </div>
  
  <div id="filterBtnLearn" class="card" onclick="toggleFilter('learning')" 
       style="flex:1; padding:10px; border:1px solid var(--warn); text-align:center; background:color-mix(in srgb, var(--warn) 5%, var(--card2)); cursor:pointer; transition:0.2s;">
    <div style="font-size:11px; font-weight:bold; color:var(--warn);">ğŸŸ¡ Ã–ÄŸreniyorum</div>
    <div style="font-size:18px; font-weight:900; color:var(--warn);" id="statLearn">0</div>
  </div>
  
  <div id="filterBtnMaster" class="card" onclick="toggleFilter('mastered')" 
       style="flex:1; padding:10px; border:1px solid var(--ok); text-align:center; background:color-mix(in srgb, var(--ok) 5%, var(--card2)); cursor:pointer; transition:0.2s;">
    <div style="font-size:11px; font-weight:bold; color:var(--ok);">ğŸŸ¢ Ã–ÄŸrendim</div>
    <div style="font-size:18px; font-weight:900; color:var(--ok);" id="statMaster">0</div>
  </div>
</div>
    </div>
    <div class="card" style="margin-bottom:12px;">
      <input id="search" placeholder="Kart ara (kelime/anlam/tÃ¼r)..." />
      <div class="smallInfo" style="margin-top:8px;">KartÄ± aÃ§ â†’ dÃ¼zenle / sil.</div>
    </div>

    <div id="cardsList"></div>
  </section>
</div>

<nav>
  <button class="navBtn active" id="navHome" onclick="go('home')"><div class="ico">ğŸ </div><span>Ana Sayfa</span></button>
  <button class="navBtn" id="navReview" onclick="go('review')"><div class="ico">ğŸ§ </div><span>Tekrar</span></button>
  <button class="navBtn" id="navCards" onclick="go('cards')"><div class="ico">ğŸ—‚ï¸</div><span>Kartlar</span></button>
</nav>

<div class="backdrop" id="backdrop" onclick="closeSheets()"></div>
<div class="toast" id="toast">â€”</div>

<!-- Manual Add -->
<div class="sheet" id="manualAddSheet">
  <div class="handle"></div>
  <h2 class="h2">Elle Kelime Ekle (Online Otomatik)</h2>

  <div class="field">
    <label>Dil</label>
    <select id="maLang">
      <option value="EN">Ä°ngilizce</option>
      <option value="RU">RusÃ§a</option>
      <option value="DE">Almanca</option>
      <option value="ES">Ä°spanyolca</option> <option value="FR">FransÄ±zca</option>
      <option value="TR">TÃ¼rkÃ§e</option>
    </select>
  </div>
  <div class="field">
    <label>Kelime / Terim</label>
    <input id="maTerm" placeholder="Ã–rn: reinforcement" />
    <div class="smallInfo" id="maHint">YazÄ±nca otomatik doldurur. Ä°nternet ÅŸart.</div>
  </div>

  <div class="field">
    <label>AnlamÄ± (TR) - (Ã‡oklu Anlam)</label>
    <textarea id="maMeaning" placeholder="Otomatik dolacak (Ã‡oklu anlam)" style="min-height:60px; font-family:inherit; background:var(--card2); border:1px solid var(--border); border-radius:16px; width:100%; padding:14px; color:var(--text);"></textarea>
  </div>

  <div class="field">
    <label>TÃ¼r</label>
    <select id="maType">
      <option value="word">Kelime</option>
      <option value="phrase">KalÄ±p</option>
      <option value="idiom">Deyim</option>
      <option value="phrasal">Phrasal Verb</option>
      <option value="noun">Ä°sim</option>
      <option value="verb">Fiil</option>
      <option value="adj">SÄ±fat</option>
      <option value="adv">Zarf</option>
    </select>
  </div>

  <div class="field">
    <label>Ã–rnek CÃ¼mle</label>
    <textarea id="maExample" placeholder="Otomatik dolacak"></textarea>
  </div>

  <div class="field">
    <label>Not (opsiyonel)</label>
    <input id="maNote" placeholder="Ä°pucu/Not" />
  </div>

  <div class="two" style="margin-top:10px;">
    <button class="btn btnSoft btnHalf" onclick="closeSheets()">VazgeÃ§</button>
    <button class="btn btnSoft btnHalf" onclick="autoFillManualFields(true)">âš¡ Doldur</button>
  </div>
  <div class="two" style="margin-top:10px;">
    <button class="btn btnPrimary btnHalf" onclick="saveManualCard()">Kaydet</button>
    <button class="btn btnDanger btnHalf" onclick="clearManual()">Temizle</button>
  </div>
</div>

<!-- Settings -->
<div class="sheet" id="settingsSheet">
  <div class="handle"></div>
  <h2 class="h2">Ayarlar</h2>

  <div class="card" style="margin-top:10px;">
    <div style="font-weight:980;">Tema</div>
    <div class="two" style="margin-top:10px;">
      <select id="themeSelect" onchange="applyThemeFromSelect()">
        <option value="dark">dark</option>
        <option value="light">light</option>
        <option value="ocean">ocean</option>
        <option value="emerald">emerald</option>
        <option value="sunset">sunset</option>
        <option value="rose">rose</option>
      </select>
      <button class="btn btnSoft" style="padding:12px 12px;" onclick="document.getElementById('btnTheme').click()">DÃ¶ndÃ¼r</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:980;">Quiz Modu</div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="toggleQuizMode()">Mod: <span id="quizModeLabel2">SeÃ§meli</span></button>
      <button class="btn btnSoft btnHalf" onclick="exportAll()">Export</button>
    </div>
    <div class="two" style="margin-top:10px;">
      <button class="btn btnSoft btnHalf" onclick="importAllPrompt()">Import</button>
      <button class="btn btnDanger btnHalf" onclick="hardReset()">SÄ±fÄ±rla</button>
    </div>
  </div>

  <div class="smallInfo" style="margin-top:12px;">SÃ¼rÃ¼m: online-autofill â€¢ dictionary + translate â€¢ no level/category</div>
</div>

<!-- Quiz overlay -->
  <div class="sheet" id="transResultSheet">
  <div class="handle"></div>
  <h2 class="h2">Ã‡eviri Sonucu</h2>
  
  <div id="trResContent" style="line-height:1.6;"></div>

  <button class="btn btnPrimary" style="width:100%; margin-top:16px;" onclick="copyToManualAdd()">â• Bu Kelimeyi Karta Ekle</button>
  <button class="btn btnSoft" style="width:100%; margin-top:10px;" onclick="closeSheets()">Kapat</button>
</div>
  <div class="sheet" id="grammarSheet">
  <div class="handle"></div>
  <h2 class="h2" style="color:var(--primary); text-align:center;">ğŸ“˜ Ä°ngilizce Ä°puÃ§larÄ±</h2>

  <div class="card" style="margin-bottom:14px; padding:0; overflow:hidden; border:1px solid var(--border);">
    <div style="background:var(--card2); padding:10px; font-weight:900; border-bottom:1px solid var(--border); text-align:center;">ğŸ‘¤ Zamirler (Pronouns)</div>
    <table style="width:100%; border-collapse:collapse; font-size:12px; text-align:center;">
      <tr style="background:color-mix(in srgb, var(--primary) 15%, transparent); font-weight:bold;">
        <td style="padding:6px;">Ben</td>
        <td style="padding:6px;">Beni</td>
        <td style="padding:6px;">Benim</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px; font-weight:bold; color:var(--primary);">I</td>
        <td style="padding:6px;">Me</td>
        <td style="padding:6px;">My</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px; font-weight:bold; color:var(--primary);">You</td>
        <td style="padding:6px;">You</td>
        <td style="padding:6px;">Your</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px; font-weight:bold; color:var(--primary);">He/She</td>
        <td style="padding:6px;">Him/Her</td>
        <td style="padding:6px;">His/Her</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px; font-weight:bold; color:var(--primary);">We</td>
        <td style="padding:6px;">Us</td>
        <td style="padding:6px;">Our</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold; color:var(--primary);">They</td>
        <td style="padding:6px;">Them</td>
        <td style="padding:6px;">Their</td>
      </tr>
    </table>
  </div>

  <div class="card" style="margin-bottom:14px; padding:0; overflow:hidden; border:1px solid var(--border);">
    <div style="background:var(--card2); padding:10px; font-weight:900; border-bottom:1px solid var(--border); text-align:center;">â³ Zamanlar (Tenses)</div>
    <table style="width:100%; border-collapse:collapse; font-size:13px;">
      <tr style="background:color-mix(in srgb, var(--primary) 15%, transparent);">
        <th style="padding:6px; text-align:left;">Zaman</th>
        <th style="padding:6px; text-align:left;">Ä°pucu</th>
        <th style="padding:6px; text-align:left;">Ã–rnek</th>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px; font-weight:bold;">Genel</td>
        <td style="padding:6px; color:var(--muted);">Her gÃ¼n</td>
        <td style="padding:6px;">I <b style="color:var(--primary)">play</b>.</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px; font-weight:bold;">Åimdiki</td>
        <td style="padding:6px; color:var(--muted);">Åu an</td>
        <td style="padding:6px;">I am <b style="color:var(--primary)">playing</b>.</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px; font-weight:bold;">GeÃ§miÅŸ</td>
        <td style="padding:6px; color:var(--muted);">DÃ¼n</td>
        <td style="padding:6px;">I <b style="color:var(--primary)">played</b>.</td>
      </tr>
      <tr>
        <td style="padding:6px; font-weight:bold;">Gelecek</td>
        <td style="padding:6px; color:var(--muted);">YarÄ±n</td>
        <td style="padding:6px;">I <b style="color:var(--primary)">will play</b>.</td>
      </tr>
    </table>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div style="font-weight:900; color:var(--warn); margin-bottom:10px; text-align:center;">ğŸ› ï¸ Modals (Kip Ekleri)</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
      <div style="background:var(--bg); padding:8px; border-radius:8px; border:1px dashed var(--border);">
        <div style="font-weight:bold; color:var(--primary);">CAN</div>
        <div style="font-size:11px;">-ebilmek (Yetenek)</div>
      </div>
      <div style="background:var(--bg); padding:8px; border-radius:8px; border:1px dashed var(--border);">
        <div style="font-weight:bold; color:var(--primary);">SHOULD</div>
        <div style="font-size:11px;">-meli (Tavsiye)</div>
      </div>
      <div style="background:var(--bg); padding:8px; border-radius:8px; border:1px dashed var(--border);">
        <div style="font-weight:bold; color:var(--primary);">MUST</div>
        <div style="font-size:11px;">-meli (Zorunlu)</div>
      </div>
      <div style="background:var(--bg); padding:8px; border-radius:8px; border:1px dashed var(--border);">
        <div style="font-weight:bold; color:var(--primary);">MIGHT</div>
        <div style="font-size:11px;">-ebilir (Ä°htimal)</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:14px; padding:0; overflow:hidden; border:1px solid var(--border);">
    <div style="background:var(--card2); padding:10px; font-weight:900; border-bottom:1px solid var(--border); text-align:center;">â“ Soru Kelimeleri (Wh- Questions)</div>
    <table style="width:100%; border-collapse:collapse; font-size:13px; text-align:center;">
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:8px; font-weight:bold; color:var(--primary);">WHO</td>
        <td style="padding:8px;">Kim?</td>
        <td style="padding:8px; font-style:italic; color:var(--muted);">Who are you?</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:8px; font-weight:bold; color:var(--primary);">WHAT</td>
        <td style="padding:8px;">Ne?</td>
        <td style="padding:8px; font-style:italic; color:var(--muted);">What is this?</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:8px; font-weight:bold; color:var(--primary);">WHERE</td>
        <td style="padding:8px;">Nerede?</td>
        <td style="padding:8px; font-style:italic; color:var(--muted);">Where is Ali?</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:8px; font-weight:bold; color:var(--primary);">WHEN</td>
        <td style="padding:8px;">Ne zaman?</td>
        <td style="padding:8px; font-style:italic; color:var(--muted);">When do we go?</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:8px; font-weight:bold; color:var(--primary);">WHY</td>
        <td style="padding:8px;">Neden?</td>
        <td style="padding:8px; font-style:italic; color:var(--muted);">Why are you sad?</td>
      </tr>
      <tr>
        <td style="padding:8px; font-weight:bold; color:var(--primary);">HOW</td>
        <td style="padding:8px;">NasÄ±l?</td>
        <td style="padding:8px; font-style:italic; color:var(--muted);">How are you?</td>
      </tr>
    </table>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div style="font-weight:900; color:var(--warn); margin-bottom:10px; text-align:center;">ğŸ A - AN - THE FarkÄ±</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
      <div style="background:var(--bg); padding:10px; border-radius:8px; border:1px dashed var(--border);">
        <div style="font-weight:bold; color:var(--primary); font-size:16px;">A / AN</div>
        <div style="font-size:11px; margin-top:2px; font-weight:bold;">HERHANGÄ° BÄ°R</div>
        <div style="font-size:11px; margin-top:4px; color:var(--muted);">
          Bilinmeyen ÅŸeylerde.<br>
          ğŸ‘‰ <b>a</b> car (bir araba)<br>
          ğŸ‘‰ <b>an</b> apple (bir elma)
        </div>
      </div>
      <div style="background:var(--bg); padding:10px; border-radius:8px; border:1px dashed var(--border);">
        <div style="font-weight:bold; color:var(--primary); font-size:16px;">THE</div>
        <div style="font-size:11px; margin-top:2px; font-weight:bold;">BÄ°LÄ°NEN O ÅEY</div>
        <div style="font-size:11px; margin-top:4px; color:var(--muted);">
          KonuÅŸulan belirli ÅŸey.<br>
          ğŸ‘‰ <b>the</b> moon (ay)<br>
          ğŸ‘‰ <b>the</b> door (o kapÄ±)
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:14px; padding:0; overflow:hidden; border:1px solid var(--border);">
    <div style="background:var(--card2); padding:10px; font-weight:900; border-bottom:1px solid var(--border); text-align:center;">ğŸ“ SÄ±fatlar (KarÅŸÄ±laÅŸtÄ±rma)</div>
    <table style="width:100%; border-collapse:collapse; font-size:13px; text-align:center;">
      <tr style="background:color-mix(in srgb, var(--primary) 15%, transparent);">
        <th style="padding:6px;">SÄ±fat</th>
        <th style="padding:6px;">Daha ...</th>
        <th style="padding:6px;">En ...</th>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px;">Big (BÃ¼yÃ¼k)</td>
        <td style="padding:6px; font-weight:bold;">Big<span style="color:var(--warn)">ger</span></td>
        <td style="padding:6px; font-weight:bold;">The Big<span style="color:var(--warn)">gest</span></td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px;">Fast (HÄ±zlÄ±)</td>
        <td style="padding:6px; font-weight:bold;">Fast<span style="color:var(--warn)">er</span></td>
        <td style="padding:6px; font-weight:bold;">The Fast<span style="color:var(--warn)">est</span></td>
      </tr>
      <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px;">Good (Ä°yi)</td>
        <td style="padding:6px; font-weight:bold; color:var(--ok);">Better</td>
        <td style="padding:6px; font-weight:bold; color:var(--ok);">The Best</td>
      </tr>
      <tr>
        <td style="padding:6px;">Bad (KÃ¶tÃ¼)</td>
        <td style="padding:6px; font-weight:bold; color:var(--warn);">Worse</td>
        <td style="padding:6px; font-weight:bold; color:var(--warn);">The Worst</td>
      </tr>
    </table>
  </div>

  <button class="btn btnSoft" style="width:100%; margin-top:20px;" onclick="closeSheets()">Kapat</button>
</div>
  <div class="overlay" id="quizOverlay">
  <div class="overlayTop">
    <div style="font-weight:980;">Quiz</div>
    <button class="iconBtn" onclick="stopQuiz()">Ã—</button>
  </div>
  <div id="quizBody" style="padding:18px;">
    <div class="card" style="padding:12px;">
      <div class="smallInfo">Kalan: <b id="qRemain">0</b>/<b id="qTotal">0</b> â€¢ âœ… <b id="qCorrect">0</b> â€¢ âŒ <b id="qWrong">0</b></div>
      <div style="margin-top:10px; font-size:40px; font-weight:1000; text-align:center;" id="qWord">â€”</div>
      <div class="smallInfo" style="text-align:center; margin-top:8px;" id="qMeta">â€”</div>
      <div style="text-align:center; font-style:italic; color:var(--primary); margin-top:6px; min-height:20px;" id="qExample"></div>
    </div>

    <div id="qChoices" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>

    <div id="qTyping" style="margin-top:12px; display:none; gap:10px;">
      <input id="qInput" placeholder="AnlamÄ±nÄ± yaz..." style="flex:1; font-weight:950;" />
      <button class="btn btnPrimary" style="padding:12px 14px;" onclick="checkTypingAnswer()">Kontrol</button>
    </div>

    <div class="smallInfo" id="qReveal" style="text-align:center; margin-top:10px; min-height:18px;"></div>

    <div class="two" style="margin-top:12px;">
      <button class="btn btnSoft btnHalf" onclick="markAsUnknown()">ğŸ”´ Bilmiyorum / Sonra</button>
    </div>

    <div class="smallInfo" style="text-align:center; margin-top:10px;">
      <span class="kbd">Enter</span> kontrol (yazmalÄ±) â€¢ <span class="kbd">Esc</span> Ã§Ä±kÄ±ÅŸ
    </div>
  </div>
</div>

<script>
/* ===========================
   1. GLOBAL DEÄÄ°ÅKENLER VE AYARLAR
   (Hata almamak iÃ§in en Ã¼stte tanÄ±mlandÄ±)
=========================== */
const DB = {
  get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
  set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

// Ana Durum (State)
const state = {
  settings: DB.get("lm_settings", { theme:"dark", quizMode:"choice" }),
  cards: DB.get("lm_cards", []),
  txCache: DB.get("lm_tx_cache", {}),
  dictCache: DB.get("lm_dict_cache", {}),
  reviewQueue: DB.get("lm_review_queue", [])
};

// Global DeÄŸiÅŸkenler
let activeFilter = "all"; 
let quizCurrent = null;
let correctCount = 0;
let wrongCount = 0;
let autoTimer = null;
let quickTermCache = "";

/* ===========================
   2. YARDIMCI FONKSÄ°YONLAR
=========================== */
function now(){ return Date.now(); }
function norm(s){ return (s||"").toLowerCase().trim(); }
function uid(){ return "c_" + Math.random().toString(36).slice(2) + "_" + Math.random().toString(36).slice(2); }
function safeText(s){ return (s ?? "").toString(); }

function toast(msg){
  const t=document.getElementById("toast");
  if(!t) return;
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}

function saveAll(){
  DB.set("lm_settings", state.settings);
  DB.set("lm_cards", state.cards);
  DB.set("lm_tx_cache", state.txCache);
  DB.set("lm_dict_cache", state.dictCache);
  DB.set("lm_review_queue", state.reviewQueue);
}

/* ===========================
   3. SAYFA GEÃ‡Ä°ÅLERÄ° (ROUTER)
=========================== */
function go(id){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  const target = document.getElementById(id);
  if(target) target.classList.add("active");
  
  document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
  const navBtn = document.getElementById("nav"+id.charAt(0).toUpperCase() + id.slice(1));
  if(navBtn) navBtn.classList.add("active");

  // Sayfa aÃ§Ä±lÄ±nca verileri tazele
  if(id==="home") renderDash();
  if(id==="review") renderReview();
  if(id==="cards") renderCards();
}

/* ===========================
   4. ARAYÃœZ (RENDER) FONKSÄ°YONLARI
=========================== */
function renderDash(){
  document.getElementById("dashTotal").textContent = state.cards.length;
  document.getElementById("dashDue").textContent = state.cards.filter(c => (c.due||0) <= now()).length;
}

function getDueCards(){ return state.cards.filter(c => (c.due||0) <= now()); }

function renderReview(){
  document.getElementById("rvTotal").textContent = state.cards.length;
  document.getElementById("rvDue").textContent = getDueCards().length;
  syncQuizModeLabels();
}

function renderCards(){
  const searchEl = document.getElementById("search");
  const q = searchEl ? norm(searchEl.value) : "";
  const list = document.getElementById("cardsList");
  if(!list) return;
  list.innerHTML="";

  // Ä°statistikleri Hesapla
  let countNew = 0, countLearning = 0, countMastered = 0;
  state.cards.forEach(c => {
      const r = c.srs ? c.srs.reps : 0;
      if(r === 0) countNew++;
      else if(r < 5) countLearning++;
      else countMastered++;
  });

  // HTML Ä°statistiklerini GÃ¼ncelle
  const statNew = document.getElementById("statNew");
  if(statNew) statNew.textContent = countNew;

  // Filtre ButonlarÄ±nÄ± GÃ¼ncelle
  updateFilterBox("filterBtnNew", "all", "new", activeFilter);
  updateFilterBoxContent("filterBtnLearn", "warn", "ğŸŸ¡ Ã–ÄŸreniyorum", countLearning, "learning", activeFilter);
  updateFilterBoxContent("filterBtnMaster", "ok", "ğŸŸ¢ Ã–ÄŸrendim", countMastered, "mastered", activeFilter);

  // KartlarÄ± Filtrele
  const items = state.cards.filter(c => {
      const matchesSearch = !q || (norm(c.term).includes(q) || norm(c.meaning).includes(q) || norm(c.type).includes(q));
      const r = c.srs ? c.srs.reps : 0;
      let matchesStatus = true;
      if(activeFilter === 'new') matchesStatus = (r === 0);
      else if(activeFilter === 'learning') matchesStatus = (r > 0 && r < 5);
      else if(activeFilter === 'mastered') matchesStatus = (r >= 5);
      return matchesSearch && matchesStatus;
  }).sort((a,b)=> (a.term||"").localeCompare((b.term||""), "en"));

  // Listeyi Bas
  if(!items.length){
    list.innerHTML=`<div class="card" style="text-align:center; padding:20px; color:var(--muted);">Kart bulunamadÄ±.</div>`;
    return;
  }

  items.forEach(c=>{
    const reps = c.srs ? c.srs.reps : 0;
    const isDue = (c.due||0) <= now();
    
    let badge = `<span class="badge" style="border:1px solid var(--border);">Yeni</span>`;
    if(reps > 0 && reps < 5) badge = `<span class="badge" style="color:var(--warn); border-color:var(--warn);">Ã–ÄŸreniliyor</span>`;
    if(reps >= 5) badge = `<span class="badge" style="color:var(--ok); border-color:var(--ok); background:rgba(16,185,129,0.1);">Ã–ÄŸrendim</span>`;
    
    const dueBadge = isDue ? `<span class="badge due" style="margin-left:4px;">Tekrar</span>` : ``;
    const resetBtn = reps > 0 ? `<button class="btn btnSoft btnHalf" style="font-size:11px;" onclick="resetSingleCard('${c.id}')">â†©ï¸ BaÅŸa Al</button>` : ``;

    const el=document.createElement("div");
    el.className="card";
    el.style.marginTop="12px";
    el.innerHTML=`
      <div class="cardLine">
        <div class="termBig">${safeText(c.term)}</div>
        <div style="display:flex;">${badge} ${dueBadge}</div>
      </div>
      <div class="smallInfo">${safeText(c.lang)} â€¢ ${safeText(c.meaning)}</div>
      <div class="smallInfo" style="margin-top:6px;">TÃ¼r: ${safeText(c.type||'-')}</div>
      <div class="smallInfo" style="margin-top:6px; opacity:0.7;">${safeText(c.example||'')}</div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btnSoft btnHalf" onclick="openEditPrompt('${c.id}')">DÃ¼zenle</button>
        ${resetBtn}
        <button class="btn btnDanger btnHalf" onclick="deleteCard('${c.id}')">Sil</button>
      </div>
    `;
    list.appendChild(el);
  });
}

// Filtre Kutusu YardÄ±mcÄ±larÄ±
function updateFilterBox(id, defaultFilter, myFilter, current){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.opacity = (current === 'all' || current === myFilter) ? "1" : "0.4";
  el.style.borderWidth = (current === myFilter) ? "2px" : "1px";
}
function updateFilterBoxContent(id, colorVar, label, count, type, current){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = `
    <div style="font-size:11px; font-weight:bold; color:var(--${colorVar});">${label}</div>
    <div style="font-size:18px; font-weight:900; color:var(--${colorVar});">${count}</div>
    <button class="btn btnSoft" style="padding:4px 8px; font-size:10px; margin-top:4px; width:100%; border-color:var(--${colorVar}); color:var(--${colorVar});" 
    onclick="event.stopPropagation(); startCategoryQuiz('${type}')">â–¶ï¸ Ã‡alÄ±ÅŸ</button>
  `;
  el.style.opacity = (current === 'all' || current === type) ? "1" : "0.4";
  el.style.borderWidth = (current === type) ? "2px" : "1px";
}

function toggleFilter(type){
  if(activeFilter === type) activeFilter = "all";
  else activeFilter = type;
  
  if(activeFilter === 'new') toast("Sadece YENÄ° kartlar");
  else if(activeFilter === 'all') toast("TÃ¼m kartlar");
  else toast("Filtre: " + activeFilter);
  
  renderCards();
}

/* ===========================
   5. QUIZ MOTORU
=========================== */
function startReviewQuiz(limit = 9999, btnElement = null){
  if(btnElement){
     document.querySelectorAll("#limitContainer .btn").forEach(b => {
        b.classList.remove("btnPrimary"); b.classList.add("btnSoft"); 
     });
     btnElement.classList.remove("btnSoft"); btnElement.classList.add("btnPrimary");
  }

  let dueCards = getDueCards();
  if(dueCards.length === 0) dueCards = [...state.cards]; // HiÃ§ yoksa hepsi

  // KarÄ±ÅŸtÄ±r
  dueCards.sort(() => Math.random() - 0.5);
  
  // Limitle
  if(dueCards.length > limit) dueCards = dueCards.slice(0, limit);

  if(dueCards.length === 0) return toast("Ã‡alÄ±ÅŸÄ±lacak kart yok!");

  state.reviewQueue = dueCards.map(c => c.id);
  DB.set("lm_review_queue", state.reviewQueue);

  openSheetOverlay("quizOverlay");
  nextQuiz();
}

function startCategoryQuiz(type){
  closeSheets(); 
  let filtered = [];
  if(type === 'learning') filtered = state.cards.filter(c => c.srs && c.srs.reps > 0 && c.srs.reps < 5);
  else if(type === 'mastered') filtered = state.cards.filter(c => c.srs && c.srs.reps >= 5);
  
  if(filtered.length === 0) return toast("Bu kategoride kart yok!");
  
  filtered.sort(() => Math.random() - 0.5);
  state.reviewQueue = filtered.map(c => c.id);
  DB.set("lm_review_queue", state.reviewQueue);
  
  openSheetOverlay("quizOverlay");
  nextQuiz();
}

function nextQuiz(){
  if(!state.reviewQueue.length){
    toast("Tebrikler! Bitti ğŸ‰");
    stopQuiz();
    return;
  }
  document.getElementById("qRemain").textContent = state.reviewQueue.length;
  
  const id = state.reviewQueue.shift();
  DB.set("lm_review_queue", state.reviewQueue);
  
  const card = state.cards.find(c => c.id === id);
  if(!card) return nextQuiz();
  
  quizCurrent = card;
  renderQuizQuestion(card);
}

function renderQuizQuestion(card){
  // Soruyu HazÄ±rla
  let qHtml = `<span style="font-size:36px; color:var(--primary);">${card.term}</span>`;
  let hint = "Bu kelimenin anlamÄ± nedir?";
  
  // Context Modu KontrolÃ¼
  let isContext = false;
  if(card.example && card.example.length > 5){
      const regex = new RegExp(`\\b${card.term}\\b`, "gi");
      if(regex.test(card.example)){
          const blank = `<span style='color:var(--primary); border-bottom:3px solid var(--primary);'>______</span>`;
          qHtml = card.example.replace(regex, blank);
          hint = "BoÅŸluÄŸa ne gelmeli?";
          isContext = true;
      }
  }

  const qWord = document.getElementById("qWord");
  qWord.innerHTML = qHtml;
  qWord.style.fontSize = isContext ? "24px" : "32px";
  document.getElementById("qMeta").textContent = hint;
  document.getElementById("qExample").textContent = "";
  document.getElementById("qReveal").innerHTML = "";

  // ÅÄ±klarÄ± HazÄ±rla
  const choicesBox = document.getElementById("qChoices");
  const typingBox = document.getElementById("qTyping");
  choicesBox.innerHTML = "";
  
  const mode = state.settings.quizMode || "choice";
  
  if(mode === "typing" && !isContext){
      choicesBox.style.display = "none";
      typingBox.style.display = "flex";
      document.getElementById("qInput").value = "";
      document.getElementById("qInput").focus();
  } else {
      typingBox.style.display = "none";
      choicesBox.style.display = "flex";
      
      let correctVal = isContext ? card.term : card.meaning;
      let options = state.cards.filter(c => c.id !== card.id)
          .sort(()=>Math.random()-0.5).slice(0,3)
          .map(c => isContext ? c.term : c.meaning);
      
      options.push(correctVal);
      options.sort(()=>Math.random()-0.5);

      options.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "qChoice";
          btn.textContent = opt;
          btn.onclick = () => checkChoice(btn, opt, correctVal, card, isContext);
          choicesBox.appendChild(btn);
      });
  }
}

function checkChoice(btn, selected, correct, card, isContext){
  const allBtns = document.querySelectorAll(".qChoice");
  allBtns.forEach(b => b.disabled = true);
  
  if(selected === correct){
      btn.classList.add("correct");
      showGradeButtons(card);
      if(isContext) document.getElementById("qWord").innerHTML = card.example.replace(new RegExp(`\\b${card.term}\\b`, "gi"), `<b style='color:var(--ok)'>${card.term}</b>`);
  } else {
      btn.classList.add("wrong");
      allBtns.forEach(b => { if(b.textContent === correct) b.classList.add("correct"); });
      grade(card, 0, false);
  }
}

function checkTypingAnswer(){
  if(!quizCurrent) return;
  const val = norm(document.getElementById("qInput").value);
  const correct = norm(quizCurrent.term); // Yazma modunda hep kelimenin kendisini soruyoruz (TR->EN gibi dÃ¼ÅŸÃ¼n) veya Anlam soruyorsak meaning.
  // Basitlik iÃ§in yazma modunu ÅŸimdilik sadece "AnlamÄ± Yaz" olarak kurguladÄ±ysak:
  // Ancak yukarÄ±daki mantÄ±kta EN kelimeyi gÃ¶sterip anlam soruyoruz.
  // KullanÄ±cÄ± anlamÄ± tam tutturamaz. Bu yÃ¼zden yazma modu EN->TR iÃ§in zordur.
  // Biz yine de basit bir kontrol yapalÄ±m:
  
  if(val === norm(quizCurrent.meaning)){
      showGradeButtons(quizCurrent);
  } else {
      document.getElementById("qReveal").textContent = `DoÄŸrusu: ${quizCurrent.meaning}`;
      grade(quizCurrent, 0, false);
  }
}

function showGradeButtons(card){
  document.getElementById("qReveal").innerHTML = `
    <div style="font-weight:bold; color:var(--ok); margin-bottom:8px;">âœ… DoÄŸru!</div>
    <div style="display:flex; gap:10px;">
      <button class="btn btnSoft btnHalf" onclick="grade(state.cards.find(c=>c.id=='${card.id}'), 3, true)">ğŸŸ¡ Ã–ÄŸreniyorum</button>
      <button class="btn btnOk btnHalf" onclick="grade(state.cards.find(c=>c.id=='${card.id}'), 5, true)">ğŸŸ¢ Tam Ã–ÄŸrendim</button>
    </div>
  `;
}

function grade(card, quality, isCorrect){
  if(isCorrect){ correctCount++; document.getElementById("qCorrect").textContent=correctCount; }
  else { wrongCount++; document.getElementById("qWrong").textContent=wrongCount; }

  // SRS Hesapla
  let s = card.srs || { interval:0, reps:0, ef:2.5 };
  let { interval, reps, ef } = s;

  if(quality === 0){
     reps = 0; interval = 0; ef = Math.max(1.3, ef - 0.2);
  } else {
     if(reps === 0) interval = 1;
     else if(reps === 1) interval = 6;
     else interval = Math.round(interval * ef);
     if(quality === 5) interval = Math.round(interval * 1.3);
     reps++;
     ef = ef + (0.1 - (5-quality)*(0.08+(5-quality)*0.02));
     if(ef<1.3) ef=1.3;
  }

  card.srs = {interval, reps, ef};
  card.due = now() + (interval * 24 * 60 * 60 * 1000);
  card.updatedAt = now();
  
  DB.set("lm_cards", state.cards);
  
  setTimeout(() => { quizCurrent=null; nextQuiz(); }, quality===0 ? 1500 : 100);
}

function stopQuiz(){
  if(quizCurrent && quizCurrent.id){
      state.reviewQueue.unshift(quizCurrent.id);
      DB.set("lm_review_queue", state.reviewQueue);
  }
  document.getElementById("quizOverlay").classList.remove("open");
  renderDash(); renderReview();
}

function markAsUnknown(){ 
  if(quizCurrent) grade(quizCurrent, 0, false); 
}

/* ===========================
   6. DÄ°ÄER Ä°ÅLEMLER (Ekle, Sil, SÄ±fÄ±rla)
=========================== */
function openManualAdd(){ clearManual(); openSheet("manualAddSheet"); }
function clearManual(){
  document.getElementById("maTerm").value="";
  document.getElementById("maMeaning").value="";
  document.getElementById("maExample").value="";
}
function saveManualCard(){
  const term = document.getElementById("maTerm").value.trim();
  const meaning = document.getElementById("maMeaning").value.trim();
  const type = document.getElementById("maType").value;
  const example = document.getElementById("maExample").value.trim();
  const lang = document.getElementById("maLang").value;
  
  if(!term || !meaning) return toast("Kelime ve anlam girilmeli.");
  
  state.cards.push({
      id: uid(), lang, term, meaning, type, example, note:"",
      due: now(), srs: {interval:0, reps:0, ef:2.5}, createdAt: now()
  });
  
  DB.set("lm_cards", state.cards);
  toast("Eklendi âœ…");
  closeSheets(); renderDash(); renderCards();
}

function deleteCard(id){
  if(!confirm("Silinsin mi?")) return;
  state.cards = state.cards.filter(c => c.id !== id);
  DB.set("lm_cards", state.cards);
  renderCards(); renderDash();
}

function resetSingleCard(id){
  const c = state.cards.find(x=>x.id===id);
  if(c && confirm("BaÅŸa alÄ±nsÄ±n mÄ±?")){
      c.srs = {interval:0, reps:0, ef:2.5};
      c.due = now();
      DB.set("lm_cards", state.cards);
      renderCards(); toast("SÄ±fÄ±rlandÄ±.");
  }
}

function openEditPrompt(id){
  const c = state.cards.find(x=>x.id===id);
  if(!c) return;
  const m = prompt("Yeni Anlam:", c.meaning);
  if(m){
      c.meaning = m;
      DB.set("lm_cards", state.cards);
      renderCards();
  }
}

function hardReset(){
  if(confirm("TÃ¼m veriler silinecek!")){
      localStorage.clear();
      location.reload();
  }
}

/* ===========================
   7. SHEET / POPUP YÃ–NETÄ°MÄ°
=========================== */
const backdrop = document.getElementById("backdrop");
function openSheet(id){ 
  backdrop.classList.add("open"); 
  const el = document.getElementById(id);
  if(el) el.classList.add("open"); 
}
function openSheetOverlay(id){
   const el = document.getElementById(id);
   if(el) el.classList.add("open");
}
function closeSheets(){ 
  backdrop.classList.remove("open"); 
  document.querySelectorAll(".sheet").forEach(s => s.classList.remove("open")); 
}

/* ===========================
   8. Ã‡EVÄ°RÄ° VE API Ä°ÅLEMLERÄ°
=========================== */
async function doQuickTranslate(){
  const inp = document.getElementById("quickTransInput");
  const term = inp.value.trim();
  if(!term) return;
  
  toast("Ã‡evriliyor...");
  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=tr&dt=t&q=${encodeURIComponent(term)}`;
  try {
      const r = await fetch(url);
      const d = await r.json();
      const mean = d[0][0][0];
      
      document.getElementById("trResContent").innerHTML = `
         <div class="big" style="text-align:center; color:var(--primary)">${term}</div>
         <div style="text-align:center; margin-top:10px;">${mean}</div>
      `;
      openSheet("transResultSheet");
      quickTermCache = term;
      inp.value = "";
  } catch(e) { toast("Hata oluÅŸtu"); }
}

function copyToManualAdd(){
    closeSheets();
    openManualAdd();
    document.getElementById("maTerm").value = quickTermCache;
}

// Otomatik Doldurma Tetikleyicisi
document.getElementById("maTerm").addEventListener("change", function(){
   // Buraya istenirse otomatik doldurma eklenebilir
});

function syncQuizModeLabels(){
   const txt = (state.settings.quizMode === "typing") ? "YazmalÄ±" : "SeÃ§meli";
   const l1 = document.getElementById("quizModeLabel");
   const l2 = document.getElementById("quizModeLabel2");
   if(l1) l1.textContent = txt;
   if(l2) l2.textContent = txt;
}
function toggleQuizMode(){
   state.settings.quizMode = (state.settings.quizMode === "choice") ? "typing" : "choice";
   saveAll(); syncQuizModeLabels();
   toast("Mod: " + state.settings.quizMode);
}

/* ===========================
   9. BAÅLATMA (INIT)
   (En sonda Ã§alÄ±ÅŸÄ±r, veriyi ekrana basar)
=========================== */
// Tema YÃ¼kle
setTheme(state.settings.theme || "dark");
function setTheme(name){
  document.documentElement.setAttribute("data-theme", name);
  state.settings.theme = name;
  saveAll();
}

// EkranlarÄ± Ä°lk Kez Ã‡iz
renderDash();
renderCards(); 
renderReview();

// EÄŸer "Kart Ara" kutusu varsa dinle
const sInput = document.getElementById("search");
if(sInput) sInput.addEventListener("input", renderCards);

// VeritabanÄ± boÅŸsa (Ä°lk KullanÄ±m) - Ä°stersen buraya starter pack ekleyebilirsin
if(state.cards.length === 0){
   console.log("Kart yok, temiz baÅŸlangÄ±Ã§.");
}
</script>
</body>
</html>
