<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LingoMaster Pro</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LingoMaster">

    <style>
        /* =========================================
           1. CORE VARIABLES & THEME ENGINE
           ========================================= */
        :root {
            /* Palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --surface-1: #0f172a;
            --surface-2: #1e293b;
            --surface-3: #334155;
            --text-1: #f8fafc;
            --text-2: #94a3b8;
            --border: #475569;
            
            /* Dimensions */
            --header-height: 60px;
            --nav-height: 70px;
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            
            /* Typography */
            --font-ui: -apple-system, BlinkMacSystemFont, "Inter", Roboto, sans-serif;
            --font-reader: "Merriweather", "Georgia", serif;
            
            /* Transitions */
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --surface-1: #f8fafc;
            --surface-2: #ffffff;
            --surface-3: #e2e8f0;
            --text-1: #0f172a;
            --text-2: #64748b;
            --border: #cbd5e1;
        }

        /* =========================================
           2. GLOBAL RESET & BASE STYLES
           ========================================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--surface-1);
            color: var(--text-1);
            font-family: var(--font-ui);
            height: 100vh; width: 100vw;
            overflow: hidden; /* App-like constraint */
            display: flex; flex-direction: column;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 4px; }

        /* Icons (SVG) */
        .icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 18px; height: 18px; }

        /* Typography Utilities */
        .h1 { font-size: 2rem; font-weight: 800; letter-spacing: -0.05rem; }
        .h2 { font-size: 1.5rem; font-weight: 700; }
        .h3 { font-size: 1.1rem; font-weight: 600; }
        .text-sm { font-size: 0.875rem; color: var(--text-2); }
        .text-xs { font-size: 0.75rem; color: var(--text-2); }
        .bold { font-weight: 700; }
        .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Layout Utilities */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .p-4 { padding: 1rem; }

        /* =========================================
           3. UI COMPONENTS
           ========================================= */
        
        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px 20px; border-radius: 12px; font-weight: 600; cursor: pointer;
            transition: transform 0.1s, opacity 0.2s; border: none;
            user-select: none; font-size: 0.95rem;
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-secondary { background: var(--surface-3); color: var(--text-1); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-ghost { background: transparent; color: var(--text-2); }
        .btn-icon { padding: 10px; border-radius: 50%; }
        .btn-float {
            position: absolute; bottom: 20px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 50;
        }

        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-2); }
        .input, .textarea, .select {
            width: 100%; padding: 14px; border-radius: 12px;
            background: var(--surface-2); border: 1px solid var(--border);
            color: var(--text-1); font-size: 1rem; outline: none;
            transition: border-color 0.2s;
        }
        .input:focus { border-color: var(--primary); }

        /* Cards */
        .card {
            background: var(--surface-2); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 16px;
            position: relative; overflow: hidden;
        }

        /* =========================================
           4. APP SHELL LAYOUT
           ========================================= */
        #app-header {
            height: var(--header-height);
            background: rgba(15, 23, 42, 0.8); /* Translucent */
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 0 16px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 40;
        }
        [data-theme="light"] #app-header { background: rgba(255, 255, 255, 0.8); }

        #main-viewport {
            flex: 1; position: relative; overflow: hidden;
        }

        .view {
            position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
            padding: 20px; padding-bottom: 100px; /* Space for nav */
            opacity: 0; pointer-events: none; transform: translateY(10px);
            transition: opacity 0.3s var(--ease), transform 0.3s var(--ease);
        }
        .view.active { opacity: 1; pointer-events: auto; transform: translateY(0); }

        #bottom-nav {
            height: var(--nav-height); background: var(--surface-2);
            border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            position: fixed; bottom: 0; width: 100%; z-index: 50;
        }
        .nav-btn {
            background: none; border: none; color: var(--text-2);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 0.7rem; font-weight: 600; cursor: pointer; flex: 1;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active svg { stroke: var(--primary); fill: rgba(99, 102, 241, 0.1); }

        /* =========================================
           5. SPECIFIC MODULE STYLES
           ========================================= */
        
        /* Reader */
        .reader-page {
            max-width: 700px; margin: 0 auto;
            font-family: var(--font-reader); font-size: 1.2rem; line-height: 1.8;
            color: var(--text-1); text-align: justify;
        }
        .token { cursor: pointer; border-radius: 4px; padding: 2px 0; transition: background 0.1s; }
        .token:active { background: rgba(99, 102, 241, 0.3); }
        .token.highlight { background: rgba(253, 224, 71, 0.3); }
        
        /* Flashcards Grid */
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 12px; }
        .fc-front { font-size: 1.4rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .fc-back { font-size: 1.1rem; color: var(--text-2); border-top: 1px solid var(--border); padding-top: 8px; }
        .fc-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: var(--surface-3); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Quiz Mode */
        .quiz-overlay {
            position: fixed; inset: 0; background: var(--surface-1); z-index: 100;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s var(--ease);
        }
        .quiz-overlay.open { transform: translateX(0); }
        .quiz-card-display {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .q-word { font-size: 3rem; font-weight: 900; margin-bottom: 2rem; }
        .q-btn-option {
            width: 100%; max-width: 400px; padding: 16px; margin-bottom: 10px;
            background: var(--surface-2); border: 1px solid var(--border); border-radius: 12px;
            font-size: 1.1rem; color: var(--text-1); text-align: left;
        }
        .q-btn-option.correct { border-color: var(--secondary); background: rgba(16, 185, 129, 0.1); }
        .q-btn-option.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* Stats Heatmap */
        .heatmap-grid { display: flex; gap: 4px; justify-content: space-between; margin-top: 10px; }
        .hm-cell {
            flex: 1; aspect-ratio: 1; background: var(--surface-3); border-radius: 4px;
            display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: var(--text-2);
        }
        .hm-cell[data-level="1"] { background: rgba(99, 102, 241, 0.4); color: white; }
        .hm-cell[data-level="2"] { background: rgba(99, 102, 241, 0.7); color: white; }
        .hm-cell[data-level="3"] { background: var(--primary); color: white; }

        /* Bottom Sheet (Word Details) */
        .backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 80;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .backdrop.open { opacity: 1; pointer-events: auto; }
        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface-2); border-radius: 24px 24px 0 0;
            padding: 24px; padding-bottom: 40px; z-index: 90;
            transform: translateY(100%); transition: transform 0.3s var(--ease);
            max-height: 85vh; overflow-y: auto;
        }
        .sheet.open { transform: translateY(0); }
        .drag-handle { width: 40px; height: 5px; background: var(--border); border-radius: 5px; margin: 0 auto 20px auto; }

        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translate(-50%, -20px);
            background: var(--text-1); color: var(--surface-1);
            padding: 10px 20px; border-radius: 50px; font-weight: 600; font-size: 0.9rem;
            opacity: 0; pointer-events: none; transition: all 0.3s var(--ease); z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .toast.visible { opacity: 1; transform: translate(-50%, 0); }

    </style>
</head>
<body>

    <header id="app-header">
        <div class="flex items-center gap-2">
            <svg class="icon" style="color:var(--primary)"><path d="M12 2l9 4.9V17L12 22l-9-4.9V7z"/></svg>
            <span class="bold" style="font-size:1.2rem">LingoMaster</span>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-ghost btn-icon" id="btn-theme">
                <svg class="icon"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            </button>
            <button class="btn btn-ghost btn-icon" id="btn-settings">
                <svg class="icon"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </div>
    </header>

    <main id="main-viewport">
        
        <div id="view-home" class="view active">
            <h2 class="h3 text-sm" style="margin-bottom:15px; color:var(--text-2); text-transform:uppercase;">Genel Bakış</h2>
            
            <div class="flex gap-4" style="margin-bottom: 20px;">
                <div class="card w-full">
                    <div class="text-sm">Toplam Kart</div>
                    <div class="h1" id="dash-total">0</div>
                </div>
                <div class="card w-full" style="border-color: rgba(245, 158, 11, 0.3)">
                    <div class="text-sm" style="color: var(--warning)">Tekrar (Due)</div>
                    <div class="h1" style="color: var(--warning)" id="dash-due">0</div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 25px;">
                <div class="flex justify-between items-center">
                    <div class="h3">Çalışma Zinciri</div>
                    <div class="text-sm bold" style="color:var(--primary)" id="dash-streak">0 Gün</div>
                </div>
                <div id="heatmap" class="heatmap-grid"></div>
            </div>

            <h2 class="h3 text-sm" style="margin-bottom:15px; color:var(--text-2); text-transform:uppercase;">Hızlı İşlemler</h2>
            
            <button class="btn btn-primary w-full p-4" onclick="App.startQuiz()" style="font-size:1.1rem; margin-bottom:10px;">
                <svg class="icon"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                Bugünkü Tekrarları Başlat
            </button>
            <button class="btn btn-secondary w-full" onclick="Router.go('library')">
                <svg class="icon"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                Kitap Okumaya Devam Et
            </button>
        </div>

        <div id="view-library" class="view">
            <div class="flex justify-between items-center mb-4" style="margin-bottom:20px">
                <h2 class="h2">Kütüphane</h2>
                <button class="btn btn-primary btn-icon" onclick="App.openAddBook()">
                    <svg class="icon"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            </div>
            <div id="library-list" class="flex-col gap-4" style="padding-bottom:20px"></div>
        </div>

        <div id="view-reader" class="view" style="background: var(--surface-1); z-index: 60;">
            <div class="flex justify-between items-center" style="position:sticky; top:-20px; background:var(--surface-1); padding-bottom:10px; border-bottom:1px solid var(--border); margin-bottom:20px;">
                <button class="btn btn-ghost" onclick="Router.go('library')">
                    <svg class="icon"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                </button>
                <div class="flex-col items-center">
                    <span class="bold text-sm" id="r-title">Book Title</span>
                    <span class="text-xs" id="r-progress">Page 1/1</span>
                </div>
                <button class="btn btn-ghost" onclick="Reader.adjustFont()">
                    <svg class="icon"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
                </button>
            </div>

            <div id="reader-canvas" class="reader-page"></div>

            <div class="flex justify-between items-center" style="margin-top:30px; padding-top:20px; border-top:1px solid var(--border);">
                <button class="btn btn-secondary" onclick="Reader.prevPage()">Önceki</button>
                <button class="btn btn-secondary" onclick="Reader.nextPage()">Sonraki</button>
            </div>
        </div>

        <div id="view-cards" class="view">
            <div class="flex gap-2" style="margin-bottom:15px">
                <input type="text" class="input" placeholder="Kart ara..." id="search-input">
            </div>
            <div id="cards-container" class="grid-cards"></div>
        </div>

    </main>

    <nav id="bottom-nav">
        <button class="nav-btn active" data-target="home" onclick="Router.go('home')">
            <svg class="icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span>Ana Sayfa</span>
        </button>
        <button class="nav-btn" data-target="library" onclick="Router.go('library')">
            <svg class="icon"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
            <span>Kütüphane</span>
        </button>
        <button class="nav-btn" data-target="cards" onclick="Router.go('cards')">
            <svg class="icon"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            <span>Kartlar</span>
        </button>
    </nav>

    <div class="backdrop" id="backdrop"></div>
    <div class="sheet" id="word-sheet">
        <div class="drag-handle"></div>
        <div class="flex justify-between items-center mb-4">
            <div>
                <span class="text-xs bold" style="color:var(--primary)" id="ws-lang">EN</span>
                <h2 class="h1" id="ws-term">Word</h2>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-ghost btn-icon" onclick="TTS.speak(document.getElementById('ws-term').textContent)">
                    <svg class="icon"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                </button>
            </div>
        </div>
        
        <div class="input-group">
            <label class="label">Anlamı</label>
            <input type="text" id="ws-meaning" class="input" placeholder="Türkçesi nedir?">
        </div>
        <div class="input-group">
            <label class="label">Bağlam / Cümle</label>
            <textarea id="ws-context" class="textarea" rows="3"></textarea>
        </div>
        
        <div class="flex gap-2">
            <a id="ws-gtranslate" href="#" target="_blank" class="btn btn-secondary flex-1">Google Çeviri</a>
            <button class="btn btn-primary flex-1" onclick="App.saveCard()">Karta Ekle</button>
        </div>
    </div>

    <div class="sheet" id="book-sheet" style="height:90vh">
        <div class="drag-handle"></div>
        <h2 class="h2" style="margin-bottom:20px">Yeni Metin Ekle</h2>
        <div class="input-group">
            <label class="label">Başlık</label>
            <input type="text" id="nb-title" class="input" placeholder="Kitap veya Makale Başlığı">
        </div>
        <div class="input-group">
            <label class="label">Dil</label>
            <select id="nb-lang" class="select">
                <option value="EN">İngilizce</option>
                <option value="RU">Rusça</option>
                <option value="DE">Almanca</option>
                <option value="FR">Fransızca</option>
            </select>
        </div>
        <div class="input-group" style="flex:1">
            <label class="label">İçerik</label>
            <textarea id="nb-content" class="textarea" style="height:200px" placeholder="Metni buraya yapıştırın..."></textarea>
        </div>
        <button class="btn btn-primary w-full" onclick="App.saveBook()">Kütüphaneye Ekle</button>
    </div>

    <div class="quiz-overlay" id="quiz-view">
        <div class="flex justify-between items-center p-4">
            <div class="bold">Quiz Modu</div>
            <button class="btn btn-ghost btn-icon" onclick="Quiz.stop()">
                <svg class="icon"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        
        <div id="quiz-content" class="quiz-card-display">
            </div>
    </div>

    <div class="toast" id="toast">Bildirim</div>

    <script>
    /**
     * =========================================================
     * LINGOMASTER CORE ENGINE (Enterprise Pattern)
     * =========================================================
     */

    // --- UTILS ---
    const Utils = {
        uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
        el: id => document.getElementById(id),
        toast: (msg) => {
            const t = Utils.el('toast');
            t.textContent = msg; t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }
    };

    // --- DATA STORE (State Management) ---
    const Store = {
        data: {
            cards: JSON.parse(localStorage.getItem('lm_cards') || '[]'),
            books: JSON.parse(localStorage.getItem('lm_books') || '[]'),
            activity: JSON.parse(localStorage.getItem('lm_activity') || '{}'),
            settings: JSON.parse(localStorage.getItem('lm_settings') || '{"theme":"dark", "fontSize":19}')
        },
        save() {
            localStorage.setItem('lm_cards', JSON.stringify(this.data.cards));
            localStorage.setItem('lm_books', JSON.stringify(this.data.books));
            localStorage.setItem('lm_activity', JSON.stringify(this.data.activity));
            localStorage.setItem('lm_settings', JSON.stringify(this.data.settings));
        },
        logActivity() {
            const k = new Date().toISOString().split('T')[0];
            this.data.activity[k] = (this.data.activity[k] || 0) + 1;
            this.save();
        },
        seed() {
            if (this.data.books.length === 0) {
                this.data.books.push({
                    id: 'b1', title: 'Sherlock Holmes (Demo)', lang: 'EN', page: 0,
                    content: `To Sherlock Holmes she is always the woman. I have seldom heard him mention her under any other name. In his eyes she eclipses and predominates the whole of her sex. It was not that he felt any emotion akin to love for Irene Adler. All emotions, and that one particularly, were abhorrent to his cold, precise but admirably balanced mind. He was, I take it, the most perfect reasoning and observing machine that the world has seen, but as a lover he would have placed himself in a false position.`
                });
                this.data.books.push({
                    id: 'b2', title: 'Толстый и тонкий (Chekhov)', lang: 'RU', page: 0,
                    content: `На вокзале Николаевской железной дороги встретились два приятеля: один толстый, другой тонкий. Толстый только что пообедал на вокзале, и губы его, подернутые маслом, лоснились, как спелые вишни. Пахло от него хересом и флер-д’оранжем. Тонкий же только что вышел из вагона и был навьючен чемоданами, узлами и картонками.`
                });
                this.save();
            }
        }
    };

    // --- SM-2 ALGORITHM (Spaced Repetition) ---
    const SRS = {
        calc(card, quality) {
            // quality: 0-5. (3+ means passed)
            let { interval, reps, ef } = card.srs || { interval:0, reps:0, ef:2.5 };
            
            if (quality >= 3) {
                if (reps === 0) interval = 1;
                else if (reps === 1) interval = 6;
                else interval = Math.round(interval * ef);
                
                reps++;
                ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (ef < 1.3) ef = 1.3;
            } else {
                reps = 0; interval = 1;
            }

            const nextDue = Date.now() + (interval * 24 * 60 * 60 * 1000);
            return { srs: { interval, reps, ef }, due: nextDue };
        }
    };

    // --- ROUTER ---
    const Router = {
        go(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            // Nav update
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const navBtn = document.querySelector(`.nav-btn[data-target="${viewId === 'reader' ? 'library' : viewId}"]`);
            if (navBtn) navBtn.classList.add('active');

            if(viewId === 'home') App.renderDash();
            if(viewId === 'cards') App.renderCards();
            if(viewId === 'library') App.renderLibrary();
        }
    };

    // --- MODULE: READER ---
    const Reader = {
        activeBook: null,
        pageSize: 750, // Characters per page approx

        open(id) {
            this.activeBook = Store.data.books.find(b => b.id === id);
            Router.go('reader');
            this.render();
        },

        getPages(text) {
            const pages = [];
            let i = 0;
            while(i < text.length) {
                let end = Math.min(i + this.pageSize, text.length);
                if(end < text.length) {
                    const space = text.lastIndexOf(' ', end);
                    if(space > i) end = space;
                }
                pages.push(text.slice(i, end).trim());
                i = end;
            }
            return pages;
        },

        render() {
            if(!this.activeBook) return;
            const b = this.activeBook;
            const pages = this.getPages(b.content);
            if(b.page >= pages.length) b.page = pages.length - 1;

            Utils.el('r-title').textContent = b.title;
            Utils.el('r-progress').textContent = `Sayfa ${b.page + 1} / ${pages.length}`;
            
            const canvas = Utils.el('reader-canvas');
            canvas.innerHTML = '';
            canvas.style.fontSize = Store.data.settings.fontSize + 'px';

            // Advanced Tokenization (keep punctuation but separate)
            const text = pages[b.page];
            // Split by space but capture logic
            text.split(/(\s+)/).forEach(chunk => {
                if (chunk.trim().length > 0 && !/^[.,!?;:"()«»—-]+$/.test(chunk)) {
                    const span = document.createElement('span');
                    span.className = 'token';
                    span.textContent = chunk;
                    span.onclick = (e) => App.openWordSheet(chunk, b.lang);
                    canvas.appendChild(span);
                } else {
                    canvas.appendChild(document.createTextNode(chunk));
                }
            });
        },

        nextPage() {
            const pgs = this.getPages(this.activeBook.content);
            if (this.activeBook.page < pgs.length - 1) {
                this.activeBook.page++; Store.save(); this.render();
            }
        },
        prevPage() {
            if (this.activeBook.page > 0) {
                this.activeBook.page--; Store.save(); this.render();
            }
        },
        adjustFont() {
            let s = Store.data.settings.fontSize;
            s = s > 24 ? 16 : s + 2;
            Store.data.settings.fontSize = s; Store.save();
            this.render();
        }
    };

    // --- MODULE: QUIZ ---
    const Quiz = {
        queue: [],
        current: null,

        start() {
            const now = Date.now();
            // Prioritize DUE cards
            this.queue = Store.data.cards.filter(c => c.due <= now);
            
            // If no due cards, mix some new ones or random review
            if (this.queue.length === 0) {
                this.queue = [...Store.data.cards].sort(() => Math.random() - 0.5).slice(0, 10);
                if (this.queue.length === 0) return Utils.toast("Hiç kart yok!");
                Utils.toast("Tekrar yok, rastgele pratik!");
            }
            
            Utils.el('quiz-view').classList.add('open');
            this.next();
        },

        next() {
            if (this.queue.length === 0) return this.stop();
            this.current = this.queue.pop();
            
            const container = Utils.el('quiz-content');
            container.innerHTML = `
                <div style="font-size:0.9rem; font-weight:700; color:var(--text-2); margin-bottom:10px">${this.current.lang}</div>
                <div class="q-word">${this.current.term}</div>
                <button class="btn btn-ghost btn-icon" onclick="TTS.speak('${this.current.term}', '${this.current.lang}')" style="margin-bottom:30px">
                    <svg class="icon"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                </button>
                <div id="q-choices" style="width:100%; display:flex; flex-direction:column; align-items:center; gap:10px"></div>
            `;

            // Generate distractors
            let opts = Store.data.cards
                .filter(c => c.id !== this.current.id)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            opts.push(this.current);
            opts.sort(() => Math.random() - 0.5);

            const choicesDiv = Utils.el('q-choices');
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'q-btn-option';
                btn.textContent = o.meaning;
                btn.onclick = () => this.answer(o.id === this.current.id, btn);
                choicesDiv.appendChild(btn);
            });
        },

        answer(isCorrect, btnElement) {
            // Visual feedback
            const allBtns = document.querySelectorAll('.q-btn-option');
            allBtns.forEach(b => b.disabled = true);
            
            if (isCorrect) {
                btnElement.classList.add('correct');
                const update = SRS.calc(this.current, 4); // Grade 4
                Object.assign(this.current, update);
                Store.logActivity();
            } else {
                btnElement.classList.add('wrong');
                // Highlight correct one
                allBtns.forEach(b => {
                    if (b.textContent === this.current.meaning) b.classList.add('correct');
                });
                const update = SRS.calc(this.current, 1); // Grade 1
                Object.assign(this.current, update);
            }
            Store.save();
            setTimeout(() => this.next(), 1200);
        },

        stop() {
            Utils.el('quiz-view').classList.remove('open');
            App.renderDash();
        }
    };

    // --- MODULE: TTS (Text To Speech) ---
    const TTS = {
        speak(txt, lang='EN') {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            const map = {'EN':'en-US', 'RU':'ru-RU', 'DE':'de-DE', 'FR':'fr-FR', 'TR':'tr-TR'};
            u.lang = map[lang] || 'en-US';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }
    };

    // --- MAIN CONTROLLER ---
    const App = {
        init() {
            Store.seed(); // Load defaults if empty
            
            // Render Heatmap on startup
            this.renderDash();
            
            // Theme Init
            document.body.setAttribute('data-theme', Store.data.settings.theme);

            // Global Listeners
            Utils.el('btn-theme').onclick = this.toggleTheme;
            Utils.el('backdrop').onclick = this.closeSheets;
            
            // Settings -> Import/Export could go here
            Utils.el('btn-settings').onclick = () => Utils.toast("Ayarlar yakında...");
            
            // Search
            Utils.el('search-input').addEventListener('input', (e) => this.renderCards(e.target.value));
        },

        toggleTheme() {
            const n = Store.data.settings.theme === 'dark' ? 'light' : 'dark';
            Store.data.settings.theme = n;
            Store.save();
            document.body.setAttribute('data-theme', n);
        },

        // --- DASHBOARD UI ---
        renderDash() {
            Utils.el('dash-total').textContent = Store.data.cards.length;
            const dueCount = Store.data.cards.filter(c => c.due <= Date.now()).length;
            Utils.el('dash-due').textContent = dueCount;
            
            // Heatmap logic
            const hm = Utils.el('heatmap');
            hm.innerHTML = '';
            const today = new Date();
            let streak = 0;
            let broken = false;

            for(let i=6; i>=0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                const count = Store.data.activity[k] || 0;
                
                // Streak calc
                if (count > 0 && !broken) streak++;
                else if (i !== 0) broken = true;

                const lvl = count > 10 ? 3 : (count > 3 ? 2 : (count > 0 ? 1 : 0));
                const div = document.createElement('div');
                div.className = 'hm-cell';
                div.setAttribute('data-level', lvl);
                div.textContent = ['Pz','Pt','Sa','Ça','Pe','Cu','Ct'][d.getDay()];
                hm.appendChild(div);
            }
            Utils.el('dash-streak').textContent = `${streak} Gün`;
        },

        // --- LIBRARY UI ---
        renderLibrary() {
            const list = Utils.el('library-list');
            list.innerHTML = '';
            Store.data.books.forEach(b => {
                const div = document.createElement('div');
                div.className = 'card flex items-center justify-between';
                div.style.marginBottom = '12px';
                div.onclick = (e) => {
                    if(!e.target.closest('.btn-icon')) Reader.open(b.id);
                };
                
                div.innerHTML = `
                    <div style="flex:1">
                        <div class="bold" style="font-size:1.1rem; margin-bottom:4px">${b.title}</div>
                        <div class="flex items-center gap-2">
                            <span class="fc-badge">${b.lang}</span>
                            <span class="text-xs">Sayfa ${b.page + 1}</span>
                        </div>
                    </div>
                    <button class="btn btn-ghost btn-icon" onclick="App.deleteBook('${b.id}')">
                        <svg class="icon-sm" style="color:var(--danger)"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        },

        openAddBook() {
            Utils.el('backdrop').classList.add('open');
            Utils.el('book-sheet').classList.add('open');
        },

        saveBook() {
            const t = Utils.el('nb-title').value;
            const c = Utils.el('nb-content').value;
            const l = Utils.el('nb-lang').value;
            
            if (!t || !c) return Utils.toast("Eksik bilgi!");
            
            Store.data.books.push({
                id: Utils.uuid(), title: t, content: c, lang: l, page: 0
            });
            Store.save();
            this.closeSheets();
            this.renderLibrary();
            Utils.toast("Kitap eklendi.");
        },

        deleteBook(id) {
            if(confirm("Silmek istiyor musun?")) {
                Store.data.books = Store.data.books.filter(b => b.id !== id);
                Store.save(); this.renderLibrary();
            }
        },

        // --- CARDS UI ---
        renderCards(query = '') {
            const cont = Utils.el('cards-container');
            cont.innerHTML = '';
            
            const filtered = Store.data.cards.filter(c => 
                (c.term + c.meaning).toLowerCase().includes(query.toLowerCase())
            );

            filtered.forEach(c => {
                const isDue = c.due <= Date.now();
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="fc-badge" style="background:${isDue ? 'var(--warning)' : 'var(--surface-3)'}; color:${isDue?'#000':'inherit'}">${isDue ? 'DUE' : 'OK'}</span>
                        <div class="flex gap-2">
                            <button class="btn btn-ghost btn-icon" style="padding:4px" onclick="TTS.speak('${c.term}', '${c.lang}')">
                                <svg class="icon-sm"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/></svg>
                            </button>
                            <button class="btn btn-ghost btn-icon" style="padding:4px" onclick="App.deleteCard('${c.id}')">✕</button>
                        </div>
                    </div>
                    <div class="fc-front">${c.term}</div>
                    <div class="fc-back">${c.meaning}</div>
                `;
                cont.appendChild(div);
            });
        },

        deleteCard(id) {
            if(confirm("Kartı sil?")) {
                Store.data.cards = Store.data.cards.filter(c => c.id !== id);
                Store.save(); this.renderCards(Utils.el('search-input').value);
            }
        },

        // --- WORD SHEET LOGIC ---
        openWordSheet(word, lang) {
            const clean = word.replace(/[.,!?;:"()«»]/g, "");
            // Heuristic context find (simple)
            const txt = Utils.el('reader-canvas').textContent;
            const idx = txt.indexOf(word);
            const ctx = "..." + txt.substring(Math.max(0, idx-30), Math.min(txt.length, idx+40)) + "...";

            Utils.el('ws-term').textContent = clean;
            Utils.el('ws-lang').textContent = lang;
            Utils.el('ws-meaning').value = '';
            Utils.el('ws-context').value = ctx;
            
            // Google Translate Link
            Utils.el('ws-gtranslate').href = `https://translate.google.com/?sl=${lang}&tl=tr&text=${clean}&op=translate`;

            Utils.el('backdrop').classList.add('open');
            Utils.el('word-sheet').classList.add('open');
        },

        saveCard() {
            const term = Utils.el('ws-term').textContent;
            const meaning = Utils.el('ws-meaning').value;
            const ctx = Utils.el('ws-context').value;
            const lang = Utils.el('ws-lang').textContent;

            if(!meaning) return Utils.toast("Anlam gerekli!");

            Store.data.cards.push({
                id: Utils.uuid(), term, meaning, example: ctx, lang,
                due: Date.now(),
                srs: { interval: 0, reps: 0, ef: 2.5 }
            });
            Store.save();
            this.closeSheets();
            Utils.toast("Kart Eklendi!");
        },

        closeSheets() {
            Utils.el('backdrop').classList.remove('open');
            document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
        },

        startQuiz() { Quiz.start(); }
    };

    // --- BOOTSTRAP ---
    App.init();

    </script>
</body>
</html>
